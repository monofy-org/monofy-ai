var monofy;(()=>{"use strict";var t={};(t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})})(t);const e=function(){function t(){this._events={},this._onceEvents={}}return t.prototype.on=function(t,e){return this._events[t]||(this._events[t]=[]),this._events[t].push(e),this},t.prototype.once=function(t,e){return this._onceEvents[t]||(this._onceEvents[t]=[]),this._onceEvents[t].push(e),this},t.prototype.emit=function(t,e){var n=this._onceEvents[t];if(n){for(var o=0,r=n;o<r.length;o++){var i=r[o];try{i(e)}catch(e){console.error("Error executing .once callback for event: ".concat(t),e)}}this._onceEvents[t]=void 0}var a=this._events[t];if(a)for(var s=0,l=a;s<l.length;s++){i=l[s];try{i(e)}catch(e){console.error("Error executing .on callback for event: ".concat(t),e)}}},t.prototype.removeAllListeners=function(){this._events={},this._onceEvents={}},t}();var n=null,o=window.AudioContext||window.webkitAudioContext;function r(){return n?("suspended"===n.state&&n.resume(),n):(n=new o({latencyHint:"interactive",sampleRate:44100}),function(){return t=this,e=void 0,r=function(){return function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,o=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}(this,(function(t){switch(t.label){case 0:return"setSinkId"in o.prototype?[4,navigator.mediaDevices.enumerateDevices()]:[3,2];case 1:return[2,t.sent()];case 2:return[2,null]}}))},new((n=void 0)||(n=Promise))((function(o,i){function a(t){try{l(r.next(t))}catch(t){i(t)}}function s(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}l((r=r.apply(t,e||[])).next())}));var t,e,n,r}().then((function(t){console.log("Audio devices",t)})),console.log("Audio context created"),n)}var i,a=(i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},i(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=function(t){function e(){var e=t.call(this)||this;return e._playbackMode="pattern",e._audioContext=null,e._bpm=100,e._scheduledEvents=[],e._startTime=null,e.domElement=document.createElement("div"),e.domElement.classList.add("audio-clock"),e.playPauseButton=document.createElement("button"),e.playPauseButton.classList.add("audio-clock-play-pause"),e.playPauseButton.addEventListener("click",(function(){e.isPlaying?e.stop():(r(),e.playPause())})),e.domElement.appendChild(e.playPauseButton),e.stopButton=document.createElement("button"),e.stopButton.classList.add("audio-clock-stop"),e.stopButton.textContent="■",e.stopButton.addEventListener("click",(function(){e.stop()})),e.domElement.appendChild(e.stopButton),e.bpmInput=document.createElement("input"),e.bpmInput.classList.add("audio-clock-bpm"),e.bpmInput.type="number",e.bpmInput.value="120",e.bpmInput.addEventListener("input",(function(){e._bpm=parseFloat(e.bpmInput.value)})),e.domElement.appendChild(e.bpmInput),e.currentTimeDisplay=document.createElement("span"),e.currentTimeDisplay.classList.add("audio-clock-time"),e.currentTimeDisplay.textContent="01:1",e.domElement.appendChild(e.currentTimeDisplay),e}return a(e,t),Object.defineProperty(e.prototype,"startTime",{get:function(){return this._startTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return this.audioContext.currentTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audioContext",{get:function(){return this._audioContext||(this._audioContext=r()),this._audioContext},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentBeat",{get:function(){return(null!==this._startTime?this.audioContext.currentTime-this._startTime:0)*(this._bpm/60)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isPlaying",{get:function(){return null!=this._startTime&&this._startTime>=0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bpm",{get:function(){return this._bpm},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"playbackMode",{get:function(){return this._playbackMode},enumerable:!1,configurable:!0}),e.prototype.start=function(){this._startTime=this.audioContext.currentTime,console.log("Started at",this._startTime),requestAnimationFrame(this._render.bind(this)),this.emit("start")},e.prototype._render=function(){this._update(this.currentBeat),this.emit("update"),this.isPlaying&&requestAnimationFrame(this._render.bind(this))},e.prototype.stop=function(){this.emit("stop"),this._startTime=null;for(var t=0,e=this._scheduledEvents;t<e.length;t++){var n=e[t].source;n.stop(),n.disconnect()}this._scheduledEvents=[],this.playPauseButton.classList.remove("active"),this._update(this.currentBeat)},e.prototype.restart=function(){this.isPlaying&&(this._startTime=this.audioContext.currentTime)},e.prototype.playPause=function(){if(this.isPlaying)this.stop();else{var t=this.audioContext.createBuffer(1,1,this.audioContext.sampleRate),e=this.audioContext.createBufferSource();e.buffer=t,e.connect(this.audioContext.destination),e.start(),this.start()}this.playPauseButton.classList.toggle("active",this.isPlaying)},e.prototype._update=function(t){var e=Math.floor(t/4)+1,n=Math.floor(t%4)+1,o="".concat(e.toString().padStart(2,"0"),":").concat(n.toString());this.currentTimeDisplay.textContent=o},e.prototype.scheduleEventAtTime=function(t,e){var n=this.audioContext.createBuffer(1,1,this.audioContext.sampleRate),o=this.audioContext.createBufferSource();o.buffer=n,o.connect(this.audioContext.destination),o.onended=function(){return t()},o.start(e),this._scheduledEvents.push({source:o,time:e,callback:t})},e.prototype.scheduleEventAtBeat=function(t,e){var n=this._startTime+e/this._bpm*60;this.scheduleEventAtTime(t,n)},e}(e),l=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),c=function(t){function e(e,n){var o=t.call(this)||this;return o.domElement=document.createElement(e),n&&o.domElement.classList.add(n),o}return l(e,t),e.prototype.dispose=function(){this.removeAllListeners(),this.domElement.remove()},e.prototype.appendChild=function(t){return this.domElement.appendChild(t.domElement),this},e.prototype.removeChild=function(t){return this.domElement.removeChild(t.domElement),this},e}(e),u=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),d=function(t){function e(e,n){var o=this;return console.assert(e,"audioClock is required"),console.assert(n,"mixer is required"),(o=t.call(this,"div","plugin-container")||this).audioClock=e,o.mixer=n,o}return u(e,t),e}(c),p=function(){function t(){}return t.register=function(t,e){this._plugins[t]?console.warn("Plugin already registered:",e):this._plugins[t]=e},t.get=function(t){return this._plugins[t]},t.instantiate=function(t,e,n){return new(this.get(t))(e,n)},t._plugins={},t}(),f=function(){function t(){}return t.linearToGain=function(t){var e=80*Math.max(0,Math.min(1,t))-80;return Math.pow(10,e/20)},t}(),m=function(){function t(t,e,n,o){void 0===n&&(n=1),void 0===o&&(o=[0]),this.audioContext=t,this.label=e,this.outputs=o,this.mute=!1,this.solo=!1,this.effects=[],this.gainNode=t.createGain(),this.gainNode.gain.value=f.linearToGain(n)}return Object.defineProperty(t.prototype,"gain",{get:function(){return this.gainNode.gain.value},enumerable:!1,configurable:!0}),t}(),h=function(t){this.audioContext=t,this.channels=[];var e=new m(t,"Master",1);e.gainNode.connect(t.destination),this.channels.push(e);for(var n=1;n<=16;n++){var o=new m(t,n.toString());o.gainNode.connect(e.gainNode),this.channels.push(o)}},v=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),y=function(t){function e(e,n){var o=t.call(this)||this;return o.audioClock=e,o.title="Untitled",o.description="",o.tempo=120,o.instruments=[],o.patterns=[],o.tracks=[],o.playlist={events:[]},n&&setTimeout((function(){o.load(n)}),0),o.mixer=new h(e.audioContext),e.on("start",(function(){console.log("DEBUG START",o.playlist);for(var t=0,e=o.playlist.events;t<e.length;t++){var n=e[t];console.log("DEBUG ITEM",n.start,n)}})),o}return v(e,t),e.prototype.serialize=function(){return JSON.stringify({title:this.title,description:this.description,tempo:this.tempo,instruments:this.instruments.map((function(t){return{name:t.name,controllerGroups:t.controllerGroups}})),patterns:this.patterns,timeline:this.playlist})},e.prototype.deserialize=function(t){console.log("Project deserialize",t);var e=JSON.parse(t);this.load(e)},e.prototype.load=function(t){console.log("Project load",t),this.title=t.title,this.description=t.description,this.tempo=t.tempo,this.patterns=t.patterns,this.playlist=t.playlist,this.instruments=[];for(var e=0,n=t.instruments;e<n.length;e++){var o=n[e];console.log("loading instrument",o),p.get(o.id);var r=p.instantiate(o.id,this.audioClock,this.mixer);this.instruments.push(r)}console.log("emitting update..."),this.emit("update",{type:"project",value:this})},e}(e),g=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),_=function(t){function e(e){var n=t.call(this,"div","window-snap-panel")||this;return n.container=e,n._isOpen=!1,n.domElement.addEventListener("pointerdown",(function(){n.toggle()})),n}return g(e,t),Object.defineProperty(e.prototype,"isOpen",{get:function(){return this._isOpen},enumerable:!1,configurable:!0}),e.prototype.open=function(){this._isOpen||(this.domElement.classList.toggle("open",!0),this._isOpen=!0,this.emit("open"))},e.prototype.close=function(){this._isOpen&&(this.domElement.classList.toggle("open",!1),this._isOpen=!1,this.emit("close"))},e.prototype.toggle=function(){this._isOpen?this.close():this.open()},e}(c),b=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),E=function(t){function e(){var e=t.call(this,"div","window-container")||this;e._activeWindow=null,e.windows=[],e._draggingWindow=null;var n=document.createElement("div");n.classList.add("window-snap-row"),e.domElement.appendChild(n);var o=document.createElement("div");return o.classList.add("window-snap-row"),o.classList.add("bottom-row"),e.domElement.appendChild(o),e._leftPanel=new _(e),n.appendChild(e._leftPanel.domElement),e._workspace=document.createElement("div"),e._workspace.classList.add("window-container-workspace"),n.appendChild(e._workspace),e._rightPanel=new _(e),n.appendChild(e._rightPanel.domElement),e._bottomPanel=new _(e),o.appendChild(e._bottomPanel.domElement),e}return b(e,t),e.prototype._handleWindowDrag=function(t){var e=t.target.domElement,n=this._workspace.getBoundingClientRect().width;if(e.parentElement===this._workspace){var o=this._leftPanel.domElement.getBoundingClientRect().width;if(t.event.clientX<=Math.max(0,o)){var r=o||300;this._leftPanel.domElement.appendChild(e),e.style.width="".concat(r,"px"),e.style.height="unset",e.classList.toggle("snap",!0)}else{var i=this._rightPanel.domElement.getBoundingClientRect().width;t.event.clientX+Math.max(250,i)>n+i+o&&(r=i||300,this._rightPanel.domElement.appendChild(e),e.style.width="".concat(r,"px"),e.style.height="unset",e.classList.toggle("snap",!0))}}else if(e.parentElement===this._leftPanel.domElement&&t.event.target===this._workspace)this._workspace.appendChild(e),e.classList.toggle("snap",!1),e.style.left=t.event.clientX+"px",(a=t.target).resetDragOffset(),a.setSize(a.options.width,a.options.height);else if(e.parentElement===this._rightPanel.domElement&&t.event.target===this._workspace){var a;this._workspace.appendChild(e),e.classList.toggle("snap",!1),e.style.left=n+"px",(a=t.target).resetDragOffset(),a.setSize(a.options.width,a.options.height)}},e.prototype._handleWindowResize=function(t){for(var e=0,n=this.windows;e<n.length;e++){var o=n[e];o.domElement!==t.target.domElement&&o.domElement.parentElement!==this._workspace&&o.domElement.parentElement===t.target.domElement.parentElement&&(o.domElement.style.width="".concat(t.width,"px"))}},e.prototype.addWindow=function(t){var e=this;this.windows.includes(t)?console.warn("Window already added",t):(t.on("drag",(function(t){return e._handleWindowDrag(t)})),t.on("resize",(function(t){return e._handleWindowResize(t)})),this.windows.push(t),this._workspace.appendChild(t.domElement),this._activeWindow||(this._activeWindow=t,this.activateWindow(t)),t.domElement.addEventListener("pointerdown",(function(){e.activateWindow(t)})),t.on("open",(function(){e.activateWindow(t)})),t.on("close",(function(){e._activeWindow===t&&(e._activeWindow=null)})))},e.prototype.activateWindow=function(t){if(this._activeWindow!==t){this._activeWindow=t;for(var e=0,n=this.windows;e<n.length;e++){var o=n[e];o.domElement.classList.toggle("active",o===t),o.domElement.style.zIndex=o===t?"1":"0"}}},e}(c),w=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),C=function(t){function e(e,n){var o=t.call(this,"div","notification")||this;o.domElement.style.display="hidden";var r=document.createElement("h1"),i=document.createElement("p");o._closeButton=document.createElement("button"),o._closeButton.textContent="×";var a=function(){o._closeButton.removeEventListener("click",a),o.dispose(),o.emit("close")};return o._closeButton.addEventListener("click",a),(null==n?void 0:n.body)&&(i.textContent=n.body),r.textContent=e,o.domElement.appendChild(r),o.domElement.appendChild(i),o.domElement.appendChild(o._closeButton),document.body.appendChild(o.domElement),o}return w(e,t),e}(c),O=[90,83,88,68,67,86,71,66,72,78,74,77,188,76,190,59,191],k=[81,50,87,51,69,82,53,84,54,89,55,85,73,57,79,48,80,219,61,221],x=["white","black","white","white","black","white","black","white","white","black","white","black"],P=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],j=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),L=null;function B(t){var e=-1;return O.includes(t)?e=O.indexOf(t):k.includes(t)&&(e=k.indexOf(t)+12),e}var T=function(t){function e(){var e=t.call(this,"div","keyboard")||this;L||navigator.requestMIDIAccess().then((function(t){console.log("MIDI Access",t),L=t,t.inputs.forEach((function(t){t.onmidimessage=function(t){return e.handleMIDI(t)}}))})).catch((function(t){console.error("MIDI Access error",t),new C("MIDI Access error",{body:t.message})}));var n=[];return window.addEventListener("keydown",(function(t){if(!(t.ctrlKey||t.altKey||t.shiftKey)&&"INPUT"!=t.target.tagName){var o=B(t.keyCode);-1===o||n.includes(o)||(n.push(o),e.emit("update",{type:"press",note:o}))}})),window.addEventListener("keyup",(function(t){var o=B(t.keyCode);-1!==o&&n.includes(o)&&(n.splice(n.indexOf(o),1),e.emit("update",{type:"release",note:o}))})),e}return j(e,t),e.prototype.handleMIDI=function(t){var e;if(console.log("MIDI",null===(e=t.data)||void 0===e?void 0:e.length,"bytes",t.data),!(null===t.data||t.data.length<3)){var n=240&t.data[0],o=t.data[1],r=t.data[2];if(144===n&&0!==r){var i=o-36,a=r;this.emit("update",{type:"press",note:i,velocity:a})}else if(128===n||144===n&&0===r)i=o-36,this.emit("update",{type:"release",note:i});else if(176===n){var s=o,l=r;console.log("Control Change",s,l)}}},e}(c),S=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),A=function(t){function e(e,n){var o=t.call(this,e,n)||this;o._resizing=!1,o._startX=0,o._startY=0,o._startWidth=0,o._startHeight=0,o._startTop=0,o._startLeft=0,o._resizeDirection=null,o.domElement.addEventListener("pointermove",(function(t){var e=o.getCurrentHandle(t);o.domElement.style.cursor="top"===e||"bottom"===e?"ns-resize":"left"===e||"right"===e?"ew-resize":"auto"}));var r=function(t){if(o._resizing){console.log(o._resizeDirection);var e=t.clientX-o._startX,n=t.clientY-o._startY;"right"===o._resizeDirection?o.domElement.style.width="".concat(o._startWidth+e,"px"):"bottom"===o._resizeDirection?o.domElement.style.height="".concat(o._startHeight+n,"px"):"left"===o._resizeDirection?(o.domElement.style.width="".concat(o._startWidth-e,"px"),o.domElement.style.left="".concat(o._startLeft+e,"px")):"top"===o._resizeDirection&&(o.domElement.style.height="".concat(o._startHeight-n,"px"),o.domElement.style.top="".concat(o._startTop+n,"px"));var r={target:o,width:o.domElement.offsetWidth,height:o.domElement.offsetHeight,event:t};o.emit("resize",r)}};return o.domElement.addEventListener("pointerdown",(function(t){if(0===t.button){var e=o.getCurrentHandle(t);e&&(window.addEventListener("pointermove",r),o.startResize(t,e),t.preventDefault());var n=function(){o.stopResize(),window.removeEventListener("pointermove",r),window.removeEventListener("pointerup",n)};window.addEventListener("pointerup",n)}})),o}return S(e,t),e.prototype.startResize=function(t,e){console.log("startResize",e),this._resizing=!0,this._startX=t.clientX,this._startY=t.clientY,this._startWidth=this.domElement.offsetWidth,this._startHeight=this.domElement.offsetHeight,this._startTop=this.domElement.offsetTop,this._startLeft=this.domElement.offsetLeft,this._resizeDirection=e},e.prototype.stopResize=function(){this._resizing=!1,this._resizeDirection=null},e.prototype.getCurrentHandle=function(t){var e=this.domElement.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top;return n>0&&n<8?"left":e.width-n<8?"right":o>0&&o<8?"top":e.height-o<8?"bottom":null},e}(c),I=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),M=function(t){function e(e){var n=t.call(this,"div","draggable-window")||this;n.options=e,n._isDragging=!1,n._dragOffsetX=0,n._dragOffsetY=0,n._top=0,n._left=0,n.domElement.style.display="none",n._top=e.top||0,n._left=e.left||0,n.persistent=e.persistent||!1,n.titlebar=document.createElement("div"),n.titlebar.className="window-titlebar",n.domElement.appendChild(n.titlebar),n.on("resize",(function(t){var e=t;n.options.width=e.width,n.options.height=e.height})),n.titlebar.addEventListener("pointerdown",(function(t){n._isDragging=!0,n._dragOffsetX=t.clientX-n.domElement.getBoundingClientRect().left+n.domElement.parentElement.getBoundingClientRect().left,n._dragOffsetY=t.clientY-n.domElement.getBoundingClientRect().top+n.domElement.parentElement.getBoundingClientRect().top+n.domElement.parentElement.scrollTop;var e=function(t){if(n._isDragging){var e=t.clientY-n._dragOffsetY,o=t.clientX-n._dragOffsetX,r=o-n._left,i=e-n._top;e<0&&(e=0),n.domElement.style.top="".concat(e,"px"),n.domElement.style.left="".concat(o,"px"),n._top=e,n._left=o;var a={target:n,event:t,top:e,left:o,deltaX:r,deltaY:i};n.emit("drag",a)}},o=function(){n._isDragging=!1,document.body.removeEventListener("pointermove",e),document.body.removeEventListener("pointerup",o)};document.body.addEventListener("pointermove",e),document.body.addEventListener("pointerup",o)})),n._title=document.createElement("div"),n._title.className="window-titlebar-title",n._title.textContent=e.title,n.titlebar.appendChild(n._title),n.content=document.createElement("div"),n.content.className="window-content",n.domElement.appendChild(n.content),n._closeButton=document.createElement("button"),n._closeButton.className="window-close-button",n._closeButton.addEventListener("pointerdown",(function(t){0===t.button&&n.close()})),n.titlebar.appendChild(n._closeButton);var o=e.width||640,r=e.height||400;return n.setSize(o,r),e.content&&n.content.appendChild(e.content),n}return I(e,t),Object.defineProperty(e.prototype,"isVisible",{get:function(){return"none"!==this.domElement.style.display},enumerable:!1,configurable:!0}),e.prototype.resetDragOffset=function(){var t=this.domElement.parentElement.getBoundingClientRect();this._dragOffsetX=t.left+100,this._dragOffsetY=t.top+10},e.prototype.show=function(t,e){var n=this;void 0===t&&(t=this._left),void 0===e&&(e=this._top),this._top=e,this._left=t,0===this._top&&0===this._left&&(t=window.innerWidth/2-200,e=window.innerHeight/4),this.domElement.style.display="flex",this.domElement.style.top="".concat(e,"px"),this.domElement.style.left="".concat(t,"px"),setTimeout((function(){var t;null===(t=n.domElement.parentElement)||void 0===t||t.appendChild(n.domElement),n.emit("open")}),1)},e.prototype.close=function(){this.domElement.style.display="none",this.emit("close"),this.persistent||(console.log("Removing window",this),this.domElement.remove())},e.prototype.setSize=function(t,e){this.options.width=t,this.options.height=e,this.domElement.style.width="".concat(t,"px"),this.domElement.style.height="".concat(e,"px")},e.prototype.setPosition=function(t,e){this.domElement.style.top="".concat(e,"px"),this.domElement.style.left="".concat(t,"px")},e.prototype.setTitle=function(t){this._title.textContent=t},e}(A),W=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),D=function(t){function e(e){void 0===e&&(e=[]);var n=t.call(this,"div","selectable-group")||this;n.items=e;for(var o=0,r=e;o<r.length;o++){var i=r[o];n.addSelectable(i,!1)}return n}return W(e,t),e.prototype.addSelectable=function(t,e){var n=this;void 0===e&&(e=!0),-1!==this.items.indexOf(t)?console.warn("Already added",t):(this.items.push(t),t.on("select",(function(){n.emit("select",n)})),e&&this.domElement.appendChild(t.domElement),t.domElement.addEventListener("pointerdown",(function(e){if(e.ctrlKey||e.shiftKey){if(e.ctrlKey)t.selected=!t.selected;else if(e.shiftKey){var o=n.items.find((function(t){return t.selected}));if(!o)return void(t.selected=!0);for(var r=n.items.indexOf(o),i=n.items.indexOf(t),a=Math.min(r,i),s=Math.max(r,i),l=a;l<=s;l++)n.items[l].selected=!0}}else for(var c=0,u=n.items;c<u.length;c++){var d=u[c];d.selected=d===t}})))},e.prototype.removeSelectable=function(t){var e=this.items.indexOf(t);-1!==e&&(this.items.splice(e,1),this.domElement.removeChild(t.domElement))},e.prototype.clear=function(){for(var t=0,e=this.items;t<e.length;t++){var n=e[t];this.domElement.removeChild(n.domElement)}this.items.length=0},e}(c),R=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),q=function(t){function e(e,n,o){var r=t.call(this,n,o)||this;return r.group=e,r.group.addSelectable(r),r}return R(e,t),Object.defineProperty(e.prototype,"selected",{get:function(){return this.domElement.classList.contains("selected")},set:function(t){t!==this.selected&&(this.domElement.classList.toggle("selected",t),this.emit("select",this))},enumerable:!1,configurable:!0}),e}(c),G=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),z=function(t){function e(){var e=t.call(this,"div","track-buttons")||this;e._mute=!1,e._solo=!1;var n=document.createElement("div");e._muteButton=n,n.classList.add("track-button"),n.classList.add("track-mute-button"),n.textContent="M",n.addEventListener("pointerdown",(function(){e._mute=!e._mute,n.classList.toggle("active",e._mute),e.emit("change")})),e.domElement.appendChild(n);var o=document.createElement("div");return e._soloButton=o,o.classList.add("track-button"),o.classList.add("track-solo-button"),o.textContent="S",o.addEventListener("pointerdown",(function(){e._solo=!e._solo,o.classList.toggle("active",e._solo),e.emit("change")})),e.domElement.appendChild(o),e}return G(e,t),Object.defineProperty(e.prototype,"mute",{get:function(){return this._mute},set:function(t){this._mute=t,this._muteButton.classList.toggle("active",this._mute)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this._solo},set:function(t){this._solo=t,this._soloButton.classList.toggle("active",this._solo)},enumerable:!1,configurable:!0}),e}(c),N=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),H=function(t){function e(e,n,o){void 0===o&&(o=!1);var r=t.call(this,e,"div","mixer-channel")||this;r.isMaster=o,r.effects=[],r._channel=n,r._label=document.createElement("span"),r._label.textContent=n.label,r.domElement.appendChild(r._label);var i=document.createElement("input");return i.type="range",i.min="0",i.max="1.2",i.step="0.01",i.value="1",r._volume=i,r.domElement.appendChild(i),r.muteSoloButtons=new z,r.domElement.appendChild(r.muteSoloButtons.domElement),i.addEventListener("input",(function(){r.emit("change")})),r.muteSoloButtons.on("change",(function(){r.emit("change")})),r}return N(e,t),Object.defineProperty(e.prototype,"channel",{get:function(){return this._channel},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume.valueAsNumber},set:function(t){this._volume.value=t.toString()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mute",{get:function(){return this.muteSoloButtons.mute},set:function(t){t!==this.muteSoloButtons.mute&&(this.muteSoloButtons.mute=t,this.channel.mute=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this.muteSoloButtons.solo},set:function(t){t!==this.muteSoloButtons.solo&&(this.muteSoloButtons.solo=t,this.channel.solo=t)},enumerable:!1,configurable:!0}),e}(q),V=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),X=function(t){function e(e){var n=t.call(this,{title:"Mixer",persistent:!0,content:document.createElement("div"),width:500,height:300})||this;n.ui=e,n.channels=new D,n.domElement.classList.add("mixer-window");var o=document.createElement("div");o.classList.add("mixer-container");var r=document.createElement("div");r.classList.add("mixer-channels-container");var i=document.createElement("div");i.classList.add("mixer-effects-container"),o.appendChild(r),o.appendChild(i),n.content.appendChild(o),console.log("MIXER CHANNELS DEBUG",n.mixer.channels);for(var a=function(t){var e=new H(s.channels,s.mixer.channels[t],0===t);s.mixer.channels[t].gainNode.gain.value=e.volume,e.on("change",(function(){n.mixer.channels[t].gainNode.gain.value=e.volume})),r.appendChild(e.domElement)},s=this,l=0;l<n.mixer.channels.length;l++)a(l);return n.channels.items[0].selected=!0,n}return V(e,t),Object.defineProperty(e.prototype,"mixer",{get:function(){return this.ui.project.mixer},enumerable:!1,configurable:!0}),e}(M),Y=function(){function t(t){var e=this;this.timeline=t,this.domElement=document.createElement("div"),this.domElement.classList.add("audio-cursor");var n=t.audioClock;n.on("update",(function(){e.update()})),n.on("start",(function(){var t;e.domElement.style.transform="translateX(0)",e.domElement.style.display="block",null===(t=e.domElement.parentElement)||void 0===t||t.appendChild(e.domElement)})),n.on("stop",(function(){e.domElement.style.display="none"}))}return t.prototype.update=function(){this.domElement.style.transform="translateX(".concat(this.timeline.audioClock.currentBeat*this.timeline.beatWidth,"px)")},t.prototype.hide=function(){this.domElement.style.display="none"},t}();function F(t){return e=this,n=arguments,r=function(t,e){return void 0===e&&(e=100),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,o=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}(this,(function(n){return t.classList.toggle("active",!0),setTimeout((function(){t.classList.toggle("active",!1)}),e),[2]}))},new((o=void 0)||(o=Promise))((function(t,i){function a(t){try{l(r.next(t))}catch(t){i(t)}}function s(t){try{l(r.throw(t))}catch(t){i(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,s)}l((r=r.apply(e,n||[])).next())}));var e,n,o,r}var K=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),U=function(t){function e(e,n){var o=this;console.assert(e,"PatternTrackInstrument track is null or undefined"),(o=t.call(this,n,"div","pattern-track-instrument")||this).track=e,o.domElement.classList.add("pattern-track-panel");var r=document.createElement("div");r.classList.add("pattern-track-label-and-buttons");var i=document.createElement("div");i.textContent=e.name,r.appendChild(i),o.muteSoloButtons=new z,o.muteSoloButtons.on("change",(function(){e.mute=o.muteSoloButtons.mute,e.solo=o.muteSoloButtons.solo})),r.appendChild(o.muteSoloButtons.domElement),o.domElement.appendChild(r);var a=document.createElement("div");a.classList.add("track-button"),a.classList.add("track-edit-button"),a.textContent="e";var s=o.track.instrument.window;return a.addEventListener("pointerdown",(function(){s.isVisible?s.close():s.show()})),s.on("close",(function(){a.classList.toggle("active",!1)})),s.on("open",(function(){a.classList.toggle("active",!0)})),o.muteSoloButtons.domElement.appendChild(a),o.indicator=document.createElement("div"),o.indicator.classList.add("pattern-track-indicator"),o.domElement.appendChild(o.indicator),o}return K(e,t),e}(q),J=function(t){function e(e){var n=this;return console.assert(e,"PatternTrackPreview track is null or undefined"),(n=t.call(this,"div","pattern-track-preview")||this).track=e,n._canvas=document.createElement("canvas"),n._canvas.height=60,n._canvas.width=1280,n._canvas.classList.add("pattern-track-pattern"),n.domElement.append(n._canvas),n}return K(e,t),Object.defineProperty(e.prototype,"canvas",{get:function(){return this._canvas},enumerable:!1,configurable:!0}),e}(c),Z=function(t){function e(e,n,o,r,i){var a=t.call(this,"div","pattern-track")||this;return a.project=e,a.instrument=n,a.events=o,a.buttonGroup=r,a.previewGroup=i,a.port=null,a.channel=0,a.button=new U(a,a.buttonGroup),a.preview=new J(a),a.domElement.appendChild(a.button.domElement),a.domElement.appendChild(a.preview.domElement),a}return K(e,t),Object.defineProperty(e.prototype,"mute",{get:function(){return this.button.muteSoloButtons.mute},set:function(t){this.button.muteSoloButtons.mute=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this.button.muteSoloButtons.solo},set:function(t){this.button.muteSoloButtons.solo=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this.instrument.name},enumerable:!1,configurable:!0}),e.prototype.trigger=function(t,e){var n=this;void 0===e&&(e=this.project.audioClock.currentBeat);var o=this.instrument.trigger(t,this.channel,e);return e>0?this.project.audioClock.scheduleEventAtBeat((function(){F(n.button.indicator)}),e):F(this.button.indicator),o},e.prototype.release=function(t,e){void 0===e&&(e=this.project.audioClock.currentBeat),this.instrument.release(t,e)},e.prototype.load=function(t){this.events=t.events},e.prototype.playback=function(){var t=this;if(this.project.audioClock.isPlaying){for(var e=void 0,n=function(t){if(!t.note&&0!==t.note)return console.warn("Missing note property in event object"),"continue";e=o.trigger(t.note,t.start),t.domElement&&(o.project.audioClock.scheduleEventAtBeat((function(){return t.domElement.classList.toggle("active",!0)}),t.start),o.project.audioClock.scheduleEventAtBeat((function(){return t.domElement.classList.toggle("active",!1)}),t.start+t.duration))},o=this,r=0,i=this.events;r<i.length;r++)n(i[r]);void 0!==e&&"source"in e&&(e.source.onended=function(){var e=t.project.audioClock.currentBeat+(4-t.project.audioClock.currentBeat%4);t.project.audioClock.scheduleEventAtBeat((function(){t.project.audioClock.restart(),t.playback()}),e)})}else console.warn("Playback cancelled")},e}(c),Q=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),$=function(t){function e(e){var n=this,o=document.createElement("div");o.classList.add("pattern-track-container"),(n=t.call(this,{title:"Pattern",persistent:!0,content:o,width:400,height:400})||this).ui=e,n.tracks=[],n.beatWidth=20,n.trackContainer=o,n.timeline=n.trackContainer,n.cursor=new Y(n),n.cursor.domElement.style.marginLeft="150px",n.timeline.appendChild(n.cursor.domElement);var r=n.domElement.querySelector("canvas");return r&&(n.beatWidth=r.width/16),n.on("resize",(function(){n.beatWidth=n.domElement.clientWidth/16})),n.addPattern("Pattern 1"),n.patternPreviews=new D,n.buttons=new D,n}return Q(e,t),Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.ui.project.audioClock},enumerable:!1,configurable:!0}),e.prototype.loadProject=function(t){for(var e,n=0,o=this.tracks;n<o.length;n++){var r=o[n];this.trackContainer.removeChild(r.domElement)}this.tracks.length=0;for(var i=0;i<t.instruments.length;i++)(r=this.addTrack(t.instruments[i],(null===(e=t.patterns[0])||void 0===e?void 0:e.tracks[i].events)||[])).load(t.patterns[0].tracks[i]),0===i&&(r.button.selected=!0)},e.prototype.addPattern=function(t){console.log("Created pattern:",t);var e={name:t,tracks:[]};this.ui.project.patterns.push(e)},e.prototype.addTrack=function(t,e){var n=this;console.log("Add track + instrument:",t);var o=new Z(this.ui.project,t,e,this.buttons,this.patternPreviews);return t.output.connect(this.ui.mixerWindow.mixer.channels[0].gainNode),console.assert(o.button instanceof U,"button is not an instance of PatternTrackInstrument"),console.assert(o.preview instanceof J,"preview is not an instance of PatternTrackPreview"),o.preview.domElement.addEventListener("pointerdown",(function(){n.ui.pianoRollWindow.loadTrack(o),n.ui.pianoRollWindow.show()})),this.tracks.push(o),this.trackContainer.appendChild(o.domElement),o},e.prototype.removeTrack=function(t){var e=this.tracks.indexOf(t);-1!==e&&(this.tracks.splice(e,1),this.trackContainer.removeChild(t.domElement),this.buttons.removeSelectable(t.button))},e.prototype.trigger=function(t,e){void 0===e&&(e=this.audioClock.currentBeat);for(var n=0,o=this.tracks;n<o.length;n++){var r=o[n];r.button.selected&&r.trigger(t,e)}},e.prototype.release=function(t,e){void 0===e&&(e=this.audioClock.currentBeat);for(var n=0,o=this.tracks;n<o.length;n++){var r=o[n];r.button.selected&&r.release(t,e)}},e}(M),tt=function(){function t(){}return t.renderSequence=function(t,e,n,o,r){void 0===r&&(r=!0);for(var i=88,a=0,s=0,l=e;s<l.length;s++){var c=l[s];if(!c.note&&0!==c.note)throw console.log("event",c),new Error("renderToCanvas() No note!");c.note<i&&(i=c.note),c.note>a&&(a=c.note)}a+=12,i-=12;var u=t.getContext("2d");r&&u.clearRect(0,0,t.width,t.height);for(var d=Math.min(t.height/(a-i+1),2),p=0,f=e;p<f.length;p++){var m=f[p],h=t.height-(m.note-i+1)*d,v=m.start*o,y=m.duration*o;u.fillStyle=n,u.fillRect(v,h,y,d)}},t.renderPattern=function(e,n,o,r){e.getContext("2d").clearRect(0,0,e.width,e.height);for(var i=[],a=0,s=n.tracks;a<s.length;a++){var l=s[a];i.push.apply(i,l.events)}t.renderSequence(e,i,o,r,!1)},t}(),et=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),nt=function(t){function e(e){var n=t.call(this,"div","scroll-panel")||this;return n.scrollElement=e,n.sensitivity=50,n.linkedElements=[],n._scrollTop=0,e.classList.add("scroll-panel-content"),n.scrollElement.addEventListener("wheel",(function(t){t.preventDefault();var e=n._scrollTop+(t.deltaY>0?-n.sensitivity:n.sensitivity);e+n.scrollElement.offsetHeight<n.domElement.offsetHeight?e=n.domElement.offsetHeight-n.scrollElement.offsetHeight:e>0&&(e=0),n._scrollTop=e,n.scrollElement.style.transform="translateY(".concat(e,"px)");for(var o=0,r=n.linkedElements;o<r.length;o++)r[o].style.transform="translateY(".concat(e,"px)");n.emit("scroll",t)})),n}return et(e,t),Object.defineProperty(e.prototype,"scrollTop",{get:function(){return this._scrollTop},set:function(t){var e=-t;this._scrollTop=e,this.scrollElement.style.transform="translateY(".concat(e,"px)");for(var n=0,o=this.linkedElements;n<o.length;n++)o[n].style.transform="translateY(".concat(e,"px)")},enumerable:!1,configurable:!0}),e.prototype.linkElement=function(t){this.linkedElements.push(t),t.classList.add("scroll-panel-content")},e}(c),ot=function(){function t(t,e,n){void 0===t&&(t=800),void 0===e&&(e=200),void 0===n&&(n=!0);var o=this;this.buffer=null,this.domElement=document.createElement("div"),this.domElement.classList.add("audio-canvas"),this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.domElement.appendChild(this.canvas),n&&this.canvas.addEventListener("click",(function(){o.buffer&&o.playBuffer(o.buffer)})),this.ctx=this.canvas.getContext("2d")}return t.prototype.generateAudio=function(t){return e=this,n=arguments,i=function(t,e){var n,o=this;return void 0===e&&(e=!1),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,o=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}(this,(function(i){switch(i.label){case 0:return[4,new Promise((function(n,i){var a={text:t.label,pitch:t.note,rate:.9};fetch("/api/tts/edge",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then((function(t){return t.arrayBuffer()})).then((function(t){console.log("Audio buffer downloaded",t),r().decodeAudioData(t,(function(t){o.buffer=t,e&&o.playBuffer(t),n(t)}))})).catch((function(t){console.error("Error downloading audio buffer",t),i(t)}))}))];case 1:return n=i.sent(),this.loadBuffer(n),[2,n]}}))},new((o=void 0)||(o=Promise))((function(t,r){function a(t){try{l(i.next(t))}catch(t){r(t)}}function s(t){try{l(i.throw(t))}catch(t){r(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,s)}l((i=i.apply(e,n||[])).next())}));var e,n,o,i},t.prototype.playBuffer=function(t){var e=r(),n=e.createBufferSource();n.buffer=t,n.connect(e.destination),n.start()},t.prototype.loadBuffer=function(t){this.buffer=t;var e=t.getChannelData(0),n=e.length,o=this.canvas.width/n;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath(),this.ctx.moveTo(0,this.canvas.height/2);for(var r=0;r<n;r++){var i=r*o,a=(e[r]+1)*this.canvas.height/2;this.ctx.lineTo(i,a)}this.ctx.lineTo(this.canvas.width,this.canvas.height/2),this.ctx.stroke()},t}(),rt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),it=function(t){function e(){return t.call(this)||this}return rt(e,t),e.prototype.generateAudio=function(t){return e=this,n=arguments,i=function(t,e){var n,o=this;return void 0===e&&(e=!1),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,o=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}(this,(function(i){switch(i.label){case 0:return[4,new Promise((function(n,i){var a={text:t.label,pitch:t.note,rate:.9};fetch("/api/tts/edge",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then((function(t){return t.arrayBuffer()})).then((function(t){console.log("Audio buffer downloaded",t),r().decodeAudioData(t,(function(t){o.buffer=t,e&&o.playBuffer(t),n(t)}))})).catch((function(t){console.error("Error downloading audio buffer",t),i(t)}))}))];case 1:return n=i.sent(),this.loadBuffer(n),[2,n]}}))},new((o=void 0)||(o=Promise))((function(t,r){function a(t){try{l(i.next(t))}catch(t){r(t)}}function s(t){try{l(i.throw(t))}catch(t){r(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,s)}l((i=i.apply(e,n||[])).next())}));var e,n,o,i},e}(ot),at=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),st=function(t){function e(e,n){void 0===e&&(e="OK"),void 0===n&&(n="Cancel");var o=t.call(this,"div","dialog-popup")||this;return o.ok=e,o.cancel=n,o.closeButton=document.createElement("button"),o.closeButton.classList.add("window-close-button"),o.domElement.appendChild(o.closeButton),o.closeButton.addEventListener("pointerdown",(function(){o.domElement.style.display="none"})),e instanceof HTMLButtonElement?o.okButton=e:e&&(o.okButton=document.createElement("button"),o.okButton.textContent=e,o.domElement.appendChild(o.okButton)),o.okButton&&o.okButton.addEventListener("click",(function(){o.emit("result",o)})),n instanceof HTMLButtonElement?o.cancelButton=n:n&&(o.cancelButton=document.createElement("button"),o.cancelButton.textContent=n,o.domElement.appendChild(o.cancelButton)),o.cancelButton&&o.cancelButton.addEventListener("click",(function(){o.emit("cancel",o)})),o}return at(e,t),Object.defineProperty(e.prototype,"isVisibile",{get:function(){return"none"!==this.domElement.style.display},enumerable:!1,configurable:!0}),e.prototype.show=function(t,e,n){var o;this.domElement.style.display="block",this.domElement.style.left="".concat(t,"px"),this.domElement.style.top="".concat(e,"px"),null===(o=this.domElement.parentElement)||void 0===o||o.appendChild(this.domElement)},e.prototype.hide=function(){this.domElement.style.display="none"},e}(c),lt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ct=function(t){function e(e){var n=t.call(this,e)||this;return n.domElement.classList.add("grid-item-editor"),n.domElement.style.display="none",n.textInput=document.createElement("input"),n.textInput.setAttribute("placeholder","Note lyric"),n.textInput.classList.add("lyric-editor-text"),n.textInput.type="text",n.domElement.appendChild(n.textInput),n.audioCanvas=new it,n.domElement.appendChild(n.audioCanvas.domElement),n.saveButton.addEventListener("click",(function(){n.audioCanvas.domElement.style.display="block"})),n}return lt(e,t),e.prototype.show=function(e,n,o){var r;t.prototype.show.call(this,e,n,o),this.textInput.value=(null===(r=this.note)||void 0===r?void 0:r.label)||""},e}(function(t){function e(e){var n=t.call(this)||this;return n.onsave=e,n.note=null,n.domElement=document.createElement("div"),n.domElement.classList.add("piano-roll-dialog"),n.closeButton=document.createElement("button"),n.closeButton.classList.add("window-close-button"),n.domElement.appendChild(n.closeButton),n.closeButton.addEventListener("click",(function(){n.domElement.style.display="none"})),n.saveButton=document.createElement("button"),n.saveButton.textContent="Save",n.domElement.appendChild(n.saveButton),n.saveButton.addEventListener("click",(function(){n.onsave(n.note)})),n}return lt(e,t),e.prototype.show=function(e,n,o){var r;t.prototype.show.call(this,e,n,o),this.note=o,null===(r=this.domElement.parentElement)||void 0===r||r.appendChild(this.domElement)},e}(st)),ut=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),dt=function(t,e,n,o){this.grid=t,this.item=e,this.velocity=.8,this.label="",this.audio=null;var r,i=e;if(this.domElement=document.createElement("div"),this.domElement.classList.add("grid-item"),this.domElement.style.height="".concat(t.rowHeight,"px"),this.labelElement=document.createElement("div"),this.labelElement.classList.add("grid-item-label"),this.domElement.appendChild(this.labelElement),o){var a=document.createElement("div");a.classList.add("grid-item-image"),a.style.backgroundImage="url(".concat(a,")"),this.domElement.appendChild(a),this.domElement.classList.add("has-image")}i.velocity&&(this.velocity=i.velocity),i.note?(this.note=i.note,this.label=n||(r=this.note,"".concat(P[r%P.length]).concat(Math.floor(r/P.length))),this.labelElement.textContent=this.label):this.note=0,this.start=e.start,this.duration=e.duration,e.label&&(this.labelElement.textContent=e.label),console.log("GridItem",this),t.gridElement.appendChild(this.domElement)},pt=function(t){function e(e,n,o){void 0===e&&(e=88),void 0===n&&(n=100),void 0===o&&(o=20);var r=this,i=document.createElement("div");(r=t.call(this,i)||this).rowCount=e,r.beatWidth=n,r.rowHeight=o,r._currentItem=null,r._dragMode=null,r._dragOffset=0,r._sequence=null,r.quantize=.25,r.drawingEnabled=!0,r.drawingLabel=void 0,r.drawingImage=void 0,r.scrollElement=i,r.domElement=document.createElement("div"),r.gridElement=i,r.domElement.classList.add("grid-container"),r.gridElement.classList.add("grid"),r.gridElement.addEventListener("dragstart",(function(t){t.preventDefault()})),r.previewCanvas=document.createElement("canvas"),r.previewCanvas.style.imageRendering="pixelated";var a=document.createElement("canvas");a.style.imageRendering="pixelated",a.width=4*r.beatWidth,a.height=r.rowHeight,console.log("debug",a.width,a.height);var s=a.getContext("2d");if(s){s.clearRect(0,0,a.width,a.height),s.lineWidth=1,s.strokeStyle="#444";for(var l=1;l<4;l++)s.beginPath(),s.moveTo(l*r.beatWidth,0),s.lineTo(l*r.beatWidth,r.rowHeight),s.stroke();s.strokeStyle="#999",s.beginPath(),s.moveTo(0,0),s.lineTo(0,r.rowHeight),s.stroke()}for(var c=0;c<e;c++){var u=document.createElement("div");u.classList.add("grid-row"),u.style.height="".concat(r.rowHeight,"px"),r.gridElement.appendChild(u);var d=a.toDataURL();u.style.backgroundImage="url(".concat(d,")"),u.style.backgroundRepeat="repeat"}return r.domElement.appendChild(r.gridElement),r.noteEditor=new ct((function(t){var e=r.noteEditor.domElement.querySelector(".lyric-editor-text");t.label=(null==e?void 0:e.value)||""})),document.body.appendChild(r.noteEditor.domElement),r.gridElement.addEventListener("pointerdown",(function(t){var e;if(!r._sequence)throw new Error("No track");if(!r._sequence.events)throw new Error("No events");if(r.drawingEnabled)if(t.preventDefault(),r._dragOffset=t.layerX,"block"!==r.noteEditor.domElement.style.display){if(t.target instanceof HTMLDivElement&&t.target.classList.contains("grid-item")){r.gridElement.classList.add("dragging");var n=r._sequence.events.find((function(e){return e.domElement===t.target}));(t.ctrlKey||1===t.button)&&(n?r.noteEditor.show(t.clientX+20,t.clientY-5,n):r.noteEditor.domElement.style.display="none"),n&&(r._currentItem=n,2===t.button?(r.remove(n),r._currentItem=null):(null===(e=n.domElement.parentElement)||void 0===e||e.appendChild(n.domElement),n.domElement.style.width=n.duration*r.beatWidth+"px",r._dragOffset<6?r._dragMode="start":n.domElement.offsetWidth-r._dragOffset<6?r._dragMode="end":r._dragMode="move"))}else{if(0!==t.button)return;if(t.target===r.gridElement){r.gridElement.classList.add("dragging");var o=Math.floor(t.layerY/r.rowHeight),i=(n=87-o,t.layerX/r.beatWidth);i=Math.round(i/r.quantize)*r.quantize,console.log("start",i,t.layerX);var a={row:o,note:n,start:i,velocity:100,duration:r.quantize,label:"",domElement:void 0};r._currentItem=r.add(a),r._currentItem.domElement.style.top="".concat((87-r._currentItem.note)*r.rowHeight,"px"),r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px"),r._dragMode="end",r.emit("select",r._currentItem)}}r.emit("update",r)}else r.noteEditor.domElement.style.display="none"})),r.gridElement.addEventListener("pointerup",(function(){r.gridElement.classList.remove("dragging"),r.emit("update",r),r.emit("release",r._currentItem),r._currentItem=null})),r.gridElement.addEventListener("pointerleave",(function(){r.gridElement.classList.remove("dragging"),r._currentItem&&(r._currentItem=null)})),r.gridElement.addEventListener("contextmenu",(function(t){t.preventDefault()})),r.gridElement.addEventListener("pointermove",(function(t){if(r._currentItem&&1===t.buttons){if("start"===r._dragMode){var e=Math.round(t.layerX/r.beatWidth/r.quantize)*r.quantize,n=r._currentItem.start;if(e>=r._currentItem.start+r._currentItem.duration)return;r._currentItem.start=e,r._currentItem.duration=n-r._currentItem.start+r._currentItem.duration,r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px"),r._currentItem.domElement.style.width="".concat(Math.max(r.quantize,r._currentItem.duration*r.beatWidth),"px")}else if("end"===r._dragMode)r._currentItem.duration=t.layerX/r.beatWidth-r._currentItem.start,r._currentItem.duration=Math.round(r._currentItem.duration/r.quantize)*r.quantize,r._currentItem.domElement.style.width="".concat(Math.max(r.quantize,r._currentItem.duration*r.beatWidth),"px");else{if("move"!==r._dragMode)return;r._currentItem.start=Math.max(0,t.layerX-r._dragOffset)/r.beatWidth,r._currentItem.start=Math.round(r._currentItem.start/r.quantize)*r.quantize,r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px")}r.emit("update",r)}})),r.gridElement.addEventListener("pointerup",(function(){r.gridElement.classList.remove("dragging"),r._currentItem&&(r._currentItem.domElement.style.pointerEvents="auto"),r._currentItem=null})),r}return ut(e,t),e.prototype.add=function(t){if(!this._sequence)throw new Error("add() No sequence loaded!");var e=new dt(this,t,this.drawingLabel,this.drawingImage);return this._sequence.events.push(e),t.domElement=e.domElement,this.emit("add",e),e},e.prototype.remove=function(t){if(!this._sequence)throw new Error("remove() No sequence loaded!");this._sequence.events.splice(this._sequence.events.indexOf(t),1),this.emit("remove",t),this.gridElement.removeChild(t.domElement)},e.prototype.load=function(t){var e,n;if(!t)throw new Error("load() No track!");console.log("Grid: load",t.events);for(var o=0,r=(null===(e=this._sequence)||void 0===e?void 0:e.events)||[];o<r.length;o++)null===(n=r[o].domElement)||void 0===n||n.remove();this._sequence=t;for(var i=0,a=t.events;i<a.length;i++){var s=a[i];this.gridElement.appendChild(s.domElement)}},e}(nt),ft=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),mt=function(t){function e(){var e=t.call(this,"div","piano-roll-keyboard")||this;return e.keys=[],e.noteHeight=20,e.redraw(),e.domElement.addEventListener("pointerdown",(function(t){t.preventDefault();var n=t.target;if(n.classList.contains("piano-roll-keyboard-key")){var o=e.keys.indexOf(n);console.log("key",n.textContent,o),n.classList.add("active"),e.emit("update",{type:"press",note:o});var r=function(){window.removeEventListener("pointerup",r),n.classList.remove("active"),e.emit("update",{type:"release",note:o})};window.addEventListener("pointerup",(function(){return r()}))}})),e}return ft(e,t),e.prototype.redraw=function(){this.domElement.innerHTML="";for(var t=87;t>=0;t--){var e=document.createElement("div");e.classList.add("piano-roll-keyboard-key"),e.style.height="".concat(this.noteHeight,"px"),e.style.backgroundColor="white"===x[t%12]?"#fff":"#000",e.style.color="white"===x[t%12]?"#000":"#fff",e.textContent=P[t%12]+(t/12|0).toString(),this.domElement.appendChild(e),this.keys.push(e)}this.keys.reverse()},e}(c),ht=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),vt=function(t){function e(e){var n=t.call(this)||this;return n.audioClock=e,n.cursorUpdateInterval=null,n.track=null,n.color="#7979ce",n.beatWidth=100,n.domElement=document.createElement("div"),n.domElement.classList.add("piano-roll"),n.sideKeyboard=new mt,n.domElement.appendChild(n.sideKeyboard.domElement),n.sideKeyboard.on("update",(function(t){var e=t;"press"==e.type?n.track.trigger(e.note):"release"==e.type&&n.track.release(e.note)})),n.grid=new pt,n.domElement.appendChild(n.grid.domElement),n.grid.on("select",(function(t){var e=t;n.track.trigger(e.note),n.track?tt.renderSequence(n.track.preview.canvas,n.track.events,n.color,n.beatWidth):console.warn("No track loaded!")})),n.grid.on("update",(function(){n.track&&tt.renderSequence(n.track.preview.canvas,n.track.events,n.color,n.beatWidth)})),n.grid.on("release",(function(t){t&&n.track.release(t.note)})),n.grid.linkElement(n.sideKeyboard.domElement),n.timeline=n.grid.domElement,n.cursor=new Y(n),n.cursor.domElement.classList.add("audio-cursor"),n.grid.domElement.appendChild(n.cursor.domElement),n.cursor.domElement.style.marginLeft=n.sideKeyboard.domElement.offsetWidth+"px",n.grid.scrollTop=1e3,n}return ht(e,t),e.prototype.load=function(t){t?(this.track=t,this.grid.load(t)):console.warn("No track provided!")},e}(e),yt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),gt=function(t){function e(e){var n=this,o=new vt(e.project.audioClock);return(n=t.call(this,{title:"Piano Roll",persistent:!0,content:o.domElement,width:900,height:400,left:100,top:100})||this).ui=e,n.pianoRoll=o,n}return yt(e,t),e.prototype.loadTrack=function(t){this.pianoRoll.load(t),this.setTitle("Piano Roll (".concat(t.name,")"))},e}(M),_t=function(){function t(t,e){var n=this;this.container=t,this.attachedElement=e,this._submenus=[],this.domElement=document.createElement("div"),this.domElement.classList.add("context-menu"),t&&t.appendChild(this.domElement),e&&(this.hide(),e.addEventListener("contextmenu",(function(t){t.preventDefault(),n.show(t.clientX+10,t.clientY-5)})))}return t.prototype._handlePointerDown=function(t){t.target===this.domElement||this.domElement.contains(t.target)||this.hide()},t.prototype.isVisible=function(){return"none"!==this.domElement.style.display},t.prototype.addItem=function(t,e){var n=this,o=document.createElement("div");return o.classList.add("context-menu-item"),o.textContent=t,o.addEventListener("click",(function(){e(),n.hide()})),this.domElement.appendChild(o),o},t.prototype.addSubmenu=function(t,e){var n=this,o=document.createElement("div");o.classList.add("context-menu-item"),o.textContent=t,o.addEventListener("click",(function(t){e.show(n.domElement.offsetLeft+n.domElement.offsetWidth-5,o.offsetTop),t.target.classList.contains("context-menu-item")&&n.hide()})),e.domElement.classList.add("context-menu-submenu"),this._submenus.push(e),o.appendChild(e.domElement),this.domElement.appendChild(o)},t.prototype.show=function(t,e){var n=this;this.container&&(this.domElement.style.left="".concat(t,"px"),this.domElement.style.top="".concat(e,"px"),this.domElement.style.display="block",document.addEventListener("pointerdown",(function(t){return n._handlePointerDown(t)})))},t.prototype.hide=function(){var t=this;if(this.isVisible()&&this.container){this.domElement.style.display="none";for(var e=0;e<this._submenus.length;e++)this._submenus[e].hide();document.removeEventListener("pointerdown",(function(e){return t._handlePointerDown(e)}))}},t}(),bt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Et=function(t){function e(e,n){var o=t.call(this,e,"div","playlist-source-item")||this;return o.item=n,o.domElement.innerText=n.name,o}return bt(e,t),e}(q),wt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Ct=function(t){function e(e){var n=t.call(this,"div","playlist-track")||this;n._track=e;var o=document.createElement("div");o.classList.add("playlist-track-panel");var r=document.createElement("div");r.classList.add("playlist-track-label-and-buttons");var i=document.createElement("div");return i.textContent=e.name,n.muteSoloButtons=new z,n.muteSoloButtons.on("change",(function(){n._track.mute=n.muteSoloButtons.mute,n._track.solo=n.muteSoloButtons.solo})),r.appendChild(i),r.appendChild(n.muteSoloButtons.domElement),o.appendChild(r),n.domElement.appendChild(o),n}return wt(e,t),Object.defineProperty(e.prototype,"mute",{get:function(){return this._track.mute},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this._track.solo},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selected",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._track.name},enumerable:!1,configurable:!0}),e.prototype.trigger=function(t,e){console.log("Trigger",t,e)},e.prototype.release=function(t){console.log("Release",t)},e}(c),Ot=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),kt=function(t){function e(e){var n=t.call(this)||this;return n.project=e,n.beatWidth=20,n._items=new Map,n.domElement=document.createElement("div"),n.domElement.classList.add("playlist"),n._trackPanels=document.createElement("div"),n._trackPanels.classList.add("playlist-tracks"),n.domElement.appendChild(n._trackPanels),n.grid=new pt(16,n.beatWidth,60),n.grid.on("add",(function(t){var e=t,o=t;n.project.playlist.events.includes(o)||n.project.playlist.events.push(o),n._items.set(e,o),n.emit("update"),console.log("Added event",t)})),n.grid.on("remove",(function(t){var e=t;if(n._items.has(e)){var o=t,r=n.project.playlist.events.indexOf(o);r>=0&&(n.project.playlist.events.splice(r,1),console.log("Removed event",t)),n._items.delete(e)}n.emit("update")})),n.grid.quantize=1,n.domElement.appendChild(n.grid.domElement),n.grid.linkElement(n._trackPanels),n.grid.load(n.project.playlist),n.timeline=n.grid.domElement,n.cursor=new Y(n),n.cursor.domElement.classList.add("audio-cursor"),n.grid.domElement.appendChild(n.cursor.domElement),n.cursor.domElement.style.marginLeft=n._trackPanels.offsetWidth+"px",n.grid.scrollTop=0,n}return Ot(e,t),Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.project.audioClock},enumerable:!1,configurable:!0}),e.prototype.loadProject=function(t){for(var e=0,n=0,o=t.tracks;n<o.length;n++){var r=o[n],i=new Ct(r);this._trackPanels.appendChild(i.domElement),e++}for(;e<16;e++)r={name:"Track ".concat(e+1),mute:!1,solo:!1,selected:!1},i=new Ct(r),t.tracks.push(r),this._trackPanels.appendChild(i.domElement)},e}(e),xt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Pt=function(t){function e(e){var n=this,o=document.createElement("div");o.classList.add("playlist-container"),(n=t.call(this,{title:"Playlist",persistent:!0,content:o,width:800,height:400})||this).ui=e,n.beatWidth=10,n.playlist=new kt(n.ui.project);var r=document.createElement("div");r.classList.add("playlist-source-container"),n.bucket=new D,n.bucket.domElement.classList.add("playlist-source-bucket"),n.refresh();var i=new _t(document.body);i.addItem("Import Audio",(function(){var t=document.createElement("input");t.type="file",t.accept="audio/*",t.addEventListener("change",(function(){var e,n=null===(e=t.files)||void 0===e?void 0:e[0];n&&console.log("Importing audio file",n)})),t.click()})),i.addItem("Generate (Stable Audio)",(function(){console.log("Add Audio")})),i.addItem("Generate (MusicGen)",(function(){console.log("Add Audio")}));var a=document.createElement("button");return a.classList.add("bucket-add-button"),a.textContent="+",a.addEventListener("click",(function(t){i.show(t.clientX,t.clientY)})),r.appendChild(n.bucket.domElement),r.appendChild(a),o.appendChild(r),o.appendChild(n.playlist.domElement),n}return xt(e,t),Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.ui.project.audioClock},enumerable:!1,configurable:!0}),e.prototype.refresh=function(){this.bucket.clear();for(var t=0,e=this.ui.project.patterns;t<e.length;t++){var n=e[t],o=new Et(this.bucket,n);this.bucket.addSelectable(o)}this.bucket.items.length>0?(this.bucket.items[0].selected=!0,this.playlist.grid.drawingEnabled=!0,this.playlist.grid.drawingLabel=this.bucket.items[0].item.name,this.playlist.grid.drawingImage=this.bucket.items[0].item.name):this.playlist.grid.drawingEnabled=!1},e.prototype.loadProject=function(t){this.playlist.loadProject(t)},e}(M),jt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Lt=function(t){function e(e){var n=t.call(this,"div","project-ui")||this;n.project=e,n.container=new E,n.domElement.appendChild(n.container.domElement),n.pianoRollWindow=new gt(n),n.container.addWindow(n.pianoRollWindow);var o=new $(n);n.container.addWindow(o),o.show(35,100);var r=new Pt(n);n.container.addWindow(r),r.show(1e3,50),n.mixerWindow=new X(n),n.container.addWindow(n.mixerWindow),n.mixerWindow.show(1e3,470);var i=new T;return n.domElement.appendChild(i.domElement),i.on("update",(function(t){var e=t;console.log("Keyboard",t),"press"===e.type?o.trigger(e.note):"release"===e.type&&o.release(e.note)})),n.project.on("update",(function(t){if(console.log("ProjectUI project update",t),!(t instanceof Object))throw new Error("Invalid event");if(!("type"in t))throw new Error("Invalid event");var e=t;if("project"===e.type){var i=e.value;console.log("Project",i),o.loadProject(i),r.loadProject(i);for(var a=0,s=i.instruments;a<s.length;a++){var l=s[a];n.container.addWindow(l.window)}}})),n}return jt(e,t),Object.defineProperty(e.prototype,"audioContext",{get:function(){return this.project.audioClock.audioContext},enumerable:!1,configurable:!0}),e.prototype.loadProject=function(t){this.project.load(t)},e}(c),Bt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Tt=function(t){function e(e,n,o){void 0===o&&(o=0);var r=t.call(this,e,n)||this;return r.transpose=24,r.output=e.audioContext.createGain(),r.output.connect(n.channels[o].gainNode),r}return Bt(e,t),e}(d),St=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),At=function(t){function e(e,n,o,r,i,a){void 0===r&&(r=1),void 0===i&&(i=.25),void 0===a&&(a="-");var s=t.call(this,"div","draggable-number")||this;return s._hideZero=a,s._value=e,s._step=r,s.domElement.addEventListener("pointerdown",(function(t){t.preventDefault();var e=t.clientY,r=s.value,a=function(t){var a=s.value,l=Math.round(-(t.clientY-e)*i),c=r+l*s._step;s.value=Math.max(n,Math.min(o,c)),a!==s.value&&s.emit("change",s.value)},l=function(){document.removeEventListener("pointermove",a),document.removeEventListener("pointerup",l)};document.addEventListener("pointermove",a),document.addEventListener("pointerup",l)})),s.value=e||0,s}return St(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this._value},set:function(t){this._value=t,0===t&&null!==this._hideZero?this.domElement.textContent=this._hideZero:this.domElement.textContent=t.toString()},enumerable:!1,configurable:!0}),e}(c),It=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Mt=function(t){function e(e,n){var o=t.call(this,e)||this;o.options=e,o.instrument=n;var r=new At(e.mixerChannel,0,16);return r.on("change",(function(t){o.mixerChannel=t,console.assert(n.mixer,"instrument.mixer is undefined!"),n.output.disconnect(),n.output.connect(n.mixer.channels[o.mixerChannel].gainNode)})),o._settingsBar=document.createElement("div"),o._settingsBar.classList.add("window-settings-bar"),o._settingsBar.appendChild(r.domElement),o.domElement.insertBefore(o._settingsBar,o.content),o}return It(e,t),Object.defineProperty(e.prototype,"mixerChannel",{get:function(){return this.options.mixerChannel},set:function(t){this.options.mixerChannel=t},enumerable:!1,configurable:!0}),e}(M),Wt=function(){function t(t){this.audioClock=t,this._settings=null,this._note=null,this._frequency=null,this._gain=t.audioContext.createGain()}return Object.defineProperty(t.prototype,"settings",{get:function(){if(!this.settings)throw new Error("Voice not initialized");return this.settings},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gain",{get:function(){return this._gain.gain.value},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"note",{get:function(){return this._note},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lfoNumber",{get:function(){return this.settings.lfoNumber},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"envelopeNumber",{get:function(){return this.settings.envelopeNumber},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frequency",{get:function(){return this._frequency},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"detune",{get:function(){return this.settings.detune},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"oscillators",{get:function(){return this.settings.oscillators},enumerable:!1,configurable:!0}),t.prototype.loadSettings=function(t){this._settings=t,this._gain.gain.value=t.gain},t.prototype.trigger=function(t,e,n){if(void 0===n&&(n=0),!this.settings)throw new Error("Voice not initialized");this._note=t,this._frequency=440*Math.pow(2,(t-69)/12),this._gain.gain.value=this.settings.gain*e},t.prototype.release=function(t){if(void 0===t&&(t=0),!this.settings)throw new Error("Voice not initialized");this._note=null,this._frequency=null},t}(),Dt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Rt=function(t){function e(e){var n=t.call(this,"div","control")||this;return n.settings=e,n._label=document.createElement("span"),n._label.classList.add("label"),n._label.textContent=e.label,n.domElement.appendChild(n._label),n}return Dt(e,t),e}(c),qt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Gt=function(){return Gt=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},Gt.apply(this,arguments)},zt=function(t){function e(e){var n=t.call(this,Gt(Gt({},e),{controlType:"slider"}))||this;return n._range=document.createElement("input"),n._range.type="range",n._range.min=e.min.toString(),n._range.max=e.max.toString(),n._range.step=e.step.toString(),n._range.value=e.value.toString(),n._range.addEventListener("input",(function(){n.settings.value=parseFloat(n._range.value),n.emit("change",n)})),n._range.addEventListener("change",(function(){n._range.blur()})),n.domElement.appendChild(n._range),n}return qt(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.settings.value},set:function(t){this.settings.value=t,this._range.value=t.toString()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"element",{get:function(){return this._range},enumerable:!1,configurable:!0}),e}(Rt),Nt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Ht=function(t){function e(e){void 0===e&&(e={attack:.003,hold:0,decay:2,sustain:.01,release:.05});var n=t.call(this,"div","envelope")||this;return n.settings=e,n.attack=new zt({controlType:"slider",name:"attack",label:"A",min:0,max:1,step:.01,value:e.attack,default:e.attack}),n.hold=new zt({controlType:"slider",name:"hold",label:"H",min:0,max:1,step:.01,value:e.hold,default:e.hold}),n.decay=new zt({controlType:"slider",name:"decay",label:"D",min:0,max:1,step:.01,value:e.decay,default:e.decay}),n.sustain=new zt({controlType:"slider",name:"sustain",label:"S",min:0,max:1,step:.01,value:e.sustain,default:e.sustain}),n.release=new zt({controlType:"slider",name:"release",label:"R",min:0,max:1,step:.01,value:e.release,default:e.release}),n.domElement.appendChild(n.attack.domElement),n.domElement.appendChild(n.decay.domElement),n.domElement.appendChild(n.sustain.domElement),n.domElement.appendChild(n.release.domElement),n}return Nt(e,t),e.prototype.trigger=function(t,e){console.log("trigger @ "+e);var n=t.value;t.cancelScheduledValues(e),t.setValueAtTime(n,e),t.exponentialRampToValueAtTime(.015,e),t.linearRampToValueAtTime(1,e+this.settings.attack),t.exponentialRampToValueAtTime(this.settings.sustain,e+this.settings.attack+this.settings.decay)},e.prototype.triggerRelease=function(t,e){console.log("triggerRelease @ "+e),t.setValueAtTime(t.value,e),t.setTargetAtTime(1e-4,e+.01,this.settings.release),t.cancelScheduledValues(e+.01+this.settings.release)},e}(c),Vt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Xt=function(){return Xt=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},Xt.apply(this,arguments)},Yt=function(t){function e(e){var n=t.call(this,Xt(Xt({},e),{controlType:"knob"}))||this;n.settings=e,n._value=0,n.sensitivity=.25,n.domElement.classList.add("knob");var o=document.createElement("div");return o.classList.add("knob-indicator"),n.sensitivity=.01*(e.max-e.min/e.step),n._handle=document.createElement("div"),n._handle.appendChild(o),n._handle.classList.add("knob-handle"),n._handle.addEventListener("pointerdown",n._onPointerDown.bind(n)),n.domElement.insertBefore(n._handle,n._label),n._setValue(e.value),n}return Vt(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!1,configurable:!0}),e.prototype._onPointerDown=function(t){var e=this;t.preventDefault(),t.stopPropagation();var n=this._value,o=(t.clientX,t.clientY),r=function(t){t.preventDefault(),t.stopPropagation();var r=-(t.clientY-o),i=t.ctrlKey?.01*e.settings.step:1,a=n+r*e.sensitivity*i;return a-=a%i,e._setValue(a),e.emit("change",e._value),!1},i=function(t){return t.preventDefault(),t.stopPropagation(),window.removeEventListener("pointermove",r),window.removeEventListener("pointerup",i),e._handle.releasePointerCapture(t.pointerId),e._handle.classList.remove("active"),!1};return window.addEventListener("pointermove",r),window.addEventListener("pointerup",i),this.emit("change",this._value),this._handle.classList.add("active"),!1},e.prototype._setValue=function(t){this._value=Math.min(this.settings.max,Math.max(this.settings.min,t)),this._handle.style.transform="rotate(".concat(280*this._value/(this.settings.max-this.settings.min)-50,"deg)")},e}(Rt),Ft=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();!function(t){function e(e){var n=t.call(this,e)||this;return n.audioClock=e,n}Ft(e,t),e.prototype.trigger=function(t,e,n){console.log("FMBassVoice triggered",t,e,n)},e.prototype.release=function(t){console.log("FMBassVoice released",t)}}(Wt);var Kt=function(t){function e(e,n,o){void 0===o&&(o=0);var r=t.call(this,e,n)||this;r.audioClock=e,r.name="FM Bass",r.id="fm_bass",r.version="0.0.1",r.description="A simple FM bass synthesizer",r.author="Johnny Street",r.controllerGroups=[],r.fmRatio=1,r.window=new Mt({title:"FM Bass",persistent:!0,content:r.domElement,mixerChannel:o},r);var i=r.audioClock.audioContext;r.modulatorGain=i.createGain(),r.modulatorGain.gain.value=100,r.gain=i.createGain(),r.gain.gain.value=0;var a=i.createBiquadFilter();a.type="highpass",a.frequency.value=20,r.gain.connect(a),a.connect(r.output),r.output.gain.value=.5,r.filter=i.createBiquadFilter(),r.filter.type="lowpass",r.filter.frequency.value=440,r.filter.Q.value=1,r.filter.connect(r.gain),r.filterEnvelope=new Ht,r.gainEnvelope=new Ht;var s=new Yt({controlType:"knob",name:"FM Gain",label:"FM Gain",min:0,max:300,step:1,default:100,value:100});r.window.content.appendChild(s.domElement),s.on("change",(function(){console.log("FM Gain",s.value),r.modulatorGain.gain.value=s.value}));var l=new Yt({controlType:"knob",name:"FM Ratio",label:"FM Ratio",min:0,max:12,step:1,default:r.fmRatio,value:r.fmRatio});return l.on("change",(function(){console.log("FM Ratio",l.value),r.fmRatio=l.value})),r.window.content.appendChild(l.domElement),r}return Ft(e,t),e.prototype.trigger=function(t,e,n){var o,r;if(void 0===n&&(n=1),console.log("FM Bass triggered",e),this._heldNote=t,t+=this.transpose,"running"===(null===(o=this._carrier)||void 0===o?void 0:o.context.state)){var i=this.gain.gain.value;this.gain.gain.cancelScheduledValues(e),this.gain.gain.setValueAtTime(i,e),this.gain.gain.setTargetAtTime(.01,e,.01);try{this._carrier.stop(e+.02),null===(r=this._modulator)||void 0===r||r.stop(e+.02)}catch(t){console.error("Error stopping carrier/modulator",t)}}this._carrier=this.audioClock.audioContext.createOscillator(),this._carrier.frequency.value=220,this._modulator=this.audioClock.audioContext.createOscillator(),this._modulator.frequency.value=220,this._carrier.connect(this.gain),this._modulator.connect(this.modulatorGain),this.modulatorGain.connect(this._carrier.frequency),this._carrier.type="sine",this._carrier.start(e),this._modulator.start(e);var a=function(t){return 440*Math.pow(2,(t-69)/12)}(t),s=e||this.audioClock.currentTime;this.gainEnvelope.trigger(this.gain.gain,s);var l=this._carrier.frequency.value;s+=.001,this._carrier.frequency.cancelScheduledValues(s),this._modulator.frequency.cancelScheduledValues(s),this._carrier.frequency.setValueAtTime(l,s),this._modulator.frequency.setValueAtTime(l*this.fmRatio,s),this._carrier.frequency.setTargetAtTime(a,s,.001),this._modulator.frequency.setTargetAtTime(a*this.fmRatio,s,.001)},e.prototype.release=function(t,e){if(this._heldNote===t){console.log("FM Bass released",t);var n=e||this.audioClock.currentTime;this.filterEnvelope.triggerRelease(this.filter.frequency,n),this.gainEnvelope.triggerRelease(this.gain.gain,n)}},e}(Tt),Ut=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Jt=function(t){function e(e,n,o,r,i,a){void 0===o&&(o=""),void 0===r&&(r=null),void 0===i&&(i=-1),void 0===a&&(a=[]);var s=t.call(this,"div","sampler-slot")||this;return s.audioClock=e,s.output=n,s.name=o,s.keyBinding=r,s.cutGroup=i,s.cutByGroups=a,s.controllerGroups=[],s.buffer=null,s._sources=[],s.name=o,s.buffer=null,s.keyBinding=r||null,s.velocity=1,s.pan=1,s.pitch=1,s.randomPitch=0,s.randomVelocity=.05,s.startPosition=0,s.endPosition=0,s.loop=!1,s.loopStart=0,s.loopEnd=0,s.cutGroup=i,s.cutByGroups=a,s._previewCanvas=new ot(200,60),s.domElement.appendChild(s._previewCanvas.domElement),s._nameElement=document.createElement("div"),s._nameElement.classList.add("sampler-slot-name"),s.domElement.appendChild(s._nameElement),s.domElement.addEventListener("pointerdown",(function(){return s.trigger()})),s}return Ut(e,t),e.prototype.loadSample=function(t,e){return n=this,o=void 0,i=function(){var n,o=this;return function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,o=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}(this,(function(r){switch(r.label){case 0:return this._nameElement.textContent="(Loading)",[4,fetch(e)];case 1:return(n=r.sent()).ok?(n.arrayBuffer().then((function(t){return o.audioClock.audioContext.decodeAudioData(t)})).then((function(e){o._nameElement.textContent=t,o.buffer=e,o.emit("update"),setTimeout((function(){o._previewCanvas.loadBuffer(e)}),1)})).catch((function(t){o._nameElement.textContent="(Empty)",console.error("Error loading sample: ".concat(e),t)})),[2]):(this._nameElement.textContent="(Empty)",console.error("Error loading sample: ".concat(e),n.statusText),[2])}}))},new((r=void 0)||(r=Promise))((function(t,e){function a(t){try{l(i.next(t))}catch(t){e(t)}}function s(t){try{l(i.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(a,s)}l((i=i.apply(n,o||[])).next())}));var n,o,r,i},e.prototype.trigger=function(t){var e=this;if(void 0===t&&(t=0),this.buffer){var n=this.audioClock.audioContext,o=n.createBufferSource();o.buffer=this.buffer,o.playbackRate.value=this.pitch+Math.random()*this.randomPitch;var r=n.createGain();if(r.gain.value=this.velocity+Math.random()*this.randomVelocity,r.connect(this.output),o.connect(r),1!==this.pan){var i=n.createStereoPanner();i.pan.value=this.pan,o.connect(i),i.connect(r)}var a=(this.audioClock.startTime||n.currentTime)+60*t/this.audioClock.bpm,s={source:o,gain:r,cutByGroups:this.cutByGroups,time:a};return this._sources.push(s),o.onended=function(){o.disconnect(),r.disconnect();var t=e._sources.indexOf(s);t>=0&&e._sources.splice(t,1)},console.log(t,n.currentTime,a),this.startPosition>=0?o.start(a,this.startPosition,(this.endPosition||this.buffer.duration)-this.startPosition):o.start(a),0!==a&&this.audioClock.isPlaying?this.audioClock.scheduleEventAtTime((function(){return F(e.domElement)}),a):F(this.domElement),this.loop&&(o.loop=!0,o.loopStart=this.loopStart,o.loopEnd=this.loopEnd||this.buffer.duration),s}console.error("No buffer loaded for sample",this.name)},e.prototype.release=function(t){for(var e=0,n=this._sources;e<n.length;e++){var o=n[e];t>=o.time&&this.cut(o,t)}},e.prototype.cut=function(t,e){void 0===e&&(e=0);var n=t.gain.gain.value;t.gain.gain.cancelScheduledValues(e),t.gain.gain.setValueAtTime(n,e),t.gain.gain.exponentialRampToValueAtTime(1e-4,e+.1),t.source.stop(e+.1)},e}(c),Zt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Qt=function(t){function e(e,n,o){void 0===o&&(o=0);var r=t.call(this,e,n,o)||this;r.audioClock=e,r.name="Sampler",r.version="0.0.1",r.description="A simple sampler",r.author="Johnny Street",r.id="sampler",r.slots=[],r.controllerGroups=[],r.output=r.audioClock.audioContext.createGain(),window.addEventListener("keydown",(function(t){return r.onKeyDown(t)}));var i=document.createElement("div");i.classList.add("sampler-slots-container"),r._slotsContainer=i;for(var a=[{keyBinding:96,name:"0"},{keyBinding:97,name:"1"},{keyBinding:98,name:"2"},{keyBinding:99,name:"3"},{keyBinding:100,name:"4"},{keyBinding:101,name:"5"},{keyBinding:102,name:"6",cutByGroups:[3,6]},{keyBinding:103,name:"7"},{keyBinding:104,name:"8"},{keyBinding:105,name:"9"},{keyBinding:111,name:"/",cutByGroups:[0,10]},{keyBinding:106,name:"*"},{keyBinding:109,name:"-"},{keyBinding:107,name:"+"},{keyBinding:13,name:"Enter"}],s=0;s<14;s++){var l=new Jt(r.audioClock,r.output,a[s].name,a[s].keyBinding,s,a[s].cutByGroups);r.slots.push(l),i.appendChild(l.domElement),l.loadSample("Sample","./data/samples/kit1/".concat(s,".wav"))}return e.on("stop",(function(){for(var t=0,e=r.slots;t<e.length;t++)e[t].release(0)})),r.domElement.appendChild(i),r.window=new Mt({title:"Sampler",persistent:!0,content:r.domElement,mixerChannel:o},r),r}return Zt(e,t),e.prototype.trigger=function(t,e,n){void 0===n&&(n=0),console.log("Sampler trigger",t);var o=this.slots[t];if(o){for(var r=0,i=this.slots;r<i.length;r++){var a=i[r];a.cutByGroups.includes(o.cutGroup)&&a.release(n)}return o.trigger(n)}},e.prototype.release=function(t,e){void 0===e&&(e=0),this.slots[t]&&this.slots[t].release(e)},e.prototype.onKeyDown=function(t){var e=this.slots.find((function(e){return e.keyBinding===t.keyCode}));if(e){t.preventDefault();var n=this.slots.indexOf(e);this.trigger(n,null)}},e}(Tt);p.register("sampler",Qt),p.register("fm_bass",Kt);var $t=document.createElement("div");$t.classList.add("studio");var te=new s,ee=new Lt(new y(te,{title:"Basic",description:"Basic project template with Sampler and Synthesizer",tempo:120,instruments:[{name:"Sampler",id:"sampler",controllerGroups:[]},{name:"FM Bass",id:"fm_bass",controllerGroups:[]}],patterns:[{name:"Pattern 1",tracks:[{events:[]},{events:[]}]}],tracks:[],playlist:{events:[]},mixer:{channels:[{label:"Master",gain:1,mute:!1,solo:!1,outputs:[],effects:[]},{label:"Drums",gain:1,mute:!1,solo:!1,outputs:[0],effects:[]},{label:"Bass",gain:1,mute:!1,solo:!1,outputs:[0],effects:[]}]}}));$t.appendChild(te.domElement),$t.appendChild(ee.domElement),document.body.appendChild($t),monofy=t})();
//# sourceMappingURL=monofy-studio.js.map