var monofy;(()=>{"use strict";var t={};(t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})})(t);const e=function(){function t(){this._events={},this._onceEvents={}}return t.prototype.on=function(t,e){return this._events[t]||(this._events[t]=[]),this._events[t].push(e),this},t.prototype.once=function(t,e){return this._onceEvents[t]||(this._onceEvents[t]=[]),this._onceEvents[t].push(e),this},t.prototype.emit=function(t,e){var n=this._onceEvents[t];if(n){for(var o=0,r=n;o<r.length;o++){var i=r[o];try{i(e)}catch(e){console.error("Error executing .once callback for event: ".concat(t),e)}}this._onceEvents[t]=void 0}var a=this._events[t];if(a)for(var c=0,l=a;c<l.length;c++){i=l[c];try{i(e)}catch(e){console.error("Error executing .on callback for event: ".concat(t),e)}}},t}();var n=null,o=window.AudioContext||window.webkitAudioContext;function r(){return n||(n=new o({latencyHint:"interactive",sampleRate:44100}),function(){return t=this,e=void 0,r=function(){return function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(l){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){a.label=c[1];break}if(6===c[0]&&a.label<r[1]){a.label=r[1],r=c;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(c);break}r[2]&&a.ops.pop(),a.trys.pop();continue}c=e.call(t,a)}catch(t){c=[6,t],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,l])}}}(this,(function(t){switch(t.label){case 0:return"setSinkId"in o.prototype?[4,navigator.mediaDevices.enumerateDevices()]:[3,2];case 1:return[2,t.sent()];case 2:return[2,null]}}))},new((n=void 0)||(n=Promise))((function(o,i){function a(t){try{l(r.next(t))}catch(t){i(t)}}function c(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,c)}l((r=r.apply(t,e||[])).next())}));var t,e,n,r}().then((function(t){console.log("Audio devices",t)})),console.log("Audio context created"),n)}var i,a=(i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},i(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),c=function(t){function e(){var e=t.call(this)||this;return e._playbackMode="pattern",e._audioContext=null,e._bpm=100,e._scheduledEvents=[],e._startTime=null,e.domElement=document.createElement("div"),e.domElement.classList.add("audio-clock"),e.playPauseButton=document.createElement("button"),e.playPauseButton.classList.add("audio-clock-play-pause"),e.playPauseButton.textContent="Play",e.playPauseButton.addEventListener("click",(function(){e.isPlaying?e.stop():(r(),e.playPause())})),e.domElement.appendChild(e.playPauseButton),e.stopButton=document.createElement("button"),e.stopButton.classList.add("audio-clock-stop"),e.stopButton.textContent="Stop",e.stopButton.addEventListener("click",(function(){e.stop()})),e.domElement.appendChild(e.stopButton),e.bpmInput=document.createElement("input"),e.bpmInput.classList.add("audio-clock-bpm"),e.bpmInput.type="number",e.bpmInput.value="120",e.bpmInput.addEventListener("input",(function(){e._bpm=parseFloat(e.bpmInput.value)})),e.domElement.appendChild(e.bpmInput),e.currentTimeDisplay=document.createElement("span"),e.currentTimeDisplay.classList.add("audio-clock-time"),e.currentTimeDisplay.textContent="01:1",e.domElement.appendChild(e.currentTimeDisplay),e}return a(e,t),Object.defineProperty(e.prototype,"startTime",{get:function(){return this._startTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return this.audioContext.currentTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audioContext",{get:function(){return this._audioContext||(this._audioContext=r()),this._audioContext},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentBeat",{get:function(){return(null!==this._startTime?this.audioContext.currentTime-this._startTime:0)*(this._bpm/60)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isPlaying",{get:function(){return null!=this._startTime&&this._startTime>=0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bpm",{get:function(){return this._bpm},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"playbackMode",{get:function(){return this._playbackMode},enumerable:!1,configurable:!0}),e.prototype.start=function(){this._startTime=this.audioContext.currentTime,console.log("Started at",this._startTime),requestAnimationFrame(this._render.bind(this)),this.emit("start")},e.prototype._render=function(){this._update(this.currentBeat),this.emit("update"),this.isPlaying&&requestAnimationFrame(this._render.bind(this))},e.prototype.stop=function(){this.emit("stop"),this._startTime=null;for(var t=0,e=this._scheduledEvents;t<e.length;t++){var n=e[t].source;n.stop(),n.disconnect()}this._scheduledEvents=[],this._update(this.currentBeat),this.playPauseButton.textContent="Play"},e.prototype.restart=function(){this.isPlaying&&(this._startTime=this.audioContext.currentTime)},e.prototype.playPause=function(){if(this.isPlaying)this.stop();else{var t=this.audioContext.createBuffer(1,1,this.audioContext.sampleRate),e=this.audioContext.createBufferSource();e.buffer=t,e.connect(this.audioContext.destination),e.start(),this.start()}this.playPauseButton.textContent=this.isPlaying?"Pause":"Play"},e.prototype._update=function(t){var e=Math.floor(t/4)+1,n=Math.floor(t%4)+1,o="".concat(e.toString().padStart(2,"0"),":").concat(n.toString());this.currentTimeDisplay.textContent=o},e.prototype.scheduleEventAtTime=function(t,e){var n=this.audioContext.createBuffer(1,1,this.audioContext.sampleRate),o=this.audioContext.createBufferSource();o.buffer=n,o.connect(this.audioContext.destination),o.onended=function(){return t()},o.start(e),this._scheduledEvents.push({source:o,time:e,callback:t})},e.prototype.scheduleEventAtBeat=function(t,e){var n=this._startTime+e/this._bpm*60;this.scheduleEventAtTime(t,n)},e}(e),l=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),s=function(t){function e(e,n){var o=t.call(this)||this;return o.domElement=document.createElement(e),n&&o.domElement.classList.add(n),o}return l(e,t),e.prototype.appendChild=function(t){return this.domElement.appendChild(t.domElement),this},e.prototype.removeChild=function(t){return this.domElement.removeChild(t.domElement),this},e}(e),u=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),d=function(t){function e(e){var n=t.call(this,"div","plugin-container")||this;return n.audioClock=e,n}return u(e,t),e}(s),p=function(){function t(){}return t.register=function(t,e){this._plugins[t]?console.warn("Plugin already registered:",e):this._plugins[t]=e},t.get=function(t){return this._plugins[t]},t.instantiate=function(t,e){return new(this.get(t))(e)},t._plugins={},t}(),f=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),h=function(t){function e(e,n){var o=t.call(this)||this;return o.audioClock=e,o.title="Untitled",o.description="",o.tempo=120,o.instruments=[],o.patterns=[],o.tracks=[],o.playlist={events:[]},n&&setTimeout((function(){o.load(n)}),0),e.on("start",(function(){console.log("DEBUG START",o.playlist);for(var t=0,e=o.playlist.events;t<e.length;t++){var n=e[t];console.log("DEBUG ITEM",n)}})),o}return f(e,t),e.prototype.serialize=function(){return JSON.stringify({title:this.title,description:this.description,tempo:this.tempo,instruments:this.instruments.map((function(t){return{name:t.name,controllerGroups:t.controllerGroups}})),patterns:this.patterns,timeline:this.playlist})},e.prototype.deserialize=function(t){console.log("Project deserialize",t);var e=JSON.parse(t);this.load(e)},e.prototype.load=function(t){console.log("Project load",t),this.title=t.title,this.description=t.description,this.tempo=t.tempo,this.patterns=t.patterns,this.playlist=t.playlist,this.instruments=[];for(var e=0,n=t.instruments;e<n.length;e++){var o=n[e];console.log("loading instrument",o),p.get(o.id);var r=p.instantiate(o.id,this.audioClock);this.instruments.push(r)}console.log("emitting update..."),this.emit("update",{type:"project",value:this})},e}(e),m=function(){function t(){this._activeWindow=null,this.windows=[],this._draggingWindow=null,this.domElement=document.createElement("div"),this.domElement.className="window-container"}return t.prototype.addWindow=function(t){var e=this;this.windows.includes(t)?console.warn("Window already added",t):(this.windows.push(t),this.domElement.appendChild(t.domElement),this._activeWindow||(this._activeWindow=t,this.activateWindow(t)),t.domElement.addEventListener("pointerdown",(function(){e.activateWindow(t)})),t.on("open",(function(){e.activateWindow(t)})),t.on("close",(function(){e._activeWindow===t&&(e._activeWindow=null)})))},t.prototype.activateWindow=function(t){if(this._activeWindow!==t){this._activeWindow=t;for(var e=0,n=this.windows;e<n.length;e++){var o=n[e];o.domElement.classList.toggle("active",o===t),o.domElement.style.zIndex=o===t?"1":"0"}}},t}(),y=[90,83,88,68,67,86,71,66,72,78,74,77,188,76,190,59,191],v=[81,50,87,51,69,82,53,84,54,89,55,85,73,57,79,48,80,219,61,221],g=["white","black","white","white","black","white","black","white","white","black","white","black"],_=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],b=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();function E(t){var e=-1;return y.includes(t)?e=y.indexOf(t):v.includes(t)&&(e=v.indexOf(t)+12),e}var w=function(t){function e(){var e=t.call(this,"div","keyboard")||this,n=[];return window.addEventListener("keydown",(function(t){if(!(t.ctrlKey||t.altKey||t.shiftKey)&&"INPUT"!=t.target.tagName){var o=E(t.keyCode);-1===o||n.includes(o)||(n.push(o),e.emit("update",{type:"press",note:o}))}})),window.addEventListener("keyup",(function(t){var o=E(t.keyCode);-1!==o&&n.includes(o)&&(n.splice(n.indexOf(o),1),e.emit("update",{type:"release",note:o}))})),e}return b(e,t),e}(s),k=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),C=function(t){function e(e,n){var o=t.call(this,e,n)||this;o._resizing=!1,o._startX=0,o._startY=0,o._startWidth=0,o._startHeight=0,o._startTop=0,o._startLeft=0,o._resizeDirection=null,o.domElement.addEventListener("pointermove",(function(t){var e=o.getCurrentHandle(t);o.domElement.style.cursor="top"===e||"bottom"===e?"ns-resize":"left"===e||"right"===e?"ew-resize":"auto"}));var r=function(t){if(o._resizing){console.log(o._resizeDirection);var e=t.clientX-o._startX,n=t.clientY-o._startY;"right"===o._resizeDirection?o.domElement.style.width="".concat(o._startWidth+e,"px"):"bottom"===o._resizeDirection?o.domElement.style.height="".concat(o._startHeight+n,"px"):"left"===o._resizeDirection?(o.domElement.style.width="".concat(o._startWidth-e,"px"),o.domElement.style.left="".concat(o._startLeft+e,"px")):"top"===o._resizeDirection&&(o.domElement.style.height="".concat(o._startHeight-n,"px"),o.domElement.style.top="".concat(o._startTop+n,"px")),o.emit("resize",{width:o.domElement.offsetWidth,height:o.domElement.offsetHeight})}};return o.domElement.addEventListener("pointerdown",(function(t){if(0===t.button){var e=o.getCurrentHandle(t);e&&(window.addEventListener("pointermove",r),o.startResize(t,e),t.preventDefault());var n=function(){o.stopResize(),window.removeEventListener("pointermove",r),window.removeEventListener("pointerup",n)};window.addEventListener("pointerup",n)}})),o}return k(e,t),e.prototype.startResize=function(t,e){console.log("startResize",e),this._resizing=!0,this._startX=t.clientX,this._startY=t.clientY,this._startWidth=this.domElement.offsetWidth,this._startHeight=this.domElement.offsetHeight,this._startTop=this.domElement.offsetTop,this._startLeft=this.domElement.offsetLeft,this._resizeDirection=e},e.prototype.stopResize=function(){this._resizing=!1,this._resizeDirection=null},e.prototype.getCurrentHandle=function(t){var e=this.domElement.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top;return n>0&&n<8?"left":e.width-n<8?"right":o>0&&o<8?"top":e.height-o<8?"bottom":null},e}(s),O=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),x=function(t){function e(e){var n=t.call(this,"div","draggable-window")||this;n._isDragging=!1,n._dragOffsetX=0,n._dragOffsetY=0,n._top=0,n._left=0,n.domElement.style.display="none",n._top=e.top||0,n._left=e.left||0,n.persistent=e.persistent||!1,n.titlebar=document.createElement("div"),n.titlebar.className="window-titlebar",n.domElement.appendChild(n.titlebar),n.titlebar.addEventListener("pointerdown",(function(t){n._isDragging=!0,n._dragOffsetX=t.clientX-n.domElement.getBoundingClientRect().left,n._dragOffsetY=t.clientY-n.domElement.getBoundingClientRect().top+n.domElement.parentElement.getBoundingClientRect().top+n.domElement.parentElement.scrollTop;var e=function(t){if(n._isDragging){console.log("Dragging");var e=t.clientY-n._dragOffsetY,o=t.clientX-n._dragOffsetX;e<0&&(e=0),o<0&&(o=0),n.domElement.style.top="".concat(e,"px"),n.domElement.style.left="".concat(o,"px"),n._top=e,n._left=o}},o=function(){n._isDragging=!1,document.body.removeEventListener("pointermove",e),document.body.removeEventListener("pointerup",o)};document.body.addEventListener("pointermove",e),document.body.addEventListener("pointerup",o)})),n._title=document.createElement("div"),n._title.className="window-titlebar-title",n._title.textContent=e.title,n.titlebar.appendChild(n._title),n.content=document.createElement("div"),n.content.className="window-content",n.domElement.appendChild(n.content),n._closeButton=document.createElement("button"),n._closeButton.className="window-close-button",n._closeButton.addEventListener("pointerdown",(function(t){0===t.button&&n.close()})),n.titlebar.appendChild(n._closeButton);var o=e.width||640,r=e.height||400;return n.setSize(o,r),e.content&&n.content.appendChild(e.content),n}return O(e,t),Object.defineProperty(e.prototype,"isVisible",{get:function(){return"none"!==this.domElement.style.display},enumerable:!1,configurable:!0}),e.prototype.show=function(t,e){var n=this;void 0===t&&(t=this._left),void 0===e&&(e=this._top),this._top=e,this._left=t,0===this._top&&0===this._left&&(t=window.innerWidth/2-200,e=window.innerHeight/4),this.domElement.style.display="flex",this.domElement.style.top="".concat(e,"px"),this.domElement.style.left="".concat(t,"px"),setTimeout((function(){var t;null===(t=n.domElement.parentElement)||void 0===t||t.appendChild(n.domElement),n.emit("open")}),1)},e.prototype.close=function(){this.domElement.style.display="none",this.emit("close"),this.persistent||(console.log("Removing window",this),this.domElement.remove())},e.prototype.setSize=function(t,e){this.domElement.style.width="".concat(t,"px"),this.domElement.style.height="".concat(e,"px")},e.prototype.setPosition=function(t,e){this.domElement.style.top="".concat(e,"px"),this.domElement.style.left="".concat(t,"px")},e.prototype.setTitle=function(t){this._title.textContent=t},e}(C),P=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),j=function(t){function e(e,n,o){var r=t.call(this,"div","mixer-channel")||this;r.gainNode=o,r._channel=e,r._label=document.createElement("span"),r._label.textContent=n,r.domElement.appendChild(r._label);var i=document.createElement("input");i.type="range",i.min="0",i.max="1.2",i.step="0.01",i.value="1";var a=document.createElement("input");a.type="checkbox";var c=document.createElement("input");return c.type="checkbox",r._volume=i,r._mute=a,r._solo=c,r.domElement.appendChild(i),r.domElement.appendChild(a),r.domElement.appendChild(c),i.addEventListener("input",(function(){r.emit("update")})),a.addEventListener("change",(function(){r.emit("update")})),c.addEventListener("change",(function(){r.emit("update")})),r}return P(e,t),Object.defineProperty(e.prototype,"channel",{get:function(){return this._channel},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume.valueAsNumber},set:function(t){this._volume.value=t.toString()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mute",{get:function(){return this._mute.checked},set:function(t){this._mute.checked=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this._solo.checked},set:function(t){this._solo.checked=t},enumerable:!1,configurable:!0}),e}(s),T=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),L=function(t){function e(e){var n=t.call(this,{title:"Mixer",persistent:!0,content:document.createElement("div"),width:500,height:300})||this;n.ui=e,n.domElement.classList.add("mixer-window");var o=document.createElement("div");o.style.display="flex",o.style.width="100%",o.style.height="100%",o.style.overflowX="auto";var r=e.audioContext,i=new j(0,"Master",r.createGain());i.gainNode.connect(r.destination),o.appendChild(i.domElement),n.content.appendChild(o);for(var a=1;a<=16;a++){var c=new j(a,"".concat(a),r.createGain());c.gainNode.connect(i.gainNode),o.appendChild(c.domElement)}return n}return T(e,t),e}(x),B=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),S=function(t){function e(e){void 0===e&&(e=[]);var n=t.call(this,"div","selectable-group")||this;n.items=e;for(var o=0,r=e;o<r.length;o++){var i=r[o];n.addSelectable(i,!1)}return n}return B(e,t),e.prototype.addSelectable=function(t,e){var n=this;void 0===e&&(e=!0),-1!==this.items.indexOf(t)?console.warn("Already added",t):(this.items.push(t),t.on("select",(function(){n.emit("select",n)})),e&&this.domElement.appendChild(t.domElement),t.domElement.addEventListener("pointerdown",(function(e){if(e.preventDefault(),e.ctrlKey||e.shiftKey){if(e.ctrlKey)t.selected=!t.selected;else if(e.shiftKey){var o=n.items.find((function(t){return t.selected}));if(!o)return void(t.selected=!0);for(var r=n.items.indexOf(o),i=n.items.indexOf(t),a=Math.min(r,i),c=Math.max(r,i),l=a;l<=c;l++)n.items[l].selected=!0}}else for(var s=0,u=n.items;s<u.length;s++){var d=u[s];d.selected=d===t}})))},e.prototype.removeSelectable=function(t){var e=this.items.indexOf(t);-1!==e&&(this.items.splice(e,1),this.domElement.removeChild(t.domElement))},e.prototype.clear=function(){for(var t=0,e=this.items;t<e.length;t++){var n=e[t];this.domElement.removeChild(n.domElement)}this.items.length=0},e}(s),A=function(){function t(t){var e=this;this.timeline=t,this.domElement=document.createElement("div"),this.domElement.classList.add("audio-cursor");var n=t.audioClock;n.on("update",(function(){e.update()})),n.on("start",(function(){var t;e.domElement.style.transform="translateX(0)",e.domElement.style.display="block",null===(t=e.domElement.parentElement)||void 0===t||t.appendChild(e.domElement)})),n.on("stop",(function(){e.domElement.style.display="none"}))}return t.prototype.update=function(){this.domElement.style.transform="translateX(".concat(this.timeline.audioClock.currentBeat*this.timeline.beatWidth,"px)")},t.prototype.hide=function(){this.domElement.style.display="none"},t}();function I(t){return e=this,n=arguments,r=function(t,e){return void 0===e&&(e=100),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(l){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){a.label=c[1];break}if(6===c[0]&&a.label<r[1]){a.label=r[1],r=c;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(c);break}r[2]&&a.ops.pop(),a.trys.pop();continue}c=e.call(t,a)}catch(t){c=[6,t],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,l])}}}(this,(function(n){return t.classList.toggle("active",!0),setTimeout((function(){t.classList.toggle("active",!1)}),e),[2]}))},new((o=void 0)||(o=Promise))((function(t,i){function a(t){try{l(r.next(t))}catch(t){i(t)}}function c(t){try{l(r.throw(t))}catch(t){i(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,c)}l((r=r.apply(e,n||[])).next())}));var e,n,o,r}var W=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),M=function(t){function e(e,n,o){var r=t.call(this,n,o)||this;return r.group=e,r.group.addSelectable(r),r}return W(e,t),Object.defineProperty(e.prototype,"selected",{get:function(){return this.domElement.classList.contains("selected")},set:function(t){t!==this.selected&&(this.domElement.classList.toggle("selected",t),this.emit("select",this))},enumerable:!1,configurable:!0}),e}(s),G=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),z=function(t){function e(e,n){var o=this;console.assert(e,"PatternTrackInstrument track is null or undefined"),(o=t.call(this,n,"div","pattern-track-instrument")||this).track=e,document.createElement("div"),o.domElement.classList.add("pattern-track-panel");var r=document.createElement("div");r.textContent=e.name;var i=document.createElement("div");i.classList.add("pattern-track-buttons");var a=document.createElement("div");a.classList.add("track-button"),a.classList.add("track-edit-button"),a.textContent="e",a.addEventListener("pointerdown",(function(){o.track.instrument.window.isVisible?o.track.instrument.window.close():e.instrument.window.show()})),o.track.instrument.window.on("close",(function(){a.classList.toggle("active",!1)})),o.track.instrument.window.on("open",(function(){a.classList.toggle("active",!0)})),i.appendChild(a);var c=document.createElement("div");c.classList.add("track-button"),c.classList.add("track-mute-button"),c.textContent="M",c.addEventListener("pointerdown",(function(){c.classList.toggle("active")})),i.appendChild(c);var l=document.createElement("div");return l.classList.add("track-button"),l.classList.add("track-solo-button"),l.textContent="S",l.addEventListener("pointerdown",(function(){l.classList.toggle("active")})),i.appendChild(l),i.appendChild(c),i.appendChild(l),o.indicator=document.createElement("div"),o.indicator.classList.add("pattern-track-indicator"),i.appendChild(o.indicator),o.domElement.appendChild(r),o.domElement.appendChild(i),o}return G(e,t),e}(M),R=function(t){function e(e,n){var o=this;return console.assert(e,"PatternTrackPreview track is null or undefined"),(o=t.call(this,n,"div","pattern-track-preview")||this).track=e,o._canvas=document.createElement("canvas"),o._canvas.height=60,o._canvas.width=1280,o._canvas.classList.add("pattern-track-pattern"),o.domElement.append(o._canvas),o}return G(e,t),Object.defineProperty(e.prototype,"canvas",{get:function(){return this._canvas},enumerable:!1,configurable:!0}),e}(M),q=function(t){function e(e,n,o,r,i){var a=t.call(this,"div","pattern-track")||this;return a.project=e,a.instrument=n,a.events=o,a.buttonGroup=r,a.previewGroup=i,a.port=null,a.channel=0,a.button=new z(a,a.buttonGroup),a.preview=new R(a,a.previewGroup),a.domElement.appendChild(a.button.domElement),a.domElement.appendChild(a.preview.domElement),a}return G(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this.instrument.name},enumerable:!1,configurable:!0}),e.prototype.trigger=function(t,e){var n=this;void 0===e&&(e=this.project.audioClock.currentBeat);var o=this.instrument.trigger(t,this.channel,e);return e>0?this.project.audioClock.scheduleEventAtBeat((function(){I(n.button.indicator)}),e):I(this.button.indicator),o},e.prototype.release=function(t,e){void 0===e&&(e=this.project.audioClock.currentBeat),this.instrument.release(t,e)},e.prototype.load=function(t){this.events=t.events},e.prototype.playback=function(){var t=this;if(this.project.audioClock.isPlaying){for(var e=void 0,n=function(t){if(!t.note&&0!==t.note)return console.warn("Missing note property in event object"),"continue";e=o.trigger(t.note,t.start),t.domElement&&(o.project.audioClock.scheduleEventAtBeat((function(){return t.domElement.classList.toggle("active",!0)}),t.start),o.project.audioClock.scheduleEventAtBeat((function(){return t.domElement.classList.toggle("active",!1)}),t.start+t.duration))},o=this,r=0,i=this.events;r<i.length;r++)n(i[r]);void 0!==e&&"source"in e&&(e.source.onended=function(){var e=t.project.audioClock.currentBeat+(4-t.project.audioClock.currentBeat%4);t.project.audioClock.scheduleEventAtBeat((function(){t.project.audioClock.restart(),t.playback()}),e)})}else console.warn("Playback cancelled")},e}(s),D=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),V=function(t){function e(e){var n=this,o=document.createElement("div");o.classList.add("pattern-track-container"),(n=t.call(this,{title:"Pattern",persistent:!0,content:o,width:400,height:400})||this).ui=e,n.tracks=[],n.beatWidth=20,n.trackContainer=o,n.timeline=n.trackContainer,n.cursor=new A(n),n.timeline.appendChild(n.cursor.domElement);var r=n.domElement.querySelector("canvas");return r&&(n.beatWidth=r.width/16),n.on("resize",(function(){n.beatWidth=n.domElement.clientWidth/16})),n.addPattern("Pattern 1"),n.patternPreviews=new S,n.buttons=new S,n}return D(e,t),Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.ui.project.audioClock},enumerable:!1,configurable:!0}),e.prototype.loadProject=function(t){for(var e,n=0,o=this.tracks;n<o.length;n++){var r=o[n];this.trackContainer.removeChild(r.domElement)}this.tracks.length=0;for(var i=0;i<t.instruments.length;i++)(r=this.addTrack(t.instruments[i],(null===(e=t.patterns[0])||void 0===e?void 0:e.tracks[i].events)||[])).load(t.patterns[0].tracks[i]),0===i&&(r.button.selected=!0)},e.prototype.addPattern=function(t){console.log("Created pattern:",t);var e={name:t,tracks:[]};this.ui.project.patterns.push(e)},e.prototype.addTrack=function(t,e){var n=this;console.log("Add track + instrument:",t);var o=new q(this.ui.project,t,e,this.buttons,this.patternPreviews);return console.assert(o.button instanceof z,"button is not an instance of PatternTrackInstrument"),console.assert(o.preview instanceof R,"preview is not an instance of PatternTrackPreview"),o.preview.domElement.addEventListener("pointerdown",(function(){n.ui.pianoRollWindow.loadTrack(o),n.ui.pianoRollWindow.show()})),this.tracks.push(o),this.trackContainer.appendChild(o.domElement),o},e.prototype.removeTrack=function(t){var e=this.tracks.indexOf(t);-1!==e&&(this.tracks.splice(e,1),this.trackContainer.removeChild(t.domElement),this.patternPreviews.removeSelectable(t.preview),this.buttons.removeSelectable(t.button))},e.prototype.trigger=function(t,e){void 0===e&&(e=this.audioClock.currentBeat);for(var n=0,o=this.tracks;n<o.length;n++){var r=o[n];r.button.selected&&r.trigger(t,e)}},e.prototype.release=function(t,e){void 0===e&&(e=this.audioClock.currentBeat);for(var n=0,o=this.tracks;n<o.length;n++){var r=o[n];r.button.selected&&r.release(t,e)}},e}(x),N=function(){function t(){}return t.renderSequence=function(t,e,n,o,r){void 0===r&&(r=!0);for(var i=88,a=0,c=0,l=e;c<l.length;c++){var s=l[c];if(!s.note&&0!==s.note)throw console.log("event",s),new Error("renderToCanvas() No note!");s.note<i&&(i=s.note),s.note>a&&(a=s.note)}a+=12,i-=12;var u=t.getContext("2d");r&&u.clearRect(0,0,t.width,t.height);for(var d=Math.min(t.height/(a-i+1),2),p=0,f=e;p<f.length;p++){var h=f[p],m=t.height-(h.note-i+1)*d,y=h.start*o,v=h.duration*o;u.fillStyle=n,u.fillRect(y,m,v,d)}},t.renderPattern=function(e,n,o,r){e.getContext("2d").clearRect(0,0,e.width,e.height);for(var i=[],a=0,c=n.tracks;a<c.length;a++){var l=c[a];i.push.apply(i,l.events)}t.renderSequence(e,i,o,r,!1)},t}(),H=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),X=function(t){function e(e){var n=t.call(this,"div","scroll-panel")||this;return n.scrollElement=e,n.sensitivity=50,n.linkedElements=[],n._scrollTop=0,e.classList.add("scroll-panel-content"),n.scrollElement.addEventListener("wheel",(function(t){t.preventDefault();var e=n._scrollTop+(t.deltaY>0?-n.sensitivity:n.sensitivity);e+n.scrollElement.offsetHeight<n.domElement.offsetHeight?e=n.domElement.offsetHeight-n.scrollElement.offsetHeight:e>0&&(e=0),n._scrollTop=e,n.scrollElement.style.transform="translateY(".concat(e,"px)");for(var o=0,r=n.linkedElements;o<r.length;o++)r[o].style.transform="translateY(".concat(e,"px)");n.emit("scroll",t)})),n}return H(e,t),Object.defineProperty(e.prototype,"scrollTop",{get:function(){return this._scrollTop},set:function(t){var e=-t;this._scrollTop=e,this.scrollElement.style.transform="translateY(".concat(e,"px)");for(var n=0,o=this.linkedElements;n<o.length;n++)o[n].style.transform="translateY(".concat(e,"px)")},enumerable:!1,configurable:!0}),e.prototype.linkElement=function(t){this.linkedElements.push(t),t.classList.add("scroll-panel-content")},e}(s),F=function(){function t(t,e,n){void 0===t&&(t=800),void 0===e&&(e=200),void 0===n&&(n=!0);var o=this;this.buffer=null,this.domElement=document.createElement("div"),this.domElement.classList.add("audio-canvas"),this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.domElement.appendChild(this.canvas),n&&this.canvas.addEventListener("click",(function(){o.buffer&&o.playBuffer(o.buffer)})),this.ctx=this.canvas.getContext("2d")}return t.prototype.generateAudio=function(t){return e=this,n=arguments,i=function(t,e){var n,o=this;return void 0===e&&(e=!1),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(l){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){a.label=c[1];break}if(6===c[0]&&a.label<r[1]){a.label=r[1],r=c;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(c);break}r[2]&&a.ops.pop(),a.trys.pop();continue}c=e.call(t,a)}catch(t){c=[6,t],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,l])}}}(this,(function(i){switch(i.label){case 0:return[4,new Promise((function(n,i){var a={text:t.label,pitch:t.note,rate:.9};fetch("/api/tts/edge",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then((function(t){return t.arrayBuffer()})).then((function(t){console.log("Audio buffer downloaded",t),r().decodeAudioData(t,(function(t){o.buffer=t,e&&o.playBuffer(t),n(t)}))})).catch((function(t){console.error("Error downloading audio buffer",t),i(t)}))}))];case 1:return n=i.sent(),this.loadBuffer(n),[2,n]}}))},new((o=void 0)||(o=Promise))((function(t,r){function a(t){try{l(i.next(t))}catch(t){r(t)}}function c(t){try{l(i.throw(t))}catch(t){r(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,c)}l((i=i.apply(e,n||[])).next())}));var e,n,o,i},t.prototype.playBuffer=function(t){var e=r(),n=e.createBufferSource();n.buffer=t,n.connect(e.destination),n.start()},t.prototype.loadBuffer=function(t){this.buffer=t;var e=t.getChannelData(0),n=e.length,o=this.canvas.width/n;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath(),this.ctx.moveTo(0,this.canvas.height/2);for(var r=0;r<n;r++){var i=r*o,a=(e[r]+1)*this.canvas.height/2;this.ctx.lineTo(i,a)}this.ctx.lineTo(this.canvas.width,this.canvas.height/2),this.ctx.stroke()},t}(),Y=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),K=function(t){function e(){return t.call(this)||this}return Y(e,t),e.prototype.generateAudio=function(t){return e=this,n=arguments,i=function(t,e){var n,o=this;return void 0===e&&(e=!1),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(l){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){a.label=c[1];break}if(6===c[0]&&a.label<r[1]){a.label=r[1],r=c;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(c);break}r[2]&&a.ops.pop(),a.trys.pop();continue}c=e.call(t,a)}catch(t){c=[6,t],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,l])}}}(this,(function(i){switch(i.label){case 0:return[4,new Promise((function(n,i){var a={text:t.label,pitch:t.note,rate:.9};fetch("/api/tts/edge",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then((function(t){return t.arrayBuffer()})).then((function(t){console.log("Audio buffer downloaded",t),r().decodeAudioData(t,(function(t){o.buffer=t,e&&o.playBuffer(t),n(t)}))})).catch((function(t){console.error("Error downloading audio buffer",t),i(t)}))}))];case 1:return n=i.sent(),this.loadBuffer(n),[2,n]}}))},new((o=void 0)||(o=Promise))((function(t,r){function a(t){try{l(i.next(t))}catch(t){r(t)}}function c(t){try{l(i.throw(t))}catch(t){r(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,c)}l((i=i.apply(e,n||[])).next())}));var e,n,o,i},e}(F),U=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),J=function(t){function e(e,n){void 0===e&&(e="OK"),void 0===n&&(n="Cancel");var o=t.call(this,"div","dialog-popup")||this;return o.ok=e,o.cancel=n,o.closeButton=document.createElement("button"),o.closeButton.classList.add("window-close-button"),o.domElement.appendChild(o.closeButton),o.closeButton.addEventListener("pointerdown",(function(){o.domElement.style.display="none"})),e instanceof HTMLButtonElement?o.okButton=e:e&&(o.okButton=document.createElement("button"),o.okButton.textContent=e,o.domElement.appendChild(o.okButton)),o.okButton&&o.okButton.addEventListener("click",(function(){o.emit("result",o)})),n instanceof HTMLButtonElement?o.cancelButton=n:n&&(o.cancelButton=document.createElement("button"),o.cancelButton.textContent=n,o.domElement.appendChild(o.cancelButton)),o.cancelButton&&o.cancelButton.addEventListener("click",(function(){o.emit("cancel",o)})),o}return U(e,t),Object.defineProperty(e.prototype,"isVisibile",{get:function(){return"none"!==this.domElement.style.display},enumerable:!1,configurable:!0}),e.prototype.show=function(t,e,n){var o;this.domElement.style.display="block",this.domElement.style.left="".concat(t,"px"),this.domElement.style.top="".concat(e,"px"),null===(o=this.domElement.parentElement)||void 0===o||o.appendChild(this.domElement)},e.prototype.hide=function(){this.domElement.style.display="none"},e}(s),Q=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Z=function(t){function e(e){var n=t.call(this,e)||this;return n.domElement.classList.add("grid-item-editor"),n.domElement.style.display="none",n.textInput=document.createElement("input"),n.textInput.setAttribute("placeholder","Note lyric"),n.textInput.classList.add("lyric-editor-text"),n.textInput.type="text",n.domElement.appendChild(n.textInput),n.audioCanvas=new K,n.domElement.appendChild(n.audioCanvas.domElement),n.saveButton.addEventListener("click",(function(){n.audioCanvas.domElement.style.display="block"})),n}return Q(e,t),e.prototype.show=function(e,n,o){var r;t.prototype.show.call(this,e,n,o),this.textInput.value=(null===(r=this.note)||void 0===r?void 0:r.label)||""},e}(function(t){function e(e){var n=t.call(this)||this;return n.onsave=e,n.note=null,n.domElement=document.createElement("div"),n.domElement.classList.add("piano-roll-dialog"),n.closeButton=document.createElement("button"),n.closeButton.classList.add("window-close-button"),n.domElement.appendChild(n.closeButton),n.closeButton.addEventListener("click",(function(){n.domElement.style.display="none"})),n.saveButton=document.createElement("button"),n.saveButton.textContent="Save",n.domElement.appendChild(n.saveButton),n.saveButton.addEventListener("click",(function(){n.onsave(n.note)})),n}return Q(e,t),e.prototype.show=function(e,n,o){var r;t.prototype.show.call(this,e,n,o),this.note=o,null===(r=this.domElement.parentElement)||void 0===r||r.appendChild(this.domElement)},e}(J)),$=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),tt=function(t,e,n,o){this.grid=t,this.velocity=.8,this.label="",this.audio=null;var r,i=e;if(this.domElement=document.createElement("div"),this.domElement.classList.add("grid-item"),this.domElement.style.height="".concat(t.rowHeight,"px"),this.labelElement=document.createElement("div"),this.labelElement.classList.add("grid-item-label"),this.domElement.appendChild(this.labelElement),o){var a=document.createElement("div");a.classList.add("grid-item-image"),a.style.backgroundImage="url(".concat(a,")"),this.domElement.appendChild(a),this.domElement.classList.add("has-image")}i.velocity&&(this.velocity=i.velocity),i.note?(this.note=i.note,this.labelElement.textContent=n||(r=this.note,"".concat(_[r%_.length]).concat(Math.floor(r/_.length)))):this.note=0,this.start=e.start,this.duration=e.duration,e.label&&(this.labelElement.textContent=e.label),console.log("GridItem",this),t.gridElement.appendChild(this.domElement)},et=function(t){function e(e,n,o){void 0===e&&(e=88),void 0===n&&(n=100),void 0===o&&(o=20);var r=this,i=document.createElement("div");(r=t.call(this,i)||this).rowCount=e,r.beatWidth=n,r.rowHeight=o,r._currentItem=null,r._dragMode=null,r._dragOffset=0,r._track=null,r.quantize=.25,r.drawingEnabled=!0,r.drawingLabel=void 0,r.drawingImage=void 0,r.scrollElement=i,r.domElement=document.createElement("div"),r.gridElement=i,r.domElement.classList.add("grid-container"),r.gridElement.classList.add("grid"),r.gridElement.addEventListener("dragstart",(function(t){t.preventDefault()})),r.previewCanvas=document.createElement("canvas"),r.previewCanvas.style.imageRendering="pixelated";var a=document.createElement("canvas");a.style.imageRendering="pixelated",a.width=4*r.beatWidth,a.height=r.rowHeight,console.log("debug",a.width,a.height);var c=a.getContext("2d");if(c){c.clearRect(0,0,a.width,a.height),c.lineWidth=1,c.strokeStyle="#444";for(var l=1;l<4;l++)c.beginPath(),c.moveTo(l*r.beatWidth,0),c.lineTo(l*r.beatWidth,r.rowHeight),c.stroke();c.strokeStyle="#999",c.beginPath(),c.moveTo(0,0),c.lineTo(0,r.rowHeight),c.stroke()}for(var s=0;s<e;s++){var u=document.createElement("div");u.classList.add("grid-row"),u.style.height="".concat(r.rowHeight,"px"),r.gridElement.appendChild(u);var d=a.toDataURL();u.style.backgroundImage="url(".concat(d,")"),u.style.backgroundRepeat="repeat"}return r.domElement.appendChild(r.gridElement),r.noteEditor=new Z((function(t){var e=r.noteEditor.domElement.querySelector(".lyric-editor-text");t.label=(null==e?void 0:e.value)||""})),document.body.appendChild(r.noteEditor.domElement),r.gridElement.addEventListener("pointerdown",(function(t){var e;if(!r._track)throw new Error("No track");if(!r._track.events)throw new Error("No events");if(r.drawingEnabled)if(t.preventDefault(),r._dragOffset=t.layerX,"block"!==r.noteEditor.domElement.style.display){if(t.target instanceof HTMLDivElement&&t.target.classList.contains("grid-item")){r.gridElement.classList.add("dragging");var n=r._track.events.find((function(e){return e.domElement===t.target}));(t.ctrlKey||1===t.button)&&(n?r.noteEditor.show(t.clientX+20,t.clientY-5,n):r.noteEditor.domElement.style.display="none"),n&&(r._currentItem=n,2===t.button?(r.remove(n),r._currentItem=null):(null===(e=n.domElement.parentElement)||void 0===e||e.appendChild(n.domElement),n.domElement.style.width=n.duration*r.beatWidth+"px",r._dragOffset<6?r._dragMode="start":n.domElement.offsetWidth-r._dragOffset<6?r._dragMode="end":r._dragMode="move"))}else{if(0!==t.button)return;if(t.target===r.gridElement){r.gridElement.classList.add("dragging");var o=87-Math.floor(t.layerY/r.rowHeight),i=t.layerX/r.beatWidth;i=Math.round(i/r.quantize)*r.quantize,console.log("start",i,t.layerX);var a={note:o,start:i,velocity:100,duration:r.quantize,label:"",domElement:void 0};r._currentItem=r.add(a),r._currentItem.domElement.style.top="".concat((87-r._currentItem.note)*r.rowHeight,"px"),r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px"),r._dragMode="end",r.emit("select",r._currentItem)}}r.emit("update",r)}else r.noteEditor.domElement.style.display="none"})),r.gridElement.addEventListener("pointerup",(function(){r.gridElement.classList.remove("dragging"),r.emit("update",r),r.emit("release",r._currentItem),r._currentItem=null})),r.gridElement.addEventListener("pointerleave",(function(){r.gridElement.classList.remove("dragging"),r._currentItem&&(r._currentItem=null)})),r.gridElement.addEventListener("contextmenu",(function(t){t.preventDefault()})),r.gridElement.addEventListener("pointermove",(function(t){if(r._currentItem&&1===t.buttons){if("start"===r._dragMode){var e=Math.round(t.layerX/r.beatWidth/r.quantize)*r.quantize,n=r._currentItem.start;if(e>=r._currentItem.start+r._currentItem.duration)return;r._currentItem.start=e,r._currentItem.duration=n-r._currentItem.start+r._currentItem.duration,r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px"),r._currentItem.domElement.style.width="".concat(Math.max(r.quantize,r._currentItem.duration*r.beatWidth),"px")}else if("end"===r._dragMode)r._currentItem.duration=t.layerX/r.beatWidth-r._currentItem.start,r._currentItem.duration=Math.round(r._currentItem.duration/r.quantize)*r.quantize,r._currentItem.domElement.style.width="".concat(Math.max(r.quantize,r._currentItem.duration*r.beatWidth),"px");else{if("move"!==r._dragMode)return;r._currentItem.start=Math.max(0,t.layerX-r._dragOffset)/r.beatWidth,r._currentItem.start=Math.round(r._currentItem.start/r.quantize)*r.quantize,r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px")}r.emit("update",r)}})),r.gridElement.addEventListener("pointerup",(function(){r.gridElement.classList.remove("dragging"),r._currentItem&&(r._currentItem.domElement.style.pointerEvents="auto"),r._currentItem=null})),r}return $(e,t),e.prototype.add=function(t){if(!this._track)throw new Error("add() No track!");var e=new tt(this,t,this.drawingLabel,this.drawingImage);return this._track.events.push(e),t.domElement=e.domElement,console.log("Grid: add",t),e},e.prototype.remove=function(t){if(!this._track)throw new Error("remove() No track!");this._track.events.splice(this._track.events.indexOf(t),1),this.gridElement.removeChild(t.domElement)},e.prototype.load=function(t){var e,n;if(!t)throw new Error("load() No track!");console.log("Grid: load",t.events);for(var o=0,r=(null===(e=this._track)||void 0===e?void 0:e.events)||[];o<r.length;o++)null===(n=r[o].domElement)||void 0===n||n.remove();this._track=t;for(var i=0,a=t.events;i<a.length;i++){var c=a[i];this.gridElement.appendChild(c.domElement)}},e}(X),nt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ot=function(t){function e(){var e=t.call(this,"div","piano-roll-keyboard")||this;return e.keys=[],e.noteHeight=20,e.redraw(),e.domElement.addEventListener("pointerdown",(function(t){t.preventDefault();var n=t.target;if(n.classList.contains("piano-roll-keyboard-key")){var o=e.keys.indexOf(n);console.log("key",n.textContent,o),n.classList.add("active"),e.emit("update",{type:"press",note:o});var r=function(){window.removeEventListener("pointerup",r),n.classList.remove("active"),e.emit("update",{type:"release",note:o})};window.addEventListener("pointerup",(function(){return r()}))}})),e}return nt(e,t),e.prototype.redraw=function(){this.domElement.innerHTML="";for(var t=87;t>=0;t--){var e=document.createElement("div");e.classList.add("piano-roll-keyboard-key"),e.style.height="".concat(this.noteHeight,"px"),e.style.backgroundColor="white"===g[t%12]?"#fff":"#000",e.style.color="white"===g[t%12]?"#000":"#fff",e.textContent=_[t%12]+(t/12|0).toString(),this.domElement.appendChild(e),this.keys.push(e)}this.keys.reverse()},e}(s),rt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),it=function(t){function e(e){var n=t.call(this)||this;return n.audioClock=e,n.cursorUpdateInterval=null,n.track=null,n.color="#7979ce",n.beatWidth=100,n.domElement=document.createElement("div"),n.domElement.classList.add("piano-roll"),n.sideKeyboard=new ot,n.domElement.appendChild(n.sideKeyboard.domElement),n.sideKeyboard.on("update",(function(t){var e=t;"press"==e.type?n.track.trigger(e.note):"release"==e.type&&n.track.release(e.note)})),n.grid=new et,n.domElement.appendChild(n.grid.domElement),n.grid.on("select",(function(t){var e=t;n.track.trigger(e.note),n.track?N.renderSequence(n.track.preview.canvas,n.track.events,n.color,n.beatWidth):console.warn("No track loaded!")})),n.grid.on("update",(function(){n.track&&N.renderSequence(n.track.preview.canvas,n.track.events,n.color,n.beatWidth)})),n.grid.on("release",(function(t){t&&n.track.release(t.note)})),n.grid.linkElement(n.sideKeyboard.domElement),n.timeline=n.grid.domElement,n.cursor=new A(n),n.cursor.domElement.classList.add("audio-cursor"),n.grid.domElement.appendChild(n.cursor.domElement),n.cursor.domElement.style.marginLeft=n.sideKeyboard.domElement.offsetWidth+"px",n.grid.scrollTop=1e3,n}return rt(e,t),e.prototype.load=function(t){t?(this.track=t,this.grid.load(t)):console.warn("No track provided!")},e}(e),at=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ct=function(t){function e(e){var n=this,o=new it(e.project.audioClock);return(n=t.call(this,{title:"Piano Roll",persistent:!0,content:o.domElement,width:900,height:400,left:100,top:100})||this).ui=e,n.pianoRoll=o,n}return at(e,t),e.prototype.loadTrack=function(t){this.pianoRoll.load(t),this.setTitle("Piano Roll (".concat(t.name,")"))},e}(x),lt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),st=function(t){function e(e,n){var o=t.call(this,e,"div","playlist-source-item")||this;return o.item=n,o.domElement.innerText=n.name,o}return lt(e,t),e}(M),ut=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),dt=function(t){function e(e){var n=t.call(this,"div","playlist-track")||this;n._track=e;var o=document.createElement("div");o.classList.add("playlist-track-panel");var r=document.createElement("div");o.appendChild(r),r.textContent=e.name;var i=document.createElement("div");i.classList.add("playlist-track-buttons"),o.appendChild(i);var a=document.createElement("div");a.classList.add("track-button"),a.classList.add("track-mute-button"),a.textContent="M",a.addEventListener("pointerdown",(function(){a.classList.toggle("active")})),i.appendChild(a);var c=document.createElement("div");return c.classList.add("track-button"),c.classList.add("track-solo-button"),c.textContent="S",c.addEventListener("pointerdown",(function(){c.classList.toggle("active")})),i.appendChild(c),n}return ut(e,t),Object.defineProperty(e.prototype,"mute",{get:function(){return this._track.mute},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this._track.solo},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selected",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._track.name},enumerable:!1,configurable:!0}),e.prototype.trigger=function(t,e){console.log("Trigger",t,e)},e.prototype.release=function(t){console.log("Release",t)},e}(s),pt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ft=function(t){function e(e){var n=t.call(this)||this;return n.project=e,n.beatWidth=20,n.domElement=document.createElement("div"),n.domElement.classList.add("playlist"),n._trackPanels=document.createElement("div"),n._trackPanels.classList.add("playlist-tracks"),n.domElement.appendChild(n._trackPanels),n.grid=new et(16,n.beatWidth,60),n.grid.quantize=1,n.domElement.appendChild(n.grid.domElement),n.grid.linkElement(n._trackPanels),n.grid.load(n.project.playlist),n.timeline=n.grid.domElement,n.cursor=new A(n),n.cursor.domElement.classList.add("audio-cursor"),n.grid.domElement.appendChild(n.cursor.domElement),n.cursor.domElement.style.marginLeft=n._trackPanels.offsetWidth+"px",n.grid.scrollTop=0,n}return pt(e,t),Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.project.audioClock},enumerable:!1,configurable:!0}),e.prototype.loadProject=function(t){for(var e=0,n=0,o=t.tracks;n<o.length;n++){var r=o[n],i=new dt(r);this._trackPanels.appendChild(i.domElement),e++}for(;e<16;e++)r={name:"Track ".concat(e+1),mute:!1,solo:!1,selected:!1},i=new dt(r),t.tracks.push(r),this._trackPanels.appendChild(i.domElement)},e}(e),ht=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),mt=function(t){function e(e){var n=this,o=document.createElement("div");return o.classList.add("playlist-container"),(n=t.call(this,{title:"Playlist",persistent:!0,content:o,width:800,height:400})||this).ui=e,n.beatWidth=10,n.playlist=new ft(n.ui.project),n.bucket=new S,n.bucket.domElement.classList.add("playlist-source-bucket"),n.refresh(),o.appendChild(n.bucket.domElement),o.appendChild(n.playlist.domElement),n}return ht(e,t),Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.ui.project.audioClock},enumerable:!1,configurable:!0}),e.prototype.refresh=function(){this.bucket.clear();for(var t=0,e=this.ui.project.patterns;t<e.length;t++){var n=e[t],o=new st(this.bucket,n);this.bucket.addSelectable(o)}this.bucket.items.length>0?(this.bucket.items[0].selected=!0,this.playlist.grid.drawingEnabled=!0,this.playlist.grid.drawingLabel=this.bucket.items[0].item.name,this.playlist.grid.drawingImage=this.bucket.items[0].item.name):this.playlist.grid.drawingEnabled=!1},e.prototype.loadProject=function(t){this.playlist.loadProject(t)},e}(x),yt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),vt=function(t){function e(e){var n=t.call(this,"div","project-ui")||this;n.project=e,n.container=new m,n.domElement.appendChild(n.container.domElement),n.pianoRollWindow=new ct(n),n.container.addWindow(n.pianoRollWindow);var o=new V(n);n.container.addWindow(o),o.show(35,100);var r=new mt(n);n.container.addWindow(r),r.show(1e3,50);var i=new L(n);n.container.addWindow(i),i.show(1e3,470);var a=new w;return n.domElement.appendChild(a.domElement),a.on("update",(function(t){var e=t;console.log("Keyboard",t),"press"===e.type?o.trigger(e.note):"release"===e.type&&o.release(e.note)})),n.project.on("update",(function(t){if(console.log("ProjectUI project update",t),!(t instanceof Object))throw new Error("Invalid event");if(!("type"in t))throw new Error("Invalid event");var e=t;if("project"===e.type){var i=e.value;console.log("Project",i),o.loadProject(i),r.loadProject(i);for(var a=0,c=i.instruments;a<c.length;a++){var l=c[a];n.container.addWindow(l.window)}}})),n}return yt(e,t),Object.defineProperty(e.prototype,"audioContext",{get:function(){return this.project.audioClock.audioContext},enumerable:!1,configurable:!0}),e.prototype.loadProject=function(t){this.project.load(t)},e}(s),gt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),_t=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return gt(e,t),e}(d),bt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Et=function(){return Et=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},Et.apply(this,arguments)},wt=function(t){function e(e){var n=t.call(this,e)||this;return n.voices=[],n._nextVoice=0,n._held=[],n.transpose=24,n._output=e.audioContext.createGain(),n}return bt(e,t),Object.defineProperty(e.prototype,"output",{get:function(){return this._output},enumerable:!1,configurable:!0}),e.prototype.addVoice=function(t){this.voices.push(t)},e.prototype.handleEvent=function(t){if("press"==t.type)console.log(this.name+" triggered voice "+this._nextVoice),this._held.push(Et(Et({},t),{voice:this.voices[this._nextVoice]})),this._nextVoice++,this._nextVoice>=this.voices.length&&(this._nextVoice=0);else if("release"==t.type){console.log(this.name+" released voice "+t);var e=this._held.findIndex((function(e){return e.note==t.note}));e>=0&&this._held.splice(e,1),this.voices.forEach((function(e){e.release(t.note)}))}else console.error(this.name+": Invalid event passed to trigger()",t)},e}(_t),kt=function(){function t(t){this.audioClock=t,this._settings=null,this._note=null,this._frequency=null,this._gain=t.audioContext.createGain()}return Object.defineProperty(t.prototype,"settings",{get:function(){if(!this.settings)throw new Error("Voice not initialized");return this.settings},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gain",{get:function(){return this._gain.gain.value},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"note",{get:function(){return this._note},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lfoNumber",{get:function(){return this.settings.lfoNumber},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"envelopeNumber",{get:function(){return this.settings.envelopeNumber},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frequency",{get:function(){return this._frequency},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"detune",{get:function(){return this.settings.detune},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"oscillators",{get:function(){return this.settings.oscillators},enumerable:!1,configurable:!0}),t.prototype.loadSettings=function(t){this._settings=t,this._gain.gain.value=t.gain},t.prototype.trigger=function(t,e,n){if(void 0===n&&(n=0),!this.settings)throw new Error("Voice not initialized");this._note=t,this._frequency=440*Math.pow(2,(t-69)/12),this._gain.gain.value=this.settings.gain*e},t.prototype.release=function(t){if(void 0===t&&(t=0),!this.settings)throw new Error("Voice not initialized");this._note=null,this._frequency=null},t}(),Ct=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Ot=function(t){function e(e,n,o,r,i,a){var c=t.call(this,"div","slider")||this;return c._type="slider",c._name=e,c._label=n,c._min=o,c._max=r,c._step=i,c._value=a,c._default=a,c._range=document.createElement("input"),c._range.type="range",c._range.min=o.toString(),c._range.max=r.toString(),c._range.step=i.toString(),c._range.value=a.toString(),c._range.addEventListener("input",(function(){c._value=parseFloat(c._range.value),c.emit("update",c)})),c._range.addEventListener("change",(function(){c._range.blur()})),c.domElement.appendChild(c._range),c}return Ct(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"label",{get:function(){return this._label},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){return this._type},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"value",{get:function(){return this._value},set:function(t){this._value=t,this._range.value=t.toString()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"default",{get:function(){return this._default},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"min",{get:function(){return this._min},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"max",{get:function(){return this._max},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"step",{get:function(){return this._step},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"element",{get:function(){return this._range},enumerable:!1,configurable:!0}),e}(s),xt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Pt=function(t){function e(e,n,o,r,i){void 0===e&&(e=.003),void 0===n&&(n=0),void 0===o&&(o=2),void 0===r&&(r=.01),void 0===i&&(i=.05);var a=t.call(this,"div","envelope")||this;return a.attack=new Ot("attack","A",0,1,.01,e),a.hold=new Ot("hold","H",0,1,.01,n),a.decay=new Ot("decay","D",0,1,.01,o),a.sustain=new Ot("sustain","S",0,1,.01,r),a.release=new Ot("release","R",0,1,.01,i),a.domElement.appendChild(a.attack.domElement),a.domElement.appendChild(a.decay.domElement),a.domElement.appendChild(a.sustain.domElement),a.domElement.appendChild(a.release.domElement),a}return xt(e,t),e.prototype.trigger=function(t,e){console.log("trigger @ "+e);var n=t.value;t.cancelScheduledValues(e),t.setValueAtTime(n,e),t.exponentialRampToValueAtTime(.015,e),t.linearRampToValueAtTime(1,e+this.attack.value),t.exponentialRampToValueAtTime(this.sustain.value,e+this.attack.value+this.decay.value)},e.prototype.triggerRelease=function(t,e){console.log("triggerRelease @ "+e),t.setValueAtTime(t.value,e),t.setTargetAtTime(1e-4,e+.01,this.release.value),t.cancelScheduledValues(e+.01+this.release.value)},e}(s),jt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();!function(t){function e(e){var n=t.call(this,e)||this;return n.audioClock=e,n}jt(e,t),e.prototype.trigger=function(t,e,n){console.log("FMBassVoice triggered",t,e,n)},e.prototype.release=function(t){console.log("FMBassVoice released",t)}}(kt);var Tt=function(t){function e(e){var n=t.call(this,e)||this;n.audioClock=e,n.name="FM Bass",n.id="fm_bass",n.version="0.0.1",n.description="A simple FM bass synthesizer",n.author="Johnny Street",n.controllerGroups=[],n.window=new x({title:"FM Bass",persistent:!0,content:n.domElement});var o=n.audioClock.audioContext;n.modulatorGain=o.createGain(),n.modulatorGain.gain.value=100,n.gain=o.createGain(),n.gain.gain.value=0;var r=o.createBiquadFilter();r.type="highpass",r.frequency.value=20,n.gain.connect(r),r.connect(n.output),n.output.gain.value=.5,n.filter=o.createBiquadFilter(),n.filter.type="lowpass",n.filter.frequency.value=440,n.filter.Q.value=1,n.filter.connect(n.gain),n.filterEnvelope=new Pt(0),n.gainEnvelope=new Pt(.015);var i=new Ot("FM Gain","FM Gain",0,1e3,1,100);return n.window.content.appendChild(i.domElement),i.on("update",(function(){console.log("FM Gain",i.value),n.modulatorGain.gain.value=i.value})),n.output.connect(o.destination),n}return jt(e,t),e.prototype.trigger=function(t,e,n){var o,r;if(void 0===n&&(n=1),console.log("FM Bass triggered",e),this._heldNote=t,t+=this.transpose,"running"===(null===(o=this._carrier)||void 0===o?void 0:o.context.state)){var i=this.gain.gain.value;this.gain.gain.cancelScheduledValues(e),this.gain.gain.setValueAtTime(i,e),this.gain.gain.setTargetAtTime(.01,e,.01);try{this._carrier.stop(e+.02),null===(r=this._modulator)||void 0===r||r.stop(e+.02)}catch(t){console.error("Error stopping carrier/modulator",t)}}this._carrier=this.audioClock.audioContext.createOscillator(),this._carrier.frequency.value=220,this._modulator=this.audioClock.audioContext.createOscillator(),this._modulator.frequency.value=220,this._carrier.connect(this.gain),this._modulator.connect(this.modulatorGain),this.modulatorGain.connect(this._carrier.frequency),this._carrier.type="sine",this._carrier.start(e),this._modulator.start(e);var a=function(t){return 440*Math.pow(2,(t-69)/12)}(t),c=e||this.audioClock.currentTime;this.gainEnvelope.trigger(this.gain.gain,c);var l=this._carrier.frequency.value;c+=.001,this._carrier.frequency.cancelScheduledValues(c),this._modulator.frequency.cancelScheduledValues(c),this._carrier.frequency.setValueAtTime(l,c),this._modulator.frequency.setValueAtTime(2*l,c),this._carrier.frequency.setTargetAtTime(a,c,.001),this._modulator.frequency.setTargetAtTime(2*a,c,.001)},e.prototype.release=function(t,e){if(this._heldNote===t){console.log("FM Bass released",t);var n=e||this.audioClock.currentTime;this.filterEnvelope.triggerRelease(this.filter.frequency,n),this.gainEnvelope.triggerRelease(this.gain.gain,n)}},e}(wt),Lt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Bt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Lt(e,t),e}(x),St=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),At=function(t){function e(e,n,o,r,i){void 0===n&&(n=""),void 0===o&&(o=null),void 0===r&&(r=-1),void 0===i&&(i=[]);var a=t.call(this,"div","sampler-slot")||this;return a.audioClock=e,a.name=n,a.keyBinding=o,a.cutGroup=r,a.cutByGroups=i,a.controllerGroups=[],a.buffer=null,a._sources=[],a.name=n,a.buffer=null,a.keyBinding=o||null,a.velocity=1,a.pan=1,a.pitch=1,a.randomPitch=0,a.randomVelocity=.05,a.startPosition=0,a.endPosition=0,a.loop=!1,a.loopStart=0,a.loopEnd=0,a.cutGroup=r,a.cutByGroups=i,a._previewCanvas=new F(200,60),a.domElement.appendChild(a._previewCanvas.domElement),a._nameElement=document.createElement("div"),a._nameElement.classList.add("sampler-slot-name"),a.domElement.appendChild(a._nameElement),a.domElement.addEventListener("pointerdown",(function(){return a.trigger()})),a}return St(e,t),e.prototype.loadSample=function(t,e){return n=this,o=void 0,i=function(){var n,o=this;return function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(l){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){a.label=c[1];break}if(6===c[0]&&a.label<r[1]){a.label=r[1],r=c;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(c);break}r[2]&&a.ops.pop(),a.trys.pop();continue}c=e.call(t,a)}catch(t){c=[6,t],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,l])}}}(this,(function(r){switch(r.label){case 0:return this._nameElement.textContent="(Loading)",[4,fetch(e)];case 1:return(n=r.sent()).ok?(n.arrayBuffer().then((function(t){return o.audioClock.audioContext.decodeAudioData(t)})).then((function(e){o._nameElement.textContent=t,o.buffer=e,o.emit("update"),setTimeout((function(){o._previewCanvas.loadBuffer(e)}),1)})).catch((function(t){o._nameElement.textContent="(Empty)",console.error("Error loading sample: ".concat(e),t)})),[2]):(this._nameElement.textContent="(Empty)",console.error("Error loading sample: ".concat(e),n.statusText),[2])}}))},new((r=void 0)||(r=Promise))((function(t,e){function a(t){try{l(i.next(t))}catch(t){e(t)}}function c(t){try{l(i.throw(t))}catch(t){e(t)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(t){t(n)}))).then(a,c)}l((i=i.apply(n,o||[])).next())}));var n,o,r,i},e.prototype.trigger=function(t){var e=this;if(void 0===t&&(t=0),this.buffer){var n=this.audioClock.audioContext,o=n.createBufferSource();o.buffer=this.buffer,o.playbackRate.value=this.pitch+Math.random()*this.randomPitch,o.connect(n.destination);var r=n.createGain();if(r.gain.value=this.velocity+Math.random()*this.randomVelocity,r.connect(n.destination),o.connect(r),1!==this.pan){var i=n.createStereoPanner();i.pan.value=this.pan,o.connect(i),i.connect(r)}var a=(this.audioClock.startTime||n.currentTime)+60*t/this.audioClock.bpm,c={source:o,gain:r,cutByGroups:this.cutByGroups,time:a};return this._sources.push(c),o.onended=function(){o.disconnect(),r.disconnect();var t=e._sources.indexOf(c);t>=0&&e._sources.splice(t,1)},console.log(t,n.currentTime,a),this.startPosition>=0?o.start(a,this.startPosition,(this.endPosition||this.buffer.duration)-this.startPosition):o.start(a),0!==a&&this.audioClock.isPlaying?this.audioClock.scheduleEventAtTime((function(){return I(e.domElement)}),a):I(this.domElement),this.loop&&(o.loop=!0,o.loopStart=this.loopStart,o.loopEnd=this.loopEnd||this.buffer.duration),c}console.error("No buffer loaded for sample",this.name)},e.prototype.release=function(t){for(var e=0,n=this._sources;e<n.length;e++){var o=n[e];t>=o.time&&this.cut(o,t)}},e.prototype.cut=function(t,e){void 0===e&&(e=0);var n=t.gain.gain.value;t.gain.gain.cancelScheduledValues(e),t.gain.gain.setValueAtTime(n,e),t.gain.gain.exponentialRampToValueAtTime(1e-4,e+.1),t.source.stop(e+.1)},e}(s),It=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Wt=function(t){function e(e){var n=t.call(this,e)||this;n.audioClock=e,n.name="Sampler",n.version="0.0.1",n.description="A simple sampler",n.author="Johnny Street",n.id="sampler",n.slots=[],n.controllerGroups=[],window.addEventListener("keydown",(function(t){return n.onKeyDown(t)}));var o=document.createElement("div");o.classList.add("sampler-slots-container"),n._slotsContainer=o;for(var r=[{keyBinding:96,name:"0"},{keyBinding:97,name:"1"},{keyBinding:98,name:"2"},{keyBinding:99,name:"3"},{keyBinding:100,name:"4"},{keyBinding:101,name:"5"},{keyBinding:102,name:"6",cutByGroups:[3,6]},{keyBinding:103,name:"7"},{keyBinding:104,name:"8"},{keyBinding:105,name:"9"},{keyBinding:111,name:"/",cutByGroups:[0,10]},{keyBinding:106,name:"*"},{keyBinding:109,name:"-"},{keyBinding:107,name:"+"},{keyBinding:13,name:"Enter"}],i=0;i<14;i++){var a=new At(n.audioClock,r[i].name,r[i].keyBinding,i,r[i].cutByGroups);n.slots.push(a),o.appendChild(a.domElement),a.loadSample("Sample","./data/samples/kit1/".concat(i,".wav"))}return e.on("stop",(function(){for(var t=0,e=n.slots;t<e.length;t++)e[t].release(0)})),n.domElement.appendChild(o),n.window=new Bt({title:"Sampler",persistent:!0,content:n.domElement}),n}return It(e,t),e.prototype.trigger=function(t,e,n){void 0===n&&(n=0),console.log("Sampler trigger",t);var o=this.slots[t];if(o){for(var r=0,i=this.slots;r<i.length;r++){var a=i[r];a.cutByGroups.includes(o.cutGroup)&&a.release(n)}return o.trigger(n)}},e.prototype.release=function(t,e){void 0===e&&(e=0),this.slots[t]&&this.slots[t].release(e)},e.prototype.onKeyDown=function(t){var e=this.slots.find((function(e){return e.keyBinding===t.keyCode}));if(e){t.preventDefault();var n=this.slots.indexOf(e);this.trigger(n,null)}},e}(_t);p.register("sampler",Wt),p.register("fm_bass",Tt);var Mt=document.createElement("div");Mt.classList.add("studio");var Gt=new c,zt=new vt(new h(Gt,{title:"Basic",description:"Basic project template with Sampler and Synthesizer",tempo:120,instruments:[{name:"Sampler",id:"sampler",controllerGroups:[]},{name:"FM Bass",id:"fm_bass",controllerGroups:[]}],patterns:[{name:"Pattern 1",tracks:[{events:[]},{events:[]}]}],tracks:[],playlist:{events:[]}}));Mt.appendChild(Gt.domElement),Mt.appendChild(zt.domElement),document.body.appendChild(Mt),monofy=t})();
//# sourceMappingURL=monofy-studio.js.map