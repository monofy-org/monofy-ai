var monofy;(()=>{"use strict";var t={};(t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})})(t);const e=function(){function t(){this._events={},this._onceEvents={}}return t.prototype.on=function(t,e){return this._events[t]||(this._events[t]=[]),this._events[t].push(e),this},t.prototype.once=function(t,e){return this._onceEvents[t]||(this._onceEvents[t]=[]),this._onceEvents[t].push(e),this},t.prototype.emit=function(t,e){var n=this._onceEvents[t];if(n){for(var o=0,r=n;o<r.length;o++){var i=r[o];try{i(e)}catch(e){console.error("Error executing .once callback for event: ".concat(t),e)}}this._onceEvents[t]=void 0}var a=this._events[t];if(a)for(var l=0,s=a;l<s.length;l++){i=s[l];try{i(e)}catch(e){console.error("Error executing .on callback for event: ".concat(t),e)}}},t.prototype.removeAllListeners=function(){this._events={},this._onceEvents={}},t}();var n=null,o=window.AudioContext||window.webkitAudioContext;function r(){return n?("suspended"===n.state&&n.resume(),n):(n=new o({latencyHint:"interactive",sampleRate:44100}),function(){return t=this,e=void 0,r=function(){return function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&l[0]?o.return:l[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,l[1])).done)return r;switch(o=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,o=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){a.label=l[1];break}if(6===l[0]&&a.label<r[1]){a.label=r[1],r=l;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(l);break}r[2]&&a.ops.pop(),a.trys.pop();continue}l=e.call(t,a)}catch(t){l=[6,t],o=0}finally{n=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}}(this,(function(t){switch(t.label){case 0:return"setSinkId"in o.prototype?[4,navigator.mediaDevices.enumerateDevices()]:[3,2];case 1:return[2,t.sent()];case 2:return[2,null]}}))},new((n=void 0)||(n=Promise))((function(o,i){function a(t){try{s(r.next(t))}catch(t){i(t)}}function l(t){try{s(r.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,l)}s((r=r.apply(t,e||[])).next())}));var t,e,n,r}().then((function(t){console.log("Audio devices",t)})),console.log("Audio context created"),n)}var i,a=(i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},i(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),l=function(t){function e(){var e=t.call(this)||this;return e._playbackMode="pattern",e._audioContext=null,e._bpm=100,e._scheduledEvents=[],e._startTime=null,e.domElement=document.createElement("div"),e.domElement.classList.add("audio-clock"),e.playPauseButton=document.createElement("button"),e.playPauseButton.classList.add("audio-clock-play-pause"),e.playPauseButton.addEventListener("click",(function(){e.isPlaying?e.stop():(r(),e.playPause())})),e.domElement.appendChild(e.playPauseButton),e.stopButton=document.createElement("button"),e.stopButton.classList.add("audio-clock-stop"),e.stopButton.textContent="■",e.stopButton.addEventListener("click",(function(){e.stop()})),e.domElement.appendChild(e.stopButton),e.bpmInput=document.createElement("input"),e.bpmInput.classList.add("audio-clock-bpm"),e.bpmInput.type="number",e.bpmInput.value="120",e.bpmInput.addEventListener("input",(function(){e._bpm=parseFloat(e.bpmInput.value)})),e.domElement.appendChild(e.bpmInput),e.currentTimeDisplay=document.createElement("span"),e.currentTimeDisplay.classList.add("audio-clock-time"),e.currentTimeDisplay.textContent="01:1",e.domElement.appendChild(e.currentTimeDisplay),e}return a(e,t),Object.defineProperty(e.prototype,"startTime",{get:function(){return this._startTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return this.audioContext.currentTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audioContext",{get:function(){return this._audioContext||(this._audioContext=r()),this._audioContext},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentBeat",{get:function(){return(null!==this._startTime?this.audioContext.currentTime-this._startTime:0)*(this._bpm/60)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isPlaying",{get:function(){return null!=this._startTime&&this._startTime>=0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bpm",{get:function(){return this._bpm},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"playbackMode",{get:function(){return this._playbackMode},enumerable:!1,configurable:!0}),e.prototype.getBeatTime=function(t){return this.currentTime+t*(this.bpm/60)},e.prototype.start=function(){this._startTime=this.audioContext.currentTime,console.log("Started at",this._startTime),requestAnimationFrame(this._render.bind(this)),this.emit("start")},e.prototype._render=function(){this._update(this.currentBeat),this.emit("update"),this.isPlaying&&requestAnimationFrame(this._render.bind(this))},e.prototype.stop=function(){this.emit("stop"),this._startTime=null;for(var t=0,e=this._scheduledEvents;t<e.length;t++){var n=e[t].source;n.stop(),n.disconnect()}this._scheduledEvents=[],this.playPauseButton.classList.remove("active"),this._update(this.currentBeat)},e.prototype.restart=function(){this.isPlaying&&(this._startTime=this.audioContext.currentTime)},e.prototype.playPause=function(){if(this.isPlaying)this.stop();else{var t=this.audioContext.createBuffer(1,1,this.audioContext.sampleRate),e=this.audioContext.createBufferSource();e.buffer=t,e.connect(this.audioContext.destination),e.start(),this.start()}this.playPauseButton.classList.toggle("active",this.isPlaying)},e.prototype._update=function(t){var e=Math.floor(t/4)+1,n=Math.floor(t%4)+1,o="".concat(e.toString().padStart(2,"0"),":").concat(n.toString());this.currentTimeDisplay.textContent=o},e.prototype.scheduleEventAtTime=function(t,e){var n=this.audioContext.createBuffer(1,1,this.audioContext.sampleRate),o=this.audioContext.createBufferSource();o.buffer=n,o.connect(this.audioContext.destination),o.onended=function(){return t()},o.start(e),this._scheduledEvents.push({source:o,time:e,callback:t})},e.prototype.scheduleEventAtBeat=function(t,e){var n=this._startTime+e/this._bpm*60;this.scheduleEventAtTime(t,n)},e}(e),s=function(){function t(t){console.assert(t.audioClock,"audioClock is required"),console.assert(t.mixer,"mixer is required"),this._project=t}return Object.defineProperty(t.prototype,"project",{get:function(){return this._project},enumerable:!1,configurable:!0}),t}(),c=function(){function t(){}return t.register=function(t,e){this._plugins[t]?console.warn("Plugin already registered:",e):this._plugins[t]=e},t.get=function(t){return this._plugins[t]},t.instantiate=function(t,e){return new(this.get(e))(t)},t._plugins={},t}(),u=function(){function t(){}return t.linearToGain=function(t){var e=80*Math.max(0,Math.min(1,t))-80;return Math.pow(10,e/20)},t.lerp=function(t,e,n){return t+(e-t)*n},t}(),d=function(){function t(t,e,n,o){void 0===n&&(n=1),void 0===o&&(o=[0]),this.audioContext=t,this.label=e,this.outputs=o,this.mute=!1,this.solo=!1,this.effects=[],this.gainNode=t.createGain(),this.gainNode.gain.value=u.linearToGain(n)}return Object.defineProperty(t.prototype,"gain",{get:function(){return this.gainNode.gain.value},enumerable:!1,configurable:!0}),t}(),p=function(t){this.audioContext=t,this.channels=[];var e=new d(t,"Master",1);e.gainNode.connect(t.destination),this.channels.push(e);for(var n=1;n<=16;n++){var o=new d(t,n.toString());o.gainNode.connect(e.gainNode),this.channels.push(o)}},f=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),m=function(t){function e(e,n){var o=this;return console.assert(e,"audioClock is required"),(o=t.call(this)||this).title="Untitled",o.description="",o.tempo=120,o.instruments=[],o.patterns=[],o.playlist={tracks:[],events:[]},o.audioClock=e,o.mixer=new p(e.audioContext),e.on("start",(function(){console.log("DEBUG START",o.playlist);for(var t=0,n=o.playlist.events;t<n.length;t++){var r=n[t];if(console.log("DEBUG ITEM",r.start,r),r.value instanceof AudioBuffer){var i=e.audioContext.createBufferSource();i.buffer=r.value,i.connect(o.mixer.channels[0].gainNode),i.start(e.getBeatTime(r.start)),i.stop(e.getBeatTime(r.start+r.duration)),console.log("DEBUG PLAY",e.getBeatTime(r.start))}else console.error("DEBUG VALUE",r.value)}})),n&&setTimeout((function(){o.load(n)}),0),o}return f(e,t),e.prototype.serialize=function(){return JSON.stringify({title:this.title,description:this.description,tempo:this.tempo,instruments:this.instruments.map((function(t){return{name:t.name}})),patterns:this.patterns,timeline:this.playlist})},e.prototype.deserialize=function(t){console.log("Project deserialize",t);var e=JSON.parse(t);this.load(e)},e.prototype.load=function(t){console.log("Project load",t),this.title=t.title,this.description=t.description,this.tempo=t.tempo,this.patterns=t.patterns,this.playlist=t.playlist,this.instruments=[];for(var e=0,n=t.instruments;e<n.length;e++){var o=n[e];console.log("loading instrument",o),c.get(o.id);var r=c.instantiate(this,o.id);this.instruments.push(r)}console.log("emitting update..."),this.emit("update",{type:"project",value:this})},e}(e),h=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),v=function(t){function e(e,n){var o=t.call(this)||this;return o.domElement=document.createElement(e),n&&o.domElement.classList.add(n),o}return h(e,t),e.prototype.dispose=function(){this.removeAllListeners(),this.domElement.remove()},e.prototype.appendChild=function(t){return this.domElement.appendChild(t.domElement),this},e.prototype.removeChild=function(t){return this.domElement.removeChild(t.domElement),this},e}(e),y=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),g=function(t){function e(e){var n=t.call(this,"div","window-snap-panel")||this;return n.container=e,n._isOpen=!1,n.domElement.addEventListener("pointerdown",(function(){n.toggle()})),n}return y(e,t),Object.defineProperty(e.prototype,"isOpen",{get:function(){return this._isOpen},enumerable:!1,configurable:!0}),e.prototype.open=function(){this._isOpen||(this.domElement.classList.toggle("open",!0),this._isOpen=!0,this.emit("open"))},e.prototype.close=function(){this._isOpen&&(this.domElement.classList.toggle("open",!1),this._isOpen=!1,this.emit("close"))},e.prototype.toggle=function(){this._isOpen?this.close():this.open()},e}(v),_=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),w=function(t){function e(){var e=t.call(this,"div","window-container")||this;e._activeWindow=null,e.windows=[],e._draggingWindow=null;var n=document.createElement("div");n.classList.add("window-snap-row"),e.domElement.appendChild(n);var o=document.createElement("div");return o.classList.add("window-snap-row"),o.classList.add("bottom-row"),e.domElement.appendChild(o),e._leftPanel=new g(e),n.appendChild(e._leftPanel.domElement),e._workspace=document.createElement("div"),e._workspace.classList.add("window-container-workspace"),n.appendChild(e._workspace),e._rightPanel=new g(e),n.appendChild(e._rightPanel.domElement),e._bottomPanel=new g(e),o.appendChild(e._bottomPanel.domElement),e}return _(e,t),e.prototype._handleWindowDrag=function(t){var e=t.target.domElement,n=this._workspace.getBoundingClientRect().width;if(e.parentElement===this._workspace){var o=this._leftPanel.domElement.getBoundingClientRect().width;if(t.event.clientX<=Math.max(0,o)){var r=o||300;this._leftPanel.domElement.appendChild(e),e.style.width="".concat(r,"px"),e.style.height="unset",e.classList.toggle("snap",!0)}else{var i=this._rightPanel.domElement.getBoundingClientRect().width;t.event.clientX+Math.max(250,i)>n+i+o&&(r=i||300,this._rightPanel.domElement.appendChild(e),e.style.width="".concat(r,"px"),e.style.height="unset",e.classList.toggle("snap",!0))}}else if(e.parentElement===this._leftPanel.domElement&&t.event.target===this._workspace)this._workspace.appendChild(e),e.classList.toggle("snap",!1),e.style.left=t.event.clientX+"px",(a=t.target).resetDragOffset(),a.setSize(a.options.width,a.options.height);else if(e.parentElement===this._rightPanel.domElement&&t.event.target===this._workspace){var a;this._workspace.appendChild(e),e.classList.toggle("snap",!1),e.style.left=n+"px",(a=t.target).resetDragOffset(),a.setSize(a.options.width,a.options.height)}},e.prototype._handleWindowResize=function(t){for(var e=0,n=this.windows;e<n.length;e++){var o=n[e];o.domElement!==t.target.domElement&&o.domElement.parentElement!==this._workspace&&o.domElement.parentElement===t.target.domElement.parentElement&&(o.domElement.style.width="".concat(t.width,"px"))}},e.prototype.addWindow=function(t){var e=this;this.windows.includes(t)?console.warn("Window already added",t):(t.on("drag",(function(t){return e._handleWindowDrag(t)})),t.on("resize",(function(t){return e._handleWindowResize(t)})),this.windows.push(t),this._workspace.appendChild(t.domElement),this._activeWindow||(this._activeWindow=t,this.activateWindow(t)),t.domElement.addEventListener("pointerdown",(function(){e.activateWindow(t)})),t.on("open",(function(){e.activateWindow(t)})),t.on("close",(function(){e._activeWindow===t&&(e._activeWindow=null)})))},e.prototype.activateWindow=function(t){if(this._activeWindow!==t){this._activeWindow=t;for(var e=0,n=this.windows;e<n.length;e++){var o=n[e];o.domElement.classList.toggle("active",o===t),o.domElement.style.zIndex=o===t?"1":"0"}}},e}(v),b=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),E=function(t){function e(e,n){var o=t.call(this,"div","notification")||this;o.domElement.style.display="hidden";var r=document.createElement("h1"),i=document.createElement("p");o._closeButton=document.createElement("button"),o._closeButton.textContent="×";var a=function(){o._closeButton.removeEventListener("click",a),o.dispose(),o.emit("close")};return o._closeButton.addEventListener("click",a),(null==n?void 0:n.body)&&(i.textContent=n.body),r.textContent=e,o.domElement.appendChild(r),o.domElement.appendChild(i),o.domElement.appendChild(o._closeButton),document.body.appendChild(o.domElement),o}return b(e,t),e}(v),O=[90,83,88,68,67,86,71,66,72,78,74,77,188,76,190,59,191],x=[81,50,87,51,69,82,53,84,54,89,55,85,73,57,79,48,80,219,61,221],C=["white","black","white","white","black","white","black","white","white","black","white","black"],k=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],j=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),P=null;function L(t){var e=-1;return O.includes(t)?e=O.indexOf(t):x.includes(t)&&(e=x.indexOf(t)+12),e}var I=function(t){function e(){var e=t.call(this,"div","keyboard")||this;P||navigator.requestMIDIAccess().then((function(t){console.log("MIDI Access",t),P=t,t.inputs.forEach((function(t){t.onmidimessage=function(t){return e.handleMIDI(t)}}))})).catch((function(t){console.error("MIDI Access error",t),new E("MIDI Access error",{body:t.message})}));var n=[];return window.addEventListener("keydown",(function(t){if(!(t.ctrlKey||t.altKey||t.shiftKey)&&"INPUT"!=t.target.tagName){var o=L(t.keyCode);if(-1!==o&&!n.includes(o)){n.push(o);var r={type:"press",note:o,velocity:.98,channel:0};e.emit("update",r)}}})),window.addEventListener("keyup",(function(t){var o=L(t.keyCode);-1!==o&&n.includes(o)&&(n.splice(n.indexOf(o),1),e.emit("update",{type:"release",note:o}))})),e}return j(e,t),e.prototype.handleMIDI=function(t){var e;if(console.log("MIDI",null===(e=t.data)||void 0===e?void 0:e.length,"bytes",t.data),!(null===t.data||t.data.length<3)){var n=t.data[0],o=240&n,r=15&n,i=t.data[1],a=t.data[2];if(144===o&&0!==a){var l={type:"press",note:s=i-36,velocity:a/128,channel:r};this.emit("update",l)}else if(128===o||144===o&&0===a){var s=i-36;this.emit("update",{type:"release",note:s})}else if(176===o){var c=i,u=a;console.log("Control Change",c,u)}}},e}(v),T=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),B=function(t){function e(e,n){var o=t.call(this,e,n)||this;o._resizing=!1,o._startX=0,o._startY=0,o._startWidth=0,o._startHeight=0,o._startTop=0,o._startLeft=0,o._resizeDirection=null,o.domElement.addEventListener("pointermove",(function(t){var e=o.getCurrentHandle(t);o.domElement.style.cursor="top"===e||"bottom"===e?"ns-resize":"left"===e||"right"===e?"ew-resize":"auto"}));var r=function(t){if(o._resizing){console.log(o._resizeDirection);var e=t.clientX-o._startX,n=t.clientY-o._startY;"right"===o._resizeDirection?o.domElement.style.width="".concat(o._startWidth+e,"px"):"bottom"===o._resizeDirection?o.domElement.style.height="".concat(o._startHeight+n,"px"):"left"===o._resizeDirection?(o.domElement.style.width="".concat(o._startWidth-e,"px"),o.domElement.style.left="".concat(o._startLeft+e,"px")):"top"===o._resizeDirection&&(o.domElement.style.height="".concat(o._startHeight-n,"px"),o.domElement.style.top="".concat(o._startTop+n,"px"));var r={target:o,width:o.domElement.offsetWidth,height:o.domElement.offsetHeight,event:t};o.emit("resize",r)}};return o.domElement.addEventListener("pointerdown",(function(t){if(0===t.button){var e=o.getCurrentHandle(t);e&&(window.addEventListener("pointermove",r),o.startResize(t,e),t.preventDefault());var n=function(){o.stopResize(),window.removeEventListener("pointermove",r),window.removeEventListener("pointerup",n)};window.addEventListener("pointerup",n)}})),o}return T(e,t),e.prototype.startResize=function(t,e){console.log("startResize",e),this._resizing=!0,this._startX=t.clientX,this._startY=t.clientY,this._startWidth=this.domElement.offsetWidth,this._startHeight=this.domElement.offsetHeight,this._startTop=this.domElement.offsetTop,this._startLeft=this.domElement.offsetLeft,this._resizeDirection=e},e.prototype.stopResize=function(){this._resizing=!1,this._resizeDirection=null},e.prototype.getCurrentHandle=function(t){var e=this.domElement.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top;return n>0&&n<8?"left":e.width-n<8?"right":o>0&&o<8?"top":e.height-o<8?"bottom":null},e}(v),S=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),A=function(t){function e(e){var n=t.call(this,"div","draggable-window")||this;n.options=e,n._isDragging=!1,n._dragOffsetX=0,n._dragOffsetY=0,n._top=0,n._left=0,n.domElement.style.display="none",n._top=e.top||0,n._left=e.left||0,n.persistent=e.persistent||!1,n.titlebar=document.createElement("div"),n.titlebar.className="window-titlebar",n.domElement.appendChild(n.titlebar),n.on("resize",(function(t){var e=t;n.options.width=e.width,n.options.height=e.height})),n.titlebar.addEventListener("pointerdown",(function(t){n._isDragging=!0,n._dragOffsetX=t.clientX-n.domElement.getBoundingClientRect().left+n.domElement.parentElement.getBoundingClientRect().left,n._dragOffsetY=t.clientY-n.domElement.getBoundingClientRect().top+n.domElement.parentElement.getBoundingClientRect().top+n.domElement.parentElement.scrollTop;var e=function(t){if(n._isDragging){var e=t.clientY-n._dragOffsetY,o=t.clientX-n._dragOffsetX,r=o-n._left,i=e-n._top;e<0&&(e=0),n.domElement.style.top="".concat(e,"px"),n.domElement.style.left="".concat(o,"px"),n._top=e,n._left=o;var a={target:n,event:t,top:e,left:o,deltaX:r,deltaY:i};n.emit("drag",a)}},o=function(){n._isDragging=!1,document.body.removeEventListener("pointermove",e),document.body.removeEventListener("pointerup",o)};document.body.addEventListener("pointermove",e),document.body.addEventListener("pointerup",o)})),n._title=document.createElement("div"),n._title.className="window-titlebar-title",n._title.textContent=e.title,n.titlebar.appendChild(n._title),n.content=document.createElement("div"),n.content.className="window-content",n.domElement.appendChild(n.content),n._closeButton=document.createElement("button"),n._closeButton.className="window-close-button",n._closeButton.addEventListener("pointerdown",(function(t){0===t.button&&n.close()})),n.titlebar.appendChild(n._closeButton);var o=e.width||640,r=e.height||400;return n.setSize(o,r),e.content&&n.content.appendChild(e.content),n}return S(e,t),Object.defineProperty(e.prototype,"isVisible",{get:function(){return"none"!==this.domElement.style.display},enumerable:!1,configurable:!0}),e.prototype.resetDragOffset=function(){var t=this.domElement.parentElement.getBoundingClientRect();this._dragOffsetX=t.left+100,this._dragOffsetY=t.top+10},e.prototype.show=function(t,e){var n=this;void 0===t&&(t=this._left),void 0===e&&(e=this._top),this._top=e,this._left=t,0===this._top&&0===this._left&&(t=window.innerWidth/2-200,e=window.innerHeight/4),this.domElement.style.display="flex",this.domElement.style.top="".concat(e,"px"),this.domElement.style.left="".concat(t,"px"),setTimeout((function(){var t;null===(t=n.domElement.parentElement)||void 0===t||t.appendChild(n.domElement),n.emit("open")}),1)},e.prototype.close=function(){this.domElement.style.display="none",this.emit("close"),this.persistent||(console.log("Removing window",this),this.domElement.remove())},e.prototype.setSize=function(t,e){this.options.width=t,this.options.height=e,this.domElement.style.width="".concat(t,"px"),this.domElement.style.height="".concat(e,"px")},e.prototype.setPosition=function(t,e){this.domElement.style.top="".concat(e,"px"),this.domElement.style.left="".concat(t,"px")},e.prototype.setTitle=function(t){this._title.textContent=t},e}(B),M=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),W=function(t){function e(e){void 0===e&&(e=[]);var n=t.call(this,"div","selectable-group")||this;n.items=e;for(var o=0,r=e;o<r.length;o++){var i=r[o];n.addSelectable(i,!1)}return n}return M(e,t),e.prototype.addSelectable=function(t,e){var n=this;void 0===e&&(e=!0),-1!==this.items.indexOf(t)?console.warn("Already added",t):(this.items.push(t),t.on("select",(function(){n.emit("select",n)})),e&&this.domElement.appendChild(t.domElement),t.domElement.addEventListener("pointerdown",(function(e){if(e.ctrlKey||e.shiftKey){if(e.ctrlKey)t.selected=!t.selected;else if(e.shiftKey){var o=n.items.find((function(t){return t.selected}));if(!o)return void(t.selected=!0);for(var r=n.items.indexOf(o),i=n.items.indexOf(t),a=Math.min(r,i),l=Math.max(r,i),s=a;s<=l;s++)n.items[s].selected=!0}}else for(var c=0,u=n.items;c<u.length;c++){var d=u[c];d.selected=d===t}})))},e.prototype.removeSelectable=function(t){var e=this.items.indexOf(t);-1!==e&&(this.items.splice(e,1),this.domElement.removeChild(t.domElement))},e.prototype.clear=function(){for(var t=0,e=this.items;t<e.length;t++){var n=e[t];this.domElement.removeChild(n.domElement)}this.items.length=0},e}(v),D=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),R=function(t){function e(e,n){return t.call(this,e,n)||this}return D(e,t),Object.defineProperty(e.prototype,"selected",{get:function(){return this.domElement.classList.contains("selected")},set:function(t){t!==this.selected&&(this.domElement.classList.toggle("selected",t),this.emit("select",this))},enumerable:!1,configurable:!0}),e}(v),V=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),q=function(t){function e(){var e=t.call(this,"div","track-buttons")||this;e._mute=!1,e._solo=!1;var n=document.createElement("div");e._muteButton=n,n.classList.add("track-button"),n.classList.add("track-mute-button"),n.textContent="M",n.addEventListener("pointerdown",(function(){e._mute=!e._mute,n.classList.toggle("active",e._mute),e.emit("change")})),e.domElement.appendChild(n);var o=document.createElement("div");return e._soloButton=o,o.classList.add("track-button"),o.classList.add("track-solo-button"),o.textContent="S",o.addEventListener("pointerdown",(function(){e._solo=!e._solo,o.classList.toggle("active",e._solo),e.emit("change")})),e.domElement.appendChild(o),e}return V(e,t),Object.defineProperty(e.prototype,"mute",{get:function(){return this._mute},set:function(t){this._mute=t,this._muteButton.classList.toggle("active",this._mute)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this._solo},set:function(t){this._solo=t,this._soloButton.classList.toggle("active",this._solo)},enumerable:!1,configurable:!0}),e}(v),N=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),z=function(t){function e(e,n,o){void 0===o&&(o=!1);var r=t.call(this,"div","mixer-channel")||this;r.isMaster=o,r.effects=[],r._channel=n,r._label=document.createElement("span"),r._label.textContent=n.label,r.domElement.appendChild(r._label);var i=document.createElement("input");return i.type="range",i.min="0",i.max="1.2",i.step="0.01",i.value="1",r._volume=i,r.domElement.appendChild(i),r.muteSoloButtons=new q,r.domElement.appendChild(r.muteSoloButtons.domElement),i.addEventListener("input",(function(){r.emit("change")})),r.muteSoloButtons.on("change",(function(){r.emit("change")})),r}return N(e,t),Object.defineProperty(e.prototype,"channel",{get:function(){return this._channel},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume.valueAsNumber},set:function(t){this._volume.value=t.toString()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mute",{get:function(){return this.muteSoloButtons.mute},set:function(t){t!==this.muteSoloButtons.mute&&(this.muteSoloButtons.mute=t,this.channel.mute=t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this.muteSoloButtons.solo},set:function(t){t!==this.muteSoloButtons.solo&&(this.muteSoloButtons.solo=t,this.channel.solo=t)},enumerable:!1,configurable:!0}),e}(R),G=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),F=function(t){function e(e){var n=t.call(this,{title:"Mixer",persistent:!0,content:document.createElement("div"),width:500,height:300})||this;n.ui=e,n.channels=new W,n.domElement.classList.add("mixer-window");var o=document.createElement("div");o.classList.add("mixer-container");var r=document.createElement("div");r.classList.add("mixer-channels-container");var i=document.createElement("div");i.classList.add("mixer-effects-container"),o.appendChild(r),o.appendChild(i),n.content.appendChild(o),console.log("MIXER CHANNELS DEBUG",n.mixer.channels);for(var a=function(t){var e=new z(l.channels,l.mixer.channels[t],0===t);l.channels.addSelectable(e),l.mixer.channels[t].gainNode.gain.value=e.volume,e.on("change",(function(){n.mixer.channels[t].gainNode.gain.value=e.volume})),r.appendChild(e.domElement)},l=this,s=0;s<n.mixer.channels.length;s++)a(s);return n.channels.items[0].selected=!0,n}return G(e,t),Object.defineProperty(e.prototype,"mixer",{get:function(){return this.ui.project.mixer},enumerable:!1,configurable:!0}),e}(A),H=function(){function t(t){var e=this;this.timeline=t,this.domElement=document.createElement("div"),this.domElement.classList.add("audio-cursor");var n=t.audioClock;n.on("update",(function(){e.update()})),n.on("start",(function(){var t;e.domElement.style.transform="translateX(0)",e.domElement.style.display="block",null===(t=e.domElement.parentElement)||void 0===t||t.appendChild(e.domElement)})),n.on("stop",(function(){e.domElement.style.display="none"}))}return t.prototype.update=function(){this.domElement.style.transform="translateX(".concat(this.timeline.audioClock.currentBeat*this.timeline.beatWidth,"px)")},t.prototype.hide=function(){this.domElement.style.display="none"},t}();function X(t){return e=this,n=arguments,r=function(t,e){return void 0===e&&(e=100),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&l[0]?o.return:l[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,l[1])).done)return r;switch(o=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,o=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){a.label=l[1];break}if(6===l[0]&&a.label<r[1]){a.label=r[1],r=l;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(l);break}r[2]&&a.ops.pop(),a.trys.pop();continue}l=e.call(t,a)}catch(t){l=[6,t],o=0}finally{n=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}}(this,(function(n){return t.classList.toggle("active",!0),setTimeout((function(){t.classList.toggle("active",!1)}),e),[2]}))},new((o=void 0)||(o=Promise))((function(t,i){function a(t){try{s(r.next(t))}catch(t){i(t)}}function l(t){try{s(r.throw(t))}catch(t){i(t)}}function s(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,l)}s((r=r.apply(e,n||[])).next())}));var e,n,o,r}var Y=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),U=function(t){function e(e){var n=this;console.assert(e,"PatternTrackInstrument track is null or undefined"),(n=t.call(this,"div","pattern-track-instrument")||this).track=e,n.domElement.classList.add("pattern-track-panel");var o=document.createElement("div");o.classList.add("pattern-track-label-and-buttons");var r=document.createElement("div");r.textContent=e.name,o.appendChild(r),n.muteSoloButtons=new q,n.muteSoloButtons.on("change",(function(){e.mute=n.muteSoloButtons.mute,e.solo=n.muteSoloButtons.solo})),o.appendChild(n.muteSoloButtons.domElement),n.domElement.appendChild(o);var i=document.createElement("div");i.classList.add("track-button"),i.classList.add("track-edit-button"),i.textContent="e";var a=n.track.window;return i.addEventListener("pointerdown",(function(){a.isVisible?a.close():a.show()})),a.on("close",(function(){i.classList.toggle("active",!1)})),a.on("open",(function(){i.classList.toggle("active",!0)})),n.muteSoloButtons.domElement.appendChild(i),n.indicator=document.createElement("div"),n.indicator.classList.add("pattern-track-indicator"),n.domElement.appendChild(n.indicator),n}return Y(e,t),e}(R),K=function(t){function e(e){var n=this;return console.assert(e,"PatternTrackPreview track is null or undefined"),(n=t.call(this,"div","pattern-track-preview")||this).track=e,n._canvas=document.createElement("canvas"),n._canvas.height=60,n._canvas.width=1280,n._canvas.classList.add("pattern-track-pattern"),n.domElement.append(n._canvas),n}return Y(e,t),Object.defineProperty(e.prototype,"canvas",{get:function(){return this._canvas},enumerable:!1,configurable:!0}),e}(v),J=function(t){function e(e,n,o,r,i){var a=t.call(this,"div","pattern-track")||this;return a.ui=e,a.instrument=n,a.events=o,a.buttonGroup=r,a.previewGroup=i,a.port=null,a.channel=0,a._window=new n.Window(e,n),a.button=new U(a),a.buttonGroup.addSelectable(a.button,!1),a.preview=new K(a),console.log("New window",a.window),a.domElement.appendChild(a.button.domElement),a.domElement.appendChild(a.preview.domElement),a}return Y(e,t),Object.defineProperty(e.prototype,"window",{get:function(){return this._window},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"mute",{get:function(){return this.button.muteSoloButtons.mute},set:function(t){this.button.muteSoloButtons.mute=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this.button.muteSoloButtons.solo},set:function(t){this.button.muteSoloButtons.solo=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this.instrument.name},enumerable:!1,configurable:!0}),e.prototype.trigger=function(t,e,n){var o=this;void 0===e&&(e=this.ui.project.audioClock.currentBeat),void 0===n&&(n=1);var r=this.instrument.trigger(t,e,n);return e>0?this.ui.project.audioClock.scheduleEventAtBeat((function(){X(o.button.indicator)}),e):X(this.button.indicator),r},e.prototype.release=function(t,e){void 0===e&&(e=this.ui.project.audioClock.currentBeat),this.instrument.release(t,e)},e.prototype.load=function(t){this.events=t.events},e}(v),Z=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Q=function(t){function e(e){var n=this,o=document.createElement("div");o.classList.add("pattern-track-container"),(n=t.call(this,{title:"Pattern",persistent:!0,content:o,width:400,height:400})||this).ui=e,n.tracks=[],n.beatWidth=20,n.trackContainer=o,n.timeline=n.trackContainer,n.cursor=new H(n),n.cursor.domElement.style.marginLeft="150px",n.timeline.appendChild(n.cursor.domElement);var r=n.domElement.querySelector("canvas");return r&&(n.beatWidth=r.width/16),n.on("resize",(function(){n.beatWidth=n.domElement.clientWidth/16})),e.project.on("update",(function(t){var e=t;if("project"===e.type){for(var o=e.value,r=0,i=n.tracks;r<i.length;r++){var a=i[r];n.trackContainer.removeChild(a.domElement)}n.tracks.length=0,0===n.ui.project.patterns.length&&n.ui.project.patterns.push({name:"Pattern 1",tracks:[]});for(var l=0;l<o.instruments.length;l++)o.patterns[0].tracks[l]||(o.patterns[0].tracks[l]={events:[]}),a=n.addTrack(o.instruments[l],o.patterns[0].tracks[l].events),o.patterns[0].tracks[l]||a.load(o.patterns[0].tracks[l]),0===l&&(a.button.selected=!0)}})),n.patternPreviews=new W,n.buttons=new W,n}return Z(e,t),e.prototype.loadPattern=function(t){this.setTitle(t.name);for(var e=0;e<this.ui.project.instruments.length;e++)t.tracks[e]=t.tracks[e]||[],this.tracks[e].load(t.tracks[e]);this.isVisible||this.show()},Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.ui.project.audioClock},enumerable:!1,configurable:!0}),e.prototype.addTrack=function(t,e){var n=this;console.log("Add track + instrument:",t);var o=new J(this.ui,t,e,this.buttons,this.patternPreviews);return t.output.connect(this.ui.mixerWindow.mixer.channels[0].gainNode),console.assert(o.button instanceof U,"button is not an instance of PatternTrackInstrument"),console.assert(o.preview instanceof K,"preview is not an instance of PatternTrackPreview"),o.preview.domElement.addEventListener("pointerdown",(function(){n.ui.pianoRollWindow.loadTrack(o),n.ui.pianoRollWindow.show()})),this.tracks.push(o),this.trackContainer.appendChild(o.domElement),o},e.prototype.removeTrack=function(t){var e=this.tracks.indexOf(t);-1!==e&&(this.tracks.splice(e,1),this.trackContainer.removeChild(t.domElement),this.buttons.removeSelectable(t.button))},e.prototype.trigger=function(t,e,n){void 0===e&&(e=this.audioClock.currentBeat),void 0===n&&(n=1);for(var o=0,r=this.tracks;o<r.length;o++){var i=r[o];i.button.selected&&i.trigger(t,e,n)}},e.prototype.release=function(t,e){void 0===e&&(e=this.audioClock.currentBeat);for(var n=0,o=this.tracks;n<o.length;n++){var r=o[n];r.button.selected&&r.release(t,e)}},e}(A),$=function(){function t(){}return t.renderWaveform=function(t,e){var n=e.getChannelData(0),o=n.length,r=t.width/o,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.beginPath(),i.moveTo(0,t.height/2);for(var a=0;a<o;a++){var l=a*r,s=(n[a]+1)*t.height/2;i.lineTo(l,s)}i.lineTo(t.width,t.height/2),i.stroke()},t.renderSequence=function(t,e,n,o,r){void 0===r&&(r=!0);for(var i=88,a=0,l=0,s=e;l<s.length;l++){var c=s[l];if(!c.note&&0!==c.note)throw console.log("event",c),new Error("renderToCanvas() No note!");c.note<i&&(i=c.note),c.note>a&&(a=c.note)}a+=12,i-=12;var u=t.getContext("2d");r&&u.clearRect(0,0,t.width,t.height);for(var d=Math.min(t.height/(a-i+1),2),p=0,f=e;p<f.length;p++){var m=f[p],h=t.height-(m.note-i+1)*d,v=m.start*o,y=m.duration*o;u.fillStyle=n,u.fillRect(v,h,y,d)}},t.renderPattern=function(e,n,o,r){e.getContext("2d").clearRect(0,0,e.width,e.height);for(var i=[],a=0,l=n.tracks;a<l.length;a++){var s=l[a];i.push.apply(i,s.events)}t.renderSequence(e,i,o,r,!1)},t}(),tt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),et=function(t){function e(e){var n=t.call(this,"div","scroll-panel")||this;return n.scrollElement=e,n.sensitivity=50,n.linkedElements=[],n._scrollTop=0,e.classList.add("scroll-panel-content"),n.scrollElement.addEventListener("wheel",(function(t){t.preventDefault();var e=n._scrollTop+(t.deltaY>0?-n.sensitivity:n.sensitivity);e+n.scrollElement.offsetHeight<n.domElement.offsetHeight?e=n.domElement.offsetHeight-n.scrollElement.offsetHeight:e>0&&(e=0),n._scrollTop=e,n.scrollElement.style.transform="translateY(".concat(e,"px)");for(var o=0,r=n.linkedElements;o<r.length;o++)r[o].style.transform="translateY(".concat(e,"px)");n.emit("scroll",t)})),n}return tt(e,t),Object.defineProperty(e.prototype,"scrollTop",{get:function(){return this._scrollTop},set:function(t){var e=-t;this._scrollTop=e,this.scrollElement.style.transform="translateY(".concat(e,"px)");for(var n=0,o=this.linkedElements;n<o.length;n++)o[n].style.transform="translateY(".concat(e,"px)")},enumerable:!1,configurable:!0}),e.prototype.linkElement=function(t){this.linkedElements.push(t),t.classList.add("scroll-panel-content")},e}(v),nt=function(){function t(t,e,n){void 0===t&&(t=800),void 0===e&&(e=200),void 0===n&&(n=!0);var o=this;this.buffer=null,this.domElement=document.createElement("div"),this.domElement.classList.add("audio-canvas"),this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.domElement.appendChild(this.canvas),n&&this.canvas.addEventListener("click",(function(){o.buffer&&o.playBuffer(o.buffer)})),this.ctx=this.canvas.getContext("2d")}return t.prototype.generateAudio=function(t){return e=this,n=arguments,i=function(t,e){var n,o=this;return void 0===e&&(e=!1),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&l[0]?o.return:l[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,l[1])).done)return r;switch(o=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,o=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){a.label=l[1];break}if(6===l[0]&&a.label<r[1]){a.label=r[1],r=l;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(l);break}r[2]&&a.ops.pop(),a.trys.pop();continue}l=e.call(t,a)}catch(t){l=[6,t],o=0}finally{n=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}}(this,(function(i){switch(i.label){case 0:return[4,new Promise((function(n,i){var a={text:t.label,pitch:t.note,rate:.9};fetch("/api/tts/edge",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then((function(t){return t.arrayBuffer()})).then((function(t){console.log("Audio buffer downloaded",t),r().decodeAudioData(t,(function(t){o.buffer=t,e&&o.playBuffer(t),n(t)}))})).catch((function(t){console.error("Error downloading audio buffer",t),i(t)}))}))];case 1:return n=i.sent(),this.loadBuffer(n),[2,n]}}))},new((o=void 0)||(o=Promise))((function(t,r){function a(t){try{s(i.next(t))}catch(t){r(t)}}function l(t){try{s(i.throw(t))}catch(t){r(t)}}function s(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,l)}s((i=i.apply(e,n||[])).next())}));var e,n,o,i},t.prototype.playBuffer=function(t){var e=r(),n=e.createBufferSource();n.buffer=t,n.connect(e.destination),n.start()},t.prototype.loadBuffer=function(t){this.buffer=t;var e=t.getChannelData(0),n=e.length,o=this.canvas.width/n;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath(),this.ctx.moveTo(0,this.canvas.height/2);for(var r=0;r<n;r++){var i=r*o,a=(e[r]+1)*this.canvas.height/2;this.ctx.lineTo(i,a)}this.ctx.lineTo(this.canvas.width,this.canvas.height/2),this.ctx.stroke()},t}(),ot=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),rt=function(t){function e(){return t.call(this)||this}return ot(e,t),e.prototype.generateAudio=function(t){return e=this,n=arguments,i=function(t,e){var n,o=this;return void 0===e&&(e=!1),function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&l[0]?o.return:l[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,l[1])).done)return r;switch(o=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,o=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){a.label=l[1];break}if(6===l[0]&&a.label<r[1]){a.label=r[1],r=l;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(l);break}r[2]&&a.ops.pop(),a.trys.pop();continue}l=e.call(t,a)}catch(t){l=[6,t],o=0}finally{n=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}}(this,(function(i){switch(i.label){case 0:return[4,new Promise((function(n,i){var a={text:t.label,pitch:t.note,rate:.9};fetch("/api/tts/edge",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then((function(t){return t.arrayBuffer()})).then((function(t){console.log("Audio buffer downloaded",t),r().decodeAudioData(t,(function(t){o.buffer=t,e&&o.playBuffer(t),n(t)}))})).catch((function(t){console.error("Error downloading audio buffer",t),i(t)}))}))];case 1:return n=i.sent(),this.loadBuffer(n),[2,n]}}))},new((o=void 0)||(o=Promise))((function(t,r){function a(t){try{s(i.next(t))}catch(t){r(t)}}function l(t){try{s(i.throw(t))}catch(t){r(t)}}function s(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(t){t(n)}))).then(a,l)}s((i=i.apply(e,n||[])).next())}));var e,n,o,i},e}(nt),it=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),at=function(t){function e(e,n){void 0===e&&(e="OK"),void 0===n&&(n="Cancel");var o=t.call(this,"div","dialog-popup")||this;return o.ok=e,o.cancel=n,o.closeButton=document.createElement("button"),o.closeButton.classList.add("window-close-button"),o.domElement.appendChild(o.closeButton),o.closeButton.addEventListener("pointerdown",(function(){o.domElement.style.display="none"})),e instanceof HTMLButtonElement?o.okButton=e:e&&(o.okButton=document.createElement("button"),o.okButton.textContent=e,o.domElement.appendChild(o.okButton)),o.okButton&&o.okButton.addEventListener("click",(function(){o.emit("result",o)})),n instanceof HTMLButtonElement?o.cancelButton=n:n&&(o.cancelButton=document.createElement("button"),o.cancelButton.textContent=n,o.domElement.appendChild(o.cancelButton)),o.cancelButton&&o.cancelButton.addEventListener("click",(function(){o.emit("cancel",o)})),o}return it(e,t),Object.defineProperty(e.prototype,"isVisibile",{get:function(){return"none"!==this.domElement.style.display},enumerable:!1,configurable:!0}),e.prototype.show=function(t,e,n){var o;this.domElement.style.display="block",this.domElement.style.left="".concat(t,"px"),this.domElement.style.top="".concat(e,"px"),null===(o=this.domElement.parentElement)||void 0===o||o.appendChild(this.domElement)},e.prototype.hide=function(){this.domElement.style.display="none"},e}(v),lt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),st=function(t){function e(e){var n=t.call(this,e)||this;return n.domElement.classList.add("grid-item-editor"),n.domElement.style.display="none",n.textInput=document.createElement("input"),n.textInput.setAttribute("placeholder","Note lyric"),n.textInput.classList.add("lyric-editor-text"),n.textInput.type="text",n.domElement.appendChild(n.textInput),n.audioCanvas=new rt,n.domElement.appendChild(n.audioCanvas.domElement),n.saveButton.addEventListener("click",(function(){n.audioCanvas.domElement.style.display="block"})),n}return lt(e,t),e.prototype.show=function(e,n,o){var r;t.prototype.show.call(this,e,n,o),this.textInput.value=(null===(r=this.note)||void 0===r?void 0:r._label)||""},e}(function(t){function e(e){var n=t.call(this)||this;return n.onsave=e,n.note=null,n.domElement=document.createElement("div"),n.domElement.classList.add("piano-roll-dialog"),n.closeButton=document.createElement("button"),n.closeButton.classList.add("window-close-button"),n.domElement.appendChild(n.closeButton),n.closeButton.addEventListener("click",(function(){n.domElement.style.display="none"})),n.saveButton=document.createElement("button"),n.saveButton.textContent="Save",n.domElement.appendChild(n.saveButton),n.saveButton.addEventListener("click",(function(){n.onsave(n.note)})),n}return lt(e,t),e.prototype.show=function(e,n,o){var r;t.prototype.show.call(this,e,n,o),this.note=o,null===(r=this.domElement.parentElement)||void 0===r||r.appendChild(this.domElement)},e}(at)),ct=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ut=function(t){function e(e,n,o,r,i){var a=t.call(this,"div","grid-item")||this;a.grid=e,a.item=n,a.value=i,a.velocity=.8,a._label="";var l,s=n;if(a.domElement.style.height="".concat(e.rowHeight,"px"),a.labelElement=document.createElement("div"),a.labelElement.classList.add("grid-item-label"),a.domElement.appendChild(a.labelElement),r){var c=document.createElement("div");c.classList.add("grid-item-image"),console.log("DEBUG Background image",r,c.style.backgroundImage,"url(".concat(r,")")),c.style.backgroundImage="url(".concat(r,")"),a.domElement.appendChild(c),a.domElement.classList.add("has-image")}return s.velocity&&(a.velocity=s.velocity),s.note?(a.note=s.note,a._label=o||(l=a.note,"".concat(k[l%k.length]).concat(Math.floor(l/k.length))),a.labelElement.textContent=a._label):a.note=0,a.start=n.start,a.duration=n.duration,n._label&&(a.labelElement.textContent=n._label),console.log("GridItem",a),e.gridElement.appendChild(a.domElement),a}return ct(e,t),Object.defineProperty(e.prototype,"label",{get:function(){return this._label},set:function(t){this._label=t,this.labelElement.textContent=t},enumerable:!1,configurable:!0}),e}(R),dt=function(t){function e(e,n,o){void 0===e&&(e=88),void 0===n&&(n=100),void 0===o&&(o=20);var r=this,i=new W;(r=t.call(this,i.domElement)||this).rowCount=e,r.beatWidth=n,r.rowHeight=o,r._currentItem=null,r._dragMode=null,r._dragOffset=0,r._sequence=null,r.quantize=.25,r.drawingEnabled=!0,r.drawingLabel=void 0,r.drawingImage=void 0,r.drawingValue=void 0,r.scrollElement=i.domElement,r.gridElement=i.domElement,r.domElement.classList.add("grid-container"),r.gridElement.classList.add("grid"),r.gridElement.addEventListener("dragstart",(function(t){t.preventDefault()})),r.previewCanvas=document.createElement("canvas"),r.previewCanvas.style.imageRendering="pixelated";var a=document.createElement("canvas");a.style.imageRendering="pixelated",a.width=4*r.beatWidth,a.height=r.rowHeight,console.log("debug",a.width,a.height);var l=a.getContext("2d");if(l){l.clearRect(0,0,a.width,a.height),l.lineWidth=1,l.strokeStyle="#444";for(var s=1;s<4;s++)l.beginPath(),l.moveTo(s*r.beatWidth,0),l.lineTo(s*r.beatWidth,r.rowHeight),l.stroke();l.strokeStyle="#999",l.beginPath(),l.moveTo(0,0),l.lineTo(0,r.rowHeight),l.stroke()}for(var c=0;c<e;c++){var u=document.createElement("div");u.classList.add("grid-row"),u.style.height="".concat(r.rowHeight,"px"),r.gridElement.appendChild(u);var d=a.toDataURL();u.style.backgroundImage="url(".concat(d,")"),u.style.backgroundRepeat="repeat"}return r.domElement.appendChild(r.gridElement),r.noteEditor=new st((function(t){var e=r.noteEditor.domElement.querySelector(".lyric-editor-text");t._label=(null==e?void 0:e.value)||""})),document.body.appendChild(r.noteEditor.domElement),r.gridElement.addEventListener("pointerdown",(function(t){var e;if(!r._sequence)throw new Error("No track");if(!r._sequence.events)throw new Error("No events");if(r.drawingEnabled)if(t.preventDefault(),r._dragOffset=t.layerX,"block"!==r.noteEditor.domElement.style.display){if(t.target instanceof HTMLDivElement&&t.target.classList.contains("grid-item")){r.gridElement.classList.add("dragging");var n=r._sequence.events.find((function(e){return e.domElement===t.target}));(t.ctrlKey||1===t.button)&&(n?r.noteEditor.show(t.clientX+20,t.clientY-5,n):r.noteEditor.domElement.style.display="none"),n&&(r._currentItem=n,2===t.button?(r.remove(n),r._currentItem=null):(null===(e=n.domElement.parentElement)||void 0===e||e.appendChild(n.domElement),n.domElement.style.width=n.duration*r.beatWidth+"px",r._dragOffset<6?r._dragMode="start":n.domElement.offsetWidth-r._dragOffset<6?r._dragMode="end":r._dragMode="move"))}else{if(0!==t.button)return;if(t.target===r.gridElement){r.gridElement.classList.add("dragging");var o=Math.floor(t.layerY/r.rowHeight),i=(n=87-o,t.layerX/r.beatWidth);i=Math.round(i/r.quantize)*r.quantize,console.log("start",i,t.layerX);var a={row:o,note:n,start:i,velocity:1,duration:r.quantize,_label:"",domElement:void 0};r._currentItem=r.add(a),r._currentItem.domElement.style.top="".concat((87-r._currentItem.note)*r.rowHeight,"px"),r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px"),r._dragMode="end",r.emit("select",r._currentItem)}}r.emit("update",r)}else r.noteEditor.domElement.style.display="none"})),r.gridElement.addEventListener("pointerup",(function(){r.gridElement.classList.remove("dragging"),r.emit("update",r),r.emit("release",r._currentItem),r._currentItem=null})),r.gridElement.addEventListener("pointerleave",(function(){r.gridElement.classList.remove("dragging"),r._currentItem&&(r._currentItem=null)})),r.gridElement.addEventListener("contextmenu",(function(t){t.preventDefault()})),r.gridElement.addEventListener("pointermove",(function(t){if(r._currentItem&&1===t.buttons){if("start"===r._dragMode){var e=Math.round(t.layerX/r.beatWidth/r.quantize)*r.quantize,n=r._currentItem.start;if(e>=r._currentItem.start+r._currentItem.duration)return;r._currentItem.start=e,r._currentItem.duration=n-r._currentItem.start+r._currentItem.duration,r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px"),r._currentItem.domElement.style.width="".concat(Math.max(r.quantize,r._currentItem.duration*r.beatWidth),"px")}else if("end"===r._dragMode)r._currentItem.duration=t.layerX/r.beatWidth-r._currentItem.start,r._currentItem.duration=Math.round(r._currentItem.duration/r.quantize)*r.quantize,r._currentItem.domElement.style.width="".concat(Math.max(r.quantize,r._currentItem.duration*r.beatWidth),"px");else{if("move"!==r._dragMode)return;r._currentItem.start=Math.max(0,t.layerX-r._dragOffset)/r.beatWidth,r._currentItem.start=Math.round(r._currentItem.start/r.quantize)*r.quantize,r._currentItem.domElement.style.left="".concat(r._currentItem.start*r.beatWidth,"px")}r.emit("update",r)}})),r.gridElement.addEventListener("pointerup",(function(){r.gridElement.classList.remove("dragging"),r._currentItem&&(r._currentItem.domElement.style.pointerEvents="auto"),r._currentItem=null})),r}return ct(e,t),e.prototype.add=function(t){if(!this._sequence)throw new Error("add() No sequence loaded!");var e=new ut(this,t,this.drawingLabel,this.drawingImage,this.drawingValue);return this._sequence.events.push(e),t.domElement=e.domElement,this.emit("add",e),e},e.prototype.remove=function(t){if(!this._sequence)throw new Error("remove() No sequence loaded!");this._sequence.events.splice(this._sequence.events.indexOf(t),1),this.emit("remove",t),this.gridElement.removeChild(t.domElement)},e.prototype.load=function(t){var e,n;if(!t)throw new Error("load() No track!");if(console.log("Grid: load",t.events),null===(e=this._sequence)||void 0===e?void 0:e.events)for(var o=0,r=this._sequence.events;o<r.length;o++)null===(n=r[o].domElement)||void 0===n||n.remove();if(this._sequence=t,t.events)for(var i=0,a=t.events;i<a.length;i++){var l=a[i];this.gridElement.appendChild(l.domElement)}},e}(et),pt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ft=function(t){function e(){var e=t.call(this,"div","piano-roll-keyboard")||this;return e.keys=[],e.noteHeight=20,e.redraw(),e.domElement.addEventListener("pointerdown",(function(t){t.preventDefault();var n=t.target;if(n.classList.contains("piano-roll-keyboard-key")){var o=e.keys.indexOf(n);console.log("key",n.textContent,o),n.classList.add("active"),e.emit("update",{type:"press",note:o});var r=function(){window.removeEventListener("pointerup",r),n.classList.remove("active"),e.emit("update",{type:"release",note:o})};window.addEventListener("pointerup",(function(){return r()}))}})),e}return pt(e,t),e.prototype.redraw=function(){this.domElement.innerHTML="";for(var t=87;t>=0;t--){var e=document.createElement("div");e.classList.add("piano-roll-keyboard-key"),e.style.height="".concat(this.noteHeight,"px"),e.style.backgroundColor="white"===C[t%12]?"#fff":"#000",e.style.color="white"===C[t%12]?"#000":"#fff",e.textContent=k[t%12]+(t/12|0).toString(),this.domElement.appendChild(e),this.keys.push(e)}this.keys.reverse()},e}(v),mt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ht=function(t){function e(e){var n=t.call(this)||this;return n.audioClock=e,n.cursorUpdateInterval=null,n.track=null,n.color="#7979ce",n.beatWidth=100,n.domElement=document.createElement("div"),n.domElement.classList.add("piano-roll"),n.sideKeyboard=new ft,n.domElement.appendChild(n.sideKeyboard.domElement),n.sideKeyboard.on("update",(function(t){var e=t;"press"==e.type?n.track.trigger(e.note):"release"==e.type&&n.track.release(e.note)})),n.grid=new dt,n.domElement.appendChild(n.grid.domElement),n.grid.on("select",(function(t){var e=t;n.track.trigger(e.note),n.track?$.renderSequence(n.track.preview.canvas,n.track.events,n.color,n.beatWidth):console.warn("No track loaded!")})),n.grid.on("update",(function(){n.track&&$.renderSequence(n.track.preview.canvas,n.track.events,n.color,n.beatWidth)})),n.grid.on("release",(function(t){t&&n.track.release(t.note)})),n.grid.linkElement(n.sideKeyboard.domElement),n.timeline=n.grid.domElement,n.cursor=new H(n),n.cursor.domElement.classList.add("audio-cursor"),n.grid.domElement.appendChild(n.cursor.domElement),n.cursor.domElement.style.marginLeft=n.sideKeyboard.domElement.offsetWidth+"px",n.grid.scrollTop=1e3,n}return mt(e,t),e.prototype.load=function(t){t?(this.track=t,this.grid.load(t)):console.warn("No track provided!")},e}(e),vt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),yt=function(t){function e(e){var n=this,o=new ht(e.project.audioClock);return(n=t.call(this,{title:"Piano Roll",persistent:!0,content:o.domElement,width:900,height:400,left:100,top:100})||this).ui=e,n.pianoRoll=o,n}return vt(e,t),e.prototype.loadTrack=function(t){this.pianoRoll.load(t),this.setTitle("Piano Roll (".concat(t.name,")"))},e}(A),gt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),_t=function(t){function e(e,n,o){var r=t.call(this)||this;return r.container=e,r.attachedElement=n,r._submenus=[],r.domElement=document.createElement("div"),r.domElement.classList.add("context-menu"),e&&e.appendChild(r.domElement),r.attachedElement&&(r.hide(),r.attachedElement.addEventListener("contextmenu",(function(t){if(!t.ctrlKey){if(o&&!o())return;t.preventDefault(),r.show(t.clientX+10,t.clientY-5)}}))),r}return gt(e,t),e.prototype._handlePointerDown=function(){this.domElement.classList.contains("submenu")||this.hide()},e.prototype.isVisible=function(){return"none"!==this.domElement.style.display},e.prototype.addItem=function(t,e,n){var o=document.createElement("div");return o.classList.add("context-menu-item"),o.textContent=t,o.addEventListener("pointerdown",(function(){e()})),this.domElement.appendChild(o),this.on("shown",(function(){n&&!n()?o.style.display="none":o.style.display="block"})),o},e.prototype.addSubmenu=function(t,e){var n=this,o=document.createElement("div");o.classList.add("context-menu-item"),o.classList.add("submenu"),o.textContent=t,o.addEventListener("pointerdown",(function(){e.show(n.domElement.offsetLeft+n.domElement.offsetWidth-5,o.offsetTop)})),e.domElement.classList.add("context-menu-submenu"),this._submenus.push(e),o.appendChild(e.domElement),this.domElement.appendChild(o)},e.prototype.show=function(t,e){var n=this;this.container&&(this.domElement.style.left="".concat(t,"px"),this.domElement.style.top="".concat(e,"px"),this.domElement.style.display="flex",document.addEventListener("pointerup",(function(){return n._handlePointerDown()})),this.emit("shown"))},e.prototype.hide=function(){var t=this;this.isVisible()&&this.container&&(this.domElement.style.display="none",document.removeEventListener("pointerup",(function(){return t._handlePointerDown()})))},e}(e),wt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),bt=function(t){function e(e){var n=t.call(this,"div","playlist-track")||this;n._track=e;var o=document.createElement("div");o.classList.add("playlist-track-panel");var r=document.createElement("div");r.classList.add("playlist-track-label-and-buttons");var i=document.createElement("div");return i.textContent=e.name,n.muteSoloButtons=new q,n.muteSoloButtons.on("change",(function(){n._track.mute=n.muteSoloButtons.mute,n._track.solo=n.muteSoloButtons.solo})),r.appendChild(i),r.appendChild(n.muteSoloButtons.domElement),o.appendChild(r),n.domElement.appendChild(o),n}return wt(e,t),Object.defineProperty(e.prototype,"mute",{get:function(){return this._track.mute},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"solo",{get:function(){return this._track.solo},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selected",{get:function(){return!1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._track.name},enumerable:!1,configurable:!0}),e.prototype.trigger=function(t,e){console.log("Trigger",t,e)},e.prototype.release=function(t){console.log("Release",t)},e}(v),Et=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Ot=function(t){function e(e){var n=t.call(this)||this;return n.project=e,n.beatWidth=20,n._items=new Map,n.domElement=document.createElement("div"),n.domElement.classList.add("playlist"),n._trackPanels=document.createElement("div"),n._trackPanels.classList.add("playlist-tracks"),n.domElement.appendChild(n._trackPanels),n.grid=new dt(16,n.beatWidth,60),n.grid.on("add",(function(t){var e=t,o=t;n.project.playlist.events.includes(o)||n.project.playlist.events.push(o),n._items.set(e,o),n.emit("update"),console.log("Added event",t)})),n.grid.on("remove",(function(t){var e=t;if(n._items.has(e)){var o=t,r=n.project.playlist.events.indexOf(o);r>=0&&(n.project.playlist.events.splice(r,1),console.log("Removed event",t)),n._items.delete(e)}n.emit("update")})),n.grid.quantize=1,n.domElement.appendChild(n.grid.domElement),n.grid.linkElement(n._trackPanels),n.grid.load(n.project.playlist),n.timeline=n.grid.domElement,n.cursor=new H(n),n.cursor.domElement.classList.add("audio-cursor"),n.grid.domElement.appendChild(n.cursor.domElement),n.cursor.domElement.style.marginLeft=n._trackPanels.offsetWidth+"px",n.grid.scrollTop=0,n.project.on("update",(function(t){var e=t;if(console.log("ProjectUI project update",e),"project"===e.type){if(!(e.value instanceof m))return void console.error("ProjectUI project update value is not a Project",e);console.log("Project",e.value),n._loadProject(e.value)}})),n}return Et(e,t),Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.project.audioClock},enumerable:!1,configurable:!0}),e.prototype._loadProject=function(t){for(var e=0,n=0;n<t.playlist.tracks.length;n++){var o=t.playlist.tracks[n],r=new bt(o);this._trackPanels.appendChild(r.domElement),n++}for(;e<16;e++)o={name:"Track ".concat(e+1),mute:!1,solo:!1,selected:!1},r=new bt(o),t.playlist.tracks.push(o),this._trackPanels.appendChild(r.domElement)},e}(e),xt=function(){function t(){}return t.random=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},t.zero=function(){return"00000000-0000-0000-0000-000000000000"},t}(),Ct=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),kt=function(){return kt=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},kt.apply(this,arguments)},jt=function(t){function e(e){var n=t.call(this,"div","treeview-item")||this;return n.item=e,n._content=document.createElement("div"),n._content.classList.add("treeview-item-content"),n._icon=document.createElement("div"),n._icon.classList.add("treeview-icon"),n._content.appendChild(n._icon),n._label=document.createElement("div"),n._label.textContent=e.name,n._label.classList.add("treeview-item-label"),n._content.appendChild(n._label),n.domElement.id=e.id,n.domElement.classList.add(e.type),n.domElement.appendChild(n._content),n}return Ct(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this.item.name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.item.id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parentId",{get:function(){return this.item.parentId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){return this.item.type},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this.item.data},enumerable:!1,configurable:!0}),e.prototype.rename=function(){var t=prompt("Enter new name",this.name);if(t){this.item.name=t;var e=this.item.data;e&&"name"in e&&(e.name=t),this._label.textContent=t,this.emit("change",this)}},e}(v),Pt=function(t){function e(e){var n=t.call(this,kt(kt({},e),{type:"folder"}))||this;return n.item=e,n._expander=document.createElement("div"),n._expander.classList.add("treeview-expander"),n._expander.textContent="+",n._content.insertBefore(n._expander,n._label),n._expander.addEventListener("pointerdown",(function(){return n.toggle()})),n.domElement.addEventListener("dragover",(function(t){t.preventDefault()})),n.domElement.addEventListener("drop",(function(t){var e;t.preventDefault();var o=null===(e=t.dataTransfer)||void 0===e?void 0:e.getData("text/plain");n.emit("change",{id:o,parentId:n.id})})),n._content.addEventListener("dblclick",(function(t){t.target==n._content&&(n.toggle(),t.preventDefault(),t.stopPropagation())})),n}return Ct(e,t),Object.defineProperty(e.prototype,"expanded",{get:function(){return this.domElement.classList.contains("expanded")},enumerable:!1,configurable:!0}),e.prototype.clear=function(){var t;null===(t=this._childContainer)||void 0===t||t.remove(),this._childContainer=void 0},e.prototype.toggle=function(t){this.domElement.classList.toggle("expanded",t),this.domElement.classList.contains("expanded")?this._expander.textContent="-":this._expander.textContent="+"},e.prototype.add=function(t,n,o,r){var i=this,a=new("folder"==t?e:jt)({type:t,name:n,id:o||xt.random(),parentId:this.id});return r&&(a.item.data=r),o&&(console.log("Special item",o),a.domElement.classList.toggle("special",!0)),this._childContainer||(this._childContainer=document.createElement("div"),this._childContainer.classList.add("treeview-children"),this.domElement.appendChild(this._childContainer)),this._childContainer.appendChild(a.domElement),this.emit("add",a),a.on("add",(function(t){return i.emit("add",t)})),a},e.prototype.addItem=function(t){t.domElement.contains(this.domElement)?console.error("Cannot add parent to child"):(this._childContainer||(this._childContainer=document.createElement("div"),this._childContainer.classList.add("treeview-children"),this.domElement.appendChild(this._childContainer)),this._childContainer.appendChild(t.domElement))},e}(jt),Lt=function(t){function e(e){void 0===e&&(e="/");var n=t.call(this,"div","treeview")||this;return n._items=new Map,n._selectedItem=null,n.root=new Pt({type:"folder",name:e,id:"root",parentId:null}),n.root.domElement.classList.toggle("special",!0),n._items.set(n.root.id,n.root),n.root.toggle(!0),n.domElement.appendChild(n.root.domElement),n.root.on("add",(function(t){var e=t;n._items.set(e.id,e),e.on("change",(function(t){var e=t,o=n._items.get(e.id),r=n._items.get(e.parentId);if(!o)throw new Error("Item not found: "+e.id);if(!r)throw new Error("Parent not found: "+e.parentId);o.item.parentId=e.parentId,r.domElement.appendChild(o.domElement),n.emit("change",t)}))})),n.domElement.addEventListener("pointerdown",(function(t){var e,o=t.target;if(!n.domElement.classList.contains("active")){var r=function(t){!n.domElement.contains(t.target)&&n.domElement.classList.contains("active")&&(n.domElement.classList.toggle("active",!1),window.removeEventListener("pointerdown",r),window.removeEventListener("keydown",i),console.log("Treeview inactive"),t.preventDefault())},i=function(t){var e=t;console.log("Keydown",e.key),"ArrowRight"===e.key&&n._selectedItem instanceof Pt?n._selectedItem.toggle(!0):"ArrowLeft"===e.key&&n._selectedItem instanceof Pt&&n._selectedItem.toggle(!1)};n.domElement.classList.toggle("active",!0),window.addEventListener("pointerdown",r),window.addEventListener("keydown",i),console.log("Treeview active")}if(o!=n.domElement){if(o.classList.contains("treeview-item-content")){var a=n._items.get(o.parentElement.id);if(!a)throw new Error("Item not found: "+o.parentElement.id);n.domElement.classList.toggle("dragging",!0),a!=n._selectedItem&&(null===(e=n._selectedItem)||void 0===e||e.domElement.classList.toggle("selected",!1),n._selectedItem=a,a.domElement.classList.toggle("selected",!0),n.emit("select",a))}}else n.deselect()})),n.domElement.addEventListener("pointerup",(function(t){var e,o,r;n.domElement.classList.toggle("dragging",!1),console.log("Selected Element",null===(e=n._selectedItem)||void 0===e?void 0:e.name);var i=null===(o=t.target)||void 0===o?void 0:o.parentElement;if(null===(r=n._selectedItem)||void 0===r?void 0:r.domElement.contains(i))console.log("Dropped on self");else if(i){var a=n.get(i.id);a instanceof Pt?a?n._selectedItem&&(a.addItem(n._selectedItem),a.toggle(!0),n.selectedItem=n._selectedItem):console.error("Target item not found"):console.error("Target is not a folder")}else console.error("No target element")})),n}return Ct(e,t),Object.defineProperty(e.prototype,"selectedItem",{get:function(){return this._selectedItem},set:function(t){var e;if(null===(e=this._selectedItem)||void 0===e||e.domElement.classList.toggle("selected",!1),t){if(t.parentId){var n=this.get(t.parentId);n instanceof Pt&&n.toggle(!0)}this._selectedItem=t,t.domElement.classList.toggle("selected",!0),this.emit("select",t)}else this._selectedItem=null},enumerable:!1,configurable:!0}),e.prototype.get=function(t){return this._items.get(t)},e.prototype.select=function(t){var e=this._items.get(t);e&&(this.selectedItem=e)},e.prototype.deselect=function(){var t;null===(t=this._selectedItem)||void 0===t||t.domElement.classList.toggle("selected",!1),this._selectedItem=null},e.prototype.clear=function(){this.root.clear(),this._items.clear(),this._items.set(this.root.id,this.root)},e.prototype.duplicateSelected=function(){var t;if(!this.selectedItem)throw new Error("No item selected");var e=null===(t=this.selectedItem)||void 0===t?void 0:t.parentId;if(!e)throw new Error("Selected item has no parent");var n=this.get(e);if(!n)throw new Error("Parent not found");if(n instanceof Pt){var o=n.add(this.selectedItem.type,this.selectedItem.name+" Copy",void 0,this.selectedItem.data?JSON.parse(JSON.stringify(this.selectedItem.data)):void 0),r=o.data;return"name"in r&&(r.name=o.name),this.selectedItem=o,o}throw new Error("Selected item is not a folder")},e.prototype.newFolderInSelected=function(){var t;if(this.selectedItem)if(this.selectedItem instanceof Pt)t=this.selectedItem.add("folder","New Folder"),this.selectedItem.toggle(!0);else{if(!this.selectedItem.parentId)throw new Error("Parent is not a folder");var e=this.get(this.selectedItem.parentId);if(!(e&&e instanceof Pt))throw new Error("Parent is not a folder");t=e.add("folder","New Folder"),e.toggle(!0),this.selectedItem=t}else t=this.root.add("folder","New Folder");return t.toggle(!0),t},e}(v),It=function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function a(t){try{s(o.next(t))}catch(t){i(t)}}function l(t){try{s(o.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,l)}s((o=o.apply(t,e||[])).next())}))},Tt=function(t,e){var n,o,r,i,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&l[0]?o.return:l[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,l[1])).done)return r;switch(o=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,o=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){a.label=l[1];break}if(6===l[0]&&a.label<r[1]){a.label=r[1],r=l;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(l);break}r[2]&&a.ops.pop(),a.trys.pop();continue}l=e.call(t,a)}catch(t){l=[6,t],o=0}finally{n=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},Bt=function(){function t(){}return t.decodeAudioData=function(t,e){return new Promise((function(n,o){e.decodeAudioData(t,(function(t){return n(t)}),(function(t){return o(t)}))}))},t.loadUrl=function(e,n){return It(this,void 0,void 0,(function(){var o,r;return Tt(this,(function(i){switch(i.label){case 0:return i.trys.push([0,4,,5]),[4,fetch(e)];case 1:return[4,i.sent().arrayBuffer()];case 2:return o=i.sent(),[4,t.decodeAudioData(o,n)];case 3:return[2,i.sent()];case 4:return r=i.sent(),console.error("Error loading audio file:",r),[3,5];case 5:return[2]}}))}))},t.loadFile=function(e,n){return It(this,void 0,void 0,(function(){var o,r;return Tt(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,e.arrayBuffer()];case 1:return o=i.sent(),[4,t.decodeAudioData(o,n)];case 2:return[2,i.sent()];case 3:return r=i.sent(),console.error("Error loading audio file:",r),[3,4];case 4:return[2]}}))}))},t.loadBlob=function(e,n){return new Promise((function(o,r){var i=new FileReader;i.onload=function(){var e=i.result;t.decodeAudioData(e,n).then((function(t){o(t)})).catch((function(t){r(t)}))},i.onerror=function(t){r(t)},i.readAsArrayBuffer(e)}))},t}(),St=function(){function t(){}return t.importFile=function(t){return void 0===t&&(t="*/*"),new Promise((function(e,n){var o=document.createElement("input");o.type="file",o.accept=t,o.addEventListener("change",(function(){var t,r=null===(t=o.files)||void 0===t?void 0:t[0];r?e(r):n(new Error("No file selected"))})),o.click()}))},t}(),At=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Mt=function(t){function e(e){var n=t.call(this,"Project")||this;n.ui=e;var o=new _t(document.body,n.domElement,(function(){var t;return"folder"===(null===(t=n.selectedItem)||void 0===t?void 0:t.type)&&"root"!==n.selectedItem.id}));o.addItem("New Folder",(function(){n.selectedItem=n.newFolderInSelected()})),o.addItem("Rename",(function(){var t;null===(t=n.selectedItem)||void 0===t||t.rename()}),(function(){var t;return(null===(t=n.selectedItem)||void 0===t?void 0:t.parentId)!==n.root.id})),o.addItem("Import Audio",(function(){o.hide(),St.importFile("audio/*").then((function(t){var e=n.selectedItem;Bt.loadFile(t,n.ui.audioContext).then((function(o){if(!o)throw new Error("Error loading audio file");var r=document.createElement("canvas");r.width=1024,r.height=100,$.renderWaveform(r,o),n.selectedItem=e.add("audio",t.name,void 0,{buffer:o,image:r.toDataURL()})})).catch((function(t){console.error("Error loading audio file",t),alert("Error loading audio file")}))}))}),(function(){var t;return"audio"===(null===(t=n.selectedItem)||void 0===t?void 0:t.id)})),o.addItem("Import Video",(function(){o.hide(),St.importFile("video/*").then((function(t){console.log("Imported file",t)}))}),(function(){var t;return"video"===(null===(t=n.selectedItem)||void 0===t?void 0:t.id)})),o.addItem("Import Image",(function(){o.hide(),St.importFile("image/*").then((function(t){var e=n.selectedItem;n.selectedItem=e.add("image",t.name,void 0,t)}))}),(function(){var t;return"images"===(null===(t=n.selectedItem)||void 0===t?void 0:t.id)})),o.addItem("New Pattern",(function(){var t=n.selectedItem,e={name:"New Pattern",image:"",tracks:[]};n.ui.project.patterns.push(e),n.selectedItem=t.add("pattern",e.name,void 0,e)}),(function(){var t;return"patterns"===(null===(t=n.selectedItem)||void 0===t?void 0:t.id)}));var r=new _t(document.body,n.domElement,(function(){var t;return"folder"!==(null===(t=n.selectedItem)||void 0===t?void 0:t.type)}));return r.addItem("Duplicate",(function(){n.selectedItem=n.duplicateSelected()}),(function(){return Boolean(n.selectedItem)})),r.addItem("Rename",(function(){var t;null===(t=n.selectedItem)||void 0===t||t.rename()}),(function(){return Boolean(n.selectedItem)})),e.project.on("update",(function(t){if("project"===t.type){console.log("ProjectTreeView.update"),n.clear(),n.root.add("folder","Audio","audio"),n.root.add("folder","Images","images");var o=n.root.add("folder","Patterns","patterns");o.toggle(!0);var r=n.root.add("folder","Presets","presets");r.toggle(!0),r.add("folder","FM Bass"),r.add("folder","FM Piano"),r.add("folder","Mixer"),r.add("folder","Multisampler"),n.root.add("folder","Samples","samples"),n.root.add("folder","Video","video");for(var i=0,a=e.project.patterns;i<a.length;i++){var l=a[i];o.add("pattern",l.name,void 0,l)}}})),n}return At(e,t),e}(Lt),Wt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Dt=function(t){function e(e){var n=t.call(this,"div","image-preview")||this;return n.handleWheelZoom=function(t){n._img.style.transform="scale(".concat(1+.01*t.deltaY,")")},n.handlePinchZoom=function(t){var e=t.touches[0],o=t.touches[1];if(e&&o){var r=Math.hypot(e.clientX-o.clientX,e.clientY-o.clientY);n._img.style.transform="scale(".concat(.01*r,")")}},n._img=document.createElement("img"),n._img.addEventListener("load",(function(){n.emit("change",n)})),e instanceof File?n._img.src=URL.createObjectURL(e):"string"==typeof e&&(n._img.src=e),n.domElement.appendChild(n._img),n.domElement.addEventListener("wheel",n.handleWheelZoom),n.domElement.addEventListener("touchstart",n.handlePinchZoom),n.domElement.addEventListener("touchmove",n.handlePinchZoom),n}return Wt(e,t),Object.defineProperty(e.prototype,"src",{set:function(t){this._img.src=t},enumerable:!1,configurable:!0}),e}(v),Rt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Vt=function(t){function e(e){var n=t.call(this,{title:e.name})||this;return n.imagePreview=new Dt(e),n.domElement.appendChild(n.imagePreview.domElement),n}return Rt(e,t),e}(A),qt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Nt=function(t){function e(e){var n=this,o=document.createElement("div");o.classList.add("playlist-container"),(n=t.call(this,{title:"Playlist",persistent:!0,content:o,width:800,height:400})||this).ui=e,n.beatWidth=10,n.playlist=new Ot(n.ui.project),n.playlist.grid.drawingEnabled=!1;var r=document.createElement("div");r.classList.add("playlist-source-container"),n.treeView=new Mt(n.ui),n.treeView.on("select",(function(){var t,e,o,r,i,a;if(console.log("ProjectTreeView.select",null===(t=n.treeView.selectedItem)||void 0===t?void 0:t.type,null===(e=n.treeView.selectedItem)||void 0===e?void 0:e.name,null===(o=n.treeView.selectedItem)||void 0===o?void 0:o.data),"pattern"===(null===(r=n.treeView.selectedItem)||void 0===r?void 0:r.type)){var l=n.treeView.selectedItem.data;n.playlist.grid.drawingLabel=l.name,n.playlist.grid.drawingImage=l.image,n.playlist.grid.drawingValue=l,n.playlist.grid.drawingEnabled=!0,n.ui.patternWindow.loadPattern(l)}else if("image"===(null===(i=n.treeView.selectedItem)||void 0===i?void 0:i.type)){var s=n.treeView.selectedItem.data;n.playlist.grid.drawingImage=URL.createObjectURL(s),n.playlist.grid.drawingLabel=s.name,n.playlist.grid.drawingValue=void 0,n.playlist.grid.drawingEnabled=!0,new Vt(s).show()}else if("audio"===(null===(a=n.treeView.selectedItem)||void 0===a?void 0:a.type)){var c=n.treeView.selectedItem.data;n.playlist.grid.drawingImage=c.image,n.playlist.grid.drawingLabel=n.treeView.selectedItem.name,n.playlist.grid.drawingValue=c.buffer,n.playlist.grid.drawingEnabled=!0}else n.playlist.grid.drawingEnabled=!1})),n.treeView.on("change",(function(t){console.log("ProjectTreeView.change",t)}));var i=new _t(document.body);i.addItem("Import Audio",(function(){St.importFile("audio/*").then((function(t){console.log("Imported file",t)}))}));var a=new _t;return a.addItem("Stable Audio",(function(){console.log("Stable Audio")})),a.addItem("MusicGen",(function(){console.log("MusicGen")})),i.addSubmenu("Generate",a),r.appendChild(n.treeView.domElement),o.appendChild(r),o.appendChild(n.playlist.domElement),n}return qt(e,t),Object.defineProperty(e.prototype,"audioClock",{get:function(){return this.ui.project.audioClock},enumerable:!1,configurable:!0}),e}(A),zt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Gt=function(t){function e(e){var n=t.call(this,"div","project-ui")||this;n.project=e,n.container=new w,n.domElement.appendChild(n.container.domElement),n.pianoRollWindow=new yt(n),n.container.addWindow(n.pianoRollWindow),n.patternWindow=new Q(n),n.container.addWindow(n.patternWindow),n.patternWindow.show(35,100);var o=new Nt(n);n.container.addWindow(o),o.show(1e3,50),n.mixerWindow=new F(n),n.container.addWindow(n.mixerWindow),n.mixerWindow.show(1e3,470);var r=new I;return n.domElement.appendChild(r.domElement),r.on("update",(function(t){var e=t;console.log("Keyboard",t),"press"===e.type?n.patternWindow.trigger(e.note+24,0,e.velocity):"release"===e.type&&n.patternWindow.release(e.note+24)})),n}return zt(e,t),Object.defineProperty(e.prototype,"audioContext",{get:function(){return this.project.audioClock.audioContext},enumerable:!1,configurable:!0}),e}(v),Ft=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Ht=function(t){function e(e,n){void 0===n&&(n=0);var o=t.call(this,e)||this;return o.mixerChannel=n,o.transpose=0,o.output=e.audioClock.audioContext.createGain(),o.output.connect(e.mixer.channels[n].gainNode),o}return Ft(e,t),e}(s),Xt=function(){function t(t){this.audioClock=t,this._settings=null,this._note=null,this._frequency=null,this._gain=t.audioContext.createGain()}return Object.defineProperty(t.prototype,"settings",{get:function(){if(!this.settings)throw new Error("Voice not initialized");return this.settings},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gain",{get:function(){return this._gain.gain.value},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"output",{get:function(){return this._gain},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"note",{get:function(){return this._note},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lfoNumber",{get:function(){return this.settings.lfoNumber},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"envelopeNumber",{get:function(){return this.settings.envelopeNumber},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frequency",{get:function(){return this._frequency},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"detune",{get:function(){return this.settings.detune},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"oscillators",{get:function(){return this.settings.oscillators},enumerable:!1,configurable:!0}),t.prototype.loadSettings=function(t){this._settings=t},t}(),Yt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Ut=function(t){function e(e){var n=t.call(this,"div","control")||this;return n.settings=e,n._label=document.createElement("span"),n._label.classList.add("label"),n._label.textContent=e.label,n.domElement.appendChild(n._label),n}return Yt(e,t),e}(v),Kt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Jt=function(){return Jt=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},Jt.apply(this,arguments)},Zt=function(t){function e(e){var n=t.call(this,Jt(Jt({},e),{controlType:"slider"}))||this;return n._range=document.createElement("input"),n._range.type="range",n._range.min=e.min.toString(),n._range.max=e.max.toString(),n._range.step=e.step.toString(),n._range.value=e.value.toString(),n._range.addEventListener("input",(function(){n.settings.value=parseFloat(n._range.value),n.emit("change",n)})),n._range.addEventListener("change",(function(){n._range.blur()})),n.domElement.appendChild(n._range),n}return Kt(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.settings.value},set:function(t){this.settings.value=t,this._range.value=t.toString()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"element",{get:function(){return this._range},enumerable:!1,configurable:!0}),e}(Ut),Qt=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),$t=function(t){function e(e){void 0===e&&(e={attack:.003,hold:0,decay:2,sustain:.01,release:.15});var n=t.call(this,"div","envelope")||this;return n.settings=e,n._triggerTime=0,n.attack=new Zt({controlType:"slider",name:"attack",label:"A",min:0,max:1,step:.01,value:e.attack,default:e.attack}),n.hold=new Zt({controlType:"slider",name:"hold",label:"H",min:0,max:1,step:.01,value:e.hold,default:e.hold}),n.decay=new Zt({controlType:"slider",name:"decay",label:"D",min:0,max:1,step:.01,value:e.decay,default:e.decay}),n.sustain=new Zt({controlType:"slider",name:"sustain",label:"S",min:0,max:1,step:.01,value:e.sustain,default:e.sustain}),n.release=new Zt({controlType:"slider",name:"release",label:"R",min:0,max:1,step:.01,value:e.release,default:e.release}),n.domElement.appendChild(n.attack.domElement),n.domElement.appendChild(n.decay.domElement),n.domElement.appendChild(n.sustain.domElement),n.domElement.appendChild(n.release.domElement),n}return Qt(e,t),e.prototype.trigger=function(t,e,n,o){void 0===n&&(n=1),void 0===o&&(o=0),console.log("trigger @ "+e),this._triggerTime=e;var r=t.value;t.cancelScheduledValues(e),t.setValueAtTime(r,e),t.exponentialRampToValueAtTime(Math.max(o,.015),e),t.linearRampToValueAtTime(n,e+this.settings.attack),t.exponentialRampToValueAtTime(this.settings.sustain||.01,e+this.settings.attack+this.settings.decay)},e.prototype.estimateValueAtTime=function(t){var e=this.settings.attack,n=this.settings.decay,o=this.settings.sustain,r=this.settings.release,i=this.settings.hold;if(t<e)return u.lerp(0,1,t/e);if(t<e+i)return 1;if(t<e+i+n){var a=t-e-i;return 1-(1-o)*Math.exp(-a/n)}var l=t-e-i-n;return o*Math.exp(-l/r)},e.prototype.triggerRelease=function(t,e){console.log("triggerRelease @ "+e);var n=t.value;t.cancelScheduledValues(this._triggerTime),t.setValueAtTime(n,e),t.exponentialRampToValueAtTime(.01,e+this.settings.release),t.setValueAtTime(0,e+this.settings.release)},e}(v),te=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ee=function(t){function e(e,n,o,r,i,a){void 0===r&&(r=1),void 0===i&&(i=.25),void 0===a&&(a="-");var l=t.call(this,"div","draggable-number")||this;return l._hideZero=a,l._value=e,l._step=r,l.domElement.addEventListener("pointerdown",(function(t){t.preventDefault();var e=t.clientY,r=l.value,a=function(t){var a=l.value,s=Math.round(-(t.clientY-e)*i),c=r+s*l._step;l.value=Math.max(n,Math.min(o,c)),a!==l.value&&l.emit("change",l.value)},s=function(){document.removeEventListener("pointermove",a),document.removeEventListener("pointerup",s)};document.addEventListener("pointermove",a),document.addEventListener("pointerup",s)})),l.value=e||0,l}return te(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this._value},set:function(t){this._value=t,0===t&&null!==this._hideZero?this.domElement.textContent=this._hideZero:this.domElement.textContent=t.toString()},enumerable:!1,configurable:!0}),e}(v),ne=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),oe=function(t){function e(e,n){var o=t.call(this,{title:n.name,width:400,height:300,persistent:!0})||this;o.instrument=n;var r=new ee(n.mixerChannel,0,16);return r.on("change",(function(t){o.instrument.mixerChannel=t,console.assert(e.project.mixer,"instrument.mixer is undefined!"),n.output.disconnect(),n.output.connect(e.project.mixer.channels[o.instrument.mixerChannel].gainNode)})),o._settingsBar=document.createElement("div"),o._settingsBar.classList.add("window-settings-bar"),o._settingsBar.appendChild(r.domElement),o.domElement.insertBefore(o._settingsBar,o.content),e.container.addWindow(o),o}return ne(e,t),e}(A),re=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ie=function(){return ie=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},ie.apply(this,arguments)},ae=function(t){function e(e){var n=t.call(this,ie(ie({},e),{controlType:"knob"}))||this;n.settings=e,n._value=0,n.sensitivity=.25,n.domElement.classList.add("knob");var o=document.createElement("div");return o.classList.add("knob-indicator"),n.sensitivity=.01*(e.max-e.min/e.step),n._handle=document.createElement("div"),n._handle.appendChild(o),n._handle.classList.add("knob-handle"),n._handle.addEventListener("pointerdown",n._onPointerDown.bind(n)),n.domElement.insertBefore(n._handle,n._label),n._setValue(e.value),n}return re(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!1,configurable:!0}),e.prototype._onPointerDown=function(t){var e=this;t.preventDefault(),t.stopPropagation();var n=this._value,o=(t.clientX,t.clientY),r=function(t){t.preventDefault(),t.stopPropagation();var r=-(t.clientY-o),i=t.ctrlKey?.01*e.settings.step:1,a=n+r*e.sensitivity*i;return a-=a%i,e._setValue(a),e.emit("change",e._value),!1},i=function(t){return t.preventDefault(),t.stopPropagation(),window.removeEventListener("pointermove",r),window.removeEventListener("pointerup",i),e._handle.releasePointerCapture(t.pointerId),e._handle.classList.remove("active"),!1};return window.addEventListener("pointermove",r),window.addEventListener("pointerup",i),this.emit("change",this._value),this._handle.classList.add("active"),!1},e.prototype._setValue=function(t){this._value=Math.min(this.settings.max,Math.max(this.settings.min,t)),this._handle.style.transform="rotate(".concat(280*this._value/(this.settings.max-this.settings.min)-50,"deg)")},e}(Ut),le=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),se=function(t){function e(e,n){var o=t.call(this,e,n)||this;o.ui=e,o.fmbass=n,o.instrument=n;var r=new ae({controlType:"knob",name:"FM Gain",label:"FM Gain",min:0,max:300,step:1,default:100,value:100});o.content.appendChild(r.domElement),r.on("change",(function(){console.log("FM Gain",r.value),o.instrument.modulatorGain.gain.value=r.value}));var i=new ae({controlType:"knob",name:"FM Ratio",label:"FM Ratio",min:0,max:12,step:1,default:o.instrument.fmRatio,value:o.instrument.fmRatio});return i.on("change",(function(){console.log("FM Ratio",i.value),o.instrument.fmRatio=i.value})),o.content.appendChild(i.domElement),o}return le(e,t),e}(oe),ce=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();!function(t){function e(e){var n=t.call(this,e)||this;return n.audioClock=e,n.name="FM Bass Voice",n.id="fm_bass_voice",n}ce(e,t),e.prototype.trigger=function(t,e,n){console.log("FMBassVoice triggered",t,e,n)},e.prototype.release=function(t){console.log("FMBassVoice released",t)}}(Xt);var ue=function(t){function e(e,n){void 0===n&&(n=0);var o=t.call(this,e,n)||this;o.name="FM Bass",o.id="fm_bass",o.version="0.0.1",o.description="A simple FM bass synthesizer",o.author="Johnny Street",o.controllerGroups=[],o.Window=se,o.fmRatio=1;var r=e.audioClock.audioContext;o.modulatorGain=r.createGain(),o.modulatorGain.gain.value=100,o._gain=r.createGain(),o._gain.gain.value=0;var i=r.createBiquadFilter();return i.type="highpass",i.frequency.value=20,o._gain.connect(i),i.connect(o.output),o.output.gain.value=.5,o._filter=r.createBiquadFilter(),o._filter.type="lowpass",o._filter.frequency.value=440,o._filter.Q.value=1,o._filter.connect(o._gain),o.filterEnvelope=new $t,o.gainEnvelope=new $t,o}return ce(e,t),e.prototype.trigger=function(t,e,n){var o,r;if(void 0===n&&(n=1),console.log("FM Bass triggered",e,"velocity = ",n),this._heldNote=t,t+=this.transpose,"running"===(null===(o=this._carrier)||void 0===o?void 0:o.context.state)){var i=this._gain.gain.value;this._gain.gain.cancelScheduledValues(e),this._gain.gain.setValueAtTime(i,e),this._gain.gain.exponentialRampToValueAtTime(.1*n,e+.01);try{this._carrier.stop(e+.02),null===(r=this._modulator)||void 0===r||r.stop(e+.02)}catch(t){console.error("Error stopping carrier/modulator",t)}}var a=function(t){return 440*Math.pow(2,(t-69)/12)}(t);this._carrier=this.project.audioClock.audioContext.createOscillator(),this._carrier.frequency.value=a,this._modulator=this.project.audioClock.audioContext.createOscillator(),this._modulator.frequency.value=a*this.fmRatio,this._carrier.connect(this._gain),this._modulator.connect(this.modulatorGain),this.modulatorGain.connect(this._carrier.frequency),this._carrier.type="sine",this._carrier.start(e),this._modulator.start(e);var l=e||this.project.audioClock.currentTime;this.gainEnvelope.trigger(this._gain.gain,l)},e.prototype.release=function(t,e){if(this._heldNote===t){console.log("FM Bass released",t);var n=e||this.project.audioClock.currentTime;this.filterEnvelope.triggerRelease(this._filter.frequency,n),this.gainEnvelope.triggerRelease(this._gain.gain,n)}},e}(Ht),de=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),pe=function(t){function e(e,n,o,r){void 0===o&&(o=0),void 0===r&&(r=16);var i=t.call(this,e,o)||this;i.voices=[],i._nextVoice=0,i._held=[];for(var a=0;a<r;a++){var l=new n(e.audioClock);i.voices.push(l),l.output.connect(i.output)}return i}return de(e,t),e.prototype.trigger=function(t,e,n){void 0===n&&(n=1),console.log(this.name+" triggered voice "+this._nextVoice),this._held.find((function(e){return e.note==t}))?console.warn(this.name+" already holding note "+t):(this._held.push({note:t,type:"press",voice:this.voices[this._nextVoice],channel:0,velocity:n||1}),this.voices[this._nextVoice].trigger(t,e,n),this._nextVoice++,this._nextVoice>=this.voices.length&&(this._nextVoice=0))},e.prototype.release=function(t,e){console.log(this.name+" released voice "+t);var n=this._held.findIndex((function(e){return e.note==t}));n>=0?(this._held[n].voice.release(t,e),this._held.splice(n,1)):console.warn(this.name+" not holding note "+t)},e}(Ht),fe=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),me=function(t){function e(e){var n=t.call(this,e)||this;n.audioClock=e,n.name="FM Piano Voice",n.id="fm_piano_voice",n.fmRatio=1;var o=e.audioContext;n.modulatorGain1=o.createGain(),n.modulatorGain1.gain.value=100,n._gain1=o.createGain(),n._gain1.gain.value=0;var r=o.createBiquadFilter();return r.type="highpass",r.frequency.value=20,n._gain1.connect(r),r.connect(n.output),n.output.gain.value=.5,n._filter=o.createBiquadFilter(),n._filter.type="lowpass",n._filter.frequency.value=440,n._filter.Q.value=1,n._filter.connect(n._gain1),n.filterEnvelope=new $t,n.gainEnvelope=new $t({attack:0,hold:0,decay:2,sustain:0,release:.3}),n}return fe(e,t),e.prototype.trigger=function(t,e,n){var o,r;if(console.log("FMPianoVoice triggered",t,e,n),"running"===(null===(o=this._carrier1)||void 0===o?void 0:o.context.state)){var i=this._gain1.gain.value;this._gain1.gain.cancelScheduledValues(e),this._gain1.gain.setValueAtTime(i,e),this._gain1.gain.exponentialRampToValueAtTime(1,e+.01);try{this._carrier1.stop(e+.02),null===(r=this._modulator1)||void 0===r||r.stop(e+.02)}catch(t){console.error("Error stopping carrier/modulator",t)}}var a=function(t){return 440*Math.pow(2,(t-69)/12)}(t);this._carrier1=this.audioClock.audioContext.createOscillator(),this._carrier1.frequency.value=a,this._modulator1=this.audioClock.audioContext.createOscillator(),this._modulator1.frequency.value=a*this.fmRatio,this._carrier1.connect(this._gain1),this._modulator1.connect(this.modulatorGain1),this.modulatorGain1.connect(this._carrier1.frequency),this._carrier1.type="sine",this.output.gain.cancelScheduledValues(e),this.output.gain.setValueAtTime(n,e),this._carrier1.start(e),this._modulator1.start(e);var l=e||this.audioClock.currentTime;this.gainEnvelope.trigger(this._gain1.gain,l)},e.prototype.release=function(t,e){console.log("FM Bass released",t);var n=e||this.audioClock.currentTime;this.gainEnvelope.triggerRelease(this.output.gain,n)},e}(Xt),he=function(t){function e(e,n){void 0===n&&(n=0);var o=t.call(this,e,me,n)||this;return o.Window=oe,o.name="FM Piano",o.id="fm_piano",o.version="0.0.1",o.description="A simple FM piano synthesizer",o.author="Johnny Street",o.controllerGroups=[],o}return fe(e,t),e.prototype.getWindow=function(t){return this._window||(this._window=new oe(t,this)),this._window},e}(pe),ve=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ye=function(t){function e(e,n){var o,r,i,a,l,s,c,u,d,p;void 0===n&&(n={});var f=t.call(this,e,n.mixerChannel)||this;return f.settings=n,f.name="Sampler",f.id="sampler",f.author="Johnny Street",f.version="0.0.1",f.description="A simple sampler",f._sources=[],f._enableEnvelope=!1,f._cutBySelf=!0,f._volume=.9,f.cutGroup=0,f.cutByGroups=[],f.Window=oe,f._gainEnvelope=new $t({attack:null!==(r=null===(o=n.envelope)||void 0===o?void 0:o.attack)&&void 0!==r?r:0,hold:null!==(a=null===(i=n.envelope)||void 0===i?void 0:i.hold)&&void 0!==a?a:0,decay:null!==(s=null===(l=n.envelope)||void 0===l?void 0:l.decay)&&void 0!==s?s:0,sustain:null!==(u=null===(c=n.envelope)||void 0===c?void 0:c.sustain)&&void 0!==u?u:1,release:null!==(p=null===(d=n.envelope)||void 0===d?void 0:d.release)&&void 0!==p?p:0}),f}return ve(e,t),e.prototype.trigger=function(t,e,n){var o=this;if(this.settings.buffer){this._cutBySelf&&this.stop();var r=this.project.audioClock.audioContext.createGain();r.connect(this.output);var i=this.project.audioClock.audioContext.createBufferSource();i.buffer=this.settings.buffer,i.connect(r);var a={source:i,gain:r};this._sources.push(a),i.onended=function(){a.gain.disconnect(),o._sources.splice(o._sources.indexOf(a),1)},i.start(e),this._enableEnvelope&&this._gainEnvelope.trigger(r.gain,e,n)}else console.warn("No buffer loaded")},e.prototype.release=function(t,e){if(this._enableEnvelope)for(var n=0,o=this._sources;n<o.length;n++){var r=o[n];this._gainEnvelope.triggerRelease(r.gain.gain,e)}},e.prototype.stop=function(t){void 0===t&&(t=0);for(var e=0,n=this._sources;e<n.length;e++)n[e].source.stop(t)},e.prototype.loadUrl=function(t){var e=this;Bt.loadUrl(t,this.project.audioClock.audioContext).then((function(t){e.settings.buffer=t}))},e.prototype.loadFile=function(t){var e=this;Bt.loadFile(t,this.project.audioClock.audioContext).then((function(t){e.settings.buffer=t}))},e.prototype.loadBlob=function(t){var e=this;Bt.loadBlob(t,this.project.audioClock.audioContext).then((function(t){e.settings.buffer=t}))},e}(Ht),ge=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),_e=function(t){function e(e,n){var o=t.call(this,e,n)||this;o.ui=e,o.instrument=n;var r=document.createElement("div");r.classList.add("sampler-slots-container"),o._slotsContainer=r;for(var i=[{keyBinding:96,name:"0"},{keyBinding:97,name:"1"},{keyBinding:98,name:"2"},{keyBinding:99,name:"3"},{keyBinding:100,name:"4"},{keyBinding:101,name:"5"},{keyBinding:102,name:"6",cutByGroups:[3,6]},{keyBinding:103,name:"7"},{keyBinding:104,name:"8"},{keyBinding:105,name:"9"},{keyBinding:111,name:"/",cutByGroups:[0,10]},{keyBinding:106,name:"*"},{keyBinding:109,name:"-"},{keyBinding:107,name:"+"},{keyBinding:13,name:"Enter"}],a=0;a<i.length;a++){var l=new ye(o.ui.project,{name:i[a].name});n.samplers.push(l),l.loadUrl("./data/samples/kit1/".concat(a,".wav"))}return e.project.audioClock.on("stop",(function(){for(var t=0,e=n.samplers;t<e.length;t++)e[t].stop()})),o.content.appendChild(r),o}return ge(e,t),e}(oe),we=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),be=function(t){function e(e){var n=t.call(this,e)||this;return n.name="Multisampler",n.version="0.0.1",n.description="A simple multisampler",n.author="Johnny Street",n.id="multisampler",n.Window=_e,n.samplers=[],n.transpose=-24,n}return we(e,t),e.prototype.trigger=function(t,e,n){t+=this.transpose,console.log("Sampler trigger",t);var o=this.samplers[t];if(o){for(var r=0,i=this.samplers;r<i.length;r++){var a=i[r];a.cutByGroups.includes(o.cutGroup)&&a.release(t,e)}return o.trigger(t,e,n)}},e.prototype.release=function(t,e){void 0===e&&(e=0),t+=this.transpose,this.samplers[t]&&this.samplers[t].release(t,e)},e}(Ht);c.register("multisampler",be),c.register("fm_bass",ue),c.register("fm_piano",he);var Ee=document.createElement("div");Ee.classList.add("studio");var Oe=new l,xe=new Gt(new m(Oe,{title:"Basic",description:"Basic project template with Sampler and Synthesizer",tempo:120,instruments:[{name:"Multisampler",id:"multisampler"},{name:"FM Bass",id:"fm_bass"},{name:"FM Piano",id:"fm_piano"}],patterns:[{name:"Pattern 1",tracks:[]}],playlist:{tracks:[],events:[]},mixer:{channels:[{label:"Master",gain:1,mute:!1,solo:!1,outputs:[],effects:[]},{label:"Drums",gain:1,mute:!1,solo:!1,outputs:[0],effects:[]},{label:"Bass",gain:1,mute:!1,solo:!1,outputs:[0],effects:[]}]}}));Ee.appendChild(Oe.domElement),Ee.appendChild(xe.domElement),document.body.appendChild(Ee),monofy=t})();
//# sourceMappingURL=monofy-studio.js.map