{"version":3,"file":"monofy-studio.js","mappings":"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","sources":["webpack://monofy/webpack/bootstrap","webpack://monofy/webpack/runtime/make namespace object","webpack://monofy/../elements/src/EventObject.ts","webpack://monofy/../elements/src/managers/AudioManager.ts","webpack://monofy/./src/elements/components/AudioClock.ts","webpack://monofy/../elements/src/elements/BaseElement.ts","webpack://monofy/../elements/src/elements/SizableElement.ts","webpack://monofy/../elements/src/elements/DraggableWindow.ts","webpack://monofy/./src/plugins/plugins.ts","webpack://monofy/./src/abstracts/Instrument.ts","webpack://monofy/./src/abstracts/Synthesizer.ts","webpack://monofy/./src/abstracts/SynthesizerVoice.ts","webpack://monofy/./src/plugins/fmbass/FMBass.ts","webpack://monofy/./src/abstracts/InstrumentWindow.ts","webpack://monofy/../elements/src/animation.ts","webpack://monofy/../elements/src/elements/AudioCanvas.ts","webpack://monofy/./src/elements/components/SamplerSlot.ts","webpack://monofy/./src/plugins/sampler/Sampler.ts","webpack://monofy/./src/elements/Project.ts","webpack://monofy/../elements/src/elements/WindowContainer.ts","webpack://monofy/./src/constants.ts","webpack://monofy/./src/elements/components/Keyboard.ts","webpack://monofy/../elements/src/elements/SelectableGroup.ts","webpack://monofy/./src/elements/components/AudioCursor.ts","webpack://monofy/../elements/src/elements/SelectableElement.ts","webpack://monofy/./src/elements/components/PatternTrack.ts","webpack://monofy/./src/elements/windows/PatternWindow.ts","webpack://monofy/../elements/src/elements/ScrollPanel.ts","webpack://monofy/./src/elements/components/LyricCanvas.ts","webpack://monofy/../elements/src/elements/DialogPopup.ts","webpack://monofy/./src/elements/audioDialogs.ts","webpack://monofy/./src/elements/components/Grid.ts","webpack://monofy/./src/elements/components/SideKeyboard.ts","webpack://monofy/./src/elements/components/PianoRoll.ts","webpack://monofy/./src/elements/windows/PianoRollWindow.ts","webpack://monofy/./src/elements/components/PlaylistTrack.ts","webpack://monofy/./src/elements/windows/PlaylistWindow.ts","webpack://monofy/./src/elements/ProjectUI.ts","webpack://monofy/./src/index.ts","webpack://monofy/./src/schema.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export interface EventDataMap {\r\n  cancel: unknown;\r\n  start: unknown;\r\n  stop: unknown;\r\n  pause: unknown;\r\n  result: unknown;\r\n  update: unknown;\r\n  open: unknown;\r\n  close: unknown;\r\n  edit: unknown;\r\n  resize: unknown;\r\n  select: unknown;\r\n  scroll: unknown;\r\n}\r\n\r\nexport type BaseEvent = keyof EventDataMap;\r\n\r\nexport default abstract class EventObject<E extends BaseEvent = BaseEvent> {\r\n  private _events: {\r\n    [eventName in E]?: ((e: EventDataMap[eventName]) => void)[];\r\n  } = {};\r\n  private _onceEvents: {\r\n    [eventName in E]?: ((e: EventDataMap[eventName]) => void)[];\r\n  } = {};\r\n\r\n  on(eventName: E, callback: (e: EventDataMap[E]) => void) {\r\n    if (!this._events[eventName]) {\r\n      this._events[eventName] = [];\r\n    }\r\n    this._events[eventName]!.push(callback);\r\n\r\n    return this;\r\n  }\r\n\r\n  once(eventName: E, callback: (e: EventDataMap[E]) => void) {\r\n    if (!this._onceEvents[eventName]) {\r\n      this._onceEvents[eventName] = [];\r\n    }\r\n    this._onceEvents[eventName]!.push(callback);\r\n\r\n    return this;\r\n  }\r\n\r\n  emit(eventName: E, eventData?: EventDataMap[E]) {\r\n    const onceCallbacks = this._onceEvents[eventName];\r\n    if (onceCallbacks) {\r\n      for (const callback of onceCallbacks) {\r\n        try {\r\n          callback(eventData);\r\n        } catch (error) {\r\n          console.error(\r\n            `Error executing .once callback for event: ${eventName}`,\r\n            error\r\n          );\r\n        }\r\n      }\r\n      this._onceEvents[eventName] = undefined;\r\n    }\r\n\r\n    const callbacks = this._events[eventName];\r\n    if (callbacks) {\r\n      for (const callback of callbacks) {\r\n        try {\r\n          callback(eventData);\r\n        } catch (error) {\r\n          console.error(\r\n            `Error executing .on callback for event: ${eventName}`,\r\n            error\r\n          );\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","let audioContext: AudioContext | null = null;\r\n\r\nconst AudioContext = window.AudioContext || (window as any).webkitAudioContext;\r\n\r\nexport function getAudioContext() {\r\n  if (!audioContext) {\r\n    audioContext = new AudioContext({\r\n      latencyHint: \"interactive\",\r\n      sampleRate: 44100,\r\n    });\r\n    getAudioDevices().then((devices) => {\r\n      console.log(\"Audio devices\", devices);\r\n    });\r\n    console.log(\"Audio context created\");\r\n    return audioContext;\r\n  }\r\n  return audioContext;\r\n}\r\n\r\nexport async function getAudioDevices() {\r\n  if (\"setSinkId\" in AudioContext.prototype) {\r\n    const devices = await navigator.mediaDevices.enumerateDevices();\r\n    return devices;\r\n  }\r\n  return null;\r\n}\r\n","import EventObject from \"../../../../elements/src/EventObject\";\r\nimport { getAudioContext } from \"../../../../elements/src/managers/AudioManager\";\r\n\r\n/**\r\n * Represents an audio clock that provides functionality for controlling audio playback and scheduling events.\r\n */\r\nexport class AudioClock extends EventObject<\r\n  \"start\" | \"stop\" | \"pause\" | \"update\"\r\n> {\r\n  readonly domElement: HTMLDivElement;\r\n  readonly bpmInput: HTMLInputElement;\r\n  readonly playPauseButton: HTMLButtonElement;\r\n  readonly stopButton: HTMLButtonElement;\r\n  readonly currentTimeDisplay: HTMLSpanElement;\r\n  private _bpm: number = 100;\r\n  private _scheduledEvents: {\r\n    source: AudioBufferSourceNode;\r\n    time: number;\r\n    callback: () => void;\r\n  }[] = [];\r\n  private _startTime: number | null = null;\r\n\r\n  get startTime(): number | null {\r\n    return this._startTime;\r\n  }\r\n\r\n  get currentBeat(): number {\r\n    const elapsedTime =\r\n      this._startTime !== null\r\n        ? getAudioContext().currentTime - this._startTime\r\n        : 0;\r\n    return elapsedTime * (this._bpm / 60);\r\n  }\r\n\r\n  get isPlaying(): boolean {\r\n    return this._startTime != null && this._startTime >= 0;\r\n  }\r\n\r\n  get bpm(): number {\r\n    return this._bpm;\r\n  }\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"audio-clock\");\r\n\r\n    this.playPauseButton = document.createElement(\"button\");\r\n    this.playPauseButton.classList.add(\"audio-clock-play-pause\");\r\n    this.playPauseButton.textContent = \"Play\";\r\n\r\n    this.playPauseButton.addEventListener(\"click\", () => {\r\n      if (this.isPlaying) {\r\n        this.stop();\r\n      } else {\r\n        getAudioContext();\r\n        this.playPause();\r\n      }\r\n    });\r\n    this.domElement.appendChild(this.playPauseButton);\r\n    this.stopButton = document.createElement(\"button\");\r\n    this.stopButton.classList.add(\"audio-clock-stop\");\r\n    this.stopButton.textContent = \"Stop\";\r\n\r\n    this.stopButton.addEventListener(\"click\", () => {\r\n      this.stop();\r\n    });\r\n    this.domElement.appendChild(this.stopButton);\r\n\r\n    this.bpmInput = document.createElement(\"input\");\r\n    this.bpmInput.classList.add(\"audio-clock-bpm\");\r\n    this.bpmInput.type = \"number\";\r\n    this.bpmInput.value = \"120\";\r\n\r\n    this.bpmInput.addEventListener(\"input\", () => {\r\n      this._bpm = parseFloat(this.bpmInput.value);\r\n    });\r\n    this.domElement.appendChild(this.bpmInput);\r\n\r\n    this.currentTimeDisplay = document.createElement(\"span\");\r\n    this.currentTimeDisplay.classList.add(\"audio-clock-time\");\r\n    this.currentTimeDisplay.textContent = \"01:1\";\r\n\r\n    this.domElement.appendChild(this.currentTimeDisplay);\r\n  }\r\n\r\n  start(): void {\r\n    this._startTime = getAudioContext().currentTime;\r\n    console.log(\"Started at\", this._startTime);\r\n    requestAnimationFrame(this._render.bind(this));\r\n    this.emit(\"start\");\r\n  }\r\n\r\n  private _render(): void {\r\n    this._update(this.currentBeat);\r\n    this.emit(\"update\");\r\n    if (this.isPlaying) requestAnimationFrame(this._render.bind(this));\r\n  }\r\n\r\n  stop(): void {\r\n    this.emit(\"stop\");\r\n    this._startTime = null;\r\n\r\n    for (const { source } of this._scheduledEvents) {\r\n      source.stop();\r\n      source.disconnect();\r\n    }\r\n    this._scheduledEvents = [];\r\n\r\n    this._update(this.currentBeat);\r\n    this.playPauseButton.textContent = \"Play\";\r\n  }\r\n\r\n  restart() {\r\n    if (this.isPlaying) {\r\n      this._startTime = getAudioContext().currentTime;\r\n    }\r\n  }\r\n\r\n  playPause(): void {\r\n    if (this.isPlaying) {\r\n      this.stop(); // TODO: This should be a pause\r\n    } else {\r\n      const audioContext = getAudioContext();\r\n\r\n      const buffer = audioContext.createBuffer(1, 1, audioContext.sampleRate);\r\n      const source = audioContext.createBufferSource();\r\n      source.buffer = buffer;\r\n      source.connect(audioContext.destination);\r\n      source.start();\r\n\r\n      this.start();\r\n    }\r\n    this.playPauseButton.textContent = this.isPlaying ? \"Pause\" : \"Play\";\r\n  }\r\n\r\n  private _update(beat: number): void {\r\n    const bars = Math.floor(beat / 4) + 1;\r\n    const beats = Math.floor(beat % 4) + 1;\r\n    const timeString = `${bars\r\n      .toString()\r\n      .padStart(2, \"0\")}:${beats.toString()}`;\r\n    this.currentTimeDisplay.textContent = timeString;\r\n  }\r\n\r\n  /**\r\n   * Schedules UI event to occur at a specific time during audio playback. This should not be used for scheduling audio events.\r\n   */\r\n  scheduleEventAtTime(callback: () => void, time: number): void {\r\n    const audioContext = getAudioContext();\r\n    const emptyBuffer = audioContext.createBuffer(\r\n      1,\r\n      1,\r\n      audioContext.sampleRate\r\n    );\r\n    const source = audioContext.createBufferSource();\r\n    source.buffer = emptyBuffer;\r\n    source.connect(audioContext.destination);\r\n    source.onended = () => callback();\r\n    source.start(time);\r\n    this._scheduledEvents.push({ source, time, callback });\r\n  }\r\n\r\n  /**\r\n   * Schedules UI event to occur at a specific time during audio playback. This should not be used for scheduling audio events.\r\n   */\r\n  scheduleEventAtBeat(callback: () => void, beat: number): void {\r\n    const time = this._startTime! + (beat / this._bpm) * 60;\r\n    this.scheduleEventAtTime(callback, time);\r\n  }\r\n}\r\n","import EventObject, { EventDataMap } from \"../EventObject\";\r\n\r\nexport abstract class BaseElement<\r\n  T extends keyof EventDataMap,\r\n> extends EventObject<T> {\r\n  readonly domElement: HTMLElement;\r\n\r\n  constructor(tagName: string, className?: string) {\r\n    super();\r\n    this.domElement = document.createElement(tagName);\r\n    if (className) {\r\n      this.domElement.classList.add(className);\r\n    }\r\n  }\r\n\r\n  appendChild(child: BaseElement<keyof EventDataMap>) {\r\n    this.domElement.appendChild(child.domElement);\r\n    return this;\r\n  }\r\n\r\n  removeChild(child: BaseElement<keyof EventDataMap>) {\r\n    this.domElement.removeChild(child.domElement);\r\n    return this;\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { BaseElement } from \"./BaseElement\";\r\n\r\nexport abstract class SizableElement<\r\n  T extends keyof EventDataMap,\r\n> extends BaseElement<\"resize\" | T> {\r\n  private _resizing = false;\r\n  private _startX = 0;\r\n  private _startY = 0;\r\n  private _startWidth = 0;\r\n  private _startHeight = 0;\r\n  private _startTop = 0;\r\n  private _startLeft = 0;\r\n\r\n  private _resizeDirection: \"top\" | \"right\" | \"bottom\" | \"left\" | null = null;\r\n\r\n  constructor(tagName: string, className?: string) {\r\n    super(tagName, className);\r\n\r\n    this.domElement.addEventListener(\"pointermove\", (e) => {\r\n      const handle = this.getCurrentHandle(e);\r\n      if (handle === \"top\" || handle === \"bottom\") {\r\n        this.domElement.style.cursor = \"ns-resize\";\r\n      } else if (handle === \"left\" || handle === \"right\") {\r\n        this.domElement.style.cursor = \"ew-resize\";\r\n      } else {\r\n        this.domElement.style.cursor = \"auto\";\r\n      }\r\n    });\r\n\r\n    const onmove = (e: PointerEvent) => {\r\n      if (this._resizing) {\r\n        console.log(this._resizeDirection);\r\n\r\n        const dx = e.clientX - this._startX;\r\n        const dy = e.clientY - this._startY;\r\n\r\n        if (this._resizeDirection === \"right\") {\r\n          this.domElement.style.width = `${this._startWidth + dx}px`;\r\n        } else if (this._resizeDirection === \"bottom\") {\r\n          this.domElement.style.height = `${this._startHeight + dy}px`;\r\n        } else if (this._resizeDirection === \"left\") {\r\n          this.domElement.style.width = `${this._startWidth - dx}px`;\r\n          this.domElement.style.left = `${this._startLeft + dx}px`;\r\n        } else if (this._resizeDirection === \"top\") {\r\n          this.domElement.style.height = `${this._startHeight - dy}px`;\r\n          this.domElement.style.top = `${this._startTop + dy}px`;\r\n        }\r\n\r\n        this.emit(\"resize\", {\r\n          width: this.domElement.offsetWidth,\r\n          height: this.domElement.offsetHeight,\r\n        });\r\n      }\r\n    };\r\n\r\n    this.domElement.addEventListener(\"pointerdown\", (e) => {\r\n      e.preventDefault();\r\n      const handle = this.getCurrentHandle(e);\r\n      if (handle) {\r\n        window.addEventListener(\"pointermove\", onmove);\r\n        this.startResize(e, handle);\r\n      }\r\n      const onrelease = () => {\r\n        this.stopResize();\r\n        window.removeEventListener(\"pointermove\", onmove);\r\n        window.removeEventListener(\"pointerup\", onrelease);\r\n      };\r\n\r\n      window.addEventListener(\"pointerup\", onrelease);\r\n    });\r\n  }\r\n\r\n  protected startResize(\r\n    e: PointerEvent,\r\n    direction: \"top\" | \"right\" | \"bottom\" | \"left\"\r\n  ) {\r\n    console.log(\"startResize\", direction);\r\n    this._resizing = true;\r\n    this._startX = e.clientX;\r\n    this._startY = e.clientY;\r\n    this._startWidth = this.domElement.offsetWidth;\r\n    this._startHeight = this.domElement.offsetHeight;\r\n    this._startTop = this.domElement.offsetTop;\r\n    this._startLeft = this.domElement.offsetLeft;\r\n    this._resizeDirection = direction;\r\n  }\r\n\r\n  protected stopResize() {\r\n    this._resizing = false;\r\n    this._resizeDirection = null;\r\n  }\r\n\r\n  getCurrentHandle(e: PointerEvent) {\r\n    const rect = this.domElement.getBoundingClientRect();\r\n    const offsetX = e.clientX - rect.left;\r\n    const offsetY = e.clientY - rect.top;\r\n\r\n    if (offsetX > 0 && offsetX < 10) {\r\n      return \"left\";\r\n    } else if (rect.width - offsetX < 10) {\r\n      return \"right\";\r\n    } else if (offsetY > 0 && offsetY < 10) {\r\n      return \"top\";\r\n    } else if (rect.height - offsetY < 10) {\r\n      return \"bottom\";\r\n    }\r\n    return null;\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { SizableElement } from \"./SizableElement\";\r\n\r\nexport interface IWindowOptions {\r\n  title: string;\r\n  content?: HTMLElement;\r\n  persistent?: boolean;\r\n  width?: number;\r\n  height?: number;\r\n}\r\n\r\nexport class DraggableWindow<\r\n  T extends keyof EventDataMap,\r\n> extends SizableElement<\"update\" | \"resize\" | \"open\" | \"close\" | T> {\r\n  readonly titlebar: HTMLElement;\r\n  readonly content: HTMLElement;\r\n  private readonly persistent;\r\n  private readonly _title: HTMLElement;\r\n  private readonly _closeButton: HTMLButtonElement;\r\n  private _isDragging = false;\r\n  private _dragOffsetX = 0;\r\n  private _dragOffsetY = 0;\r\n  private _top = 0;\r\n  private _left = 0;\r\n\r\n  get isVisible() {\r\n    return this.domElement.style.display !== \"none\";\r\n  }\r\n\r\n  constructor(options: IWindowOptions) {\r\n    super(\"div\", \"draggable-window\");\r\n\r\n    this.persistent = options.persistent || false;\r\n\r\n    this.domElement.addEventListener(\"pointerdown\", () => {\r\n      this.domElement.parentElement!.appendChild(this.domElement);\r\n    });\r\n\r\n    this.titlebar = document.createElement(\"div\");\r\n    this.titlebar.className = \"window-titlebar\";\r\n    this.domElement.appendChild(this.titlebar);\r\n\r\n    this.titlebar.addEventListener(\"pointerdown\", (e) => {\r\n      this._isDragging = true;\r\n      this._dragOffsetX =\r\n        e.clientX - this.domElement.getBoundingClientRect().left;\r\n      this._dragOffsetY =\r\n        e.clientY -\r\n        this.domElement.getBoundingClientRect().top +\r\n        this.domElement.parentElement!.getBoundingClientRect().top +\r\n        this.domElement.parentElement!.scrollTop;\r\n\r\n      const ondrag = (e: PointerEvent) => {\r\n        if (this._isDragging) {\r\n          console.log(\"Dragging\");\r\n\r\n          let newTop = e.clientY - this._dragOffsetY;\r\n          let newLeft = e.clientX - this._dragOffsetX;\r\n\r\n          if (newTop < 0) {\r\n            newTop = 0;\r\n          }\r\n\r\n          if (newLeft < 0) {\r\n            newLeft = 0;\r\n          }\r\n\r\n          this.domElement.style.top = `${newTop}px`;\r\n          this.domElement.style.left = `${newLeft}px`;\r\n\r\n          this._top = newTop;\r\n          this._left = newLeft;\r\n        }\r\n      };\r\n\r\n      const onrelease = () => {\r\n        this._isDragging = false;\r\n        document.body.removeEventListener(\"pointermove\", ondrag);\r\n        document.body.removeEventListener(\"pointerup\", onrelease);\r\n      };\r\n\r\n      document.body.addEventListener(\"pointermove\", ondrag);\r\n      document.body.addEventListener(\"pointerup\", onrelease);\r\n    });\r\n\r\n    this._title = document.createElement(\"div\");\r\n    this._title.className = \"window-titlebar-title\";\r\n    this._title.textContent = options.title;\r\n    this.titlebar.appendChild(this._title);\r\n\r\n    this.content = document.createElement(\"div\");\r\n    this.content.className = \"window-content\";\r\n    this.domElement.appendChild(this.content);\r\n\r\n    this._closeButton = document.createElement(\"button\");\r\n    this._closeButton.className = \"window-close-button\";\r\n    this._closeButton.addEventListener(\"pointerdown\", (e) => {\r\n      if (e.button === 0) this.close();\r\n    });\r\n\r\n    this.titlebar.appendChild(this._closeButton);\r\n\r\n    const width = options.width || 640;\r\n    const height = options.height || 400;\r\n    this.setSize(width, height);\r\n\r\n    if (options.content) this.content.appendChild(options.content);\r\n  }\r\n\r\n  show(x?: number, y?: number) {\r\n    this.domElement.style.display = \"flex\";\r\n    if (y) this.domElement.style.top = `${y}px`;\r\n    if (x) this.domElement.style.left = `${x}px`;\r\n    setTimeout(() => {\r\n      this.domElement.parentElement?.appendChild(this.domElement);\r\n      this.emit(\"open\");\r\n    }, 1);\r\n  }\r\n\r\n  close() {\r\n    this.domElement.style.display = \"none\";\r\n    this.emit(\"close\");\r\n    if (!this.persistent) {\r\n      console.log(\"Removing window\", this);\r\n      this.domElement.remove();\r\n    }\r\n  }\r\n\r\n  setSize(width: number, height: number) {\r\n    this.domElement.style.width = `${width}px`;\r\n    this.domElement.style.height = `${height}px`;\r\n  }\r\n\r\n  setPosition(x: number, y: number) {\r\n    this.domElement.style.top = `${y}px`;\r\n    this.domElement.style.left = `${x}px`;\r\n  }\r\n\r\n  setTitle(title: string) {\r\n    this._title.textContent = title;\r\n  }\r\n}\r\n","import { EventDataMap } from \"../../../elements/src/EventObject\";\r\nimport { BaseElement } from \"../../../elements/src/elements/BaseElement\";\r\nimport { DraggableWindow } from \"../../../elements/src/elements/DraggableWindow\";\r\nimport { AudioClock } from \"../elements/components/AudioClock\";\r\nimport { ControllerGroup, IHasControls } from \"../schema\";\r\n\r\nexport abstract class Plugin\r\n  extends BaseElement<\"update\">\r\n  implements IHasControls\r\n{\r\n  abstract name: string;\r\n  abstract version: string;\r\n  abstract description: string;\r\n  abstract author: string;\r\n  abstract controllerGroups: ControllerGroup[];\r\n  abstract window: DraggableWindow<\"update\" | keyof EventDataMap>;\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(\"div\", \"plugin-container\");\r\n  }\r\n}\r\n\r\nexport abstract class Plugins {\r\n  static readonly plugins: (typeof Plugin)[] = [];\r\n\r\n  static register(plugin: typeof Plugin) {\r\n    if (Plugins.plugins.includes(plugin)) {\r\n      console.warn(\"Plugin already registered:\", plugin);\r\n      return;\r\n    }\r\n    Plugins.plugins.push(plugin);\r\n  }\r\n\r\n  static get(name: string) {\r\n    return this.plugins.find((plugin) => plugin.name === name);\r\n  }\r\n}\r\n","import { IInstrument } from \"../elements/IInstrument\";\r\nimport { AudioClock } from \"../elements/components/AudioClock\";\r\nimport { ISourceEvent } from \"../elements/components/SamplerSlot\";\r\nimport { Plugin } from \"../plugins/plugins\";\r\n\r\nexport abstract class Instrument extends Plugin implements IInstrument {\r\n\r\n  abstract id: string;\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(audioClock);\r\n  }\r\n\r\n  abstract trigger(\r\n    note: number,\r\n    when: number,\r\n    velocity: number | undefined\r\n  ): ISourceEvent | undefined;\r\n  abstract release(note: number): void;\r\n}\r\n","import { getAudioContext } from \"../../../elements/src/managers/AudioManager\";\r\nimport { SynthesizerVoice } from \"./SynthesizerVoice\";\r\nimport { AudioClock } from \"../elements/components/AudioClock\";\r\nimport { IKeyboardEvent } from \"../elements/components/Keyboard\";\r\nimport { ISynthesizerSettings } from \"../schema\";\r\nimport { Instrument } from \"./Instrument\";\r\nimport { InstrumentWindow } from \"./InstrumentWindow\";\r\n\r\ninterface ISynthesizerEvent extends IKeyboardEvent {\r\n  voice: SynthesizerVoice;\r\n}\r\n\r\nexport abstract class Synthesizer<T extends SynthesizerVoice>\r\n  extends Instrument\r\n  implements ISynthesizerSettings\r\n{\r\n  abstract readonly window: InstrumentWindow;\r\n  readonly voices: SynthesizerVoice[] = [];\r\n  private _nextVoice = 0;\r\n  private _gain: GainNode;\r\n  private _ctx: AudioContext;\r\n  private _held: ISynthesizerEvent[] = [];\r\n\r\n  get gain() {\r\n    return this._gain;\r\n  }\r\n\r\n  constructor(audioClock: AudioClock) {\r\n    super(audioClock);\r\n    this._ctx = getAudioContext();\r\n    this._gain = this._ctx.createGain();\r\n  }\r\n\r\n  addVoice(voice: T) {\r\n    this.voices.push(voice);\r\n  }\r\n\r\n  handleEvent(event: IKeyboardEvent) {\r\n    if (event.type == \"press\") {\r\n      console.log(this.name + \" triggered voice \" + this._nextVoice);\r\n\r\n      this._held.push({ ...event, voice: this.voices[this._nextVoice] });\r\n\r\n      this._nextVoice++;\r\n      if (this._nextVoice >= this.voices.length) {\r\n        this._nextVoice = 0;\r\n      }\r\n    } else if (event.type == \"release\") {\r\n      console.log(this.name + \" released voice \" + event);\r\n    } else {\r\n      console.error(this.name + \": Invalid event passed to trigger()\", event);\r\n    }\r\n  }\r\n}\r\n","import { getAudioContext } from \"../../../elements/src/managers/AudioManager\";\r\nimport { AudioClock } from \"../elements/components/AudioClock\";\r\nimport { ISynthesizerVoiceSettings } from \"../schema\";\r\n\r\nexport abstract class SynthesizerVoice implements ISynthesizerVoiceSettings {\r\n  _settings: ISynthesizerVoiceSettings | null = null;\r\n\r\n  get settings(): ISynthesizerVoiceSettings {\r\n    if (!this.settings) throw new Error(\"Voice not initialized\");\r\n    return this.settings;\r\n  }\r\n\r\n  private readonly _gain: GainNode;\r\n  private _note: number | null = null;\r\n  private _frequency: number | null = null;  \r\n\r\n  get gain() {\r\n    return this._gain.gain.value;\r\n  }\r\n\r\n  get note() {\r\n    return this._note;\r\n  }\r\n\r\n  get lfoNumber() {\r\n    return this.settings.lfoNumber;\r\n  }\r\n\r\n  get envelopeNumber() {\r\n    return this.settings.envelopeNumber;\r\n  }\r\n\r\n  get frequency() {\r\n    return this._frequency;\r\n  }\r\n\r\n  get detune() {\r\n    return this.settings.detune;\r\n  }\r\n\r\n  get oscillators() {\r\n    return this.settings.oscillators;\r\n  }\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    const audioContext = getAudioContext();\r\n    this._gain = audioContext.createGain();\r\n  }\r\n\r\n  loadSettings(settings: ISynthesizerVoiceSettings) {\r\n    this._settings = settings;\r\n    this._gain.gain.value = settings.gain;\r\n  }\r\n\r\n  trigger(note: number, velocity: number, time = 0) {\r\n    if (!this.settings) throw new Error(\"Voice not initialized\");\r\n\r\n    this._note = note;\r\n    this._frequency = 440 * Math.pow(2, (note - 69) / 12);\r\n    this._gain.gain.value = this.settings.gain * velocity;\r\n\r\n    // TODO\r\n  }\r\n\r\n  release(time = 0) {\r\n    if (!this.settings) throw new Error(\"Voice not initialized\");\r\n\r\n    this._note = null;\r\n    this._frequency = null;\r\n\r\n    // TODO\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { InstrumentWindow } from \"../../abstracts/InstrumentWindow\";\r\nimport { Synthesizer } from \"../../abstracts/Synthesizer\";\r\nimport { SynthesizerVoice } from \"../../abstracts/SynthesizerVoice\";\r\nimport { AudioClock } from \"../../elements/components/AudioClock\";\r\nimport { ISourceEvent } from \"../../elements/components/SamplerSlot\";\r\nimport { ControllerGroup } from \"../../schema\";\r\nimport { Plugins } from \"../plugins\";\r\n\r\nexport class FMBassVoice extends SynthesizerVoice {\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(audioClock);\r\n  }\r\n\r\n  trigger(note: number, when: number, velocity: number | undefined) {\r\n    console.log(\"FMBassVoice triggered\", note, when, velocity);\r\n  }\r\n\r\n  release(note: number) {\r\n    console.log(\"FMBassVoice released\", note);\r\n  }\r\n}\r\n\r\nexport class FMBass extends Synthesizer<FMBassVoice> {\r\n  readonly name = \"FM Bass\";\r\n  readonly id = \"fm_bass\";\r\n  readonly version = \"0.0.1\";\r\n  readonly description = \"A simple FM bass synthesizer\";\r\n  readonly author = \"Johnny Street\";\r\n  readonly controllerGroups: ControllerGroup[] = [];\r\n  readonly window: InstrumentWindow;\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(audioClock);\r\n\r\n    this.window = new DraggableWindow({\r\n      title: \"FM Bass\",\r\n      persistent: true,\r\n      content: this.domElement,\r\n    });\r\n  }\r\n\r\n  trigger(\r\n    note: number,\r\n    when: number,\r\n    velocity: number | undefined\r\n  ): ISourceEvent | undefined {\r\n    console.log(\"FM Bass triggered\", note, when, velocity);\r\n    return undefined;\r\n  }\r\n\r\n  release(note: number) {\r\n    console.log(\"FM Bass released\", note);\r\n  }\r\n}\r\n\r\nPlugins.register(FMBass);\r\n","import { DraggableWindow } from \"../../../elements/src/elements/DraggableWindow\";\r\n\r\nexport class InstrumentWindow extends DraggableWindow<\"update\"> {}","export async function triggerActive(elt: HTMLElement, timeout = 100) {  \r\n  elt.classList.toggle(\"active\", true);\r\n  setTimeout(() => {\r\n    elt.classList.toggle(\"active\", false);\r\n  }, timeout);\r\n}\r\n","import { getAudioContext } from \"../../../elements/src/managers/AudioManager\";\r\n\r\nexport class AudioCanvas {\r\n  domElement: HTMLDivElement;\r\n  canvas: HTMLCanvasElement;\r\n  ctx: CanvasRenderingContext2D;\r\n  buffer: AudioBuffer | null = null;\r\n\r\n  constructor(width = 800, height = 200, playOnClick = true) {\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"audio-canvas\");\r\n\r\n    this.canvas = document.createElement(\"canvas\");\r\n    this.canvas.width = width;\r\n    this.canvas.height = height;\r\n    this.domElement.appendChild(this.canvas);\r\n\r\n    if (playOnClick) {\r\n      this.canvas.addEventListener(\"click\", () => {\r\n        if (this.buffer) {\r\n          this.playBuffer(this.buffer);\r\n        }\r\n      });\r\n    }\r\n\r\n    this.ctx = this.canvas.getContext(\"2d\") as CanvasRenderingContext2D;\r\n  }\r\n\r\n  async generateAudio(\r\n    note: { label: string; note: number },\r\n    preview: boolean = false\r\n  ): Promise<AudioBuffer> {\r\n    const buffer: AudioBuffer = await new Promise((resolve, reject) => {\r\n      const req = {\r\n        text: note.label,\r\n        pitch: note.note,\r\n        rate: 0.9,\r\n      };\r\n      fetch(\"/api/tts/edge\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify(req),\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      })\r\n        .then((res) => res.arrayBuffer())\r\n        .then((data) => {\r\n          console.log(\"Audio buffer downloaded\", data);\r\n          getAudioContext().decodeAudioData(\r\n            data,\r\n            (audioBuffer: AudioBuffer) => {\r\n              this.buffer = audioBuffer;\r\n              if (preview) {\r\n                this.playBuffer(audioBuffer);\r\n              }\r\n\r\n              resolve(audioBuffer);\r\n            }\r\n          );\r\n        })\r\n        .catch((error) => {\r\n          console.error(\"Error downloading audio buffer\", error);\r\n          reject(error);\r\n        });\r\n    });\r\n\r\n    this.loadBuffer(buffer);\r\n\r\n    return buffer;\r\n  }\r\n\r\n  playBuffer(audioBuffer: AudioBuffer) {\r\n    const ctx = getAudioContext();\r\n    const source = ctx.createBufferSource();\r\n    source.buffer = audioBuffer;\r\n    source.connect(ctx.destination);\r\n    source.start();\r\n  }\r\n\r\n  loadBuffer(audioBuffer: AudioBuffer) {\r\n    this.buffer = audioBuffer;\r\n\r\n    const channelData = audioBuffer.getChannelData(0);\r\n    const bufferLength = channelData.length;\r\n    const sliceWidth = this.canvas.width / bufferLength;\r\n\r\n    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(0, this.canvas.height / 2);\r\n\r\n    for (let i = 0; i < bufferLength; i++) {\r\n      const x = i * sliceWidth;\r\n      const y = ((channelData[i] + 1) * this.canvas.height) / 2;\r\n\r\n      this.ctx.lineTo(x, y);\r\n    }\r\n\r\n    this.ctx.lineTo(this.canvas.width, this.canvas.height / 2);\r\n    this.ctx.stroke();\r\n  }\r\n}\r\n","import { triggerActive } from \"../../../../elements/src/animation\";\r\nimport { AudioCanvas } from \"../../../../elements/src/elements/AudioCanvas\";\r\nimport { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { getAudioContext } from \"../../../../elements/src/managers/AudioManager\";\r\nimport { ControllerGroup, ISamplerSlot, InstrumentType } from \"../../schema\";\r\nimport { AudioClock } from \"./AudioClock\";\r\n\r\nexport interface ISourceEvent {\r\n  source: AudioBufferSourceNode;\r\n  gain: GainNode;\r\n  cutByGroups: number[];\r\n  time: number;\r\n}\r\n\r\nexport class SamplerSlot extends BaseElement<\"update\"> implements ISamplerSlot {\r\n  private _nameElement;\r\n\r\n  type: InstrumentType = \"sampler\";\r\n  controllerGroups: ControllerGroup[] = [];\r\n  buffer: AudioBuffer | null = null;\r\n  velocity: number;\r\n  pan: number;\r\n  pitch: number;\r\n  randomPitch: number;\r\n  randomVelocity: number;\r\n  startPosition: number;\r\n  endPosition: number;\r\n  loop: boolean;\r\n  loopStart: number;\r\n  loopEnd: number;\r\n  protected _sources: ISourceEvent[] = [];\r\n  private _previewCanvas: AudioCanvas;\r\n\r\n  constructor(\r\n    readonly audioClock: AudioClock,\r\n    public name = \"\",\r\n    public keyBinding: number | null = null,\r\n    public cutGroup = -1,\r\n    readonly cutByGroups: number[] = []\r\n  ) {\r\n    super(\"div\", \"sampler-slot\");\r\n\r\n    this.name = name;\r\n    this.buffer = null;\r\n    this.keyBinding = keyBinding || null;\r\n    this.velocity = 1;\r\n    this.pan = 1;\r\n    this.pitch = 1;\r\n    this.randomPitch = 0;\r\n    this.randomVelocity = 0.05;\r\n    this.startPosition = 0;\r\n    this.endPosition = 0;\r\n    this.loop = false;\r\n    this.loopStart = 0;\r\n    this.loopEnd = 0;\r\n    this.cutGroup = cutGroup;\r\n    this.cutByGroups = cutByGroups;\r\n\r\n    this._previewCanvas = new AudioCanvas(200, 60);\r\n    this.domElement.appendChild(this._previewCanvas.domElement);\r\n\r\n    this._nameElement = document.createElement(\"div\");\r\n    this._nameElement.classList.add(\"sampler-slot-name\");\r\n    this.domElement.appendChild(this._nameElement);\r\n\r\n    this.domElement.addEventListener(\"pointerdown\", () => this.trigger());\r\n  }\r\n\r\n  async loadSample(name: string, url: string) {\r\n    const audioContext = getAudioContext();\r\n\r\n    this._nameElement.textContent = \"(Loading)\";\r\n\r\n    const response = await fetch(url);\r\n    if (!response.ok) {\r\n      this._nameElement.textContent = \"(Empty)\";\r\n      console.error(`Error loading sample: ${url}`, response.statusText);\r\n      return;\r\n    }\r\n\r\n    response\r\n      .arrayBuffer()\r\n      .then((buffer) => audioContext.decodeAudioData(buffer))\r\n      .then((audioBuffer) => {\r\n        this._nameElement.textContent = name;\r\n        this.buffer = audioBuffer;\r\n        this.emit(\"update\");\r\n        setTimeout(() => {\r\n          this._previewCanvas.loadBuffer(audioBuffer);\r\n        }, 1);\r\n      })\r\n      .catch((error) => {\r\n        this._nameElement.textContent = \"(Empty)\";\r\n        console.error(`Error loading sample: ${url}`, error);\r\n      });\r\n  }\r\n\r\n  trigger(beat = 0) {\r\n    if (!this.buffer) {\r\n      console.error(\"No buffer loaded for sample\", this.name);\r\n      return;\r\n    }\r\n\r\n    const audioContext = getAudioContext();\r\n    const source = audioContext.createBufferSource();\r\n    source.buffer = this.buffer;\r\n    source.playbackRate.value = this.pitch + Math.random() * this.randomPitch;\r\n    source.connect(audioContext.destination);\r\n\r\n    const gain = audioContext.createGain();\r\n    gain.gain.value = this.velocity + Math.random() * this.randomVelocity;\r\n    gain.connect(audioContext.destination);\r\n\r\n    source.connect(gain);\r\n\r\n    if (this.pan !== 1) {\r\n      const pan = audioContext.createStereoPanner();\r\n      pan.pan.value = this.pan;\r\n      source.connect(pan);\r\n      pan.connect(gain);\r\n    }\r\n\r\n    const time =\r\n      (this.audioClock.startTime || audioContext.currentTime) +\r\n      (beat * 60) / this.audioClock.bpm;\r\n\r\n    const entry: ISourceEvent = {\r\n      source,\r\n      gain,\r\n      cutByGroups: this.cutByGroups,\r\n      time,\r\n    };\r\n\r\n    this._sources.push(entry);\r\n\r\n    source.onended = () => {\r\n      source.disconnect();\r\n      gain.disconnect();\r\n      const index = this._sources.indexOf(entry);\r\n      if (index >= 0) this._sources.splice(index, 1);\r\n    };\r\n\r\n    console.log(beat, audioContext.currentTime, time);\r\n\r\n    if (this.startPosition >= 0) {\r\n      source.start(\r\n        time,\r\n        this.startPosition,\r\n        (this.endPosition || this.buffer.duration) - this.startPosition\r\n      );\r\n    } else {\r\n      source.start(time);\r\n    }\r\n\r\n    if (time === 0 || !this.audioClock.isPlaying) {\r\n      triggerActive(this.domElement);\r\n    } else {\r\n      this.audioClock.scheduleEventAtTime(\r\n        () => triggerActive(this.domElement),\r\n        time\r\n      );\r\n    }\r\n\r\n    if (this.loop) {\r\n      source.loop = true;\r\n      source.loopStart = this.loopStart;\r\n      source.loopEnd = this.loopEnd || this.buffer.duration;\r\n    }\r\n\r\n    return entry;\r\n  }\r\n\r\n  release(time: number) {\r\n    for (const entry of this._sources) {\r\n      if (time >= entry.time) this.cut(entry, time);\r\n    }\r\n  }\r\n\r\n  cut(entry: ISourceEvent, time = 0) {\r\n    const currentValue = entry.gain.gain.value;\r\n    entry.gain.gain.cancelScheduledValues(time);\r\n    entry.gain.gain.setValueAtTime(currentValue, time);\r\n    entry.gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.1);\r\n    entry.source.stop(time + 0.1);\r\n  }\r\n}\r\n","import { Instrument } from \"../../abstracts/Instrument\";\r\nimport { InstrumentWindow } from \"../../abstracts/InstrumentWindow\";\r\nimport { AudioClock } from \"../../elements/components/AudioClock\";\r\nimport { SamplerSlot } from \"../../elements/components/SamplerSlot\";\r\nimport { ControllerGroup } from \"../../schema\";\r\nimport { Plugins } from \"../plugins\";\r\n\r\nexport class Sampler extends Instrument {\r\n  readonly name = \"Sampler\";\r\n  readonly version = \"0.0.1\";\r\n  readonly description = \"A simple sampler\";\r\n  readonly author = \"Johnny Street\";\r\n  readonly id = \"sampler\";\r\n  readonly window: InstrumentWindow;\r\n\r\n  private readonly _slotsContainer: HTMLDivElement;\r\n\r\n  slots: SamplerSlot[] = [];\r\n  controllerGroups: ControllerGroup[] = [];\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(audioClock);\r\n    window.addEventListener(\"keydown\", (event) => this.onKeyDown(event));\r\n\r\n    const container = document.createElement(\"div\");\r\n    container.classList.add(\"sampler-slots-container\");\r\n    this._slotsContainer = container;\r\n\r\n    //keypad numbers 0-9\r\n    // then . / * + - Enter\r\n    const defaultSlots = [\r\n      { keyBinding: 96, name: \"0\" },\r\n      { keyBinding: 97, name: \"1\" },\r\n      { keyBinding: 98, name: \"2\" },\r\n      { keyBinding: 99, name: \"3\" },\r\n      { keyBinding: 100, name: \"4\" },\r\n      { keyBinding: 101, name: \"5\" },\r\n      { keyBinding: 102, name: \"6\", cutByGroups: [3, 6] },\r\n      { keyBinding: 103, name: \"7\" },\r\n      { keyBinding: 104, name: \"8\" },\r\n      { keyBinding: 105, name: \"9\" },\r\n      { keyBinding: 111, name: \"/\", cutByGroups: [0, 10] },\r\n      { keyBinding: 106, name: \"*\" },\r\n      { keyBinding: 109, name: \"-\" },\r\n      { keyBinding: 107, name: \"+\" },\r\n      { keyBinding: 13, name: \"Enter\" },\r\n    ];\r\n\r\n    for (let i = 0; i < 14; i++) {\r\n      const slot = new SamplerSlot(\r\n        this.audioClock,\r\n        defaultSlots[i].name,\r\n        defaultSlots[i].keyBinding,\r\n        i,\r\n        defaultSlots[i].cutByGroups\r\n      );\r\n      this.slots.push(slot);\r\n      container.appendChild(slot.domElement);\r\n      slot.loadSample(\"Sample\", `./data/samples/kit1/${i}.wav`);\r\n    }\r\n\r\n    audioClock.on(\"stop\", () => {\r\n      for (const slot of this.slots) {\r\n        slot.release(0);\r\n      }\r\n    });\r\n\r\n    this.domElement.appendChild(container);\r\n\r\n    this.window = new InstrumentWindow({\r\n      title: \"Sampler\",\r\n      persistent: true,\r\n      content: this.domElement,\r\n    });\r\n  }\r\n\r\n  trigger(note: number, channel: number | null, beat = 0) {\r\n    console.log(\"Sampler trigger\", note);\r\n    const slot = this.slots[note];\r\n    if (slot) {\r\n      for (const each of this.slots) {\r\n        if (each.cutByGroups.includes(slot.cutGroup)) {\r\n          each.release(beat);\r\n        }\r\n      }\r\n      return slot.trigger(beat);\r\n    }\r\n  }\r\n\r\n  release(note: number, time = 0): void {\r\n    if (this.slots[note]) {\r\n      this.slots[note].release(time);\r\n    }\r\n  }\r\n\r\n  onKeyDown(event: KeyboardEvent) {\r\n    //console.log(event.key, event.keyCode);\r\n    const slot = this.slots.find((slot) => slot.keyBinding === event.keyCode);\r\n    if (slot) {\r\n      event.preventDefault();\r\n      const note = this.slots.indexOf(slot);\r\n      this.trigger(note, null);\r\n    }\r\n  }\r\n}\r\n\r\nPlugins.register(Sampler);\r\n","import EventObject from \"../../../elements/src/EventObject\";\r\nimport { Instrument } from \"../abstracts/Instrument\";\r\nimport { FMBass } from \"../plugins/fmbass/FMBass\";\r\nimport { Sampler } from \"../plugins/sampler/Sampler\";\r\nimport { IPattern, IProject, ISequence, ITimelineSequence } from \"../schema\";\r\nimport { IInstrument } from \"./IInstrument\";\r\nimport { AudioClock } from \"./components/AudioClock\";\r\n\r\nexport class Project extends EventObject<\"update\"> implements IProject {\r\n  title = \"Untitled\";\r\n  description = \"\";\r\n  tempo = 120;\r\n  instruments: Instrument[] = [];\r\n  patterns: IPattern[] = [];\r\n  sequences: ISequence[] = [];\r\n  timeline: ITimelineSequence[] = [];\r\n\r\n  constructor(\r\n    readonly audioClock: AudioClock,\r\n    project?: IProject\r\n  ) {\r\n    super();\r\n    if (project) {\r\n      setTimeout(() => {\r\n        this.load(project);\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  serialize(): string {\r\n    return JSON.stringify({\r\n      title: this.title,\r\n      description: this.description,\r\n      tempo: this.tempo,\r\n      instruments: this.instruments.map((instrument) => {\r\n        return {\r\n          name: instrument.name,\r\n          controllerGroups: instrument.controllerGroups,\r\n        };\r\n      }),\r\n      patterns: this.patterns,\r\n      sequences: this.sequences,\r\n      timeline: this.timeline,\r\n    });\r\n  }\r\n\r\n  deserialize(data: string): void {\r\n    console.log(\"Project deserialize\", data);\r\n    const project = JSON.parse(data) as IProject;\r\n\r\n    // TODO error checking\r\n\r\n    this.load(project);\r\n  }\r\n\r\n  load(project: IProject): void {\r\n    console.log(\"Project load\", project);\r\n\r\n    this.title = project.title;\r\n    this.description = project.description;\r\n    this.tempo = project.tempo;\r\n    this.patterns = project.patterns;\r\n    this.timeline = project.timeline;\r\n    this.instruments = [];\r\n\r\n    for (const instrument of project.instruments as IInstrument[]) {\r\n      console.log(\"debug\", instrument);\r\n      if (instrument.id === \"sampler\") {\r\n        this.instruments.push(new Sampler(this.audioClock));\r\n      } else if (instrument.id === \"fm_bass\") {\r\n        this.instruments.push(new FMBass(this.audioClock));\r\n      } else {\r\n        console.error(\"Unknown instrument\", instrument);\r\n      }\r\n    }\r\n\r\n    console.log(\"emitting update...\");\r\n    this.emit(\"update\", { type: \"project\", value: this });\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { DraggableWindow } from \"./DraggableWindow\";\r\n\r\nexport class WindowContainer {\r\n  readonly domElement: HTMLDivElement;\r\n\r\n  windows: DraggableWindow<keyof EventDataMap>[] = [];\r\n  _draggingWindow: DraggableWindow<keyof EventDataMap> | null = null;\r\n\r\n  constructor() {\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.className = \"window-container\";\r\n    this.domElement.addEventListener(\"pointerdown\", () => {});\r\n  }\r\n\r\n  addWindow<T extends DraggableWindow<keyof EventDataMap>>(window: T) {\r\n    if (this.windows.includes(window)) {\r\n      console.warn(\"Window already added\", window);\r\n      return;\r\n    }\r\n    this.windows.push(window);\r\n    this.domElement.appendChild(window.domElement);\r\n  }\r\n}\r\n","export const DEFAULT_NOTE_HEIGHT = 20;\r\n\r\nexport const BOTTOM_ROW = [\r\n  90, 83, 88, 68, 67, 86, 71, 66, 72, 78, 74, 77, 188, 76, 190, 59, 191,\r\n];\r\n\r\nexport const TOP_ROW = [\r\n  81, 50, 87, 51, 69, 82, 53, 84, 54, 89, 55, 85, 73, 57, 79, 48, 80, 219, 61,\r\n  221,\r\n];\r\n\r\nexport const KEY_COLORS = [\r\n  \"white\",\r\n  \"black\",\r\n  \"white\",\r\n  \"white\",\r\n  \"black\",\r\n  \"white\",\r\n  \"black\",\r\n  \"white\",\r\n  \"white\",\r\n  \"black\",\r\n  \"white\",\r\n  \"black\",\r\n];\r\n\r\nexport const NOTE_NAMES = [\r\n  \"A\",\r\n  \"A#\",\r\n  \"B\",\r\n  \"C\",\r\n  \"C#\",\r\n  \"D\",\r\n  \"D#\",\r\n  \"E\",\r\n  \"F\",\r\n  \"F#\",\r\n  \"G\",\r\n  \"G#\",\r\n];\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { BOTTOM_ROW, TOP_ROW } from \"../../constants\";\r\n\r\nexport interface IKeyboardEvent {\r\n  type: \"press\" | \"release\";\r\n  note: number;\r\n}\r\n\r\nfunction keyToNote(keyCode: number) {\r\n  let note = -1;\r\n\r\n  if (BOTTOM_ROW.includes(keyCode)) {\r\n    note = BOTTOM_ROW.indexOf(keyCode);\r\n  } else if (TOP_ROW.includes(keyCode)) {\r\n    note = TOP_ROW.indexOf(keyCode) + 12;\r\n  }\r\n\r\n  return note;\r\n}\r\n\r\nexport class Keyboard extends BaseElement<\"update\"> {\r\n  constructor() {\r\n    super(\"div\", \"keyboard\");\r\n\r\n    const pressedKeys: number[] = [];\r\n\r\n    window.addEventListener(\"keydown\", (event) => {\r\n      //console.log(event.key, event.keyCode);\r\n\r\n      if (event.ctrlKey || event.altKey || event.shiftKey) return;\r\n\r\n      const target = event.target as HTMLElement;\r\n      if (target.tagName == \"INPUT\") return;\r\n\r\n      const note = keyToNote(event.keyCode);\r\n      if (note === -1 || pressedKeys.includes(note)) return;\r\n\r\n      pressedKeys.push(note);\r\n      this.emit(\"update\", { type: \"press\", note });\r\n    });\r\n\r\n    window.addEventListener(\"keyup\", (event) => {\r\n\r\n      const note = keyToNote(event.keyCode);\r\n      if (note === -1 || !pressedKeys.includes(note)) return;      \r\n\r\n      pressedKeys.splice(pressedKeys.indexOf(note), 1);\r\n      this.emit(\"update\", { type: \"release\", note });\r\n    });\r\n  }\r\n}\r\n","import { BaseElement } from \"./BaseElement\";\r\nimport { SelectableElement } from \"./SelectableElement\";\r\n\r\nexport class SelectableGroup<\r\n  T extends SelectableElement,\r\n> extends BaseElement<\"select\"> {\r\n  readonly selected: T[];\r\n\r\n  constructor(readonly items: T[]) {\r\n    super(\"div\", \"selectable-group\");\r\n    this.selected = [];\r\n    this.items.forEach(this.add.bind(this));\r\n  }\r\n\r\n  add(selectable: T) {\r\n    if (this.selected.indexOf(selectable) !== -1) {\r\n      console.warn(\"Already added\", selectable);\r\n    } else {\r\n      selectable.on(\"select\", () => {\r\n        for (const item of this.selected) {\r\n          item.domElement.classList.toggle(\"selected\", item === selectable);\r\n        }\r\n        if (selectable.selected) {\r\n          this.selected.push(selectable);\r\n        }\r\n        this.emit(\"select\", this);\r\n      });\r\n      this.domElement.appendChild(selectable.domElement);\r\n    }\r\n  }\r\n\r\n  remove(selectable: T) {\r\n    const index = this.items.indexOf(selectable);\r\n    if (index !== -1) {\r\n      this.items.splice(index, 1);\r\n      this.domElement.removeChild(selectable.domElement);\r\n    }\r\n  }\r\n}\r\n","import { AudioClock } from \"./AudioClock\";\r\n\r\nexport interface ICursorTimeline {\r\n  domElement: HTMLElement;\r\n  timeline: HTMLElement;\r\n  cursor: AudioCursor;\r\n  audioClock: AudioClock;\r\n  beatWidth: number;\r\n}\r\n\r\nexport class AudioCursor {\r\n  readonly domElement: HTMLDivElement;\r\n\r\n  constructor(readonly timeline: ICursorTimeline) {\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"audio-cursor\");\r\n\r\n    const clock = timeline.audioClock;\r\n\r\n    clock.on(\"update\", () => {\r\n      this.update();\r\n    });\r\n\r\n    clock.on(\"start\", () => {\r\n      this.domElement.style.transform = \"translateX(0)\";\r\n      this.domElement.style.display = \"block\";\r\n      this.domElement.parentElement?.appendChild(this.domElement);\r\n    });\r\n\r\n    clock.on(\"stop\", () => {\r\n      this.domElement.style.display = \"none\";\r\n    });\r\n  }\r\n\r\n  update() {\r\n    this.domElement.style.transform = `translateX(${\r\n      this.timeline.audioClock.currentBeat * this.timeline.beatWidth\r\n    }px)`;\r\n  }\r\n\r\n  hide() {\r\n    this.domElement.style.display = \"none\";\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { BaseElement } from \"./BaseElement\";\r\n\r\nexport abstract class SelectableElement<\r\n  T extends keyof EventDataMap = \"select\",\r\n> extends BaseElement<\"select\" | T> {\r\n  get selected() {\r\n    return this.domElement.classList.contains(\"selected\");\r\n  }\r\n\r\n  constructor(tagName: string, className?: string) {\r\n    super(tagName, className);\r\n\r\n    this.domElement.addEventListener(\"pointerdown\", () => {\r\n      this.domElement.classList.toggle(\"selected\");\r\n      this.emit(\"select\", this);\r\n    });\r\n  }\r\n}\r\n","import { triggerActive } from \"../../../../elements/src/animation\";\r\nimport { IEventItem, ISequence } from \"../../schema\";\r\nimport { ISourceEvent } from \"./SamplerSlot\";\r\nimport { Project } from \"../Project\";\r\nimport { Instrument } from \"../../abstracts/Instrument\";\r\nimport { SelectableElement } from \"../../../../elements/src/elements/SelectableElement\";\r\n\r\nexport class PatternTrack\r\n  extends SelectableElement<\"update\" | \"select\" | \"edit\">\r\n  implements ISequence\r\n{\r\n  private _canvas: HTMLCanvasElement;\r\n  private readonly _instrumentPanel: HTMLDivElement;\r\n  private readonly _indicator: HTMLDivElement;\r\n  port: number | null = null;\r\n  channel: number = 0;\r\n  events: IEventItem[] = [];\r\n\r\n  get canvas() {\r\n    return this._canvas;\r\n  }\r\n\r\n  get name() {\r\n    return this.instrument.name;\r\n  }\r\n\r\n  constructor(\r\n    readonly project: Project,\r\n    public instrument: Instrument\r\n  ) {\r\n    super(\"div\", \"pattern-track\");\r\n\r\n    this._instrumentPanel = document.createElement(\"div\");\r\n    this._instrumentPanel.classList.add(\"pattern-track-panel\");\r\n    this._instrumentPanel.addEventListener(\"pointerdown\", () => {\r\n      this.emit(\"select\", this);\r\n    });\r\n\r\n    const label = document.createElement(\"div\");\r\n    this._instrumentPanel.appendChild(label);\r\n    label.textContent = instrument.name;\r\n\r\n    const buttons = document.createElement(\"div\");\r\n    buttons.classList.add(\"pattern-track-buttons\");\r\n    this._instrumentPanel.appendChild(buttons);\r\n\r\n    const edit = document.createElement(\"button\");\r\n    edit.textContent = \"e\";\r\n    buttons.appendChild(edit);\r\n\r\n    const mute = document.createElement(\"button\");\r\n    mute.textContent = \"M\";\r\n    buttons.appendChild(mute);\r\n\r\n    const solo = document.createElement(\"button\");\r\n    solo.textContent = \"S\";\r\n    buttons.appendChild(solo);\r\n\r\n    this._indicator = document.createElement(\"div\");\r\n    this._indicator.classList.add(\"pattern-track-indicator\");\r\n    buttons.appendChild(this._indicator);\r\n\r\n    buttons.appendChild(mute);\r\n    buttons.appendChild(solo);\r\n\r\n    this._canvas = document.createElement(\"canvas\");\r\n    this._canvas.height = 100;\r\n    this._canvas.width = 1600;\r\n    this._canvas.classList.add(\"pattern-track-pattern\");\r\n\r\n    this._canvas.addEventListener(\"pointerdown\", () => {\r\n      this.emit(\"edit\", this);\r\n    });\r\n\r\n    this.domElement.appendChild(this._instrumentPanel);\r\n    this.domElement.appendChild(this._indicator);\r\n    this.domElement.appendChild(this._canvas);\r\n  }\r\n\r\n  trigger(note: number, beat = 0) {\r\n    const source = this.instrument.trigger(note, this.channel, beat);\r\n    if (beat > 0) {\r\n      this.project.audioClock.scheduleEventAtBeat(() => {\r\n        triggerActive(this._indicator);\r\n      }, beat);\r\n    } else {\r\n      triggerActive(this._indicator);\r\n    }\r\n    return source;\r\n  }\r\n\r\n  release(note: number, beat = 0) {\r\n    console.warn(\"TODO: PatternTrack release\", note, beat);\r\n  }\r\n\r\n  load(sequence: ISequence) {\r\n    this.events = sequence.events;\r\n  }\r\n\r\n  playback() {\r\n    if (!this.project.audioClock.isPlaying) {\r\n      console.warn(\"Playback cancelled\");\r\n      return;\r\n    }\r\n\r\n    let sourceEvent: ISourceEvent | undefined = undefined;\r\n\r\n    for (const event of this.events) {\r\n      sourceEvent = this.trigger(event.note, event.start);\r\n      if (event.domElement) {\r\n        this.project.audioClock.scheduleEventAtBeat(\r\n          () => event.domElement!.classList.toggle(\"active\", true),\r\n          event.start\r\n        );\r\n        this.project.audioClock.scheduleEventAtBeat(\r\n          () => event.domElement!.classList.toggle(\"active\", false),\r\n          event.start + event.duration\r\n        );\r\n      }\r\n    }\r\n\r\n    if (typeof sourceEvent !== \"undefined\" && \"source\" in sourceEvent) {\r\n      sourceEvent.source.onended = () => {\r\n        const nextLoop =\r\n          this.project.audioClock.currentBeat +\r\n          (4 - (this.project.audioClock.currentBeat % 4));\r\n        this.project.audioClock.scheduleEventAtBeat(() => {\r\n          this.project.audioClock.restart();\r\n          this.playback();\r\n        }, nextLoop);\r\n      };\r\n    }\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { SelectableGroup } from \"../../../../elements/src/elements/SelectableGroup\";\r\nimport { Instrument } from \"../../abstracts/Instrument\";\r\nimport { IPattern } from \"../../schema\";\r\nimport { Project } from \"../Project\";\r\nimport { AudioClock } from \"../components/AudioClock\";\r\nimport { AudioCursor, ICursorTimeline } from \"../components/AudioCursor\";\r\nimport { PatternTrack } from \"../components/PatternTrack\";\r\n\r\nexport class PatternWindow\r\n  extends DraggableWindow<\"select\" | \"edit\">\r\n  implements ICursorTimeline\r\n{\r\n  readonly trackContainer: SelectableGroup<PatternTrack>;\r\n  readonly cursor: AudioCursor;\r\n  readonly timeline: HTMLDivElement;\r\n\r\n  get tracks() {\r\n    return this.trackContainer.items;\r\n  }\r\n\r\n  get audioClock(): AudioClock {\r\n    return this.project.audioClock;\r\n  }\r\n\r\n  beatWidth = 20;\r\n  patterns: IPattern[] = [\r\n    {\r\n      name: \"Pattern 1\",\r\n      sequences: [],\r\n    },\r\n  ];\r\n\r\n  constructor(readonly project: Project) {\r\n    const tracks: PatternTrack[] = [];\r\n\r\n    const container = new SelectableGroup<PatternTrack>(tracks);\r\n    container.domElement.classList.add(\"pattern-track-container\");\r\n\r\n    super({\r\n      title: \"Pattern\",\r\n      persistent: true,\r\n      content: container.domElement,\r\n      width: 400,\r\n      height: 400,\r\n    });\r\n    this.trackContainer = container;\r\n    this.setSize(800, 400);\r\n\r\n    project.patterns = this.patterns;\r\n\r\n    this.timeline = document.createElement(\"div\");\r\n    this.timeline.style.position = \"absolute\";\r\n    this.timeline.style.width = \"calc(100% - 88px)\";\r\n    this.timeline.style.height = \"100%\";\r\n    this.timeline.style.left = \"88px\";\r\n    this.timeline.style.pointerEvents = \"none\";\r\n    this.timeline.style.overflow = \"hidden\";\r\n\r\n    this.cursor = new AudioCursor(this);\r\n    this.timeline.appendChild(this.cursor.domElement);\r\n\r\n    const canvas = this.domElement.querySelector(\"canvas\");\r\n    if (canvas) this.beatWidth = canvas.width / 16;\r\n\r\n    this.on(\"resize\", () => {\r\n      this.beatWidth = this.domElement.clientWidth / 16;\r\n    });\r\n\r\n    project.audioClock.on(\"start\", () => {\r\n      if (!project.audioClock.startTime) {\r\n        throw new Error(\"Audio clock start time is not set\");\r\n      }\r\n      for (const track of this.trackContainer.items) {\r\n        track.playback();\r\n      }\r\n    });\r\n\r\n    this.addPattern(\"Pattern 1\");\r\n\r\n    // container.appendChild(this.cursor.domElement);\r\n  }\r\n\r\n  loadProject(project: Project) {\r\n    this.patterns = project.patterns;\r\n    this.trackContainer.items.forEach((track) => {\r\n      this.trackContainer.remove(track);\r\n    });\r\n    this.trackContainer.items.length = 0;\r\n    for (let i = 0; i < project.instruments.length; i++) {\r\n      const track = this.addTrack(project.instruments[i]);\r\n      track.load(project.patterns[0].sequences[i]);\r\n    }\r\n  }\r\n\r\n  addPattern(name: string) {\r\n    console.log(\"Created pattern:\", name);\r\n    const pattern: IPattern = { name, sequences: [] };\r\n    this.patterns.push(pattern);\r\n  }\r\n\r\n  addTrack(instrument: Instrument) {\r\n    console.log(\"Added track + instrument:\", instrument);\r\n\r\n    const track = new PatternTrack(this.project, instrument);\r\n    if (this.trackContainer.items.length === 0) {\r\n      // HACK: add cursor to first track      \r\n      track.domElement.appendChild(this.timeline);\r\n    }\r\n\r\n    track.on(\"select\", (selectedTrack) => {\r\n      this.emit(\"select\", selectedTrack);\r\n    });\r\n\r\n    track.on(\"edit\", (selectedTrack) => {\r\n      console.log(\"PatternWindow edit\", selectedTrack);\r\n      this.emit(\"edit\", selectedTrack);\r\n    });\r\n\r\n    this.trackContainer.add(track);\r\n\r\n    return track;\r\n  }\r\n\r\n  removeTrack(track: PatternTrack) {\r\n    const index = this.trackContainer.items.indexOf(track);\r\n    if (index !== -1) {\r\n      this.trackContainer.items.splice(index, 1);\r\n      this.trackContainer.remove(track);\r\n    }\r\n  }\r\n\r\n  trigger(note: number) {\r\n    for (const track of this.trackContainer.items) {\r\n      if (track.selected) track.trigger(note);\r\n    }\r\n  }\r\n\r\n  play() {\r\n    if (this.audioClock.startTime == null) {\r\n      throw new Error(\"Audio clock start time is not set\");\r\n    }\r\n    for (const track of this.trackContainer.items) {\r\n      for (const event of track.events) {\r\n        track.trigger(\r\n          event.note,\r\n          this.audioClock.startTime + (event.start * 60) / this.audioClock.bpm\r\n        );\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { BaseElement } from \"./BaseElement\";\r\n\r\nexport abstract class ScrollPanel<\r\n  T extends keyof EventDataMap,\r\n> extends BaseElement<\"scroll\" | T> {\r\n  sensitivity = 50;\r\n  private linkedElements: HTMLElement[] = [];\r\n  private _scrollTop = 0;\r\n\r\n  get scrollTop() {\r\n    return this._scrollTop;\r\n  }\r\n\r\n  set scrollTop(value: number) {\r\n    const top = -value;\r\n    this._scrollTop = top;\r\n    this.scrollElement.style.transform = `translateY(${top}px)`;\r\n    for (const linkedElement of this.linkedElements) {\r\n      linkedElement.style.transform = `translateY(${top}px)`;\r\n    }\r\n  }\r\n\r\n  constructor(readonly scrollElement: HTMLElement) {\r\n    super(\"div\", \"scroll-panel\");\r\n    scrollElement.classList.add(\"scroll-panel-content\");\r\n\r\n    this.scrollElement.addEventListener(\"wheel\", (e) => {\r\n      e.preventDefault();\r\n      console.log(e.deltaY);\r\n      let top =\r\n        this._scrollTop + (e.deltaY > 0 ? -this.sensitivity : this.sensitivity);\r\n      const bottom = top + this.scrollElement.offsetHeight;\r\n      if (bottom < this.domElement.offsetHeight) {\r\n        top = this.domElement.offsetHeight - this.scrollElement.offsetHeight;\r\n      } else if (top > 0) {\r\n        top = 0;\r\n      }\r\n      this._scrollTop = top;\r\n      this.scrollElement.style.transform = `translateY(${top}px)`;\r\n      for (const linkedElement of this.linkedElements) {\r\n        linkedElement.style.transform = `translateY(${top}px)`;\r\n      }\r\n\r\n      this.emit(\"scroll\", e);\r\n    });\r\n  }\r\n\r\n  linkElement(element: HTMLElement) {\r\n    this.linkedElements.push(element);\r\n    element.classList.add(\"scroll-panel-content\");\r\n  }\r\n}\r\n","import { getAudioContext } from \"../../../../elements/src/managers/AudioManager\";\r\nimport { AudioCanvas } from \"../../../../elements/src/elements/AudioCanvas\";\r\n\r\nexport class LyricCanvas extends AudioCanvas {\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  async generateAudio(\r\n    note: { label: string; note: number },\r\n    preview: boolean = false\r\n  ): Promise<AudioBuffer> {\r\n    const buffer: AudioBuffer = await new Promise((resolve, reject) => {\r\n      const req = {\r\n        text: note.label,\r\n        pitch: note.note,\r\n        rate: 0.9,\r\n      };\r\n      fetch(\"/api/tts/edge\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify(req),\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      })\r\n        .then((res) => res.arrayBuffer())\r\n        .then((data) => {\r\n          console.log(\"Audio buffer downloaded\", data);\r\n          getAudioContext().decodeAudioData(\r\n            data,\r\n            (audioBuffer: AudioBuffer) => {\r\n              this.buffer = audioBuffer;\r\n              if (preview) {\r\n                this.playBuffer(audioBuffer);\r\n              }\r\n\r\n              resolve(audioBuffer);\r\n            }\r\n          );\r\n        })\r\n        .catch((error) => {\r\n          console.error(\"Error downloading audio buffer\", error);\r\n          reject(error);\r\n        });\r\n    });\r\n\r\n    this.loadBuffer(buffer);\r\n\r\n    return buffer;\r\n  }\r\n}\r\n","import { BaseElement } from \"./BaseElement\";\r\n\r\nexport class DialogPopup extends BaseElement<\"result\" | \"cancel\"> {  \r\n  closeButton: HTMLButtonElement;\r\n  okButton: HTMLButtonElement | undefined;\r\n  cancelButton: HTMLButtonElement | undefined;\r\n\r\n  get isVisibile() {\r\n    return this.domElement.style.display !== \"none\";\r\n  }\r\n\r\n  constructor(\r\n    private readonly ok: string | HTMLButtonElement = \"OK\",\r\n    private readonly cancel: string | HTMLButtonElement = \"Cancel\"\r\n  ) {\r\n    super(\"div\", \"dialog-popup\");\r\n\r\n    this.closeButton = document.createElement(\"button\");\r\n    this.closeButton.classList.add(\"window-close-button\");    \r\n    this.domElement.appendChild(this.closeButton);\r\n    this.closeButton.addEventListener(\"pointerdown\", () => {\r\n      this.domElement.style.display = \"none\";\r\n    });\r\n\r\n    if (ok instanceof HTMLButtonElement) {\r\n      this.okButton = ok;\r\n    } else if (ok) {\r\n      this.okButton = document.createElement(\"button\");\r\n      this.okButton.textContent = ok;\r\n      this.domElement.appendChild(this.okButton);\r\n    }\r\n\r\n    if (this.okButton) {\r\n      this.okButton.addEventListener(\"click\", () => {\r\n        this.emit(\"result\", this);\r\n      });\r\n    }\r\n\r\n    if (cancel instanceof HTMLButtonElement) {\r\n      this.cancelButton = cancel;\r\n    } else if (cancel) {\r\n      this.cancelButton = document.createElement(\"button\");\r\n      this.cancelButton.textContent = cancel;\r\n      this.domElement.appendChild(this.cancelButton);\r\n    }\r\n\r\n    if (this.cancelButton) {\r\n      this.cancelButton.addEventListener(\"click\", () => {\r\n        this.emit(\"cancel\", this);\r\n      });\r\n    }\r\n  }\r\n\r\n  show(x: number, y: number, targetObject?: unknown) { /* eslint-disable-line @typescript-eslint/no-unused-vars */\r\n    this.domElement.style.display = \"block\";\r\n    this.domElement.style.left = `${x}px`;\r\n    this.domElement.style.top = `${y}px`;\r\n    this.domElement.parentElement?.appendChild(this.domElement);\r\n  }\r\n\r\n  hide() {\r\n    this.domElement.style.display = \"none\";\r\n  }\r\n}\r\n","import { LyricCanvas } from \"./components/LyricCanvas\";\r\nimport { DialogPopup } from \"../../../elements/src/elements/DialogPopup\";\r\nimport { IEventItem } from \"../schema\";\r\n\r\nexport class PianoRollDialog extends DialogPopup {\r\n  domElement: HTMLDivElement;\r\n  closeButton: HTMLButtonElement;\r\n  saveButton: HTMLButtonElement;\r\n  note: IEventItem | null = null;\r\n\r\n  constructor(public onsave: (note: IEventItem) => void) {\r\n    super();\r\n\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"piano-roll-dialog\");\r\n\r\n    this.closeButton = document.createElement(\"button\");\r\n    this.closeButton.classList.add(\"window-close-button\");\r\n    this.domElement.appendChild(this.closeButton);\r\n    this.closeButton.addEventListener(\"click\", () => {\r\n      this.domElement.style.display = \"none\";\r\n    });\r\n\r\n    this.saveButton = document.createElement(\"button\");\r\n    this.saveButton.textContent = \"Save\";\r\n    this.domElement.appendChild(this.saveButton);\r\n    this.saveButton.addEventListener(\"click\", () => {\r\n      this.onsave(this.note!);\r\n    });\r\n  }\r\n\r\n  override show(x: number, y: number, note: IEventItem) {\r\n    super.show(x, y, note);\r\n    this.note = note;\r\n    this.domElement.parentElement?.appendChild(this.domElement);\r\n  }\r\n}\r\n\r\nexport class LyricEditorDialog extends PianoRollDialog {\r\n  textInput: HTMLInputElement;\r\n  audioCanvas: LyricCanvas;\r\n  pitchSlider: HTMLInputElement;\r\n  constructor(onsave: (note: IEventItem) => void) {\r\n    super(onsave);\r\n    this.domElement.classList.add(\"piano-roll-note-editor\");\r\n    this.domElement.style.display = \"none\";\r\n\r\n    this.textInput = document.createElement(\"input\");\r\n    this.textInput.setAttribute(\"placeholder\", \"Note lyric\");\r\n    this.textInput.classList.add(\"lyric-editor-text\");\r\n    this.textInput.type = \"text\";\r\n    this.domElement.appendChild(this.textInput);\r\n\r\n    this.pitchSlider = document.createElement(\"input\");\r\n    this.pitchSlider.classList.add(\"lyric-editor-pitch\");\r\n    this.pitchSlider.type = \"range\";\r\n    this.pitchSlider.min = \"-0.5\";\r\n    this.pitchSlider.max = \"0.5\";\r\n    this.pitchSlider.step = \"0.01\";\r\n    this.pitchSlider.value = \"0\";\r\n    this.pitchSlider.addEventListener(\"input\", () => {\r\n      this.note!.note = parseFloat(this.pitchSlider.value);\r\n    });\r\n    this.domElement.appendChild(this.pitchSlider);\r\n\r\n    this.audioCanvas = new LyricCanvas();\r\n    this.domElement.appendChild(this.audioCanvas.domElement);\r\n\r\n    this.saveButton.addEventListener(\"click\", () => {\r\n      this.audioCanvas.domElement.style.display = \"block\";\r\n      // this.audioCanvas.generateAudio(this.note!, true).then((buffer) => {\r\n      //   this.note!.audio = buffer;\r\n      // });\r\n      // this.onsave(this.note!);\r\n    });\r\n  }\r\n\r\n  show(x: number, y: number, note: IEventItem) {\r\n    super.show(x, y, note);\r\n    this.textInput.value = this.note?.label || \"\";\r\n    // if (this.note?.audio) {\r\n    //   this.audioCanvas.loadBuffer(this.note.audio);\r\n    //   this.audioCanvas.domElement.style.display = \"block\";\r\n    // } else {\r\n    //   this.audioCanvas.domElement.style.display = \"none\";\r\n    // }\r\n  }\r\n}\r\n","import { ScrollPanel } from \"../../../../elements/src/elements/ScrollPanel\";\r\nimport { DEFAULT_NOTE_HEIGHT, NOTE_NAMES } from \"../../constants\";\r\nimport { PatternTrack } from \"./PatternTrack\";\r\nimport { LyricEditorDialog } from \"../audioDialogs\";\r\nimport { IEventItem } from \"../../schema\";\r\n\r\n\r\nfunction getNoteNameFromPitch(pitch: number): string {\r\n  const note = NOTE_NAMES[pitch % NOTE_NAMES.length];\r\n  return `${note}${Math.floor(pitch / NOTE_NAMES.length)}`;\r\n}\r\n\r\nconst NOTE_HANDLE_WIDTH = 6;\r\n\r\nexport class GridItem {\r\n  note: number;\r\n  start: number;\r\n  duration: number;\r\n  velocity: number = 0.8;\r\n  label: string | \"\" = \"\";\r\n  domElement: HTMLDivElement;\r\n  noteLabel: HTMLDivElement;\r\n  lyricLabel: HTMLDivElement;\r\n  audio: AudioBuffer | null = null;\r\n\r\n  constructor(\r\n    private readonly grid: Grid,\r\n    item: IEventItem\r\n  ) {\r\n    this.note = item.note;\r\n    this.start = item.start;\r\n    this.duration = item.duration;\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"piano-roll-note\");\r\n    this.domElement.style.height = `${grid.noteHeight}px`;\r\n\r\n    this.noteLabel = document.createElement(\"div\");\r\n    this.noteLabel.classList.add(\"piano-roll-note-label\");\r\n    this.noteLabel.textContent = getNoteNameFromPitch(this.note);\r\n    this.domElement.appendChild(this.noteLabel);\r\n\r\n    this.lyricLabel = document.createElement(\"div\");\r\n    this.lyricLabel.classList.add(\"piano-roll-note-lyric\");\r\n    this.domElement.appendChild(this.lyricLabel);\r\n\r\n    if (item.label) this.lyricLabel.textContent = item.label;\r\n\r\n    console.log(\"GridItem\", this);\r\n\r\n    grid.gridElement.appendChild(this.domElement);\r\n  }\r\n}\r\n\r\nexport class Grid extends ScrollPanel<\"select\" | \"update\"> {\r\n  readonly domElement: HTMLDivElement;\r\n  readonly gridElement: HTMLDivElement;\r\n  readonly previewCanvas: HTMLCanvasElement;\r\n  readonly noteHeight = DEFAULT_NOTE_HEIGHT;\r\n  readonly beatWidth = 100;\r\n  readonly noteEditor: LyricEditorDialog;\r\n  private _currentNote: IEventItem | null = null;\r\n  private _dragMode: string | null = null;\r\n  private _quantize: number = 0.25;\r\n  private _dragOffset: number = 0;\r\n  private _track: PatternTrack | null = null;\r\n  readonly scrollElement: HTMLDivElement;\r\n\r\n  constructor() {\r\n    const gridElement = document.createElement(\"div\");\r\n\r\n    super(gridElement);\r\n\r\n    this.scrollElement = gridElement;\r\n\r\n    this.domElement = document.createElement(\"div\");\r\n\r\n    this.gridElement = gridElement;\r\n\r\n    this.domElement.classList.add(\"piano-roll-grid-container\");\r\n    this.gridElement.classList.add(\"piano-roll-grid\");\r\n\r\n    this.gridElement.addEventListener(\"dragstart\", (event) => {\r\n      event.preventDefault();\r\n    });\r\n\r\n    this.previewCanvas = document.createElement(\"canvas\");\r\n    this.previewCanvas.style.imageRendering = \"pixelated\";\r\n\r\n    const rowBackgroundCanvas = document.createElement(\"canvas\");\r\n    rowBackgroundCanvas.style.imageRendering = \"pixelated\";\r\n    rowBackgroundCanvas.width = this.beatWidth * 4;\r\n    rowBackgroundCanvas.height = this.noteHeight;\r\n    console.log(\"debug\", rowBackgroundCanvas.width, rowBackgroundCanvas.height);\r\n    const ctx = rowBackgroundCanvas.getContext(\"2d\");\r\n    // disable anti-alias\r\n\r\n    if (ctx) {\r\n      ctx.strokeStyle = \"#666\";\r\n      ctx.lineWidth = 0.5;\r\n      for (let j = 1; j < 4; j++) {\r\n        ctx.beginPath();\r\n        ctx.moveTo(j * this.beatWidth, 0);\r\n        ctx.lineTo(j * this.beatWidth, this.noteHeight);\r\n        ctx.stroke();\r\n      }\r\n      ctx.lineWidth = 1;\r\n      ctx.strokeStyle = \"white\";\r\n      ctx.beginPath();\r\n      ctx.moveTo(0, 0);\r\n      ctx.lineTo(0, this.noteHeight);\r\n      ctx.stroke();\r\n    }\r\n    for (let i = 0; i < 88; i++) {\r\n      const row = document.createElement(\"div\");\r\n      row.classList.add(\"piano-roll-grid-row\");\r\n      row.style.height = `${this.noteHeight}px`;\r\n      this.gridElement.appendChild(row);\r\n      const base64 = rowBackgroundCanvas.toDataURL();\r\n      row.style.backgroundImage = `url(${base64})`;\r\n      row.style.backgroundRepeat = \"repeat\";\r\n    }\r\n    this.domElement.appendChild(this.gridElement);\r\n\r\n    this.noteEditor = new LyricEditorDialog((note) => {\r\n      const input = this.noteEditor.domElement.querySelector(\r\n        \".lyric-editor-text\"\r\n      ) as HTMLInputElement;\r\n      note.label = input?.value || \"\";\r\n    });\r\n\r\n    document.body.appendChild(this.noteEditor.domElement);\r\n\r\n    this.gridElement.addEventListener(\"pointerdown\", (event) => {\r\n      if (!this._track) throw new Error(\"No track\");\r\n\r\n      if (!this._track.events) throw new Error(\"No events\");\r\n\r\n      event.preventDefault();\r\n\r\n      this._dragOffset = event.layerX;\r\n\r\n      if (this.noteEditor.domElement.style.display === \"block\") {\r\n        this.noteEditor.domElement.style.display = \"none\";\r\n        return;\r\n      }\r\n\r\n      if (\r\n        event.target instanceof HTMLDivElement &&\r\n        event.target.classList.contains(\"piano-roll-note\")\r\n      ) {\r\n        this.gridElement.classList.add(\"dragging\");\r\n        const note = this._track.events.find(\r\n          (n) => n.domElement === event.target\r\n        );\r\n\r\n        if (event.ctrlKey || event.button === 1) {\r\n          if (note)\r\n            this.noteEditor.show(event.clientX + 20, event.clientY - 5, note);\r\n          else this.noteEditor.domElement.style.display = \"none\";\r\n        }\r\n\r\n        if (note) {\r\n          this._currentNote = note;\r\n\r\n          if (event.button === 2) {\r\n            this.remove(note);\r\n            this._currentNote = null;\r\n          } else {\r\n            note.domElement!.parentElement?.appendChild(note.domElement!);\r\n            if (this._dragOffset < NOTE_HANDLE_WIDTH) {\r\n              this._dragMode = \"start\";\r\n            } else if (\r\n              note.domElement!.offsetWidth - this._dragOffset <\r\n              NOTE_HANDLE_WIDTH\r\n            ) {\r\n              this._dragMode = \"end\";\r\n            } else {\r\n              this._dragMode = \"move\";\r\n            }\r\n          }\r\n        }\r\n      } else if (event.button !== 0) return;\r\n      else if (event.target === this.gridElement) {\r\n        this.gridElement.classList.add(\"dragging\");\r\n        const pitch = 87 - Math.floor(event.layerY / this.noteHeight);\r\n\r\n        let start = event.layerX / this.beatWidth;\r\n        start = Math.round(start / this._quantize) * this._quantize;\r\n        console.log(\"start\", start, event.layerX);\r\n\r\n        const item: IEventItem = {\r\n          note: pitch,\r\n          start: start,\r\n          velocity: 100,\r\n          duration: 0.25,\r\n          label: \"\",\r\n          domElement: undefined\r\n        };\r\n\r\n        this._currentNote = this.add(item);\r\n        this._currentNote.domElement!.style.top = `${\r\n          (87 - this._currentNote.note) * this.noteHeight\r\n        }px`;\r\n        this._currentNote.domElement!.style.left = `${\r\n          this._currentNote.start * this.beatWidth\r\n        }px`;\r\n        this._dragMode = \"end\";\r\n\r\n        this.emit(\"select\", this._currentNote);\r\n      }\r\n\r\n      this.emit(\"update\", this);\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointerup\", () => {\r\n      this.gridElement.classList.remove(\"dragging\");\r\n      this._currentNote = null;\r\n\r\n      this.emit(\"update\", this);\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointerleave\", () => {\r\n      this.gridElement.classList.remove(\"dragging\");\r\n      if (this._currentNote) {\r\n        this.remove(this._currentNote);\r\n        this._currentNote = null;\r\n      }\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"contextmenu\", (event) => {\r\n      event.preventDefault();\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointermove\", (event) => {\r\n      if (this._currentNote && event.buttons === 1) {\r\n        if (this._dragMode === \"start\") {\r\n          const oldStart = this._currentNote.start;\r\n          this._currentNote.start = event.layerX / this.beatWidth;\r\n          this._currentNote.start =\r\n            Math.round(this._currentNote.start / this._quantize) *\r\n            this._quantize;\r\n          this._currentNote.duration =\r\n            oldStart - this._currentNote.start + this._currentNote.duration;\r\n          this._currentNote.domElement!.style.left = `${\r\n            this._currentNote.start * this.beatWidth\r\n          }px`;\r\n          this._currentNote.domElement!.style.width = `${\r\n            this._currentNote.duration * this.beatWidth\r\n          }px`;\r\n        } else if (this._dragMode === \"end\") {\r\n          this._currentNote.duration =\r\n            event.layerX / this.beatWidth - this._currentNote.start;\r\n\r\n          // quantize\r\n          this._currentNote.duration =\r\n            Math.round(this._currentNote.duration / this._quantize) *\r\n            this._quantize;\r\n\r\n          this._currentNote.domElement!.style.width = `${\r\n            this._currentNote.duration * this.beatWidth\r\n          }px`;\r\n        } else if (this._dragMode === \"move\") {\r\n          this._currentNote.start =\r\n            (event.layerX - this._dragOffset) / this.beatWidth;\r\n          this._currentNote.start =\r\n            Math.round(this._currentNote.start / this._quantize) *\r\n            this._quantize;\r\n          this._currentNote.domElement!.style.left = `${\r\n            this._currentNote.start * this.beatWidth\r\n          }px`;\r\n        } else {\r\n          return;\r\n        }\r\n\r\n        this.emit(\"update\", this);\r\n      }\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointerup\", () => {\r\n      this.gridElement.classList.remove(\"dragging\");\r\n      if (this._currentNote) {\r\n        this._currentNote.domElement!.style.pointerEvents = \"auto\";\r\n      }\r\n      this._currentNote = null;\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointerleave\", () => {\r\n      this.gridElement.classList.remove(\"dragging\");\r\n      if (this._currentNote) {\r\n        this._currentNote.domElement!.style.pointerEvents = \"auto\";\r\n      }\r\n      this._currentNote = null;\r\n    });\r\n  }\r\n\r\n  add(event: IEventItem) {\r\n    if (!this._track) throw new Error(\"add() No track!\");\r\n    const item = new GridItem(this, event);\r\n    this._track.events.push(item);\r\n    console.log(\"Grid: add\", event);\r\n    return item;\r\n  }\r\n\r\n  remove(event: IEventItem) {\r\n    if (!this._track) throw new Error(\"remove() No track!\");\r\n    this._track.events.splice(this._track.events.indexOf(event), 1);\r\n    this.gridElement.removeChild(event.domElement!);\r\n  }\r\n\r\n  load(track: PatternTrack) {\r\n    console.log(\"Grid: load\", track.events);\r\n    this._track?.events.forEach((event) => event.domElement!.remove());\r\n    this._track = track;\r\n    track.events.forEach((event) => {\r\n      this.gridElement.appendChild(event.domElement!);\r\n    });\r\n  }\r\n\r\n  renderToCanvas(canvas: HTMLCanvasElement, color: string) {\r\n    if (!this._track) throw new Error(\"renderToCanvas() No track!\");\r\n\r\n    // find lowest note\r\n    let lowestNote = 88;\r\n    this._track.events.forEach((note) => {\r\n      if (note.note < lowestNote) lowestNote = note.note;\r\n    });\r\n\r\n    // find highest note\r\n    let highestNote = 0;\r\n    this._track.events.forEach((note) => {\r\n      if (note.note > highestNote) highestNote = note.note;\r\n    });\r\n\r\n    highestNote += 12;\r\n    lowestNote -= 12;\r\n\r\n    const ctx = canvas.getContext(\"2d\") as CanvasRenderingContext2D;\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n    let padded_scale = canvas.height / (highestNote - lowestNote + 1);\r\n\r\n    if (padded_scale > 2) {\r\n      padded_scale = 2;\r\n    }\r\n\r\n    this._track.events.forEach((note) => {\r\n      const y = canvas.height - (note.note - lowestNote + 1) * padded_scale;\r\n      const x = note.start * this.beatWidth;\r\n      const width = note.duration * this.beatWidth;\r\n      ctx.fillStyle = color;\r\n      ctx.fillRect(x, y, width, padded_scale);\r\n    });\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport {\r\n  DEFAULT_NOTE_HEIGHT,\r\n  KEY_COLORS,\r\n  NOTE_NAMES,\r\n} from \"../../constants\";\r\nimport { IKeyboardEvent } from \"./Keyboard\";\r\n\r\nexport class SideKeyboard extends BaseElement<\"update\"> {  \r\n  keys: HTMLDivElement[] = [];\r\n  noteHeight = DEFAULT_NOTE_HEIGHT;\r\n\r\n  constructor() {\r\n\r\n    super(\"div\", \"piano-roll-keyboard\");\r\n\r\n    this.redraw();\r\n\r\n    this.domElement.addEventListener(\"pointerdown\", (e) => {\r\n      e.preventDefault();\r\n      const key = e.target as HTMLDivElement;\r\n\r\n      if (key.classList.contains(\"piano-roll-keyboard-key\")) {\r\n        const note_index = this.keys.indexOf(key);\r\n        console.log(\"key\", key.textContent, note_index);        \r\n        key.classList.add(\"active\");\r\n        this.emit(\"update\", { type: \"press\", note: note_index } as IKeyboardEvent);\r\n        const pointerup = () => {\r\n          key.classList.remove(\"active\");\r\n          this.emit(\"update\", { type: \"release\", note: note_index } as IKeyboardEvent);\r\n          window.removeEventListener(\"pointerup\", pointerup);\r\n        };\r\n\r\n        window.addEventListener(\"pointerup\", () => pointerup());\r\n      }\r\n    });\r\n  }\r\n\r\n  redraw() {\r\n    this.domElement.innerHTML = \"\";\r\n\r\n    for (let i = 87; i >= 0; i--) {\r\n      const key = document.createElement(\"div\");\r\n      key.classList.add(\"piano-roll-keyboard-key\");\r\n      key.style.height = `${this.noteHeight}px`;\r\n      // key.style.bottom = `${i * this.noteHeight}px`;\r\n      key.style.backgroundColor =\r\n        KEY_COLORS[i % 12] === \"white\" ? \"#fff\" : \"#000\";\r\n      key.style.color = KEY_COLORS[i % 12] === \"white\" ? \"#000\" : \"#fff\";\r\n      key.textContent = NOTE_NAMES[i % 12] + ((i / 12) | 0).toString();\r\n      this.domElement.appendChild(key);\r\n      this.keys.push(key);\r\n    }\r\n\r\n    this.keys.reverse();\r\n  }\r\n}\r\n","import EventObject from \"../../../../elements/src/EventObject\";\r\nimport { AudioClock } from \"./AudioClock\";\r\nimport { AudioCursor, ICursorTimeline } from \"./AudioCursor\";\r\nimport { Grid, GridItem } from \"./Grid\";\r\nimport { IKeyboardEvent } from \"./Keyboard\";\r\nimport { PatternTrack } from \"./PatternTrack\";\r\nimport { SideKeyboard } from \"./SideKeyboard\";\r\n\r\nexport class PianoRoll\r\n  extends EventObject<\"update\">\r\n  implements ICursorTimeline\r\n{\r\n  readonly domElement: HTMLDivElement;\r\n  readonly grid: Grid;\r\n  readonly sideKeyboard: SideKeyboard;\r\n  readonly cursor: AudioCursor;\r\n  readonly timeline: HTMLElement;\r\n  cursorUpdateInterval: number | object | null = null;\r\n  track: PatternTrack | null = null;\r\n  color = \"#7979ce\";\r\n  beatWidth = 100;\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super();\r\n\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"piano-roll\");\r\n\r\n    this.sideKeyboard = new SideKeyboard();\r\n    this.domElement.appendChild(this.sideKeyboard.domElement);\r\n    this.sideKeyboard.on(\"update\", (event) => {\r\n      const e = event as IKeyboardEvent;\r\n      if (e.type == \"press\") this.track!.trigger(e.note);\r\n      else if (e.type == \"release\") this.track!.release(e.note);\r\n    });\r\n\r\n    this.grid = new Grid();\r\n    this.domElement.appendChild(this.grid.domElement);\r\n    this.grid.on(\"select\", (item) => {\r\n      const note = item as GridItem;\r\n      this.track!.trigger(note.note);\r\n      if (this.track) {\r\n        this.grid.renderToCanvas(this.track.canvas, this.color);\r\n      }\r\n    });\r\n    this.grid.on(\"update\", () => {\r\n      if (this.track) {\r\n        this.grid.renderToCanvas(this.track.canvas, this.color);\r\n      }\r\n    });\r\n    this.grid.linkElement(this.sideKeyboard.domElement);\r\n\r\n    this.timeline = this.grid.domElement;\r\n\r\n    this.cursor = new AudioCursor(this);\r\n    this.cursor.domElement.classList.add(\"audio-cursor\");\r\n    this.grid.domElement.appendChild(this.cursor.domElement);\r\n\r\n    this.grid.scrollTop = 1000;\r\n  }\r\n\r\n  load(track: PatternTrack) {\r\n    this.track = track;\r\n    this.grid.load(track);\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { AudioClock } from \"../components/AudioClock\";\r\nimport { PatternTrack } from \"../components/PatternTrack\";\r\nimport { PianoRoll } from \"../components/PianoRoll\";\r\n\r\nexport class PianoRollWindow extends DraggableWindow<\"update\"> {\r\n  pianoRoll: PianoRoll;\r\n\r\n  constructor(readonly clock: AudioClock) {\r\n    const pianoRoll = new PianoRoll(clock);\r\n\r\n    super({\r\n      title: \"Piano Roll\",\r\n      persistent: true,\r\n      content: pianoRoll.domElement,\r\n      width: 900,\r\n      height: 400,\r\n    });\r\n    this.pianoRoll = pianoRoll;\r\n\r\n    this.setSize(800, 400);\r\n  }\r\n\r\n  loadTrack(track: PatternTrack) {\r\n    this.pianoRoll.load(track);\r\n    this.setTitle(`Piano Roll (${track.name})`);\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { ITimelineItem, ITimelineSequence } from \"../../schema\";\r\n\r\nexport class PlaylistTrack\r\n  extends BaseElement<\"update\">\r\n  implements ITimelineSequence\r\n{\r\n  name = \"Track 1\";\r\n  items: ITimelineItem[] = [];\r\n\r\n  constructor(name: string) {\r\n    super(\"div\", \"playlist-track\");\r\n\r\n    const settings = document.createElement(\"div\");\r\n    settings.classList.add(\"instrument-panel\");\r\n\r\n    const label = document.createElement(\"div\");\r\n    settings.appendChild(label);\r\n    label.textContent = name;\r\n\r\n    const buttons = document.createElement(\"div\");\r\n    buttons.classList.add(\"playlist-track-selector\");\r\n    settings.appendChild(buttons);\r\n\r\n    const mute = document.createElement(\"button\");\r\n    mute.textContent = \"M\";\r\n    buttons.appendChild(mute);\r\n\r\n    const solo = document.createElement(\"button\");\r\n    solo.textContent = \"S\";\r\n    buttons.appendChild(solo);\r\n\r\n    const track = document.createElement(\"div\");\r\n    track.classList.add(\"pattern-panel\");\r\n\r\n    this.domElement.appendChild(settings);\r\n    this.domElement.appendChild(track);\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { Project } from \"../Project\";\r\nimport { PlaylistTrack } from \"../components/PlaylistTrack\";\r\nimport { AudioClock } from \"../components/AudioClock\";\r\nimport { AudioCursor, ICursorTimeline } from \"../components/AudioCursor\";\r\n\r\nexport class PlaylistWindow\r\n  extends DraggableWindow<\"update\" | \"select\">\r\n  implements ICursorTimeline\r\n{\r\n  private _tracks: PlaylistTrack[] = [];\r\n  readonly timeline: HTMLDivElement;\r\n  readonly cursor: AudioCursor;\r\n  beatWidth = 100;\r\n\r\n  get audioClock(): AudioClock {\r\n    return this.project.audioClock;\r\n  }\r\n\r\n  constructor(readonly project: Project) {\r\n    const container = document.createElement(\"div\");\r\n    container.classList.add(\"playlist-track-container\");\r\n\r\n    super({\r\n      title: \"Playlist\",\r\n      persistent: true,\r\n      content: container,\r\n      width: 800,\r\n      height: 400,\r\n    });\r\n    this.timeline = container;    \r\n\r\n    this.cursor = new AudioCursor(this);\r\n\r\n    this.project.audioClock.on(\"update\", () => {\r\n      this.cursor.update();\r\n    });\r\n  }\r\n\r\n  addTrack(name: string) {\r\n    console.log(\"Add track\", name);\r\n    const track = new PlaylistTrack(name);\r\n    this._tracks.push(track);\r\n    this.timeline.appendChild(track.domElement);\r\n    this.timeline.appendChild(this.cursor.domElement);\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../elements/src/elements/BaseElement\";\r\nimport { WindowContainer } from \"../../../elements/src/elements/WindowContainer\";\r\nimport { Project } from \"./Project\";\r\nimport { IKeyboardEvent, Keyboard } from \"./components/Keyboard\";\r\nimport { PatternTrack } from \"./components/PatternTrack\";\r\nimport { PatternWindow } from \"./windows/PatternWindow\";\r\nimport { PianoRollWindow } from \"./windows/PianoRollWindow\";\r\nimport { PlaylistWindow } from \"./windows/PlaylistWindow\";\r\n\r\nexport class ProjectUI extends BaseElement<\"update\"> {\r\n  container: WindowContainer;\r\n\r\n  constructor(readonly project: Project) {\r\n    super(\"div\", \"project-ui\");\r\n\r\n    this.container = new WindowContainer();\r\n    this.domElement.appendChild(this.container.domElement);\r\n\r\n    const pianoRollWindow = new PianoRollWindow(project.audioClock);\r\n    this.container.addWindow(pianoRollWindow);    \r\n    pianoRollWindow.setPosition(500, 100);\r\n\r\n    const patternWindow = new PatternWindow(project);    \r\n    patternWindow.show(35, 100);\r\n    this.container.addWindow(patternWindow);\r\n\r\n    const playlistWindow = new PlaylistWindow(project);\r\n    patternWindow.show(200, 200);\r\n    this.container.addWindow(playlistWindow);\r\n\r\n    patternWindow.on(\"edit\", (selectedTrack) => {\r\n      console.log(\"edit\", selectedTrack);\r\n      pianoRollWindow.loadTrack(selectedTrack as PatternTrack);\r\n      pianoRollWindow.show();\r\n    });\r\n\r\n    patternWindow.on(\"select\", (selectedTrack) => {\r\n      console.log(\"select\", selectedTrack);\r\n      const track = selectedTrack as PatternTrack;\r\n      track.instrument.window.show();\r\n    });\r\n\r\n    // playlistWindow.show(600, 100);\r\n\r\n    // const samplerWindow: SamplerWindow = project.instruments[0] as SamplerWindow;\r\n    // container.addWindow(samplerWindow);\r\n    //samplerWindow.setSize(400, 400);\r\n    //samplerWindow.show(1465, 100);\r\n\r\n    const keyboard = new Keyboard();\r\n    this.domElement.appendChild(keyboard.domElement);\r\n    keyboard.on(\"update\", (event) => {\r\n      const e = event as IKeyboardEvent;\r\n      console.log(\"Keyboard\", event);\r\n      if (e.type === \"press\") {\r\n        patternWindow.trigger(e.note);\r\n      } else if (e.type === \"release\") {\r\n        console.log(\"Release\", e.note);\r\n      }\r\n    });\r\n\r\n    this.project.on(\"update\", (event) => {\r\n      console.log(\"ProjectUI project update\", event);\r\n\r\n      if (!(event instanceof Object)) {\r\n        throw new Error(\"Invalid event\");\r\n      }\r\n\r\n      if (!(\"type\" in event)) {\r\n        throw new Error(\"Invalid event\");\r\n      }\r\n\r\n      const e = event as { type: string; value: unknown };\r\n\r\n      if (e.type === \"project\") {\r\n        const project = e.value as Project;\r\n        console.log(\"Project\", project);\r\n        patternWindow.loadProject(project);\r\n        for (const instrument of project.instruments) {\r\n          this.container.addWindow(instrument.window);\r\n        }\r\n      }\r\n    });\r\n  }\r\n}\r\n","import { AudioClock } from \"./elements/components/AudioClock\";\r\nimport { Project } from \"./elements/Project\";\r\nimport { ProjectUI } from \"./elements/ProjectUI\";\r\nimport { templates } from \"./schema\";\r\n\r\nconst domElement = document.createElement(\"div\");\r\ndomElement.classList.add(\"studio\");\r\n\r\nconst audioClock = new AudioClock();\r\nconst project = new Project(audioClock, templates.Basic);\r\nconst projectUI = new ProjectUI(project);\r\n\r\ndomElement.appendChild(audioClock.domElement);\r\ndomElement.appendChild(projectUI.domElement);\r\ndocument.body.appendChild(domElement);\r\n\r\n","export type ControllerGroup = { [key: string]: IPluginControl };\r\nexport type ControllerValue = number | string | boolean | AudioBuffer | object;\r\nexport type ControlType =\r\n  | \"knob\"\r\n  | \"slider\"\r\n  | \"string\"\r\n  | \"select\"\r\n  | \"audio\"\r\n  | \"object\";\r\nexport type InstrumentType = \"sampler\" | \"synthesizer\" | null;\r\n\r\nexport interface IEvent {\r\n  start: number;\r\n  duration: number;\r\n}\r\n\r\nexport interface IEventItem extends IEvent {\r\n  note: number;\r\n  velocity: number;\r\n  label: string;\r\n  domElement: HTMLElement | undefined;\r\n}\r\n\r\nexport interface ISequence {\r\n  events: IEventItem[];\r\n}\r\n\r\nexport interface IPattern {\r\n  name: string;\r\n  sequences: ISequence[];\r\n}\r\n\r\nexport interface IHasOwnEnvelope {\r\n  envelope: IEnvelope | null;\r\n}\r\n\r\nexport interface IHasOwnLFO {\r\n  lfo?: IOscillatorSettings;\r\n}\r\n\r\nexport interface IUseEnvelope {\r\n  envelopeNumber: number | null;\r\n}\r\n\r\nexport interface IUseLFO {\r\n  lfoNumber: number | null;\r\n}\r\n\r\nexport interface IHasControls {\r\n  controllerGroups: ControllerGroup[];\r\n}\r\n\r\nexport interface IInstrumentSettings extends IHasControls {\r\n  name: string;  \r\n  id: string;\r\n  inputPort?: number;\r\n  inputChannel?: number;\r\n}\r\n\r\nexport interface ITimelineItem extends IEvent {\r\n  type: \"pattern\" | \"audio\";\r\n  label: string;\r\n}\r\n\r\nexport interface ITimelinePattern extends ITimelineItem {\r\n  pattern: IPattern;\r\n}\r\n\r\nexport interface ITimelineAudio extends ITimelineItem {\r\n  buffer: AudioBuffer;\r\n  fadeIn: number;\r\n  fadeOut: number;\r\n}\r\n\r\nexport interface ITimelineSequence {\r\n  name: string;\r\n  items: ITimelineItem[];\r\n}\r\n\r\nexport interface IProject {\r\n  title: string;\r\n  description: string;\r\n  tempo: number;\r\n  instruments: IInstrumentSettings[];\r\n  patterns: IPattern[];\r\n  timeline: ITimelineSequence[];\r\n}\r\n\r\nexport interface ISamplerSlot {\r\n  name: string;\r\n  buffer: AudioBuffer | null;\r\n  keyBinding: number | null;\r\n  velocity: number;\r\n  pan: number;\r\n  pitch: number;\r\n  randomPitch: number;\r\n  randomVelocity: number;\r\n  startPosition: number;\r\n  endPosition: number;\r\n  loop: boolean;\r\n  loopStart: number;\r\n  loopEnd: number;\r\n  cutGroup: number;\r\n  cutByGroups: number[];\r\n}\r\n\r\nexport interface ISamplerSettings {\r\n  name: string;\r\n  slots: ISamplerSlot[];\r\n}\r\n\r\nexport interface IPluginControl {\r\n  type: ControlType;\r\n  name: string;\r\n  label: string;\r\n  default: ControllerValue;\r\n  value: ControllerValue;\r\n  min?: number;\r\n  max?: number;\r\n  step?: number;\r\n}\r\n\r\nexport interface IEnvelope {\r\n  attack: IPluginControl;\r\n  hold: IPluginControl;\r\n  decay: IPluginControl;\r\n  sustain: IPluginControl;\r\n  release: IPluginControl;\r\n}\r\n\r\nexport interface IOscillatorSettings extends IHasOwnEnvelope {\r\n  shape: \"sine\" | \"square\" | \"sawtooth\" | \"triangle\";\r\n  detune: number;\r\n  gain?: number;\r\n  route?: number;\r\n  feedback?: number;\r\n}\r\n\r\nexport interface IFilter extends IHasOwnEnvelope {\r\n  type:\r\n    | \"lowpass\"\r\n    | \"highpass\"\r\n    | \"bandpass\"\r\n    | \"lowshelf\"\r\n    | \"highshelf\"\r\n    | \"peaking\"\r\n    | \"notch\"\r\n    | \"allpass\";\r\n  frequency: number;\r\n  detune: number;\r\n  Q: number;\r\n  gain: number;\r\n}\r\n\r\nexport interface ISynthesizerSettings {\r\n  name: string;\r\n  voices: ISynthesizerVoiceSettings[];\r\n}\r\n\r\nexport interface ISynthesizerVoiceSettings extends IUseEnvelope, IUseLFO {\r\n  gain: number;\r\n  frequency: number | null;\r\n  detune: number | null;\r\n  oscillators: IOscillatorSettings[];\r\n  note: number | null;\r\n}\r\n\r\nexport const templates: { [key: string]: IProject } = {\r\n  Basic: {\r\n    title: \"Basic\",\r\n    description: \"Basic project template with Sampler and Synthesizer\",\r\n    tempo: 120,\r\n    instruments: [\r\n      { name: \"Sampler\", id: \"sampler\", controllerGroups: [] },\r\n      {\r\n        name: \"FM Bass\",        \r\n        id: \"fm_bass\",\r\n        controllerGroups: [],\r\n      },\r\n    ],\r\n    patterns: [\r\n      {\r\n        name: \"Pattern 1\",\r\n        sequences: [\r\n          {\r\n            events: [],\r\n          },\r\n          {\r\n            events: [],\r\n          },\r\n        ],\r\n      },\r\n    ],\r\n    timeline: [],\r\n  },\r\n};\r\n"],"names":["exports","Symbol","toStringTag","Object","defineProperty","value","_events","_onceEvents","on","eventName","callback","this","push","once","emit","eventData","onceCallbacks","error","console","undefined","callbacks","audioContext","AudioContext","window","webkitAudioContext","getAudioContext","latencyHint","sampleRate","prototype","navigator","mediaDevices","enumerateDevices","getAudioDevices","then","devices","log","_bpm","_scheduledEvents","_startTime","domElement","document","createElement","classList","add","playPauseButton","textContent","addEventListener","isPlaying","stop","playPause","appendChild","stopButton","bpmInput","type","parseFloat","currentTimeDisplay","currentTime","start","requestAnimationFrame","_render","bind","_update","currentBeat","source","disconnect","restart","buffer","createBuffer","createBufferSource","connect","destination","beat","bars","Math","floor","beats","timeString","toString","padStart","scheduleEventAtTime","time","emptyBuffer","onended","scheduleEventAtBeat","tagName","className","child","removeChild","_resizing","_startX","_startY","_startWidth","_startHeight","_startTop","_startLeft","_resizeDirection","e","handle","getCurrentHandle","style","cursor","onmove","dx","clientX","dy","clientY","width","height","left","top","offsetWidth","offsetHeight","preventDefault","startResize","onrelease","stopResize","removeEventListener","direction","offsetTop","offsetLeft","rect","getBoundingClientRect","offsetX","offsetY","BaseElement","options","_isDragging","_dragOffsetX","_dragOffsetY","_top","_left","persistent","parentElement","titlebar","scrollTop","ondrag","newTop","newLeft","body","_title","title","content","_closeButton","button","close","setSize","display","show","x","y","setTimeout","remove","setPosition","setTitle","SizableElement","audioClock","register","plugin","Plugins","plugins","includes","warn","get","name","find","Plugin","voices","_nextVoice","_held","_ctx","_gain","createGain","addVoice","voice","handleEvent","event","length","Instrument","_settings","_note","_frequency","settings","Error","gain","lfoNumber","envelopeNumber","detune","oscillators","loadSettings","trigger","note","velocity","pow","release","when","SynthesizerVoice","id","version","description","author","controllerGroups","DraggableWindow","Synthesizer","FMBass","triggerActive","elt","timeout","toggle","playOnClick","canvas","playBuffer","ctx","getContext","generateAudio","preview","Promise","resolve","reject","req","text","label","pitch","rate","fetch","method","JSON","stringify","headers","res","arrayBuffer","data","decodeAudioData","audioBuffer","catch","loadBuffer","channelData","getChannelData","bufferLength","sliceWidth","clearRect","beginPath","moveTo","i","lineTo","stroke","keyBinding","cutGroup","cutByGroups","_sources","pan","randomPitch","randomVelocity","startPosition","endPosition","loop","loopStart","loopEnd","_previewCanvas","AudioCanvas","_nameElement","loadSample","url","response","ok","statusText","playbackRate","random","createStereoPanner","startTime","bpm","entry","index","indexOf","splice","duration","cut","currentValue","cancelScheduledValues","setValueAtTime","exponentialRampToValueAtTime","slots","onKeyDown","container","_slotsContainer","defaultSlots","slot","SamplerSlot","InstrumentWindow","channel","each","keyCode","Sampler","project","tempo","instruments","patterns","sequences","timeline","load","serialize","map","instrument","deserialize","parse","windows","_draggingWindow","addWindow","BOTTOM_ROW","TOP_ROW","KEY_COLORS","NOTE_NAMES","keyToNote","pressedKeys","ctrlKey","altKey","shiftKey","target","items","selected","forEach","selectable","item","clock","update","transform","beatWidth","hide","contains","port","events","_instrumentPanel","buttons","edit","mute","solo","_indicator","_canvas","sequence","playback","sourceEvent","nextLoop","SelectableElement","SelectableGroup","trackContainer","position","pointerEvents","overflow","AudioCursor","querySelector","clientWidth","addPattern","loadProject","track","addTrack","pattern","PatternTrack","selectedTrack","removeTrack","play","scrollElement","sensitivity","linkedElements","_scrollTop","deltaY","linkElement","element","cancel","closeButton","HTMLButtonElement","okButton","cancelButton","targetObject","onsave","textInput","setAttribute","pitchSlider","min","max","step","audioCanvas","LyricCanvas","saveButton","DialogPopup","grid","audio","noteHeight","noteLabel","lyricLabel","gridElement","_currentNote","_dragMode","_quantize","_dragOffset","_track","previewCanvas","imageRendering","rowBackgroundCanvas","strokeStyle","lineWidth","j","row","base64","toDataURL","backgroundImage","backgroundRepeat","noteEditor","LyricEditorDialog","input","layerX","HTMLDivElement","n","layerY","round","oldStart","GridItem","renderToCanvas","color","lowestNote","highestNote","padded_scale","fillStyle","fillRect","ScrollPanel","keys","redraw","key","innerHTML","backgroundColor","reverse","cursorUpdateInterval","sideKeyboard","SideKeyboard","Grid","pianoRoll","PianoRoll","loadTrack","_tracks","PlaylistTrack","WindowContainer","pianoRollWindow","PianoRollWindow","patternWindow","PatternWindow","playlistWindow","PlaylistWindow","keyboard","Keyboard","AudioClock","projectUI","ProjectUI","Project"],"sourceRoot":""}