{"version":3,"file":"monofy-studio.js","mappings":"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","sources":["webpack://monofy/webpack/bootstrap","webpack://monofy/webpack/runtime/make namespace object","webpack://monofy/../elements/src/EventObject.ts","webpack://monofy/../elements/src/managers/AudioManager.ts","webpack://monofy/./src/elements/components/AudioClock.ts","webpack://monofy/../elements/src/elements/BaseElement.ts","webpack://monofy/./src/plugins/plugins.ts","webpack://monofy/./src/elements/Project.ts","webpack://monofy/../elements/src/elements/WindowContainer.ts","webpack://monofy/./src/constants.ts","webpack://monofy/./src/elements/components/Keyboard.ts","webpack://monofy/../elements/src/elements/SizableElement.ts","webpack://monofy/../elements/src/elements/DraggableWindow.ts","webpack://monofy/./src/elements/components/MixerChannel.ts","webpack://monofy/./src/elements/windows/MixerWindow.ts","webpack://monofy/../elements/src/elements/SelectableGroup.ts","webpack://monofy/./src/elements/components/AudioCursor.ts","webpack://monofy/../elements/src/animation.ts","webpack://monofy/../elements/src/elements/SelectableElement.ts","webpack://monofy/./src/elements/components/PatternTrack.ts","webpack://monofy/./src/elements/windows/PatternWindow.ts","webpack://monofy/../elements/src/elements/ScrollPanel.ts","webpack://monofy/../elements/src/elements/AudioCanvas.ts","webpack://monofy/./src/elements/components/LyricCanvas.ts","webpack://monofy/../elements/src/elements/DialogPopup.ts","webpack://monofy/./src/elements/audioDialogs.ts","webpack://monofy/./src/elements/components/Grid.ts","webpack://monofy/./src/elements/components/SideKeyboard.ts","webpack://monofy/./src/elements/components/PianoRoll.ts","webpack://monofy/./src/elements/windows/PianoRollWindow.ts","webpack://monofy/./src/elements/components/PlaylistTrack.ts","webpack://monofy/./src/elements/PlaylistSourceItem.ts","webpack://monofy/./src/elements/windows/PlaylistWindow.ts","webpack://monofy/./src/elements/ProjectUI.ts","webpack://monofy/./src/abstracts/Instrument.ts","webpack://monofy/./src/abstracts/Synthesizer.ts","webpack://monofy/./src/abstracts/SynthesizerVoice.ts","webpack://monofy/./src/elements/components/Slider.ts","webpack://monofy/./src/elements/components/Envelope.ts","webpack://monofy/./src/plugins/fmbass/FMBass.ts","webpack://monofy/./src/abstracts/InstrumentWindow.ts","webpack://monofy/./src/elements/components/SamplerSlot.ts","webpack://monofy/./src/plugins/sampler/Sampler.ts","webpack://monofy/./src/index.ts","webpack://monofy/./src/schema.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export interface EventDataMap {\r\n  cancel: unknown;\r\n  start: unknown;\r\n  stop: unknown;\r\n  pause: unknown;\r\n  result: unknown;\r\n  update: unknown;\r\n  open: unknown;\r\n  close: unknown;\r\n  edit: unknown;\r\n  resize: unknown;\r\n  select: unknown;\r\n  scroll: unknown;\r\n}\r\n\r\nexport type BaseEvent = keyof EventDataMap;\r\n\r\nexport default abstract class EventObject<E extends BaseEvent = BaseEvent> {\r\n  private _events: {\r\n    [eventName in E]?: ((e: EventDataMap[eventName]) => void)[];\r\n  } = {};\r\n  private _onceEvents: {\r\n    [eventName in E]?: ((e: EventDataMap[eventName]) => void)[];\r\n  } = {};\r\n\r\n  on(eventName: E, callback: (e: EventDataMap[E]) => void) {\r\n    if (!this._events[eventName]) {\r\n      this._events[eventName] = [];\r\n    }\r\n    this._events[eventName]!.push(callback);\r\n\r\n    return this;\r\n  }\r\n\r\n  once(eventName: E, callback: (e: EventDataMap[E]) => void) {\r\n    if (!this._onceEvents[eventName]) {\r\n      this._onceEvents[eventName] = [];\r\n    }\r\n    this._onceEvents[eventName]!.push(callback);\r\n\r\n    return this;\r\n  }\r\n\r\n  emit(eventName: E, eventData?: EventDataMap[E]) {\r\n    const onceCallbacks = this._onceEvents[eventName];\r\n    if (onceCallbacks) {\r\n      for (const callback of onceCallbacks) {\r\n        try {\r\n          callback(eventData);\r\n        } catch (error) {\r\n          console.error(\r\n            `Error executing .once callback for event: ${eventName}`,\r\n            error\r\n          );\r\n        }\r\n      }\r\n      this._onceEvents[eventName] = undefined;\r\n    }\r\n\r\n    const callbacks = this._events[eventName];\r\n    if (callbacks) {\r\n      for (const callback of callbacks) {\r\n        try {\r\n          callback(eventData);\r\n        } catch (error) {\r\n          console.error(\r\n            `Error executing .on callback for event: ${eventName}`,\r\n            error\r\n          );\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","let audioContext: AudioContext | null = null;\r\n\r\nconst AudioContext = window.AudioContext || (window as any).webkitAudioContext;\r\n\r\nexport function getAudioContext() {\r\n  if (!audioContext) {\r\n    audioContext = new AudioContext({\r\n      latencyHint: \"interactive\",\r\n      sampleRate: 44100,\r\n    });\r\n    getAudioDevices().then((devices) => {\r\n      console.log(\"Audio devices\", devices);\r\n    });\r\n    console.log(\"Audio context created\");\r\n    return audioContext;\r\n  }\r\n  return audioContext;\r\n}\r\n\r\nexport async function getAudioDevices() {\r\n  if (\"setSinkId\" in AudioContext.prototype) {\r\n    const devices = await navigator.mediaDevices.enumerateDevices();\r\n    return devices;\r\n  }\r\n  return null;\r\n}\r\n","import EventObject from \"../../../../elements/src/EventObject\";\r\nimport { getAudioContext } from \"../../../../elements/src/managers/AudioManager\";\r\n\r\n/**\r\n * Represents an audio clock that provides functionality for controlling audio playback and scheduling events.\r\n */\r\nexport class AudioClock extends EventObject<\r\n  \"start\" | \"stop\" | \"pause\" | \"update\"\r\n> {\r\n  readonly domElement: HTMLDivElement;\r\n  readonly bpmInput: HTMLInputElement;\r\n  readonly playPauseButton: HTMLButtonElement;\r\n  readonly stopButton: HTMLButtonElement;\r\n  readonly currentTimeDisplay: HTMLSpanElement;\r\n  private _playbackMode: \"pattern\" | \"playlist\" = \"pattern\";\r\n  private _audioContext: AudioContext | null = null;\r\n  private _bpm: number = 100;\r\n  private _scheduledEvents: {\r\n    source: AudioBufferSourceNode;\r\n    time: number;\r\n    callback: () => void;\r\n  }[] = [];\r\n  private _startTime: number | null = null;\r\n\r\n  get startTime(): number | null {\r\n    return this._startTime;\r\n  }\r\n\r\n  get currentTime(): number {\r\n    return this.audioContext.currentTime;\r\n  }\r\n\r\n  get audioContext(): AudioContext {\r\n    if (!this._audioContext) {\r\n      this._audioContext = getAudioContext();\r\n    }\r\n    return this._audioContext;\r\n  }\r\n\r\n  get currentBeat(): number {\r\n    const elapsedTime =\r\n      this._startTime !== null\r\n        ? this.audioContext.currentTime - this._startTime\r\n        : 0;\r\n    return elapsedTime * (this._bpm / 60);\r\n  }\r\n\r\n  get isPlaying(): boolean {\r\n    return this._startTime != null && this._startTime >= 0;\r\n  }\r\n\r\n  get bpm(): number {\r\n    return this._bpm;\r\n  }\r\n\r\n  get playbackMode(): \"pattern\" | \"playlist\" {\r\n    return this._playbackMode;\r\n  }\r\n\r\n  constructor() {\r\n    super();\r\n\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"audio-clock\");\r\n\r\n    this.playPauseButton = document.createElement(\"button\");\r\n    this.playPauseButton.classList.add(\"audio-clock-play-pause\");\r\n    this.playPauseButton.textContent = \"Play\";\r\n\r\n    this.playPauseButton.addEventListener(\"click\", () => {\r\n      if (this.isPlaying) {\r\n        this.stop();\r\n      } else {\r\n        getAudioContext();\r\n        this.playPause();\r\n      }\r\n    });\r\n    this.domElement.appendChild(this.playPauseButton);\r\n    this.stopButton = document.createElement(\"button\");\r\n    this.stopButton.classList.add(\"audio-clock-stop\");\r\n    this.stopButton.textContent = \"Stop\";\r\n\r\n    this.stopButton.addEventListener(\"click\", () => {\r\n      this.stop();\r\n    });\r\n    this.domElement.appendChild(this.stopButton);\r\n\r\n    this.bpmInput = document.createElement(\"input\");\r\n    this.bpmInput.classList.add(\"audio-clock-bpm\");\r\n    this.bpmInput.type = \"number\";\r\n    this.bpmInput.value = \"120\";\r\n\r\n    this.bpmInput.addEventListener(\"input\", () => {\r\n      this._bpm = parseFloat(this.bpmInput.value);\r\n    });\r\n    this.domElement.appendChild(this.bpmInput);\r\n\r\n    this.currentTimeDisplay = document.createElement(\"span\");\r\n    this.currentTimeDisplay.classList.add(\"audio-clock-time\");\r\n    this.currentTimeDisplay.textContent = \"01:1\";\r\n\r\n    this.domElement.appendChild(this.currentTimeDisplay);\r\n  }\r\n\r\n  start(): void {\r\n    this._startTime = this.audioContext.currentTime;\r\n    console.log(\"Started at\", this._startTime);\r\n    requestAnimationFrame(this._render.bind(this));\r\n    this.emit(\"start\");\r\n  }\r\n\r\n  private _render(): void {\r\n    this._update(this.currentBeat);\r\n    this.emit(\"update\");\r\n    if (this.isPlaying) requestAnimationFrame(this._render.bind(this));\r\n  }\r\n\r\n  stop(): void {\r\n    this.emit(\"stop\");\r\n    this._startTime = null;\r\n\r\n    for (const { source } of this._scheduledEvents) {\r\n      source.stop();\r\n      source.disconnect();\r\n    }\r\n    this._scheduledEvents = [];\r\n\r\n    this._update(this.currentBeat);\r\n    this.playPauseButton.textContent = \"Play\";\r\n  }\r\n\r\n  restart() {\r\n    if (this.isPlaying) {\r\n      this._startTime = this.audioContext.currentTime;\r\n    }\r\n  }\r\n\r\n  playPause(): void {\r\n    if (this.isPlaying) {\r\n      this.stop(); // TODO: This should be a pause\r\n    } else {\r\n      const buffer = this.audioContext.createBuffer(\r\n        1,\r\n        1,\r\n        this.audioContext.sampleRate\r\n      );\r\n      const source = this.audioContext.createBufferSource();\r\n      source.buffer = buffer;\r\n      source.connect(this.audioContext.destination);\r\n      source.start();\r\n\r\n      this.start();\r\n    }\r\n    this.playPauseButton.textContent = this.isPlaying ? \"Pause\" : \"Play\";\r\n  }\r\n\r\n  private _update(beat: number): void {\r\n    const bars = Math.floor(beat / 4) + 1;\r\n    const beats = Math.floor(beat % 4) + 1;\r\n    const timeString = `${bars\r\n      .toString()\r\n      .padStart(2, \"0\")}:${beats.toString()}`;\r\n    this.currentTimeDisplay.textContent = timeString;\r\n  }\r\n\r\n  /**\r\n   * Schedules UI event to occur at a specific time during audio playback. This should not be used for scheduling audio events.\r\n   */\r\n  scheduleEventAtTime(callback: () => void, time: number): void {\r\n    const emptyBuffer = this.audioContext.createBuffer(\r\n      1,\r\n      1,\r\n      this.audioContext.sampleRate\r\n    );\r\n    const source = this.audioContext.createBufferSource();\r\n    source.buffer = emptyBuffer;\r\n    source.connect(this.audioContext.destination);\r\n    source.onended = () => callback();\r\n    source.start(time);\r\n    this._scheduledEvents.push({ source, time, callback });\r\n  }\r\n\r\n  /**\r\n   * Schedules UI event to occur at a specific time during audio playback. This should not be used for scheduling audio events.\r\n   */\r\n  scheduleEventAtBeat(callback: () => void, beat: number): void {\r\n    const time = this._startTime! + (beat / this._bpm) * 60;\r\n    this.scheduleEventAtTime(callback, time);\r\n  }\r\n}\r\n","import EventObject, { EventDataMap } from \"../EventObject\";\r\n\r\nexport abstract class BaseElement<\r\n  T extends keyof EventDataMap,\r\n> extends EventObject<T> {\r\n  readonly domElement: HTMLElement;\r\n\r\n  constructor(tagName: string, className?: string) {\r\n    super();\r\n    this.domElement = document.createElement(tagName);\r\n    if (className) {\r\n      this.domElement.classList.add(className);\r\n    }\r\n  }\r\n\r\n  appendChild(child: BaseElement<keyof EventDataMap>) {\r\n    this.domElement.appendChild(child.domElement);\r\n    return this;\r\n  }\r\n\r\n  removeChild(child: BaseElement<keyof EventDataMap>) {\r\n    this.domElement.removeChild(child.domElement);\r\n    return this;\r\n  }\r\n}\r\n","import { EventDataMap } from \"../../../elements/src/EventObject\";\r\nimport { BaseElement } from \"../../../elements/src/elements/BaseElement\";\r\nimport { DraggableWindow } from \"../../../elements/src/elements/DraggableWindow\";\r\nimport { AudioClock } from \"../elements/components/AudioClock\";\r\nimport { ControllerGroup, IHasControls } from \"../schema\";\r\n\r\nexport abstract class Plugin\r\n  extends BaseElement<\"update\">\r\n  implements IHasControls\r\n{\r\n  abstract name: string;\r\n  abstract version: string;\r\n  abstract description: string;\r\n  abstract author: string;\r\n  abstract controllerGroups: ControllerGroup[];\r\n  abstract window: DraggableWindow<\"update\" | keyof EventDataMap>;\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(\"div\", \"plugin-container\");\r\n  }\r\n}\r\n\r\nexport class Plugins {\r\n  private static readonly _plugins: { [key: string]: typeof Plugin } = {};\r\n\r\n  static register(name: string, plugin: typeof Plugin) {\r\n    if (this._plugins[name]) {\r\n      console.warn(\"Plugin already registered:\", plugin);\r\n      return;\r\n    }\r\n    this._plugins[name] = plugin;\r\n  }\r\n\r\n  static get<T extends Plugin>(name: string): T {\r\n    return this._plugins[name] as any as T;\r\n  }\r\n\r\n  static instantiate<T extends Plugin>(id: string, audioClock: AudioClock) {\r\n    return new (this.get(id) as any)(audioClock) as T;\r\n  }\r\n}\r\n","import EventObject from \"../../../elements/src/EventObject\";\r\nimport { Instrument } from \"../abstracts/Instrument\";\r\nimport { Plugins } from \"../plugins/plugins\";\r\nimport { IPattern, IProject, ISequence, IPlaylistTrack } from \"../schema\";\r\nimport { IInstrument } from \"./IInstrument\";\r\nimport { AudioClock } from \"./components/AudioClock\";\r\n\r\nexport class Project extends EventObject<\"update\"> implements IProject {\r\n  title = \"Untitled\";\r\n  description = \"\";\r\n  tempo = 120;\r\n  instruments: Instrument[] = [];\r\n  patterns: IPattern[] = [];\r\n  sequences: ISequence[] = [];\r\n  timeline: IPlaylistTrack[] = [];\r\n\r\n  constructor(\r\n    readonly audioClock: AudioClock,\r\n    project?: IProject\r\n  ) {\r\n    super();\r\n    if (project) {\r\n      setTimeout(() => {\r\n        this.load(project);\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  serialize(): string {\r\n    return JSON.stringify({\r\n      title: this.title,\r\n      description: this.description,\r\n      tempo: this.tempo,\r\n      instruments: this.instruments.map((instrument) => {\r\n        return {\r\n          name: instrument.name,\r\n          controllerGroups: instrument.controllerGroups,\r\n        };\r\n      }),\r\n      patterns: this.patterns,\r\n      sequences: this.sequences,\r\n      timeline: this.timeline,\r\n    });\r\n  }\r\n\r\n  deserialize(data: string): void {\r\n    console.log(\"Project deserialize\", data);\r\n    const project = JSON.parse(data) as IProject;\r\n\r\n    // TODO error checking\r\n\r\n    this.load(project);\r\n  }\r\n\r\n  load(project: IProject): void {\r\n    console.log(\"Project load\", project);\r\n\r\n    this.title = project.title;\r\n    this.description = project.description;\r\n    this.tempo = project.tempo;\r\n    this.patterns = project.patterns;\r\n    this.timeline = project.timeline;\r\n    this.instruments = [];\r\n\r\n    for (const instrument of project.instruments as IInstrument[]) {\r\n      console.log(\"loading instrument\", instrument);      \r\n      const T = Plugins.get(instrument.id);\r\n      const instance: typeof T = Plugins.instantiate<typeof T>(instrument.id, this.audioClock);    \r\n      this.instruments.push(instance as Instrument);\r\n    }\r\n\r\n    console.log(\"emitting update...\");\r\n    this.emit(\"update\", { type: \"project\", value: this });\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { DraggableWindow } from \"./DraggableWindow\";\r\n\r\nexport class WindowContainer {\r\n  readonly domElement: HTMLDivElement;\r\n  private _activeWindow: DraggableWindow | null = null;\r\n\r\n  windows: DraggableWindow<keyof EventDataMap>[] = [];\r\n  _draggingWindow: DraggableWindow | null = null;\r\n\r\n  constructor() {\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.className = \"window-container\";\r\n    //this.domElement.addEventListener(\"pointerdown\", () => {});\r\n  }\r\n\r\n  addWindow<T extends DraggableWindow>(window: T) {\r\n    if (this.windows.includes(window)) {\r\n      console.warn(\"Window already added\", window);\r\n      return;\r\n    }\r\n    this.windows.push(window);\r\n    this.domElement.appendChild(window.domElement);\r\n    if (!this._activeWindow) {\r\n      this._activeWindow = window;\r\n      this.activateWindow(window);\r\n    }    \r\n\r\n    window.domElement.addEventListener(\"pointerdown\", () => {\r\n      this.activateWindow(window);\r\n    });\r\n\r\n    window.on(\"close\", () => {\r\n      if (this._activeWindow === window) {\r\n        this._activeWindow = null;\r\n      }\r\n    });\r\n  }\r\n\r\n  activateWindow(window: DraggableWindow) {\r\n\r\n    if (this._activeWindow === window) {\r\n      return;\r\n    }\r\n\r\n    this._activeWindow = window;\r\n    this.domElement.appendChild(window.domElement);\r\n\r\n    for (const w of this.windows) {\r\n      w.domElement.classList.toggle(\"active\", w === window);\r\n    }\r\n  }\r\n}\r\n","export const DEFAULT_NOTE_HEIGHT = 20;\r\n\r\nexport const BOTTOM_ROW = [\r\n  90, 83, 88, 68, 67, 86, 71, 66, 72, 78, 74, 77, 188, 76, 190, 59, 191,\r\n];\r\n\r\nexport const TOP_ROW = [\r\n  81, 50, 87, 51, 69, 82, 53, 84, 54, 89, 55, 85, 73, 57, 79, 48, 80, 219, 61,\r\n  221,\r\n];\r\n\r\nexport const KEY_COLORS = [\r\n  \"white\",\r\n  \"black\",\r\n  \"white\",\r\n  \"white\",\r\n  \"black\",\r\n  \"white\",\r\n  \"black\",\r\n  \"white\",\r\n  \"white\",\r\n  \"black\",\r\n  \"white\",\r\n  \"black\",\r\n];\r\n\r\nexport const NOTE_NAMES = [\r\n  \"A\",\r\n  \"A#\",\r\n  \"B\",\r\n  \"C\",\r\n  \"C#\",\r\n  \"D\",\r\n  \"D#\",\r\n  \"E\",\r\n  \"F\",\r\n  \"F#\",\r\n  \"G\",\r\n  \"G#\",\r\n];\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { BOTTOM_ROW, TOP_ROW } from \"../../constants\";\r\n\r\nexport interface IKeyboardEvent {\r\n  type: \"press\" | \"release\";\r\n  note: number;\r\n}\r\n\r\nfunction keyToNote(keyCode: number) {\r\n  let note = -1;\r\n\r\n  if (BOTTOM_ROW.includes(keyCode)) {\r\n    note = BOTTOM_ROW.indexOf(keyCode);\r\n  } else if (TOP_ROW.includes(keyCode)) {\r\n    note = TOP_ROW.indexOf(keyCode) + 12;\r\n  }\r\n\r\n  return note;\r\n}\r\n\r\nexport class Keyboard extends BaseElement<\"update\"> {\r\n  constructor() {\r\n    super(\"div\", \"keyboard\");\r\n\r\n    const pressedKeys: number[] = [];\r\n\r\n    window.addEventListener(\"keydown\", (event) => {\r\n      //console.log(event.key, event.keyCode);\r\n\r\n      if (event.ctrlKey || event.altKey || event.shiftKey) return;\r\n\r\n      const target = event.target as HTMLElement;\r\n      if (target.tagName == \"INPUT\") return;\r\n\r\n      const note = keyToNote(event.keyCode);\r\n      if (note === -1 || pressedKeys.includes(note)) return;\r\n\r\n      pressedKeys.push(note);\r\n      this.emit(\"update\", { type: \"press\", note });\r\n    });\r\n\r\n    window.addEventListener(\"keyup\", (event) => {\r\n\r\n      const note = keyToNote(event.keyCode);\r\n      if (note === -1 || !pressedKeys.includes(note)) return;      \r\n\r\n      pressedKeys.splice(pressedKeys.indexOf(note), 1);\r\n      this.emit(\"update\", { type: \"release\", note });\r\n    });\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { BaseElement } from \"./BaseElement\";\r\n\r\nexport abstract class SizableElement<\r\n  T extends keyof EventDataMap,\r\n> extends BaseElement<\"resize\" | T> {\r\n  private _resizing = false;\r\n  private _startX = 0;\r\n  private _startY = 0;\r\n  private _startWidth = 0;\r\n  private _startHeight = 0;\r\n  private _startTop = 0;\r\n  private _startLeft = 0;\r\n\r\n  private _resizeDirection: \"top\" | \"right\" | \"bottom\" | \"left\" | null = null;\r\n\r\n  constructor(tagName: string, className?: string) {\r\n    super(tagName, className);\r\n\r\n    this.domElement.addEventListener(\"pointermove\", (e) => {\r\n      const handle = this.getCurrentHandle(e);\r\n      if (handle === \"top\" || handle === \"bottom\") {\r\n        this.domElement.style.cursor = \"ns-resize\";\r\n      } else if (handle === \"left\" || handle === \"right\") {\r\n        this.domElement.style.cursor = \"ew-resize\";\r\n      } else {\r\n        this.domElement.style.cursor = \"auto\";\r\n      }\r\n    });\r\n\r\n    const onmove = (e: PointerEvent) => {\r\n      if (this._resizing) {\r\n        console.log(this._resizeDirection);\r\n\r\n        const dx = e.clientX - this._startX;\r\n        const dy = e.clientY - this._startY;\r\n\r\n        if (this._resizeDirection === \"right\") {\r\n          this.domElement.style.width = `${this._startWidth + dx}px`;\r\n        } else if (this._resizeDirection === \"bottom\") {\r\n          this.domElement.style.height = `${this._startHeight + dy}px`;\r\n        } else if (this._resizeDirection === \"left\") {\r\n          this.domElement.style.width = `${this._startWidth - dx}px`;\r\n          this.domElement.style.left = `${this._startLeft + dx}px`;\r\n        } else if (this._resizeDirection === \"top\") {\r\n          this.domElement.style.height = `${this._startHeight - dy}px`;\r\n          this.domElement.style.top = `${this._startTop + dy}px`;\r\n        }\r\n\r\n        this.emit(\"resize\", {\r\n          width: this.domElement.offsetWidth,\r\n          height: this.domElement.offsetHeight,\r\n        });\r\n      }\r\n    };\r\n\r\n    this.domElement.addEventListener(\"pointerdown\", (e) => {\r\n      if (e.button !== 0) return;\r\n      //if (e.target !== this.domElement) return;      \r\n      const handle = this.getCurrentHandle(e);\r\n      if (handle) {\r\n        window.addEventListener(\"pointermove\", onmove);\r\n        this.startResize(e, handle);\r\n        e.preventDefault();\r\n      }\r\n      const onrelease = () => {\r\n        this.stopResize();\r\n        window.removeEventListener(\"pointermove\", onmove);\r\n        window.removeEventListener(\"pointerup\", onrelease);\r\n      };\r\n\r\n      window.addEventListener(\"pointerup\", onrelease);\r\n    });\r\n  }\r\n\r\n  protected startResize(\r\n    e: PointerEvent,\r\n    direction: \"top\" | \"right\" | \"bottom\" | \"left\"\r\n  ) {\r\n    console.log(\"startResize\", direction);\r\n    this._resizing = true;\r\n    this._startX = e.clientX;\r\n    this._startY = e.clientY;\r\n    this._startWidth = this.domElement.offsetWidth;\r\n    this._startHeight = this.domElement.offsetHeight;\r\n    this._startTop = this.domElement.offsetTop;\r\n    this._startLeft = this.domElement.offsetLeft;\r\n    this._resizeDirection = direction;\r\n  }\r\n\r\n  protected stopResize() {\r\n    this._resizing = false;\r\n    this._resizeDirection = null;\r\n  }\r\n\r\n  getCurrentHandle(e: PointerEvent) {\r\n    const rect = this.domElement.getBoundingClientRect();\r\n    const offsetX = e.clientX - rect.left;\r\n    const offsetY = e.clientY - rect.top;\r\n\r\n    if (offsetX > 0 && offsetX < 8) {\r\n      return \"left\";\r\n    } else if (rect.width - offsetX < 8) {\r\n      return \"right\";\r\n    } else if (offsetY > 0 && offsetY < 8) {\r\n      return \"top\";\r\n    } else if (rect.height - offsetY < 8) {\r\n      return \"bottom\";\r\n    }\r\n    return null;\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { SizableElement } from \"./SizableElement\";\r\n\r\nexport interface IWindowOptions {\r\n  title: string;\r\n  content?: HTMLElement;\r\n  persistent?: boolean;\r\n  width?: number;\r\n  height?: number;\r\n  top?: number;\r\n  left?: number;\r\n}\r\n\r\nexport class DraggableWindow<\r\n  T extends keyof EventDataMap = keyof EventDataMap,\r\n> extends SizableElement<\"update\" | \"resize\" | \"open\" | \"close\" | T> {\r\n  readonly titlebar: HTMLElement;\r\n  readonly content: HTMLElement;\r\n  private readonly persistent;\r\n  private readonly _title: HTMLElement;\r\n  private readonly _closeButton: HTMLButtonElement;\r\n  private _isDragging = false;\r\n  private _dragOffsetX = 0;\r\n  private _dragOffsetY = 0;\r\n  private _top = 0;\r\n  private _left = 0;\r\n\r\n  get isVisible() {\r\n    return this.domElement.style.display !== \"none\";\r\n  }\r\n\r\n  constructor(options: IWindowOptions) {\r\n    super(\"div\", \"draggable-window\");\r\n\r\n    this.domElement.style.display = \"none\";\r\n\r\n    this._top = options.top || 0;\r\n    this._left = options.left || 0;\r\n\r\n    this.persistent = options.persistent || false;\r\n\r\n    this.titlebar = document.createElement(\"div\");\r\n    this.titlebar.className = \"window-titlebar\";\r\n    this.domElement.appendChild(this.titlebar);\r\n\r\n    this.titlebar.addEventListener(\"pointerdown\", (e) => {\r\n      this._isDragging = true;\r\n      this._dragOffsetX =\r\n        e.clientX - this.domElement.getBoundingClientRect().left;\r\n      this._dragOffsetY =\r\n        e.clientY -\r\n        this.domElement.getBoundingClientRect().top +\r\n        this.domElement.parentElement!.getBoundingClientRect().top +\r\n        this.domElement.parentElement!.scrollTop;\r\n\r\n      const ondrag = (e: PointerEvent) => {\r\n        if (this._isDragging) {\r\n          console.log(\"Dragging\");\r\n\r\n          let newTop = e.clientY - this._dragOffsetY;\r\n          let newLeft = e.clientX - this._dragOffsetX;\r\n\r\n          if (newTop < 0) {\r\n            newTop = 0;\r\n          }\r\n\r\n          if (newLeft < 0) {\r\n            newLeft = 0;\r\n          }\r\n\r\n          this.domElement.style.top = `${newTop}px`;\r\n          this.domElement.style.left = `${newLeft}px`;\r\n\r\n          this._top = newTop;\r\n          this._left = newLeft;\r\n        }\r\n      };\r\n\r\n      const onrelease = () => {\r\n        this._isDragging = false;\r\n        document.body.removeEventListener(\"pointermove\", ondrag);\r\n        document.body.removeEventListener(\"pointerup\", onrelease);\r\n      };\r\n\r\n      document.body.addEventListener(\"pointermove\", ondrag);\r\n      document.body.addEventListener(\"pointerup\", onrelease);\r\n    });\r\n\r\n    this._title = document.createElement(\"div\");\r\n    this._title.className = \"window-titlebar-title\";\r\n    this._title.textContent = options.title;\r\n    this.titlebar.appendChild(this._title);\r\n\r\n    this.content = document.createElement(\"div\");\r\n    this.content.className = \"window-content\";\r\n    this.domElement.appendChild(this.content);\r\n\r\n    this._closeButton = document.createElement(\"button\");\r\n    this._closeButton.className = \"window-close-button\";\r\n    this._closeButton.addEventListener(\"pointerdown\", (e) => {\r\n      if (e.button === 0) this.close();\r\n    });\r\n\r\n    this.titlebar.appendChild(this._closeButton);\r\n\r\n    const width = options.width || 640;\r\n    const height = options.height || 400;\r\n    this.setSize(width, height);\r\n\r\n    if (options.content) this.content.appendChild(options.content);\r\n  }\r\n\r\n  show(x?: number, y?: number) {\r\n\r\n    if (x === undefined) x = this._left;\r\n    if (y === undefined) y = this._top;\r\n\r\n    this._top = y;\r\n    this._left = x;\r\n\r\n    if (this._top === 0 && this._left === 0) {\r\n      x = window.innerWidth / 2 - 200;\r\n      y = window.innerHeight / 4;\r\n    }\r\n\r\n    this.domElement.style.display = \"flex\";\r\n    this.domElement.style.top = `${y}px`;\r\n    this.domElement.style.left = `${x}px`;\r\n    setTimeout(() => {\r\n      this.domElement.parentElement?.appendChild(this.domElement);\r\n      this.emit(\"open\");\r\n    }, 1);\r\n  }\r\n\r\n  close() {\r\n    this.domElement.style.display = \"none\";\r\n    this.emit(\"close\");\r\n    if (!this.persistent) {\r\n      console.log(\"Removing window\", this);\r\n      this.domElement.remove();\r\n    }\r\n  }\r\n\r\n  setSize(width: number, height: number) {\r\n    this.domElement.style.width = `${width}px`;\r\n    this.domElement.style.height = `${height}px`;\r\n  }\r\n\r\n  setPosition(x: number, y: number) {\r\n    this.domElement.style.top = `${y}px`;\r\n    this.domElement.style.left = `${x}px`;\r\n  }\r\n\r\n  setTitle(title: string) {\r\n    this._title.textContent = title;\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\n\r\nexport class MixerChannel extends BaseElement<\"update\"> {\r\n  private readonly _channel: number;\r\n  private readonly _volume: HTMLInputElement;\r\n  private readonly _mute: HTMLInputElement;\r\n  private readonly _solo: HTMLInputElement;\r\n  private readonly _label: HTMLSpanElement;\r\n\r\n  get channel() {\r\n    return this._channel;\r\n  }\r\n\r\n  get volume() {\r\n    return this._volume.valueAsNumber;\r\n  }\r\n\r\n  set volume(value: number) {\r\n    this._volume.value = value.toString();\r\n  }\r\n\r\n  get mute() {\r\n    return this._mute.checked;\r\n  }\r\n\r\n  set mute(value: boolean) {\r\n    this._mute.checked = value;\r\n  }\r\n\r\n  get solo() {\r\n    return this._solo.checked;\r\n  }\r\n\r\n  set solo(value: boolean) {\r\n    this._solo.checked = value;\r\n  }\r\n\r\n  constructor(channel: number, label: string) {\r\n    super(\"div\", \"mixer-channel\");\r\n\r\n    this._channel = channel;\r\n\r\n    this._label = document.createElement(\"span\");\r\n    this._label.textContent = label;\r\n    this.domElement.appendChild(this._label);\r\n\r\n    const volume = document.createElement(\"input\");\r\n    volume.type = \"range\";\r\n    volume.min = \"0\";\r\n    volume.max = \"1.2\";\r\n    volume.step = \"0.01\";\r\n    volume.value = \"1\";\r\n\r\n    const mute = document.createElement(\"input\");\r\n    mute.type = \"checkbox\";\r\n\r\n    const solo = document.createElement(\"input\");\r\n    solo.type = \"checkbox\";\r\n\r\n    this._volume = volume;\r\n    this._mute = mute;\r\n    this._solo = solo;\r\n\r\n    this.domElement.appendChild(volume);\r\n    this.domElement.appendChild(mute);\r\n    this.domElement.appendChild(solo);\r\n\r\n    volume.addEventListener(\"input\", () => {\r\n      this.emit(\"update\");\r\n    });\r\n\r\n    mute.addEventListener(\"change\", () => {\r\n      this.emit(\"update\");\r\n    });\r\n\r\n    solo.addEventListener(\"change\", () => {\r\n      this.emit(\"update\");\r\n    });\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { ProjectUI } from \"../ProjectUI\";\r\nimport { MixerChannel } from \"../components/MixerChannel\";\r\n\r\nexport class MixerWindow extends DraggableWindow {\r\n  constructor(readonly ui: ProjectUI) {\r\n    super({\r\n      title: \"Mixer\",\r\n      persistent: true,\r\n      content: document.createElement(\"div\"),\r\n      width: 500,\r\n      height: 300,\r\n    });\r\n\r\n    this.domElement.classList.add(\"mixer-window\");\r\n\r\n    const container = document.createElement(\"div\");\r\n    container.style.display = \"flex\";\r\n    container.style.width = \"100%\";\r\n    container.style.height = \"100%\";\r\n    container.style.overflowX = \"auto\";        \r\n\r\n    const masterChannel = new MixerChannel(0, \"Master\");\r\n    container.appendChild(masterChannel.domElement);\r\n\r\n    this.content.appendChild(container);\r\n\r\n    for (let i = 0; i < 16; i++) {\r\n      const channel = new MixerChannel(i + 1, `${i + 1}`);\r\n      container.appendChild(channel.domElement);\r\n    }\r\n  }\r\n}\r\n","import { BaseElement } from \"./BaseElement\";\r\nimport { SelectableElement } from \"./SelectableElement\";\r\n\r\nexport class SelectableGroup<\r\n  T extends SelectableElement,\r\n> extends BaseElement<\"select\"> {\r\n  constructor(readonly items: T[] = []) {\r\n    super(\"div\", \"selectable-group\");\r\n    for (const item of items) {\r\n      this.addSelectable(item, false);\r\n    }\r\n  }\r\n\r\n  addSelectable(selectable: T, addToDom = true) {\r\n    if (this.items.indexOf(selectable) !== -1) {\r\n      console.warn(\"Already added\", selectable);\r\n    } else {\r\n      this.items.push(selectable);\r\n      selectable.on(\"select\", () => {\r\n        this.emit(\"select\", this);\r\n      });\r\n      if (addToDom) this.domElement.appendChild(selectable.domElement);\r\n\r\n      selectable.domElement.addEventListener(\"pointerdown\", (e) => {\r\n        e.preventDefault();\r\n        if (!e.ctrlKey && !e.shiftKey) {\r\n          for (const item of this.items) {\r\n            item.selected = item === selectable;\r\n          }\r\n        } else if (e.ctrlKey) {\r\n          selectable.selected = !selectable.selected;\r\n        } else if (e.shiftKey) {\r\n          const f = this.items.find((t) => t.selected);\r\n          if (!f) {\r\n            selectable.selected = true;\r\n            return;\r\n          }\r\n          const start = this.items.indexOf(f);\r\n          const end = this.items.indexOf(selectable);\r\n          const min = Math.min(start, end);\r\n          const max = Math.max(start, end);\r\n          for (let i = min; i <= max; i++) {\r\n            this.items[i].selected = true;\r\n          }\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  removeSelectable(selectable: T) {\r\n    const index = this.items.indexOf(selectable);\r\n    if (index !== -1) {\r\n      this.items.splice(index, 1);\r\n      this.domElement.removeChild(selectable.domElement);\r\n    }\r\n  }\r\n\r\n  clear() {\r\n    for (const item of this.items) {\r\n      this.domElement.removeChild(item.domElement);\r\n    }\r\n    this.items.length = 0;\r\n  }\r\n}\r\n","import { AudioClock } from \"./AudioClock\";\r\n\r\nexport interface ICursorTimeline {\r\n  domElement: HTMLElement;\r\n  timeline: HTMLElement;\r\n  cursor: AudioCursor;\r\n  audioClock: AudioClock;\r\n  beatWidth: number;\r\n}\r\n\r\nexport class AudioCursor {\r\n  readonly domElement: HTMLDivElement;\r\n\r\n  constructor(readonly timeline: ICursorTimeline) {\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"audio-cursor\");\r\n\r\n    const clock = timeline.audioClock;\r\n\r\n    clock.on(\"update\", () => {\r\n      this.update();\r\n    });\r\n\r\n    clock.on(\"start\", () => {\r\n      this.domElement.style.transform = \"translateX(0)\";\r\n      this.domElement.style.display = \"block\";\r\n      this.domElement.parentElement?.appendChild(this.domElement);\r\n    });\r\n\r\n    clock.on(\"stop\", () => {\r\n      this.domElement.style.display = \"none\";\r\n    });\r\n  }\r\n\r\n  update() {\r\n    this.domElement.style.transform = `translateX(${\r\n      this.timeline.audioClock.currentBeat * this.timeline.beatWidth\r\n    }px)`;\r\n  }\r\n\r\n  hide() {\r\n    this.domElement.style.display = \"none\";\r\n  }\r\n}\r\n","export async function triggerActive(elt: HTMLElement, timeout = 100) {  \r\n  elt.classList.toggle(\"active\", true);\r\n  setTimeout(() => {\r\n    elt.classList.toggle(\"active\", false);\r\n  }, timeout);\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { BaseElement } from \"./BaseElement\";\r\nimport { SelectableGroup } from \"./SelectableGroup\";\r\n\r\nexport class SelectableElement<\r\n  T extends keyof EventDataMap = \"select\",\r\n> extends BaseElement<\"select\" | T> {\r\n  get selected() {\r\n    return this.domElement.classList.contains(\"selected\");\r\n  }\r\n\r\n  set selected(value: boolean) {\r\n    if (value === this.selected) return;\r\n    this.domElement.classList.toggle(\"selected\", value);\r\n    this.emit(\"select\", this);\r\n  }\r\n\r\n  constructor(\r\n    readonly group: SelectableGroup<SelectableElement>,\r\n    tagName: string,\r\n    className?: string\r\n  ) {\r\n    super(tagName, className);\r\n    this.group.addSelectable(this);\r\n  }\r\n}\r\n","import { triggerActive } from \"../../../../elements/src/animation\";\r\nimport { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { SelectableElement } from \"../../../../elements/src/elements/SelectableElement\";\r\nimport { SelectableGroup } from \"../../../../elements/src/elements/SelectableGroup\";\r\nimport { Instrument } from \"../../abstracts/Instrument\";\r\nimport { INoteEvent, ISequence } from \"../../schema\";\r\nimport { Project } from \"../Project\";\r\nimport { ISourceEvent } from \"./SamplerSlot\";\r\n\r\nexport class PatternTrackInstrument extends SelectableElement {\r\n  readonly indicator: HTMLDivElement;\r\n\r\n  constructor(\r\n    readonly track: PatternTrack,\r\n    buttonGroup: SelectableGroup<PatternTrackInstrument>\r\n  ) {\r\n    console.assert(track, \"PatternTrackInstrument track is null or undefined\");\r\n\r\n    super(buttonGroup, \"div\", \"pattern-track-instrument\");\r\n\r\n    document.createElement(\"div\");\r\n    this.domElement.classList.add(\"pattern-track-panel\");\r\n\r\n    const textLabel = document.createElement(\"div\");\r\n    textLabel.textContent = track.name;\r\n\r\n    const buttons = document.createElement(\"div\");\r\n    buttons.classList.add(\"pattern-track-buttons\");\r\n\r\n    const edit = document.createElement(\"div\");\r\n    edit.classList.add(\"track-button\");\r\n    edit.classList.add(\"track-edit-button\");\r\n    edit.textContent = \"e\";\r\n    edit.addEventListener(\"pointerdown\", () => {\r\n      if (this.track.instrument.window.isVisible) {\r\n        this.track.instrument.window.close();\r\n      } else {\r\n        track.instrument.window.show();\r\n      }\r\n    });\r\n    this.track.instrument.window.on(\"close\", () => {\r\n      edit.classList.toggle(\"active\", false);\r\n    });\r\n    this.track.instrument.window.on(\"open\", () => {\r\n      edit.classList.toggle(\"active\", true);\r\n    });\r\n    buttons.appendChild(edit);\r\n\r\n    const mute = document.createElement(\"div\");\r\n    mute.classList.add(\"track-button\");\r\n    mute.classList.add(\"track-mute-button\");\r\n    mute.textContent = \"M\";\r\n    mute.addEventListener(\"pointerdown\", () => {\r\n      mute.classList.toggle(\"active\");\r\n    });\r\n    buttons.appendChild(mute);\r\n\r\n    const solo = document.createElement(\"div\");\r\n    solo.classList.add(\"track-button\");\r\n    solo.classList.add(\"track-solo-button\");\r\n    solo.textContent = \"S\";\r\n    solo.addEventListener(\"pointerdown\", () => {\r\n      solo.classList.toggle(\"active\");\r\n    });\r\n    buttons.appendChild(solo);\r\n\r\n    buttons.appendChild(mute);\r\n    buttons.appendChild(solo);\r\n\r\n    this.indicator = document.createElement(\"div\");\r\n    this.indicator.classList.add(\"pattern-track-indicator\");\r\n    buttons.appendChild(this.indicator);\r\n\r\n    this.domElement.appendChild(textLabel);\r\n    this.domElement.appendChild(buttons);\r\n  }\r\n}\r\n\r\nexport class PatternTrackPreview extends SelectableElement {\r\n  private _canvas: HTMLCanvasElement;\r\n\r\n  get canvas() {\r\n    return this._canvas;\r\n  }\r\n\r\n  constructor(\r\n    readonly track: PatternTrack,\r\n    previewGroup: SelectableGroup<PatternTrackPreview>\r\n  ) {\r\n    console.assert(track, \"PatternTrackPreview track is null or undefined\");\r\n\r\n    super(previewGroup, \"div\", \"pattern-track-preview\");\r\n    this._canvas = document.createElement(\"canvas\");\r\n    this._canvas.height = 100;\r\n    this._canvas.width = 1600;\r\n    this._canvas.classList.add(\"pattern-track-pattern\");\r\n\r\n    this.domElement.append(this._canvas);\r\n  }\r\n}\r\n\r\nexport class PatternTrack extends BaseElement<\"update\"> implements ISequence {\r\n  readonly button: PatternTrackInstrument;\r\n  readonly preview: PatternTrackPreview;\r\n  port: number | null = null;\r\n  channel: number = 0;\r\n  events: INoteEvent[] = [];\r\n\r\n  get name() {\r\n    return this.instrument.name;\r\n  }\r\n\r\n  constructor(\r\n    readonly project: Project,\r\n    public instrument: Instrument,\r\n    readonly buttonGroup: SelectableGroup<PatternTrackInstrument>,\r\n    readonly previewGroup: SelectableGroup<PatternTrackPreview>\r\n  ) {\r\n    super(\"div\", \"pattern-track\");\r\n\r\n    this.button = new PatternTrackInstrument(this, this.buttonGroup);\r\n    this.preview = new PatternTrackPreview(this, this.previewGroup);\r\n\r\n    this.domElement.appendChild(this.button.domElement);\r\n    this.domElement.appendChild(this.preview.domElement);\r\n  }\r\n\r\n  trigger(note: number, beat: number = this.project.audioClock.currentBeat) {\r\n    const source = this.instrument.trigger(note, this.channel, beat);\r\n    if (beat > 0) {\r\n      this.project.audioClock.scheduleEventAtBeat(() => {\r\n        triggerActive(this.button.indicator);\r\n      }, beat);\r\n    } else {\r\n      triggerActive(this.button.indicator);\r\n    }\r\n    return source;\r\n  }\r\n\r\n  release(note: number, beat: number = this.project.audioClock.currentBeat) {\r\n    this.instrument.release(note, beat);\r\n  }\r\n\r\n  load(sequence: ISequence) {\r\n    this.events = sequence.events;\r\n  }\r\n\r\n  playback() {\r\n    if (!this.project.audioClock.isPlaying) {\r\n      console.warn(\"Playback cancelled\");\r\n      return;\r\n    }\r\n\r\n    let sourceEvent: ISourceEvent | undefined = undefined;\r\n\r\n    for (const event of this.events) {\r\n      sourceEvent = this.trigger(event.note, event.start);\r\n      if (event.domElement) {\r\n        this.project.audioClock.scheduleEventAtBeat(\r\n          () => event.domElement!.classList.toggle(\"active\", true),\r\n          event.start\r\n        );\r\n        this.project.audioClock.scheduleEventAtBeat(\r\n          () => event.domElement!.classList.toggle(\"active\", false),\r\n          event.start + event.duration\r\n        );\r\n      }\r\n    }\r\n\r\n    if (typeof sourceEvent !== \"undefined\" && \"source\" in sourceEvent) {\r\n      sourceEvent.source.onended = () => {\r\n        const nextLoop =\r\n          this.project.audioClock.currentBeat +\r\n          (4 - (this.project.audioClock.currentBeat % 4));\r\n        this.project.audioClock.scheduleEventAtBeat(() => {\r\n          this.project.audioClock.restart();\r\n          this.playback();\r\n        }, nextLoop);\r\n      };\r\n    }\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { SelectableGroup } from \"../../../../elements/src/elements/SelectableGroup\";\r\nimport { Instrument } from \"../../abstracts/Instrument\";\r\nimport { IPattern } from \"../../schema\";\r\nimport { Project } from \"../Project\";\r\nimport { ProjectUI } from \"../ProjectUI\";\r\nimport { AudioClock } from \"../components/AudioClock\";\r\nimport { AudioCursor, ICursorTimeline } from \"../components/AudioCursor\";\r\nimport {\r\n  PatternTrack,\r\n  PatternTrackInstrument,\r\n  PatternTrackPreview,\r\n} from \"../components/PatternTrack\";\r\n\r\nexport class PatternWindow\r\n  extends DraggableWindow<\"select\" | \"edit\">\r\n  implements ICursorTimeline\r\n{\r\n  readonly trackContainer: HTMLDivElement;\r\n  readonly cursor: AudioCursor;\r\n  readonly timeline: HTMLDivElement;\r\n  readonly tracks: PatternTrack[] = [];\r\n  readonly patternPreviews: SelectableGroup<PatternTrackPreview>;\r\n  readonly buttons: SelectableGroup<PatternTrackInstrument>;\r\n\r\n  get audioClock(): AudioClock {\r\n    return this.ui.project.audioClock;\r\n  }\r\n\r\n  beatWidth = 20;\r\n\r\n  constructor(public ui: ProjectUI) {\r\n    const container = document.createElement(\"div\");\r\n    container.classList.add(\"pattern-track-container\");\r\n\r\n    super({\r\n      title: \"Pattern\",\r\n      persistent: true,\r\n      content: container,\r\n      width: 400,\r\n      height: 400,\r\n    });\r\n    this.trackContainer = container;\r\n\r\n    this.timeline = this.trackContainer;\r\n\r\n    this.cursor = new AudioCursor(this);\r\n    this.timeline.appendChild(this.cursor.domElement);\r\n\r\n    const canvas = this.domElement.querySelector(\"canvas\");\r\n    if (canvas) this.beatWidth = canvas.width / 16;\r\n\r\n    this.on(\"resize\", () => {\r\n      this.beatWidth = this.domElement.clientWidth / 16;\r\n    });\r\n\r\n    ui.project.audioClock.on(\"start\", () => {\r\n      if (!ui.project.audioClock.startTime) {\r\n        throw new Error(\"Audio clock start time is not set\");\r\n      }\r\n      for (const track of this.tracks) {\r\n        track.playback();\r\n      }\r\n    });\r\n\r\n    this.addPattern(\"Pattern 1\");\r\n\r\n    this.patternPreviews = new SelectableGroup<PatternTrackPreview>();\r\n    this.buttons = new SelectableGroup<PatternTrackInstrument>();\r\n\r\n    // container.appendChild(this.cursor.domElement);\r\n  }\r\n\r\n  loadProject(project: Project) {\r\n    for (const track of this.tracks) {\r\n      this.trackContainer.removeChild(track.domElement);\r\n    }\r\n    this.tracks.length = 0;\r\n    for (let i = 0; i < project.instruments.length; i++) {\r\n      const track = this.addTrack(project.instruments[i]);\r\n      track.load(project.patterns[0].sequences[i]);\r\n      if (i === 0) {\r\n        track.button.selected = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  addPattern(name: string) {\r\n    console.log(\"Created pattern:\", name);\r\n    const pattern: IPattern = { name, sequences: [] };\r\n    this.ui.project.patterns.push(pattern);\r\n  }\r\n\r\n  addTrack(instrument: Instrument) {\r\n    console.log(\"Add track + instrument:\", instrument);\r\n\r\n    const track = new PatternTrack(\r\n      this.ui.project,\r\n      instrument,\r\n      this.buttons,\r\n      this.patternPreviews\r\n    );\r\n\r\n    console.assert(\r\n      track.button instanceof PatternTrackInstrument,\r\n      \"button is not an instance of PatternTrackInstrument\"\r\n    );\r\n    console.assert(\r\n      track.preview instanceof PatternTrackPreview,\r\n      \"preview is not an instance of PatternTrackPreview\"\r\n    );\r\n\r\n    track.preview.domElement.addEventListener(\"pointerdown\", () => {\r\n      this.ui.pianoRollWindow.loadTrack(track);\r\n      this.ui.pianoRollWindow.show();\r\n    });\r\n\r\n    this.tracks.push(track);\r\n    this.trackContainer.appendChild(track.domElement);\r\n\r\n    return track;\r\n  }\r\n\r\n  removeTrack(track: PatternTrack) {\r\n    const index = this.tracks.indexOf(track);\r\n    if (index !== -1) {\r\n      this.tracks.splice(index, 1);\r\n      this.trackContainer.removeChild(track.domElement);\r\n      this.patternPreviews.removeSelectable(track.preview);\r\n      this.buttons.removeSelectable(track.button);\r\n    }\r\n  }\r\n\r\n  trigger(note: number, beat: number = this.audioClock.currentBeat) {\r\n    for (const track of this.tracks) {\r\n      if (track.button.selected) {\r\n        track.trigger(note, beat);\r\n      }\r\n    }\r\n  }\r\n\r\n  release(note: number, beat: number = this.audioClock.currentBeat) {\r\n    for (const track of this.tracks) {\r\n      if (track.button.selected) {\r\n        track.release(note, beat);\r\n      }\r\n    }\r\n  }\r\n\r\n  play() {\r\n    if (this.audioClock.startTime == null) {\r\n      throw new Error(\"Audio clock start time is not set\");\r\n    }\r\n    for (const track of this.tracks) {\r\n      for (const event of track.events) {\r\n        track.trigger(\r\n          event.note,\r\n          this.audioClock.startTime + (event.start * 60) / this.audioClock.bpm\r\n        );\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { EventDataMap } from \"../EventObject\";\r\nimport { BaseElement } from \"./BaseElement\";\r\n\r\nexport abstract class ScrollPanel<\r\n  T extends keyof EventDataMap,\r\n> extends BaseElement<\"scroll\" | T> {\r\n  sensitivity = 50;\r\n  private linkedElements: HTMLElement[] = [];\r\n  private _scrollTop = 0;\r\n\r\n  get scrollTop() {\r\n    return this._scrollTop;\r\n  }\r\n\r\n  set scrollTop(value: number) {\r\n    const top = -value;\r\n    this._scrollTop = top;\r\n    this.scrollElement.style.transform = `translateY(${top}px)`;\r\n    for (const linkedElement of this.linkedElements) {\r\n      linkedElement.style.transform = `translateY(${top}px)`;\r\n    }\r\n  }\r\n\r\n  constructor(readonly scrollElement: HTMLElement) {\r\n    super(\"div\", \"scroll-panel\");\r\n    scrollElement.classList.add(\"scroll-panel-content\");\r\n\r\n    this.scrollElement.addEventListener(\"wheel\", (e) => {\r\n      e.preventDefault();\r\n      console.log(e.deltaY);\r\n      let top =\r\n        this._scrollTop + (e.deltaY > 0 ? -this.sensitivity : this.sensitivity);\r\n      const bottom = top + this.scrollElement.offsetHeight;\r\n      if (bottom < this.domElement.offsetHeight) {\r\n        top = this.domElement.offsetHeight - this.scrollElement.offsetHeight;\r\n      } else if (top > 0) {\r\n        top = 0;\r\n      }\r\n      this._scrollTop = top;\r\n      this.scrollElement.style.transform = `translateY(${top}px)`;\r\n      for (const linkedElement of this.linkedElements) {\r\n        linkedElement.style.transform = `translateY(${top}px)`;\r\n      }\r\n\r\n      this.emit(\"scroll\", e);\r\n    });\r\n  }\r\n\r\n  linkElement(element: HTMLElement) {\r\n    this.linkedElements.push(element);\r\n    element.classList.add(\"scroll-panel-content\");\r\n  }\r\n}\r\n","import { getAudioContext } from \"../../../elements/src/managers/AudioManager\";\r\n\r\nexport class AudioCanvas {\r\n  domElement: HTMLDivElement;\r\n  canvas: HTMLCanvasElement;\r\n  ctx: CanvasRenderingContext2D;\r\n  buffer: AudioBuffer | null = null;\r\n\r\n  constructor(width = 800, height = 200, playOnClick = true) {\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"audio-canvas\");\r\n\r\n    this.canvas = document.createElement(\"canvas\");\r\n    this.canvas.width = width;\r\n    this.canvas.height = height;\r\n    this.domElement.appendChild(this.canvas);\r\n\r\n    if (playOnClick) {\r\n      this.canvas.addEventListener(\"click\", () => {\r\n        if (this.buffer) {\r\n          this.playBuffer(this.buffer);\r\n        }\r\n      });\r\n    }\r\n\r\n    this.ctx = this.canvas.getContext(\"2d\") as CanvasRenderingContext2D;\r\n  }\r\n\r\n  async generateAudio(\r\n    note: { label: string; note: number },\r\n    preview: boolean = false\r\n  ): Promise<AudioBuffer> {\r\n    const buffer: AudioBuffer = await new Promise((resolve, reject) => {\r\n      const req = {\r\n        text: note.label,\r\n        pitch: note.note,\r\n        rate: 0.9,\r\n      };\r\n      fetch(\"/api/tts/edge\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify(req),\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      })\r\n        .then((res) => res.arrayBuffer())\r\n        .then((data) => {\r\n          console.log(\"Audio buffer downloaded\", data);\r\n          getAudioContext().decodeAudioData(\r\n            data,\r\n            (audioBuffer: AudioBuffer) => {\r\n              this.buffer = audioBuffer;\r\n              if (preview) {\r\n                this.playBuffer(audioBuffer);\r\n              }\r\n\r\n              resolve(audioBuffer);\r\n            }\r\n          );\r\n        })\r\n        .catch((error) => {\r\n          console.error(\"Error downloading audio buffer\", error);\r\n          reject(error);\r\n        });\r\n    });\r\n\r\n    this.loadBuffer(buffer);\r\n\r\n    return buffer;\r\n  }\r\n\r\n  playBuffer(audioBuffer: AudioBuffer) {\r\n    const ctx = getAudioContext();\r\n    const source = ctx.createBufferSource();\r\n    source.buffer = audioBuffer;\r\n    source.connect(ctx.destination);\r\n    source.start();\r\n  }\r\n\r\n  loadBuffer(audioBuffer: AudioBuffer) {\r\n    this.buffer = audioBuffer;\r\n\r\n    const channelData = audioBuffer.getChannelData(0);\r\n    const bufferLength = channelData.length;\r\n    const sliceWidth = this.canvas.width / bufferLength;\r\n\r\n    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(0, this.canvas.height / 2);\r\n\r\n    for (let i = 0; i < bufferLength; i++) {\r\n      const x = i * sliceWidth;\r\n      const y = ((channelData[i] + 1) * this.canvas.height) / 2;\r\n\r\n      this.ctx.lineTo(x, y);\r\n    }\r\n\r\n    this.ctx.lineTo(this.canvas.width, this.canvas.height / 2);\r\n    this.ctx.stroke();\r\n  }\r\n}\r\n","import { AudioCanvas } from \"../../../../elements/src/elements/AudioCanvas\";\r\nimport { getAudioContext } from \"../../../../elements/src/managers/AudioManager\";\r\n\r\nexport class LyricCanvas extends AudioCanvas {\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  async generateAudio(\r\n    note: { label: string; note: number },\r\n    preview: boolean = false\r\n  ): Promise<AudioBuffer> {\r\n    const buffer: AudioBuffer = await new Promise((resolve, reject) => {\r\n      const req = {\r\n        text: note.label,\r\n        pitch: note.note,\r\n        rate: 0.9,\r\n      };\r\n      fetch(\"/api/tts/edge\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify(req),\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      })\r\n        .then((res) => res.arrayBuffer())\r\n        .then((data) => {\r\n          console.log(\"Audio buffer downloaded\", data);\r\n          getAudioContext().decodeAudioData(\r\n            data,\r\n            (audioBuffer: AudioBuffer) => {\r\n              this.buffer = audioBuffer;\r\n              if (preview) {\r\n                this.playBuffer(audioBuffer);\r\n              }\r\n\r\n              resolve(audioBuffer);\r\n            }\r\n          );\r\n        })\r\n        .catch((error) => {\r\n          console.error(\"Error downloading audio buffer\", error);\r\n          reject(error);\r\n        });\r\n    });\r\n\r\n    this.loadBuffer(buffer);\r\n\r\n    return buffer;\r\n  }\r\n}\r\n","import { BaseElement } from \"./BaseElement\";\r\n\r\nexport class DialogPopup extends BaseElement<\"result\" | \"cancel\"> {  \r\n  closeButton: HTMLButtonElement;\r\n  okButton: HTMLButtonElement | undefined;\r\n  cancelButton: HTMLButtonElement | undefined;\r\n\r\n  get isVisibile() {\r\n    return this.domElement.style.display !== \"none\";\r\n  }\r\n\r\n  constructor(\r\n    private readonly ok: string | HTMLButtonElement = \"OK\",\r\n    private readonly cancel: string | HTMLButtonElement = \"Cancel\"\r\n  ) {\r\n    super(\"div\", \"dialog-popup\");\r\n\r\n    this.closeButton = document.createElement(\"button\");\r\n    this.closeButton.classList.add(\"window-close-button\");    \r\n    this.domElement.appendChild(this.closeButton);\r\n    this.closeButton.addEventListener(\"pointerdown\", () => {\r\n      this.domElement.style.display = \"none\";\r\n    });\r\n\r\n    if (ok instanceof HTMLButtonElement) {\r\n      this.okButton = ok;\r\n    } else if (ok) {\r\n      this.okButton = document.createElement(\"button\");\r\n      this.okButton.textContent = ok;\r\n      this.domElement.appendChild(this.okButton);\r\n    }\r\n\r\n    if (this.okButton) {\r\n      this.okButton.addEventListener(\"click\", () => {\r\n        this.emit(\"result\", this);\r\n      });\r\n    }\r\n\r\n    if (cancel instanceof HTMLButtonElement) {\r\n      this.cancelButton = cancel;\r\n    } else if (cancel) {\r\n      this.cancelButton = document.createElement(\"button\");\r\n      this.cancelButton.textContent = cancel;\r\n      this.domElement.appendChild(this.cancelButton);\r\n    }\r\n\r\n    if (this.cancelButton) {\r\n      this.cancelButton.addEventListener(\"click\", () => {\r\n        this.emit(\"cancel\", this);\r\n      });\r\n    }\r\n  }\r\n\r\n  show(x: number, y: number, targetObject?: unknown) { /* eslint-disable-line @typescript-eslint/no-unused-vars */\r\n    this.domElement.style.display = \"block\";\r\n    this.domElement.style.left = `${x}px`;\r\n    this.domElement.style.top = `${y}px`;\r\n    this.domElement.parentElement?.appendChild(this.domElement);\r\n  }\r\n\r\n  hide() {\r\n    this.domElement.style.display = \"none\";\r\n  }\r\n}\r\n","import { LyricCanvas } from \"./components/LyricCanvas\";\r\nimport { DialogPopup } from \"../../../elements/src/elements/DialogPopup\";\r\nimport { INoteEvent } from \"../schema\";\r\n\r\nexport class PianoRollDialog extends DialogPopup {\r\n  domElement: HTMLDivElement;\r\n  closeButton: HTMLButtonElement;\r\n  saveButton: HTMLButtonElement;\r\n  note: INoteEvent | null = null;\r\n\r\n  constructor(public onsave: (note: INoteEvent) => void) {\r\n    super();\r\n\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"piano-roll-dialog\");\r\n\r\n    this.closeButton = document.createElement(\"button\");\r\n    this.closeButton.classList.add(\"window-close-button\");\r\n    this.domElement.appendChild(this.closeButton);\r\n    this.closeButton.addEventListener(\"click\", () => {\r\n      this.domElement.style.display = \"none\";\r\n    });\r\n\r\n    this.saveButton = document.createElement(\"button\");\r\n    this.saveButton.textContent = \"Save\";\r\n    this.domElement.appendChild(this.saveButton);\r\n    this.saveButton.addEventListener(\"click\", () => {\r\n      this.onsave(this.note!);\r\n    });\r\n  }\r\n\r\n  override show(x: number, y: number, note: INoteEvent) {\r\n    super.show(x, y, note);\r\n    this.note = note;\r\n    this.domElement.parentElement?.appendChild(this.domElement);\r\n  }\r\n}\r\n\r\nexport class LyricEditorDialog extends PianoRollDialog {\r\n  textInput: HTMLInputElement;\r\n  audioCanvas: LyricCanvas;\r\n  pitchSlider: HTMLInputElement;\r\n  constructor(onsave: (note: INoteEvent) => void) {\r\n    super(onsave);\r\n    this.domElement.classList.add(\"piano-roll-note-editor\");\r\n    this.domElement.style.display = \"none\";\r\n\r\n    this.textInput = document.createElement(\"input\");\r\n    this.textInput.setAttribute(\"placeholder\", \"Note lyric\");\r\n    this.textInput.classList.add(\"lyric-editor-text\");\r\n    this.textInput.type = \"text\";\r\n    this.domElement.appendChild(this.textInput);\r\n\r\n    this.pitchSlider = document.createElement(\"input\");\r\n    this.pitchSlider.classList.add(\"lyric-editor-pitch\");\r\n    this.pitchSlider.type = \"range\";\r\n    this.pitchSlider.min = \"-0.5\";\r\n    this.pitchSlider.max = \"0.5\";\r\n    this.pitchSlider.step = \"0.01\";\r\n    this.pitchSlider.value = \"0\";\r\n    this.pitchSlider.addEventListener(\"input\", () => {\r\n      this.note!.note = parseFloat(this.pitchSlider.value);\r\n    });\r\n    this.domElement.appendChild(this.pitchSlider);\r\n\r\n    this.audioCanvas = new LyricCanvas();\r\n    this.domElement.appendChild(this.audioCanvas.domElement);\r\n\r\n    this.saveButton.addEventListener(\"click\", () => {\r\n      this.audioCanvas.domElement.style.display = \"block\";\r\n      // this.audioCanvas.generateAudio(this.note!, true).then((buffer) => {\r\n      //   this.note!.audio = buffer;\r\n      // });\r\n      // this.onsave(this.note!);\r\n    });\r\n  }\r\n\r\n  show(x: number, y: number, note: INoteEvent) {\r\n    super.show(x, y, note);\r\n    this.textInput.value = this.note?.label || \"\";\r\n    // if (this.note?.audio) {\r\n    //   this.audioCanvas.loadBuffer(this.note.audio);\r\n    //   this.audioCanvas.domElement.style.display = \"block\";\r\n    // } else {\r\n    //   this.audioCanvas.domElement.style.display = \"none\";\r\n    // }\r\n  }\r\n}\r\n","import { ScrollPanel } from \"../../../../elements/src/elements/ScrollPanel\";\r\nimport { DEFAULT_NOTE_HEIGHT, NOTE_NAMES } from \"../../constants\";\r\nimport { PatternTrack } from \"./PatternTrack\";\r\nimport { LyricEditorDialog } from \"../audioDialogs\";\r\nimport { INoteEvent } from \"../../schema\";\r\n\r\nfunction getNoteNameFromPitch(pitch: number): string {\r\n  const note = NOTE_NAMES[pitch % NOTE_NAMES.length];\r\n  return `${note}${Math.floor(pitch / NOTE_NAMES.length)}`;\r\n}\r\n\r\nconst NOTE_HANDLE_WIDTH = 6;\r\n\r\nexport class GridItem {\r\n  note: number;\r\n  start: number;\r\n  duration: number;\r\n  velocity: number = 0.8;\r\n  label: string | \"\" = \"\";\r\n  domElement: HTMLDivElement;\r\n  noteLabel: HTMLDivElement;\r\n  lyricLabel: HTMLDivElement;\r\n  audio: AudioBuffer | null = null;\r\n\r\n  constructor(\r\n    private readonly grid: Grid,\r\n    item: INoteEvent\r\n  ) {\r\n    this.note = item.note;\r\n    this.start = item.start;\r\n    this.duration = item.duration;\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"piano-roll-note\");\r\n    this.domElement.style.height = `${grid.noteHeight}px`;\r\n\r\n    this.noteLabel = document.createElement(\"div\");\r\n    this.noteLabel.classList.add(\"piano-roll-note-label\");\r\n    this.noteLabel.textContent = getNoteNameFromPitch(this.note);\r\n    this.domElement.appendChild(this.noteLabel);\r\n\r\n    this.lyricLabel = document.createElement(\"div\");\r\n    this.lyricLabel.classList.add(\"piano-roll-note-lyric\");\r\n    this.domElement.appendChild(this.lyricLabel);\r\n\r\n    if (item.label) this.lyricLabel.textContent = item.label;\r\n\r\n    console.log(\"GridItem\", this);\r\n\r\n    grid.gridElement.appendChild(this.domElement);\r\n  }\r\n}\r\n\r\nexport class Grid extends ScrollPanel<\"select\" | \"update\"> {\r\n  readonly domElement: HTMLDivElement;\r\n  readonly gridElement: HTMLDivElement;\r\n  readonly previewCanvas: HTMLCanvasElement;\r\n  readonly noteHeight = DEFAULT_NOTE_HEIGHT;\r\n  readonly beatWidth = 100;\r\n  readonly noteEditor: LyricEditorDialog;\r\n  private _currentNote: INoteEvent | null = null;\r\n  private _dragMode: string | null = null;\r\n  private _quantize: number = 0.25;\r\n  private _dragOffset: number = 0;\r\n  private _track: PatternTrack | null = null;\r\n  readonly scrollElement: HTMLDivElement;\r\n\r\n  constructor() {\r\n    const gridElement = document.createElement(\"div\");\r\n\r\n    super(gridElement);\r\n\r\n    this.scrollElement = gridElement;\r\n\r\n    this.domElement = document.createElement(\"div\");\r\n\r\n    this.gridElement = gridElement;\r\n\r\n    this.domElement.classList.add(\"piano-roll-grid-container\");\r\n    this.gridElement.classList.add(\"piano-roll-grid\");\r\n\r\n    this.gridElement.addEventListener(\"dragstart\", (event) => {\r\n      event.preventDefault();\r\n    });\r\n\r\n    this.previewCanvas = document.createElement(\"canvas\");\r\n    this.previewCanvas.style.imageRendering = \"pixelated\";\r\n\r\n    const rowBackgroundCanvas = document.createElement(\"canvas\");\r\n    rowBackgroundCanvas.style.imageRendering = \"pixelated\";\r\n    rowBackgroundCanvas.width = this.beatWidth * 4;\r\n    rowBackgroundCanvas.height = this.noteHeight;\r\n    console.log(\"debug\", rowBackgroundCanvas.width, rowBackgroundCanvas.height);\r\n    const ctx = rowBackgroundCanvas.getContext(\"2d\");\r\n    // disable anti-alias\r\n\r\n    if (ctx) {\r\n      ctx.strokeStyle = \"#666\";\r\n      ctx.lineWidth = 0.5;\r\n      for (let j = 1; j < 4; j++) {\r\n        ctx.beginPath();\r\n        ctx.moveTo(j * this.beatWidth, 0);\r\n        ctx.lineTo(j * this.beatWidth, this.noteHeight);\r\n        ctx.stroke();\r\n      }\r\n      ctx.lineWidth = 1;\r\n      ctx.strokeStyle = \"white\";\r\n      ctx.beginPath();\r\n      ctx.moveTo(0, 0);\r\n      ctx.lineTo(0, this.noteHeight);\r\n      ctx.stroke();\r\n    }\r\n    for (let i = 0; i < 88; i++) {\r\n      const row = document.createElement(\"div\");\r\n      row.classList.add(\"piano-roll-grid-row\");\r\n      row.style.height = `${this.noteHeight}px`;\r\n      this.gridElement.appendChild(row);\r\n      const base64 = rowBackgroundCanvas.toDataURL();\r\n      row.style.backgroundImage = `url(${base64})`;\r\n      row.style.backgroundRepeat = \"repeat\";\r\n    }\r\n    this.domElement.appendChild(this.gridElement);\r\n\r\n    this.noteEditor = new LyricEditorDialog((note) => {\r\n      const input = this.noteEditor.domElement.querySelector(\r\n        \".lyric-editor-text\"\r\n      ) as HTMLInputElement;\r\n      note.label = input?.value || \"\";\r\n    });\r\n\r\n    document.body.appendChild(this.noteEditor.domElement);\r\n\r\n    this.gridElement.addEventListener(\"pointerdown\", (event) => {\r\n      if (!this._track) throw new Error(\"No track\");\r\n\r\n      if (!this._track.events) throw new Error(\"No events\");\r\n\r\n      event.preventDefault();\r\n\r\n      this._dragOffset = event.layerX;\r\n\r\n      if (this.noteEditor.domElement.style.display === \"block\") {\r\n        this.noteEditor.domElement.style.display = \"none\";\r\n        return;\r\n      }\r\n\r\n      if (\r\n        event.target instanceof HTMLDivElement &&\r\n        event.target.classList.contains(\"piano-roll-note\")\r\n      ) {\r\n        this.gridElement.classList.add(\"dragging\");\r\n        const note = this._track.events.find(\r\n          (n) => n.domElement === event.target\r\n        );\r\n\r\n        if (event.ctrlKey || event.button === 1) {\r\n          if (note)\r\n            this.noteEditor.show(event.clientX + 20, event.clientY - 5, note);\r\n          else this.noteEditor.domElement.style.display = \"none\";\r\n        }\r\n\r\n        if (note) {\r\n          this._currentNote = note;\r\n\r\n          if (event.button === 2) {\r\n            this.remove(note);\r\n            this._currentNote = null;\r\n          } else {\r\n            note.domElement!.parentElement?.appendChild(note.domElement!);\r\n            if (this._dragOffset < NOTE_HANDLE_WIDTH) {\r\n              this._dragMode = \"start\";\r\n            } else if (\r\n              note.domElement!.offsetWidth - this._dragOffset <\r\n              NOTE_HANDLE_WIDTH\r\n            ) {\r\n              this._dragMode = \"end\";\r\n            } else {\r\n              this._dragMode = \"move\";\r\n            }\r\n          }\r\n        }\r\n      } else if (event.button !== 0) return;\r\n      else if (event.target === this.gridElement) {\r\n        this.gridElement.classList.add(\"dragging\");\r\n        const pitch = 87 - Math.floor(event.layerY / this.noteHeight);\r\n\r\n        let start = event.layerX / this.beatWidth;\r\n        start = Math.round(start / this._quantize) * this._quantize;\r\n        console.log(\"start\", start, event.layerX);\r\n\r\n        const item: INoteEvent = {\r\n          note: pitch,\r\n          start: start,\r\n          velocity: 100,\r\n          duration: 0.25,\r\n          label: \"\",\r\n          domElement: undefined,\r\n        };\r\n\r\n        this._currentNote = this.add(item);\r\n        this._currentNote.domElement!.style.top = `${\r\n          (87 - this._currentNote.note) * this.noteHeight\r\n        }px`;\r\n        this._currentNote.domElement!.style.left = `${\r\n          this._currentNote.start * this.beatWidth\r\n        }px`;\r\n        this._dragMode = \"end\";\r\n\r\n        this.emit(\"select\", this._currentNote);\r\n      }\r\n\r\n      this.emit(\"update\", this);\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointerup\", () => {\r\n      this.gridElement.classList.remove(\"dragging\");\r\n      this._currentNote = null;\r\n\r\n      this.emit(\"update\", this);\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointerleave\", () => {\r\n      this.gridElement.classList.remove(\"dragging\");\r\n      if (this._currentNote) {\r\n        this.remove(this._currentNote);\r\n        this._currentNote = null;\r\n      }\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"contextmenu\", (event) => {\r\n      event.preventDefault();\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointermove\", (event) => {\r\n      if (this._currentNote && event.buttons === 1) {\r\n        if (this._dragMode === \"start\") {\r\n          const oldStart = this._currentNote.start;\r\n          this._currentNote.start = event.layerX / this.beatWidth;\r\n          this._currentNote.start =\r\n            Math.round(this._currentNote.start / this._quantize) *\r\n            this._quantize;\r\n          this._currentNote.duration =\r\n            oldStart - this._currentNote.start + this._currentNote.duration;\r\n          this._currentNote.domElement!.style.left = `${\r\n            this._currentNote.start * this.beatWidth\r\n          }px`;\r\n          this._currentNote.domElement!.style.width = `${\r\n            this._currentNote.duration * this.beatWidth\r\n          }px`;\r\n        } else if (this._dragMode === \"end\") {\r\n          this._currentNote.duration =\r\n            event.layerX / this.beatWidth - this._currentNote.start;\r\n\r\n          // quantize\r\n          this._currentNote.duration =\r\n            Math.round(this._currentNote.duration / this._quantize) *\r\n            this._quantize;\r\n\r\n          this._currentNote.domElement!.style.width = `${\r\n            this._currentNote.duration * this.beatWidth\r\n          }px`;\r\n        } else if (this._dragMode === \"move\") {\r\n          this._currentNote.start =\r\n            (event.layerX - this._dragOffset) / this.beatWidth;\r\n          this._currentNote.start =\r\n            Math.round(this._currentNote.start / this._quantize) *\r\n            this._quantize;\r\n          this._currentNote.domElement!.style.left = `${\r\n            this._currentNote.start * this.beatWidth\r\n          }px`;\r\n        } else {\r\n          return;\r\n        }\r\n\r\n        this.emit(\"update\", this);\r\n      }\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointerup\", () => {\r\n      this.gridElement.classList.remove(\"dragging\");\r\n      if (this._currentNote) {\r\n        this._currentNote.domElement!.style.pointerEvents = \"auto\";\r\n      }\r\n      this._currentNote = null;\r\n    });\r\n\r\n    this.gridElement.addEventListener(\"pointerleave\", () => {\r\n      this.gridElement.classList.remove(\"dragging\");\r\n      if (this._currentNote) {\r\n        this._currentNote.domElement!.style.pointerEvents = \"auto\";\r\n      }\r\n      this._currentNote = null;\r\n    });\r\n  }\r\n\r\n  add(event: INoteEvent) {\r\n    if (!this._track) throw new Error(\"add() No track!\");\r\n    const item = new GridItem(this, event);\r\n    this._track.events.push(item);\r\n    console.log(\"Grid: add\", event);\r\n    return item;\r\n  }\r\n\r\n  remove(event: INoteEvent) {\r\n    if (!this._track) throw new Error(\"remove() No track!\");\r\n    this._track.events.splice(this._track.events.indexOf(event), 1);\r\n    this.gridElement.removeChild(event.domElement!);\r\n  }\r\n\r\n  load(track: PatternTrack) {\r\n    if (!track) {\r\n      throw new Error(\"load() No track!\");\r\n    }\r\n    console.log(\"Grid: load\", track.events);\r\n    for (const event of this._track?.events || []) {\r\n      event.domElement?.remove();\r\n    }\r\n    this._track = track;\r\n    for (const event of track.events) {\r\n      this.gridElement.appendChild(event.domElement!);\r\n    }\r\n  }\r\n\r\n  renderToCanvas(canvas: HTMLCanvasElement, color: string, beatWidth: number) {\r\n    if (!this._track) throw new Error(\"renderToCanvas() No track!\");\r\n\r\n    // find lowest note\r\n    let lowestNote = 88;\r\n    for (const note of this._track.events) {\r\n      if (note.note < lowestNote) lowestNote = note.note;\r\n    }\r\n\r\n    // find highest note\r\n    let highestNote = 0;\r\n    for (const note of this._track.events) {\r\n      if (note.note > highestNote) highestNote = note.note;\r\n    }\r\n\r\n    highestNote += 12;\r\n    lowestNote -= 12;\r\n\r\n    const ctx = canvas.getContext(\"2d\") as CanvasRenderingContext2D;\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\r\n    let padded_scale = canvas.height / (highestNote - lowestNote + 1);\r\n\r\n    if (padded_scale > 2) {\r\n      padded_scale = 2;\r\n    }\r\n\r\n    for (const note of this._track.events) {\r\n      const y = canvas.height - (note.note - lowestNote + 1) * padded_scale;\r\n      const x = note.start * beatWidth;\r\n      const width = note.duration * beatWidth;\r\n      ctx.fillStyle = color;\r\n      ctx.fillRect(x, y, width, padded_scale);\r\n    }\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport {\r\n  DEFAULT_NOTE_HEIGHT,\r\n  KEY_COLORS,\r\n  NOTE_NAMES,\r\n} from \"../../constants\";\r\nimport { IKeyboardEvent } from \"./Keyboard\";\r\n\r\nexport class SideKeyboard extends BaseElement<\"update\"> {  \r\n  keys: HTMLDivElement[] = [];\r\n  noteHeight = DEFAULT_NOTE_HEIGHT;\r\n\r\n  constructor() {\r\n\r\n    super(\"div\", \"piano-roll-keyboard\");\r\n\r\n    this.redraw();\r\n\r\n    this.domElement.addEventListener(\"pointerdown\", (e) => {\r\n      e.preventDefault();\r\n      const key = e.target as HTMLDivElement;\r\n\r\n      if (key.classList.contains(\"piano-roll-keyboard-key\")) {\r\n        const note_index = this.keys.indexOf(key);\r\n        console.log(\"key\", key.textContent, note_index);        \r\n        key.classList.add(\"active\");\r\n        this.emit(\"update\", { type: \"press\", note: note_index } as IKeyboardEvent);\r\n        const pointerup = () => {\r\n          window.removeEventListener(\"pointerup\", pointerup);\r\n          key.classList.remove(\"active\");\r\n          this.emit(\"update\", { type: \"release\", note: note_index } as IKeyboardEvent);          \r\n        };\r\n\r\n        window.addEventListener(\"pointerup\", () => pointerup());\r\n      }\r\n    });\r\n  }\r\n\r\n  redraw() {\r\n    this.domElement.innerHTML = \"\";\r\n\r\n    for (let i = 87; i >= 0; i--) {\r\n      const key = document.createElement(\"div\");\r\n      key.classList.add(\"piano-roll-keyboard-key\");\r\n      key.style.height = `${this.noteHeight}px`;\r\n      // key.style.bottom = `${i * this.noteHeight}px`;\r\n      key.style.backgroundColor =\r\n        KEY_COLORS[i % 12] === \"white\" ? \"#fff\" : \"#000\";\r\n      key.style.color = KEY_COLORS[i % 12] === \"white\" ? \"#000\" : \"#fff\";\r\n      key.textContent = NOTE_NAMES[i % 12] + ((i / 12) | 0).toString();\r\n      this.domElement.appendChild(key);\r\n      this.keys.push(key);\r\n    }\r\n\r\n    this.keys.reverse();\r\n  }\r\n}\r\n","import EventObject from \"../../../../elements/src/EventObject\";\r\nimport { AudioClock } from \"./AudioClock\";\r\nimport { AudioCursor, ICursorTimeline } from \"./AudioCursor\";\r\nimport { Grid, GridItem } from \"./Grid\";\r\nimport { IKeyboardEvent } from \"./Keyboard\";\r\nimport { PatternTrack } from \"./PatternTrack\";\r\nimport { SideKeyboard } from \"./SideKeyboard\";\r\n\r\nexport class PianoRoll\r\n  extends EventObject<\"update\">\r\n  implements ICursorTimeline\r\n{\r\n  readonly domElement: HTMLDivElement;\r\n  readonly grid: Grid;\r\n  readonly sideKeyboard: SideKeyboard;\r\n  readonly cursor: AudioCursor;\r\n  readonly timeline: HTMLElement;\r\n  cursorUpdateInterval: number | object | null = null;\r\n  track: PatternTrack | null = null;\r\n  color = \"#7979ce\";\r\n  beatWidth = 100;\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super();\r\n\r\n    this.domElement = document.createElement(\"div\");\r\n    this.domElement.classList.add(\"piano-roll\");\r\n\r\n    this.sideKeyboard = new SideKeyboard();\r\n    this.domElement.appendChild(this.sideKeyboard.domElement);\r\n    this.sideKeyboard.on(\"update\", (event) => {\r\n      const e = event as IKeyboardEvent;\r\n      if (e.type == \"press\") this.track!.trigger(e.note);\r\n      else if (e.type == \"release\") this.track!.release(e.note);\r\n    });\r\n\r\n    this.grid = new Grid();\r\n    this.domElement.appendChild(this.grid.domElement);\r\n    this.grid.on(\"select\", (item) => {\r\n      const note = item as GridItem;\r\n      this.track!.trigger(note.note);\r\n      if (this.track) {\r\n        this.grid.renderToCanvas(\r\n          this.track.preview.canvas,\r\n          this.color,\r\n          this.beatWidth\r\n        );\r\n      } else {\r\n        console.warn(\"No track loaded!\");\r\n      }\r\n    });\r\n    this.grid.on(\"update\", () => {\r\n      if (this.track) {\r\n        this.grid.renderToCanvas(\r\n          this.track.preview.canvas,\r\n          this.color,\r\n          this.beatWidth\r\n        );\r\n      }\r\n    });\r\n    this.grid.linkElement(this.sideKeyboard.domElement);\r\n\r\n    this.timeline = this.grid.domElement;\r\n\r\n    this.cursor = new AudioCursor(this);\r\n    this.cursor.domElement.classList.add(\"audio-cursor\");\r\n    this.grid.domElement.appendChild(this.cursor.domElement);\r\n    this.cursor.domElement.style.marginLeft =\r\n      this.sideKeyboard.domElement.offsetWidth + \"px\";\r\n\r\n    this.grid.scrollTop = 1000;\r\n  }\r\n\r\n  load(track: PatternTrack) {\r\n    if (!track) {\r\n      console.warn(\"No track provided!\");\r\n      return;\r\n    }\r\n    this.track = track;\r\n    this.grid.load(track);\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { ProjectUI } from \"../ProjectUI\";\r\nimport { PatternTrack } from \"../components/PatternTrack\";\r\nimport { PianoRoll } from \"../components/PianoRoll\";\r\n\r\nexport class PianoRollWindow extends DraggableWindow {\r\n  pianoRoll: PianoRoll;\r\n\r\n  constructor(readonly ui: ProjectUI) {\r\n    const pianoRoll = new PianoRoll(ui.project.audioClock);\r\n\r\n    super({\r\n      title: \"Piano Roll\",\r\n      persistent: true,\r\n      content: pianoRoll.domElement,\r\n      width: 900,\r\n      height: 400,\r\n      left: 100,\r\n      top: 100,\r\n    });\r\n    this.pianoRoll = pianoRoll;\r\n  }\r\n\r\n  loadTrack(track: PatternTrack) {\r\n    this.pianoRoll.load(track);\r\n    this.setTitle(`Piano Roll (${track.name})`);\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { IPlaylistEvent, IPlaylistItem, IPlaylistTrack } from \"../../schema\";\r\n\r\nexport class PlaylistTrack\r\n  extends BaseElement<\"update\">\r\n  implements IPlaylistTrack\r\n{\r\n  name = \"Track 1\";\r\n  readonly items: IPlaylistItem[] = [];\r\n  readonly events: IPlaylistEvent[] = [];\r\n  readonly timeline: HTMLElement;\r\n\r\n  constructor(name: string, events?: IPlaylistEvent[]) {\r\n    super(\"div\", \"playlist-track\");\r\n\r\n    const settings = document.createElement(\"div\");\r\n    settings.classList.add(\"playlist-track-panel\");\r\n\r\n    const label = document.createElement(\"div\");\r\n    settings.appendChild(label);\r\n    label.textContent = name;\r\n\r\n    const buttons = document.createElement(\"div\");\r\n    buttons.classList.add(\"playlist-track-buttons\");\r\n    settings.appendChild(buttons);\r\n\r\n    const mute = document.createElement(\"div\");\r\n    mute.classList.add(\"track-button\");\r\n    mute.classList.add(\"track-mute-button\");\r\n    mute.textContent = \"M\";\r\n    mute.addEventListener(\"pointerdown\", () => {\r\n      mute.classList.toggle(\"active\");\r\n    });\r\n    buttons.appendChild(mute);\r\n\r\n    const solo = document.createElement(\"div\");\r\n    solo.classList.add(\"track-button\");\r\n    solo.classList.add(\"track-solo-button\");\r\n    solo.textContent = \"S\";\r\n    solo.addEventListener(\"pointerdown\", () => {\r\n      solo.classList.toggle(\"active\");\r\n    });\r\n    buttons.appendChild(solo);\r\n\r\n    this.timeline = document.createElement(\"div\");\r\n    this.timeline.classList.add(\"playlist-track-timeline\");\r\n\r\n    this.timeline.addEventListener(\"pointerdown\", (e) => {\r\n      const x = e.offsetX;\r\n      const duration = 1;\r\n      const start = x / this.timeline.clientWidth;\r\n      const label = \"Event\";\r\n\r\n      const event: IPlaylistEvent = {\r\n        start,\r\n        duration,\r\n        label,\r\n        type: \"pattern\",\r\n        value: {\r\n          name: \"Pattern\",\r\n          sequences: [],\r\n        },\r\n      };\r\n\r\n      this.addEvent(event);\r\n    });\r\n\r\n    if (events) {\r\n      this.loadEvents(events);\r\n    }\r\n\r\n    this.domElement.appendChild(settings);\r\n    this.domElement.appendChild(this.timeline);\r\n  }\r\n\r\n  loadEvents(events: IPlaylistEvent[]) {\r\n    for (const event of events) {\r\n      this.addEvent(event);\r\n    }\r\n  }\r\n\r\n  addEvent(event: IPlaylistEvent) {\r\n    this.events.push(event);\r\n\r\n    const item = document.createElement(\"div\");\r\n    item.classList.add(\"playlist-track-item\");\r\n    item.textContent = event.label;\r\n    item.style.left = `${event.start * 100}px`;\r\n    item.style.width = `${event.duration * 100}px`;\r\n\r\n    this.timeline.appendChild(item);\r\n  }\r\n}\r\n","import { SelectableElement } from \"../../../elements/src/elements/SelectableElement\";\r\nimport { SelectableGroup } from \"../../../elements/src/elements/SelectableGroup\";\r\nimport { IPattern } from \"../schema\";\r\n\r\nexport class PlaylistSourceItem extends SelectableElement {\r\n  constructor(group: SelectableGroup<PlaylistSourceItem>, readonly item: IPattern) {\r\n    super(group, \"div\", \"playlist-source-item\");\r\n\r\n    this.domElement.innerText = item.name;\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { PlaylistTrack } from \"../components/PlaylistTrack\";\r\nimport { AudioClock } from \"../components/AudioClock\";\r\nimport { AudioCursor, ICursorTimeline } from \"../components/AudioCursor\";\r\nimport { ProjectUI } from \"../ProjectUI\";\r\nimport { IProject } from \"../../schema\";\r\nimport { SelectableGroup } from \"../../../../elements/src/elements/SelectableGroup\";\r\nimport { PlaylistSourceItem } from \"../PlaylistSourceItem\";\r\n\r\nexport class PlaylistWindow extends DraggableWindow implements ICursorTimeline {\r\n  private _tracks: PlaylistTrack[] = [];\r\n  readonly timeline: HTMLDivElement;\r\n  readonly bucket: SelectableGroup<PlaylistSourceItem>;\r\n  readonly cursor: AudioCursor;\r\n  beatWidth = 10;\r\n\r\n  get audioClock(): AudioClock {\r\n    return this.ui.project.audioClock;\r\n  }\r\n\r\n  constructor(readonly ui: ProjectUI) {\r\n    const container = document.createElement(\"div\");\r\n    container.classList.add(\"playlist-container\");\r\n\r\n    super({\r\n      title: \"Playlist\",\r\n      persistent: true,\r\n      content: container,\r\n      width: 800,\r\n      height: 400,\r\n    });\r\n\r\n    this.bucket = new SelectableGroup<PlaylistSourceItem>();\r\n    this.bucket.domElement.classList.add(\"playlist-source-bucket\");\r\n    this.refresh();\r\n    container.appendChild(this.bucket.domElement);\r\n\r\n    this.timeline = document.createElement(\"div\");\r\n    this.timeline.classList.add(\"playlist-timeline\");\r\n    container.appendChild(this.timeline);\r\n\r\n    this.cursor = new AudioCursor(this);   \r\n\r\n    this.ui.project.audioClock.on(\"update\", () => {\r\n      this.cursor.update();\r\n    });\r\n  }\r\n\r\n  refresh() {\r\n    this.bucket.clear();\r\n\r\n    for (const pattern of this.ui.project.patterns) {\r\n      const item = new PlaylistSourceItem(this.bucket, pattern);\r\n      this.bucket.addSelectable(item);\r\n    }\r\n  }\r\n\r\n  addTrack(name: string) {\r\n    console.log(\"Add track\", name);\r\n    const track = new PlaylistTrack(name);\r\n    this._tracks.push(track);\r\n    this.timeline.appendChild(track.domElement);\r\n    this.timeline.appendChild(this.cursor.domElement);\r\n  }\r\n\r\n  loadProject(project: IProject) {\r\n    this._tracks.forEach((track) => {\r\n      this.timeline.removeChild(track.domElement);\r\n    });\r\n    this._tracks = [];\r\n\r\n    project.timeline.forEach((track) => {\r\n      this.addTrack(track.name);\r\n    });\r\n\r\n    for (let i = project.timeline.length; i < 16; i++) {\r\n      this.addTrack(`Track ${i + 1}`);\r\n    }\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../elements/src/elements/BaseElement\";\r\nimport { WindowContainer } from \"../../../elements/src/elements/WindowContainer\";\r\nimport { Project } from \"./Project\";\r\nimport { IKeyboardEvent, Keyboard } from \"./components/Keyboard\";\r\nimport { MixerWindow } from \"./windows/MixerWindow\";\r\nimport { PatternWindow } from \"./windows/PatternWindow\";\r\nimport { PianoRollWindow } from \"./windows/PianoRollWindow\";\r\nimport { PlaylistWindow } from \"./windows/PlaylistWindow\";\r\n\r\nexport class ProjectUI extends BaseElement<\"update\"> {\r\n  container: WindowContainer;\r\n  readonly pianoRollWindow: PianoRollWindow;\r\n\r\n  constructor(readonly project: Project) {\r\n    super(\"div\", \"project-ui\");\r\n\r\n    this.container = new WindowContainer();\r\n    this.domElement.appendChild(this.container.domElement);\r\n\r\n    this.pianoRollWindow = new PianoRollWindow(this);\r\n    this.container.addWindow(this.pianoRollWindow);\r\n\r\n    const patternWindow = new PatternWindow(this);\r\n    this.container.addWindow(patternWindow);\r\n    patternWindow.show(35, 100);\r\n\r\n    const playlistWindow = new PlaylistWindow(this);\r\n    this.container.addWindow(playlistWindow);\r\n    playlistWindow.show(1000, 50);\r\n\r\n    const mixerWindow = new MixerWindow(this);\r\n    this.container.addWindow(mixerWindow);\r\n    mixerWindow.show(1000, 470);\r\n\r\n    const keyboard = new Keyboard();\r\n    this.domElement.appendChild(keyboard.domElement);\r\n    keyboard.on(\"update\", (event) => {\r\n      const e = event as IKeyboardEvent;\r\n      console.log(\"Keyboard\", event);\r\n      if (e.type === \"press\") {\r\n        patternWindow.trigger(e.note);\r\n      } else if (e.type === \"release\") {\r\n        patternWindow.release(e.note);\r\n      }\r\n    });\r\n\r\n    this.project.on(\"update\", (event) => {\r\n      console.log(\"ProjectUI project update\", event);\r\n\r\n      if (!(event instanceof Object)) {\r\n        throw new Error(\"Invalid event\");\r\n      }\r\n\r\n      if (!(\"type\" in event)) {\r\n        throw new Error(\"Invalid event\");\r\n      }\r\n\r\n      const e = event as { type: string; value: unknown };\r\n\r\n      if (e.type === \"project\") {\r\n        const project = e.value as Project;\r\n        console.log(\"Project\", project);\r\n        patternWindow.loadProject(project);\r\n        playlistWindow.loadProject(project);\r\n        for (const instrument of project.instruments) {\r\n          this.container.addWindow(instrument.window);\r\n        }\r\n      }\r\n    });\r\n  }\r\n  loadProject(project: Project) {\r\n    this.project.load(project);\r\n  }\r\n}\r\n","import { IHasAudioClock } from \"../IHasAudioClock\";\r\nimport { IInstrument } from \"../elements/IInstrument\";\r\nimport { AudioClock } from \"../elements/components/AudioClock\";\r\nimport { ISourceEvent } from \"../elements/components/SamplerSlot\";\r\nimport { Plugin } from \"../plugins/plugins\";\r\n\r\nexport abstract class Instrument\r\n  extends Plugin\r\n  implements IInstrument, IHasAudioClock  \r\n{\r\n  constructor(audioClock: AudioClock) {\r\n    super(audioClock);\r\n  }\r\n  \r\n  abstract id: string;\r\n\r\n  inputPort?: number | undefined;\r\n  inputChannel?: number | undefined;\r\n\r\n  abstract trigger(\r\n    note: number,\r\n    when: number,\r\n    velocity?: number\r\n  ): ISourceEvent | undefined;\r\n  abstract release(note: number, when: number): void;\r\n}\r\n","import { SynthesizerVoice } from \"./SynthesizerVoice\";\r\nimport { AudioClock } from \"../elements/components/AudioClock\";\r\nimport { IKeyboardEvent } from \"../elements/components/Keyboard\";\r\nimport { ISynthesizerSettings } from \"../schema\";\r\nimport { Instrument } from \"./Instrument\";\r\nimport { InstrumentWindow } from \"./InstrumentWindow\";\r\n\r\ninterface ISynthesizerEvent extends IKeyboardEvent {\r\n  voice: SynthesizerVoice;\r\n}\r\n\r\nexport abstract class Synthesizer<T extends SynthesizerVoice>\r\n  extends Instrument\r\n  implements ISynthesizerSettings\r\n{\r\n  abstract readonly window: InstrumentWindow;\r\n  readonly voices: SynthesizerVoice[] = [];\r\n  private _nextVoice = 0;\r\n  private _output: GainNode;  \r\n  private _held: ISynthesizerEvent[] = [];\r\n  public transpose = 24;\r\n\r\n  get output() {\r\n    return this._output;\r\n  }\r\n\r\n  constructor(audioClock: AudioClock) {\r\n    super(audioClock);    \r\n    this._output = audioClock.audioContext.createGain();    \r\n  }\r\n\r\n  addVoice(voice: T) {\r\n    this.voices.push(voice);\r\n  }\r\n\r\n  handleEvent(event: IKeyboardEvent) {\r\n    if (event.type == \"press\") {\r\n      console.log(this.name + \" triggered voice \" + this._nextVoice);\r\n\r\n      this._held.push({ ...event, voice: this.voices[this._nextVoice] });\r\n\r\n      this._nextVoice++;\r\n      if (this._nextVoice >= this.voices.length) {\r\n        this._nextVoice = 0;\r\n      }\r\n    } else if (event.type == \"release\") {\r\n      console.log(this.name + \" released voice \" + event);\r\n\r\n      const index = this._held.findIndex((e) => e.note == event.note);\r\n      if (index >= 0) {\r\n        this._held.splice(index, 1);\r\n      }\r\n\r\n      this.voices.forEach((voice) => {\r\n        voice.release(event.note);\r\n      });\r\n    } else {\r\n      console.error(this.name + \": Invalid event passed to trigger()\", event);\r\n    }\r\n  }\r\n}\r\n","import { AudioClock } from \"../elements/components/AudioClock\";\r\nimport { ISynthesizerVoiceSettings } from \"../schema\";\r\n\r\nexport abstract class SynthesizerVoice implements ISynthesizerVoiceSettings {\r\n  _settings: ISynthesizerVoiceSettings | null = null;\r\n\r\n  get settings(): ISynthesizerVoiceSettings {\r\n    if (!this.settings) throw new Error(\"Voice not initialized\");\r\n    return this.settings;\r\n  }\r\n\r\n  private readonly _gain: GainNode;\r\n  private _note: number | null = null;\r\n  private _frequency: number | null = null;  \r\n\r\n  get gain() {\r\n    return this._gain.gain.value;\r\n  }\r\n\r\n  get note() {\r\n    return this._note;\r\n  }\r\n\r\n  get lfoNumber() {\r\n    return this.settings.lfoNumber;\r\n  }\r\n\r\n  get envelopeNumber() {\r\n    return this.settings.envelopeNumber;\r\n  }\r\n\r\n  get frequency() {\r\n    return this._frequency;\r\n  }\r\n\r\n  get detune() {\r\n    return this.settings.detune;\r\n  }\r\n\r\n  get oscillators() {\r\n    return this.settings.oscillators;\r\n  }\r\n\r\n  constructor(readonly audioClock: AudioClock) {    \r\n    this._gain = audioClock.audioContext.createGain();\r\n  }\r\n\r\n  loadSettings(settings: ISynthesizerVoiceSettings) {\r\n    this._settings = settings;\r\n    this._gain.gain.value = settings.gain;\r\n  }\r\n\r\n  trigger(note: number, velocity: number, time = 0) {\r\n    if (!this.settings) throw new Error(\"Voice not initialized\");\r\n\r\n    this._note = note;\r\n    this._frequency = 440 * Math.pow(2, (note - 69) / 12);\r\n    this._gain.gain.value = this.settings.gain * velocity;\r\n\r\n    // TODO\r\n  }\r\n\r\n  release(time = 0) {\r\n    if (!this.settings) throw new Error(\"Voice not initialized\");\r\n\r\n    this._note = null;\r\n    this._frequency = null;\r\n\r\n    // TODO\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { ControlType, IPluginControl } from \"../../schema\";\r\n\r\nexport class Slider extends BaseElement<\"update\"> implements IPluginControl {\r\n  private readonly _name: string;\r\n  private readonly _label: string;\r\n  private readonly _type: ControlType = \"slider\";\r\n  private readonly _default: number;\r\n  private readonly _min: number;\r\n  private readonly _max: number;\r\n  private readonly _step: number;\r\n  private readonly _range: HTMLInputElement;\r\n  private _value: number;\r\n\r\n  get name() {\r\n    return this._name;\r\n  }\r\n\r\n  get label() {\r\n    return this._label;\r\n  }\r\n\r\n  get type() {\r\n    return this._type;\r\n  }\r\n\r\n  get value() {\r\n    return this._value;\r\n  }\r\n\r\n  get default() {\r\n    return this._default;\r\n  }\r\n\r\n  get min() {\r\n    return this._min;\r\n  }\r\n\r\n  get max() {\r\n    return this._max;\r\n  }\r\n\r\n  get step() {\r\n    return this._step;\r\n  }\r\n\r\n  set value(value: number) {\r\n    this._value = value;\r\n    this._range.value = value.toString();\r\n  }\r\n\r\n  get element() {\r\n    return this._range;\r\n  }\r\n\r\n  constructor(\r\n    name: string,\r\n    label: string,\r\n    min: number,\r\n    max: number,\r\n    step: number,\r\n    value: number\r\n  ) {\r\n    super(\"div\", \"slider\");\r\n\r\n    this._name = name;\r\n    this._label = label;\r\n    this._min = min;\r\n    this._max = max;\r\n    this._step = step;\r\n    this._value = value;\r\n    this._default = value;\r\n\r\n    this._range = document.createElement(\"input\");\r\n    this._range.type = \"range\";\r\n    this._range.min = min.toString();\r\n    this._range.max = max.toString();\r\n    this._range.step = step.toString();\r\n    this._range.value = value.toString();\r\n\r\n    this._range.addEventListener(\"input\", () => {\r\n      this._value = parseFloat(this._range.value);\r\n      this.emit(\"update\", this);\r\n    });\r\n\r\n    this.domElement.appendChild(this._range);\r\n  }\r\n}\r\n","import { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { IEnvelope } from \"../../schema\";\r\nimport { Slider } from \"./Slider\";\r\n\r\nexport class Envelope extends BaseElement<\"update\"> implements IEnvelope {\r\n  readonly attack: Slider;\r\n  readonly hold: Slider;\r\n  readonly decay: Slider;\r\n  readonly sustain: Slider;\r\n  readonly release: Slider;\r\n\r\n  constructor(\r\n    attack = 0.003,\r\n    hold = 0.0,\r\n    decay = 2.0,\r\n    sustain = 0.01,\r\n    release = 0.05\r\n  ) {\r\n    super(\"div\", \"envelope\");\r\n\r\n    this.attack = new Slider(\"attack\", \"A\", 0, 1, 0.01, attack);\r\n    this.hold = new Slider(\"hold\", \"H\", 0, 1, 0.01, hold);\r\n    this.decay = new Slider(\"decay\", \"D\", 0, 1, 0.01, decay);\r\n    this.sustain = new Slider(\"sustain\", \"S\", 0, 1, 0.01, sustain);\r\n    this.release = new Slider(\"release\", \"R\", 0, 1, 0.01, release);\r\n\r\n    this.domElement.appendChild(this.attack.domElement);\r\n    this.domElement.appendChild(this.decay.domElement);\r\n    this.domElement.appendChild(this.sustain.domElement);\r\n    this.domElement.appendChild(this.release.domElement);\r\n  }\r\n\r\n  trigger(param: AudioParam, when: number) {\r\n    console.log(\"trigger @ \" + when);\r\n    const value = param.value;\r\n    param.cancelScheduledValues(when);\r\n    param.setValueAtTime(value, when);\r\n    param.exponentialRampToValueAtTime(0.015, when);\r\n    //param.setValueAtTime(0.015, when);\r\n    param.linearRampToValueAtTime(1, when + this.attack.value);\r\n    //param.setValueAtTime(1, when + this.attack.value);\r\n    param.exponentialRampToValueAtTime(\r\n      this.sustain.value,\r\n      when + this.attack.value + this.decay.value\r\n    );\r\n  }\r\n\r\n  triggerRelease(param: AudioParam, when: number) {\r\n    console.log(\"triggerRelease @ \" + when);\r\n    param.setValueAtTime(param.value, when);\r\n    param.setTargetAtTime(0.0001, when + 0.01, this.release.value);\r\n    param.cancelScheduledValues(when + 0.01 + this.release.value);\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../../elements/src/elements/DraggableWindow\";\r\nimport { InstrumentWindow } from \"../../abstracts/InstrumentWindow\";\r\nimport { Synthesizer } from \"../../abstracts/Synthesizer\";\r\nimport { SynthesizerVoice } from \"../../abstracts/SynthesizerVoice\";\r\nimport { AudioClock } from \"../../elements/components/AudioClock\";\r\nimport { Envelope } from \"../../elements/components/Envelope\";\r\nimport { ISourceEvent } from \"../../elements/components/SamplerSlot\";\r\nimport { Slider } from \"../../elements/components/Slider\";\r\nimport { ControllerGroup } from \"../../schema\";\r\n\r\nfunction noteToFrequency(note: number) {\r\n  return 440 * Math.pow(2, (note - 69) / 12);\r\n}\r\n\r\nexport class FMBassVoice extends SynthesizerVoice {\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(audioClock);\r\n  }\r\n\r\n  trigger(note: number, when: number, velocity: number | undefined) {\r\n    console.log(\"FMBassVoice triggered\", note, when, velocity);\r\n  }\r\n\r\n  release(note: number) {\r\n    console.log(\"FMBassVoice released\", note);\r\n  }\r\n}\r\n\r\nexport class FMBass extends Synthesizer<FMBassVoice> {\r\n  readonly name = \"FM Bass\";\r\n  readonly id = \"fm_bass\";\r\n  readonly version = \"0.0.1\";\r\n  readonly description = \"A simple FM bass synthesizer\";\r\n  readonly author = \"Johnny Street\";\r\n  readonly controllerGroups: ControllerGroup[] = [];\r\n  readonly window: InstrumentWindow;\r\n  private _carrier?: OscillatorNode;\r\n  private _modulator?: OscillatorNode;\r\n  readonly modulatorGain: GainNode;\r\n  readonly filter: BiquadFilterNode;\r\n  readonly gain: GainNode;\r\n  readonly filterEnvelope: Envelope;\r\n  readonly gainEnvelope: Envelope;\r\n  private _heldNote: number | undefined;\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(audioClock);\r\n\r\n    this.window = new DraggableWindow({\r\n      title: \"FM Bass\",\r\n      persistent: true,\r\n      content: this.domElement,\r\n    });\r\n\r\n    const audioContext = this.audioClock.audioContext;\r\n\r\n    this.modulatorGain = audioContext.createGain();\r\n    this.modulatorGain.gain.value = 100;\r\n\r\n    this.gain = audioContext.createGain();\r\n    this.gain.gain.value = 0;\r\n\r\n    const highpassFilter = audioContext.createBiquadFilter();\r\n    highpassFilter.type = \"highpass\";\r\n    highpassFilter.frequency.value = 20;\r\n    this.gain.connect(highpassFilter);\r\n    highpassFilter.connect(this.output);\r\n\r\n    this.output.gain.value = 0.5;\r\n\r\n    this.filter = audioContext.createBiquadFilter();\r\n    this.filter.type = \"lowpass\";\r\n    this.filter.frequency.value = 440;\r\n    this.filter.Q.value = 1;\r\n    this.filter.connect(this.gain);\r\n\r\n    this.filterEnvelope = new Envelope(0);\r\n    this.gainEnvelope = new Envelope(0.015);\r\n\r\n    const fmGainSlider = new Slider(\"FM Gain\", \"FM Gain\", 0, 1000, 1, 100);\r\n    this.window.content.appendChild(fmGainSlider.domElement);\r\n    fmGainSlider.on(\"update\", () => {\r\n      console.log(\"FM Gain\", fmGainSlider.value);\r\n      this.modulatorGain.gain.value = fmGainSlider.value;\r\n    });\r\n    // const container = this.window.content.appendChild();\r\n\r\n    this.output.connect(audioContext.destination); // TODO: use mixer\r\n  }\r\n\r\n  trigger(\r\n    note: number,\r\n    when: number,\r\n    velocity: number | undefined\r\n  ): ISourceEvent | undefined {\r\n    console.log(\"FM Bass triggered\", note, when, velocity);\r\n\r\n    this._heldNote = note;\r\n\r\n    note += this.transpose;\r\n\r\n    if (this._carrier?.context.state === \"running\") {\r\n      const g = this.gain.gain.value;\r\n      this.gain.gain.cancelScheduledValues(when);\r\n      this.gain.gain.setValueAtTime(g, when);\r\n      this.gain.gain.setTargetAtTime(0.01, when, 0.01);\r\n\r\n      try {\r\n        this._carrier.stop(when + 0.02);\r\n        this._modulator?.stop(when + 0.02);\r\n      } catch (e) {\r\n        console.error(\"Error stopping carrier/modulator\", e);\r\n      }\r\n    }\r\n\r\n    this._carrier = this.audioClock.audioContext.createOscillator();\r\n    this._carrier.frequency.value = 220;\r\n\r\n    this._modulator = this.audioClock.audioContext.createOscillator();\r\n    this._modulator.frequency.value = 220;\r\n\r\n    this._carrier.connect(this.gain);\r\n    this._modulator.connect(this.modulatorGain);\r\n    this.modulatorGain.connect(this._carrier.frequency);\r\n\r\n    this._carrier.type = \"sine\";\r\n\r\n    this._carrier.start(when);\r\n    this._modulator.start(when);\r\n\r\n    const freq = noteToFrequency(note);\r\n    let time = when || this.audioClock.currentTime;\r\n\r\n    this.gainEnvelope.trigger(this.gain.gain, time);\r\n\r\n    const value = this._carrier.frequency.value;\r\n\r\n    time += 0.001;\r\n\r\n    this._carrier.frequency.cancelScheduledValues(time);\r\n    this._modulator.frequency.cancelScheduledValues(time);\r\n\r\n    this._carrier.frequency.setValueAtTime(value, time);\r\n    this._modulator.frequency.setValueAtTime(value * 2, time);\r\n\r\n    this._carrier.frequency.setTargetAtTime(freq, time, 0.001);\r\n    this._modulator.frequency.setTargetAtTime(freq * 2, time, 0.001);\r\n    //this.filterEnvelope.trigger(this.filter.frequency, time);\r\n\r\n    return undefined;\r\n  }\r\n\r\n  release(note: number, when: number) {\r\n    if (this._heldNote !== note) {\r\n      return;\r\n    }\r\n    console.log(\"FM Bass released\", note);\r\n    const time = when || this.audioClock.currentTime;\r\n    this.filterEnvelope.triggerRelease(this.filter.frequency, time);\r\n    this.gainEnvelope.triggerRelease(this.gain.gain, time);\r\n  }\r\n}\r\n","import { DraggableWindow } from \"../../../elements/src/elements/DraggableWindow\";\r\n\r\nexport class InstrumentWindow extends DraggableWindow {}\r\n","import { triggerActive } from \"../../../../elements/src/animation\";\r\nimport { AudioCanvas } from \"../../../../elements/src/elements/AudioCanvas\";\r\nimport { BaseElement } from \"../../../../elements/src/elements/BaseElement\";\r\nimport { ControllerGroup, ISamplerSlot } from \"../../schema\";\r\nimport { AudioClock } from \"./AudioClock\";\r\n\r\nexport interface ISourceEvent {\r\n  source: AudioBufferSourceNode;\r\n  gain: GainNode;\r\n  cutByGroups: number[];\r\n  time: number;\r\n}\r\n\r\nexport class SamplerSlot extends BaseElement<\"update\"> implements ISamplerSlot {\r\n  private _nameElement;\r\n  controllerGroups: ControllerGroup[] = [];\r\n  buffer: AudioBuffer | null = null;\r\n  velocity: number;\r\n  pan: number;\r\n  pitch: number;\r\n  randomPitch: number;\r\n  randomVelocity: number;\r\n  startPosition: number;\r\n  endPosition: number;\r\n  loop: boolean;\r\n  loopStart: number;\r\n  loopEnd: number;\r\n  protected _sources: ISourceEvent[] = [];\r\n  private _previewCanvas: AudioCanvas;\r\n\r\n  constructor(\r\n    readonly audioClock: AudioClock,\r\n    public name = \"\",\r\n    public keyBinding: number | null = null,\r\n    public cutGroup = -1,\r\n    readonly cutByGroups: number[] = []\r\n  ) {\r\n    super(\"div\", \"sampler-slot\");\r\n\r\n    this.name = name;\r\n    this.buffer = null;\r\n    this.keyBinding = keyBinding || null;\r\n    this.velocity = 1;\r\n    this.pan = 1;\r\n    this.pitch = 1;\r\n    this.randomPitch = 0;\r\n    this.randomVelocity = 0.05;\r\n    this.startPosition = 0;\r\n    this.endPosition = 0;\r\n    this.loop = false;\r\n    this.loopStart = 0;\r\n    this.loopEnd = 0;\r\n    this.cutGroup = cutGroup;\r\n    this.cutByGroups = cutByGroups;\r\n\r\n    this._previewCanvas = new AudioCanvas(200, 60);\r\n    this.domElement.appendChild(this._previewCanvas.domElement);\r\n\r\n    this._nameElement = document.createElement(\"div\");\r\n    this._nameElement.classList.add(\"sampler-slot-name\");\r\n    this.domElement.appendChild(this._nameElement);\r\n\r\n    this.domElement.addEventListener(\"pointerdown\", () => this.trigger());\r\n  }\r\n\r\n  async loadSample(name: string, url: string) {\r\n    this._nameElement.textContent = \"(Loading)\";\r\n\r\n    const response = await fetch(url);\r\n    if (!response.ok) {\r\n      this._nameElement.textContent = \"(Empty)\";\r\n      console.error(`Error loading sample: ${url}`, response.statusText);\r\n      return;\r\n    }\r\n\r\n    response\r\n      .arrayBuffer()\r\n      .then((buffer) => this.audioClock.audioContext.decodeAudioData(buffer))\r\n      .then((audioBuffer) => {\r\n        this._nameElement.textContent = name;\r\n        this.buffer = audioBuffer;\r\n        this.emit(\"update\");\r\n        setTimeout(() => {\r\n          this._previewCanvas.loadBuffer(audioBuffer);\r\n        }, 1);\r\n      })\r\n      .catch((error) => {\r\n        this._nameElement.textContent = \"(Empty)\";\r\n        console.error(`Error loading sample: ${url}`, error);\r\n      });\r\n  }\r\n\r\n  trigger(beat = 0) {\r\n    if (!this.buffer) {\r\n      console.error(\"No buffer loaded for sample\", this.name);\r\n      return;\r\n    }\r\n\r\n    const audioContext = this.audioClock.audioContext;\r\n    const source = audioContext.createBufferSource();\r\n    source.buffer = this.buffer;\r\n    source.playbackRate.value = this.pitch + Math.random() * this.randomPitch;\r\n    source.connect(audioContext.destination);\r\n\r\n    const gain = audioContext.createGain();\r\n    gain.gain.value = this.velocity + Math.random() * this.randomVelocity;\r\n    gain.connect(audioContext.destination);\r\n\r\n    source.connect(gain);\r\n\r\n    if (this.pan !== 1) {\r\n      const pan = audioContext.createStereoPanner();\r\n      pan.pan.value = this.pan;\r\n      source.connect(pan);\r\n      pan.connect(gain);\r\n    }\r\n\r\n    const time =\r\n      (this.audioClock.startTime || audioContext.currentTime) +\r\n      (beat * 60) / this.audioClock.bpm;\r\n\r\n    const entry: ISourceEvent = {\r\n      source,\r\n      gain,\r\n      cutByGroups: this.cutByGroups,\r\n      time,\r\n    };\r\n\r\n    this._sources.push(entry);\r\n\r\n    source.onended = () => {\r\n      source.disconnect();\r\n      gain.disconnect();\r\n      const index = this._sources.indexOf(entry);\r\n      if (index >= 0) this._sources.splice(index, 1);\r\n    };\r\n\r\n    console.log(beat, audioContext.currentTime, time);\r\n\r\n    if (this.startPosition >= 0) {\r\n      source.start(\r\n        time,\r\n        this.startPosition,\r\n        (this.endPosition || this.buffer.duration) - this.startPosition\r\n      );\r\n    } else {\r\n      source.start(time);\r\n    }\r\n\r\n    if (time === 0 || !this.audioClock.isPlaying) {\r\n      triggerActive(this.domElement);\r\n    } else {\r\n      this.audioClock.scheduleEventAtTime(\r\n        () => triggerActive(this.domElement),\r\n        time\r\n      );\r\n    }\r\n\r\n    if (this.loop) {\r\n      source.loop = true;\r\n      source.loopStart = this.loopStart;\r\n      source.loopEnd = this.loopEnd || this.buffer.duration;\r\n    }\r\n\r\n    return entry;\r\n  }\r\n\r\n  release(time: number) {\r\n    for (const entry of this._sources) {\r\n      if (time >= entry.time) this.cut(entry, time);\r\n    }\r\n  }\r\n\r\n  cut(entry: ISourceEvent, time = 0) {\r\n    const currentValue = entry.gain.gain.value;\r\n    entry.gain.gain.cancelScheduledValues(time);\r\n    entry.gain.gain.setValueAtTime(currentValue, time);\r\n    entry.gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.1);\r\n    entry.source.stop(time + 0.1);\r\n  }\r\n}\r\n","import { Instrument } from \"../../abstracts/Instrument\";\r\nimport { InstrumentWindow } from \"../../abstracts/InstrumentWindow\";\r\nimport { AudioClock } from \"../../elements/components/AudioClock\";\r\nimport { SamplerSlot } from \"../../elements/components/SamplerSlot\";\r\nimport { ControllerGroup } from \"../../schema\";\r\n\r\nexport class Sampler extends Instrument {\r\n  readonly name = \"Sampler\";\r\n  readonly version = \"0.0.1\";\r\n  readonly description = \"A simple sampler\";\r\n  readonly author = \"Johnny Street\";\r\n  readonly id = \"sampler\";\r\n  readonly window: InstrumentWindow;\r\n\r\n  private readonly _slotsContainer: HTMLDivElement;\r\n\r\n  slots: SamplerSlot[] = [];\r\n  controllerGroups: ControllerGroup[] = [];\r\n\r\n  constructor(readonly audioClock: AudioClock) {\r\n    super(audioClock);\r\n    window.addEventListener(\"keydown\", (event) => this.onKeyDown(event));\r\n\r\n    const container = document.createElement(\"div\");\r\n    container.classList.add(\"sampler-slots-container\");\r\n    this._slotsContainer = container;\r\n\r\n    //keypad numbers 0-9\r\n    // then . / * + - Enter\r\n    const defaultSlots = [\r\n      { keyBinding: 96, name: \"0\" },\r\n      { keyBinding: 97, name: \"1\" },\r\n      { keyBinding: 98, name: \"2\" },\r\n      { keyBinding: 99, name: \"3\" },\r\n      { keyBinding: 100, name: \"4\" },\r\n      { keyBinding: 101, name: \"5\" },\r\n      { keyBinding: 102, name: \"6\", cutByGroups: [3, 6] },\r\n      { keyBinding: 103, name: \"7\" },\r\n      { keyBinding: 104, name: \"8\" },\r\n      { keyBinding: 105, name: \"9\" },\r\n      { keyBinding: 111, name: \"/\", cutByGroups: [0, 10] },\r\n      { keyBinding: 106, name: \"*\" },\r\n      { keyBinding: 109, name: \"-\" },\r\n      { keyBinding: 107, name: \"+\" },\r\n      { keyBinding: 13, name: \"Enter\" },\r\n    ];\r\n\r\n    for (let i = 0; i < 14; i++) {\r\n      const slot = new SamplerSlot(\r\n        this.audioClock,\r\n        defaultSlots[i].name,\r\n        defaultSlots[i].keyBinding,\r\n        i,\r\n        defaultSlots[i].cutByGroups\r\n      );\r\n      this.slots.push(slot);\r\n      container.appendChild(slot.domElement);\r\n      slot.loadSample(\"Sample\", `./data/samples/kit1/${i}.wav`);\r\n    }\r\n\r\n    audioClock.on(\"stop\", () => {\r\n      for (const slot of this.slots) {\r\n        slot.release(0);\r\n      }\r\n    });\r\n\r\n    this.domElement.appendChild(container);\r\n\r\n    this.window = new InstrumentWindow({\r\n      title: \"Sampler\",\r\n      persistent: true,\r\n      content: this.domElement,\r\n    });\r\n  }\r\n\r\n  trigger(note: number, channel: number | null, beat = 0) {\r\n    console.log(\"Sampler trigger\", note);\r\n    const slot = this.slots[note];\r\n    if (slot) {\r\n      for (const each of this.slots) {\r\n        if (each.cutByGroups.includes(slot.cutGroup)) {\r\n          each.release(beat);\r\n        }\r\n      }\r\n      return slot.trigger(beat);\r\n    }\r\n  }\r\n\r\n  release(note: number, time = 0): void {\r\n    if (this.slots[note]) {\r\n      this.slots[note].release(time);\r\n    }\r\n  }\r\n\r\n  onKeyDown(event: KeyboardEvent) {\r\n    //console.log(event.key, event.keyCode);\r\n    const slot = this.slots.find((slot) => slot.keyBinding === event.keyCode);\r\n    if (slot) {\r\n      event.preventDefault();\r\n      const note = this.slots.indexOf(slot);\r\n      this.trigger(note, null);\r\n    }\r\n  }\r\n}\r\n","import { AudioClock } from \"./elements/components/AudioClock\";\r\nimport { Project } from \"./elements/Project\";\r\nimport { ProjectUI } from \"./elements/ProjectUI\";\r\nimport { FMBass } from \"./plugins/fmbass/FMBass\";\r\nimport { Plugins } from \"./plugins/plugins\";\r\nimport { Sampler } from \"./plugins/sampler/Sampler\";\r\nimport { templates } from \"./schema\";\r\n\r\nPlugins.register(\"sampler\", Sampler);\r\nPlugins.register(\"fm_bass\", FMBass);\r\n\r\nconst domElement = document.createElement(\"div\");\r\ndomElement.classList.add(\"studio\");\r\n\r\nconst audioClock = new AudioClock();\r\nconst project = new Project(audioClock, templates.Basic);\r\nconst projectUI = new ProjectUI(project);\r\n\r\ndomElement.appendChild(audioClock.domElement);\r\ndomElement.appendChild(projectUI.domElement);\r\ndocument.body.appendChild(domElement);\r\n","export type ControllerGroup = { [key: string]: IPluginControl };\r\nexport type ControllerValue = number | string | boolean | AudioBuffer | object;\r\nexport type ControlType =\r\n  | \"knob\"\r\n  | \"slider\"\r\n  | \"string\"\r\n  | \"select\"\r\n  | \"audio\"\r\n  | \"object\";\r\n\r\nexport interface IEvent {\r\n  start: number;\r\n  duration: number;\r\n}\r\n\r\nexport interface INoteEvent extends IEvent {\r\n  note: number;\r\n  velocity: number;\r\n  label: string;\r\n  domElement?: HTMLElement;\r\n}\r\n\r\nexport interface IPlaylistEvent extends IEvent {\r\n  type: \"pattern\" | \"audio\";\r\n  label: string;\r\n  value: IPattern | AudioBuffer;\r\n  domElement?: HTMLElement;\r\n}\r\n\r\nexport interface ISequence {\r\n  events: INoteEvent[];\r\n}\r\n\r\nexport interface IPattern {\r\n  name: string;\r\n  sequences: ISequence[];\r\n}\r\n\r\nexport interface IPlaylistTrack {\r\n  name: string;\r\n  events: IPlaylistEvent[];\r\n}\r\n\r\nexport interface IHasOwnEnvelope {\r\n  envelope: IEnvelope | null;\r\n}\r\n\r\nexport interface IHasOwnLFO {\r\n  lfo?: IOscillatorSettings;\r\n}\r\n\r\nexport interface IUseEnvelope {\r\n  envelopeNumber: number | null;\r\n}\r\n\r\nexport interface IUseLFO {\r\n  lfoNumber: number | null;\r\n}\r\n\r\nexport interface IHasControls {\r\n  controllerGroups: ControllerGroup[];\r\n}\r\n\r\nexport interface IInstrumentSettings extends IHasControls {\r\n  name: string;\r\n  id: string;\r\n  inputPort?: number;\r\n  inputChannel?: number;\r\n}\r\n\r\nexport interface IPlaylistItem extends IEvent {\r\n  type: \"pattern\" | \"audio\";\r\n  label: string;\r\n  value: IPattern | AudioBuffer;\r\n}\r\n\r\nexport interface IPlaylistTrack {\r\n  name: string;\r\n  items: IPlaylistItem[];\r\n}\r\n\r\nexport interface IProject {\r\n  title: string;\r\n  description: string;\r\n  tempo: number;\r\n  instruments: IInstrumentSettings[];\r\n  patterns: IPattern[];\r\n  timeline: IPlaylistTrack[];\r\n}\r\n\r\nexport interface ISamplerSlot {\r\n  name: string;\r\n  buffer: AudioBuffer | null;\r\n  keyBinding: number | null;\r\n  velocity: number;\r\n  pan: number;\r\n  pitch: number;\r\n  randomPitch: number;\r\n  randomVelocity: number;\r\n  startPosition: number;\r\n  endPosition: number;\r\n  loop: boolean;\r\n  loopStart: number;\r\n  loopEnd: number;\r\n  cutGroup: number;\r\n  cutByGroups: number[];\r\n}\r\n\r\nexport interface ISamplerSettings {\r\n  name: string;\r\n  slots: ISamplerSlot[];\r\n}\r\n\r\nexport interface IPluginControl {\r\n  type: ControlType;\r\n  name: string;\r\n  label: string;\r\n  default: ControllerValue;\r\n  value: ControllerValue;\r\n  min?: number;\r\n  max?: number;\r\n  step?: number;\r\n}\r\n\r\nexport interface IEnvelope {\r\n  attack: IPluginControl;\r\n  hold: IPluginControl;\r\n  decay: IPluginControl;\r\n  sustain: IPluginControl;\r\n  release: IPluginControl;\r\n}\r\n\r\nexport interface IOscillatorSettings extends IHasOwnEnvelope {\r\n  shape: \"sine\" | \"square\" | \"sawtooth\" | \"triangle\";\r\n  detune: number;\r\n  gain?: number;\r\n  route?: number;\r\n  feedback?: number;\r\n}\r\n\r\nexport interface IFilter extends IHasOwnEnvelope {\r\n  type:\r\n    | \"lowpass\"\r\n    | \"highpass\"\r\n    | \"bandpass\"\r\n    | \"lowshelf\"\r\n    | \"highshelf\"\r\n    | \"peaking\"\r\n    | \"notch\"\r\n    | \"allpass\";\r\n  frequency: number;\r\n  detune: number;\r\n  Q: number;\r\n  gain: number;\r\n}\r\n\r\nexport interface ISynthesizerSettings {\r\n  name: string;\r\n  voices: ISynthesizerVoiceSettings[];\r\n}\r\n\r\nexport interface ISynthesizerVoiceSettings extends IUseEnvelope, IUseLFO {\r\n  gain: number;\r\n  frequency: number | null;\r\n  detune: number | null;\r\n  oscillators: IOscillatorSettings[];\r\n  note: number | null;\r\n}\r\n\r\nexport const templates: { [key: string]: IProject } = {\r\n  Basic: {\r\n    title: \"Basic\",\r\n    description: \"Basic project template with Sampler and Synthesizer\",\r\n    tempo: 120,\r\n    instruments: [\r\n      { name: \"Sampler\", id: \"sampler\", controllerGroups: [] },\r\n      {\r\n        name: \"FM Bass\",\r\n        id: \"fm_bass\",\r\n        controllerGroups: [],\r\n      },\r\n    ],\r\n    patterns: [\r\n      {\r\n        name: \"Pattern 1\",\r\n        sequences: [\r\n          {\r\n            events: [],\r\n          },\r\n          {\r\n            events: [],\r\n          },\r\n        ],\r\n      },\r\n    ],\r\n    timeline: [],\r\n  },\r\n};\r\n"],"names":["exports","Symbol","toStringTag","Object","defineProperty","value","_events","_onceEvents","on","eventName","callback","this","push","once","emit","eventData","onceCallbacks","error","console","undefined","callbacks","audioContext","AudioContext","window","webkitAudioContext","getAudioContext","latencyHint","sampleRate","prototype","navigator","mediaDevices","enumerateDevices","getAudioDevices","then","devices","log","_playbackMode","_audioContext","_bpm","_scheduledEvents","_startTime","domElement","document","createElement","classList","add","playPauseButton","textContent","addEventListener","isPlaying","stop","playPause","appendChild","stopButton","bpmInput","type","parseFloat","currentTimeDisplay","currentTime","start","requestAnimationFrame","_render","bind","_update","currentBeat","source","disconnect","restart","buffer","createBuffer","createBufferSource","connect","destination","beat","bars","Math","floor","beats","timeString","toString","padStart","scheduleEventAtTime","time","emptyBuffer","onended","scheduleEventAtBeat","tagName","className","child","removeChild","audioClock","BaseElement","register","name","plugin","_plugins","warn","get","instantiate","id","project","title","description","tempo","instruments","patterns","sequences","timeline","setTimeout","load","serialize","JSON","stringify","map","instrument","controllerGroups","deserialize","data","parse","Plugins","instance","_activeWindow","windows","_draggingWindow","addWindow","includes","activateWindow","w","toggle","BOTTOM_ROW","TOP_ROW","KEY_COLORS","NOTE_NAMES","keyToNote","keyCode","note","indexOf","pressedKeys","event","ctrlKey","altKey","shiftKey","target","splice","_resizing","_startX","_startY","_startWidth","_startHeight","_startTop","_startLeft","_resizeDirection","e","handle","getCurrentHandle","style","cursor","onmove","dx","clientX","dy","clientY","width","height","left","top","offsetWidth","offsetHeight","button","startResize","preventDefault","onrelease","stopResize","removeEventListener","direction","offsetTop","offsetLeft","rect","getBoundingClientRect","offsetX","offsetY","options","_isDragging","_dragOffsetX","_dragOffsetY","_top","_left","display","persistent","titlebar","parentElement","scrollTop","ondrag","newTop","newLeft","body","_title","content","_closeButton","close","setSize","show","x","y","innerWidth","innerHeight","remove","setPosition","setTitle","SizableElement","channel","label","_channel","_label","volume","min","max","step","mute","solo","_volume","_mute","_solo","valueAsNumber","checked","ui","container","overflowX","masterChannel","MixerChannel","i","DraggableWindow","items","item","addSelectable","selectable","addToDom","selected","f","find","t","end","removeSelectable","index","clear","length","clock","update","transform","beatWidth","hide","triggerActive","elt","timeout","group","contains","track","buttonGroup","assert","textLabel","buttons","edit","isVisible","indicator","SelectableElement","previewGroup","_canvas","append","port","events","PatternTrackInstrument","preview","PatternTrackPreview","trigger","release","sequence","playback","sourceEvent","duration","nextLoop","tracks","trackContainer","AudioCursor","canvas","querySelector","clientWidth","startTime","Error","addPattern","patternPreviews","SelectableGroup","loadProject","addTrack","pattern","PatternTrack","pianoRollWindow","loadTrack","removeTrack","play","bpm","scrollElement","sensitivity","linkedElements","_scrollTop","deltaY","linkElement","element","playOnClick","playBuffer","ctx","getContext","generateAudio","Promise","resolve","reject","req","text","pitch","rate","fetch","method","headers","res","arrayBuffer","decodeAudioData","audioBuffer","catch","loadBuffer","channelData","getChannelData","bufferLength","sliceWidth","clearRect","beginPath","moveTo","lineTo","stroke","AudioCanvas","ok","cancel","closeButton","HTMLButtonElement","okButton","cancelButton","targetObject","onsave","textInput","setAttribute","pitchSlider","audioCanvas","LyricCanvas","saveButton","DialogPopup","grid","velocity","audio","noteHeight","noteLabel","lyricLabel","gridElement","_currentNote","_dragMode","_quantize","_dragOffset","_track","previewCanvas","imageRendering","rowBackgroundCanvas","strokeStyle","lineWidth","j","row","base64","toDataURL","backgroundImage","backgroundRepeat","noteEditor","LyricEditorDialog","input","layerX","HTMLDivElement","n","layerY","round","oldStart","pointerEvents","GridItem","renderToCanvas","color","lowestNote","highestNote","padded_scale","fillStyle","fillRect","ScrollPanel","keys","redraw","key","innerHTML","backgroundColor","reverse","cursorUpdateInterval","sideKeyboard","SideKeyboard","Grid","marginLeft","pianoRoll","PianoRoll","settings","addEvent","loadEvents","innerText","_tracks","bucket","refresh","PlaylistSourceItem","PlaylistTrack","forEach","WindowContainer","PianoRollWindow","patternWindow","PatternWindow","playlistWindow","PlaylistWindow","mixerWindow","MixerWindow","keyboard","Keyboard","Plugin","voices","_nextVoice","_held","transpose","_output","createGain","addVoice","voice","handleEvent","findIndex","Instrument","_settings","_note","_frequency","_gain","gain","lfoNumber","envelopeNumber","detune","oscillators","loadSettings","pow","_type","_name","_min","_max","_step","_value","_default","_range","attack","hold","decay","sustain","Slider","param","when","cancelScheduledValues","setValueAtTime","exponentialRampToValueAtTime","linearRampToValueAtTime","triggerRelease","setTargetAtTime","SynthesizerVoice","version","author","modulatorGain","highpassFilter","createBiquadFilter","frequency","output","filter","Q","filterEnvelope","Envelope","gainEnvelope","fmGainSlider","_heldNote","_carrier","context","state","g","_modulator","createOscillator","freq","noteToFrequency","Synthesizer","keyBinding","cutGroup","cutByGroups","_sources","pan","randomPitch","randomVelocity","startPosition","endPosition","loop","loopStart","loopEnd","_previewCanvas","_nameElement","loadSample","url","response","statusText","playbackRate","random","createStereoPanner","entry","cut","currentValue","slots","onKeyDown","_slotsContainer","defaultSlots","slot","SamplerSlot","InstrumentWindow","each","Sampler","FMBass","AudioClock","projectUI","ProjectUI","Project"],"sourceRoot":""}